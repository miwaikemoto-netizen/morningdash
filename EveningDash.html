<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Evening Dash</title>
<meta name="theme-color" content="#0b1220">
<style>
:root{
  --bg:#090f1c; --bg2:#0b1220;
  --fg:#e6edf7; --muted:#a7b4c8;
  --card:#0f172a; --border:rgba(255,255,255,.12);
  --accent:#60a5fa; --accent-press:#3b82f6;
  --radius:16px; --shadow:0 10px 30px rgba(0,0,0,.35);
  --chip:#1e293b; --chip-on:#1d4ed8;
}
*{box-sizing:border-box;-webkit-tap-highlight-color: transparent}
html,body{margin:0;height:100%}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;background:linear-gradient(180deg,var(--bg),var(--bg2));color:var(--fg)}
.container{max-width:900px;margin:0 auto;padding:16px 16px 92px}
h1{margin:4px 0 10px;font-size:34px;line-height:1.2;font-weight:800}
h2{margin:0 0 10px;font-size:20px}
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;margin:12px 0}
.row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.btn{appearance:none;border:1px solid var(--border);border-radius:14px;padding:12px 16px;background:rgba(255,255,255,.04);cursor:pointer;color:var(--fg);text-decoration:none;font-size:16px}
.btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
.btn.primary:active{background:var(--accent-press)}
.input, select, textarea{border:1px solid var(--border);border-radius:12px;padding:12px 14px;background:rgba(255,255,255,.04);color:var(--fg);font-size:16px}
textarea{width:100%;min-height:96px;resize:vertical}
.small{font-size:13px;color:var(--muted)}
.header{display:flex;justify-content:space-between;align-items:flex-end;gap:10px;flex-wrap:wrap;margin-bottom:6px}
.bigdate{display:flex;align-items:baseline;gap:6px}
.bigdate .md{font-weight:800;font-size:42px}
.bigdate .sep{font-size:30px;transform:translateY(-2px)}
.bigdate .y{font-weight:700;font-size:16px;color:var(--muted)}
.wday{font-weight:700}
#goodnight{display:none;font-size:40px;text-align:center;margin-top:12px}
footer{font-size:12px;color:var(--muted);margin-top:16px}
hr{border:none;border-top:1px solid var(--border);margin:12px 0}
.historyItem{padding:10px;border:1px dashed var(--border);border-radius:12px;margin-top:8px}
label.checkbox{display:flex;align-items:center;gap:10px;cursor:pointer;font-size:16px}
label.checkbox input{transform:scale(1.2)}

/* é¸æŠãƒãƒƒãƒ—ï¼ˆiPhoneã§æŠ¼ã—ã‚„ã™ã„ã‚µã‚¤ã‚ºï¼‰ */
.chips{display:flex;flex-wrap:wrap;gap:10px}
.chip{padding:12px 16px;border-radius:999px;background:var(--chip);border:1px solid var(--border);cursor:pointer;font-size:16px}
.chip.on{background:var(--chip-on);border-color:transparent}
.chips:empty::after{content:"ï¼ˆã“ã“ã«é¸æŠè‚¢ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰";color:var(--muted);font-size:14px}

/* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç´°éƒ¨ */
#musicRow{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.wxIcon{font-size:24px}
.wxLine{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <h1>ğŸŒ™ Evening Dash</h1>
        <div class="bigdate">
          <span class="md" id="mdM">08</span><span class="sep">/</span><span class="md" id="mdD">28</span>
          <span class="y" id="mdY">2025</span>
          <span class="wday" id="mdW">æœ¨æ›œæ—¥</span>
        </div>
      </div>
      <div class="row">
        <a href="./" class="btn">â˜€ï¸ æœã®è¨˜éŒ²ã¸</a>
        <a id="openCal" href="#" class="btn">ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</a>
      </div>
    </div>

    <!-- â‘  ç”Ÿæ´»ç¿’æ…£ãƒã‚§ãƒƒã‚¯ -->
    <section class="card" id="secHabits">
      <h2>â‘  ç”Ÿæ´»ç¿’æ…£ãƒã‚§ãƒƒã‚¯</h2>
      <div class="row">
        <label class="checkbox"><input type="checkbox" id="h_bath"> ãŠé¢¨å‘‚</label>
        <label class="checkbox"><input type="checkbox" id="h_teeth"> æ­¯ç£¨ã</label>
        <label class="checkbox"><input type="checkbox" id="h_skin"> ã‚¹ã‚­ãƒ³ã‚±ã‚¢</label>
        <label class="checkbox"><input type="checkbox" id="h_hair"> ãƒãƒ³ãƒ‰/ãƒ˜ã‚¢ã‚±ã‚¢</label>
        <label class="checkbox"><input type="checkbox" id="h_special"> ã‚¹ãƒšã‚·ãƒ£ãƒ«ã‚±ã‚¢</label>
        <label class="checkbox"><input type="checkbox" id="h_tomorrow"> æ˜æ—¥ã®æº–å‚™</label>
      </div>
    </section>

    <!-- â‘¡ æ—¥è¨˜ãƒ»è¨˜éŒ²ï¼ˆæ°—åœ§+å¤©æ°— è‡ªå‹•å–å¾—ï¼‰ -->
    <section class="card" id="secDiary">
      <h2>â‘¡ æ—¥è¨˜ãƒ»è¨˜éŒ²</h2>

      <!-- å¤©æ°—/æ°—åœ§ï¼ˆæœ€ä¸Šæ®µãƒ»è‡ªå‹•å–å¾—ï¼‰ -->
      <div id="wxRow" class="wxLine">
        <div id="wxIcon" class="wxIcon">â³</div>
        <div id="wxText" class="small">å¤©æ°—ãƒ»æ°—åœ§ã‚’å–å¾—ä¸­â€¦</div>
      </div>

      <hr>

      <!-- æ„Ÿæƒ…ãƒ»ä½“èª¿ -->
      <div>æ„Ÿæƒ…è¨˜éŒ²</div>
      <div id="moodChips" class="chips" style="margin-bottom:8px"></div>

      <div>ä½“èª¿è¨˜éŒ²ï¼ˆè¤‡æ•°å¯ï¼‰</div>
      <div id="condChips" class="chips"></div>

      <hr>

      <div>
        <label>ğŸ“Œ å‡ºæ¥ãŸã“ã¨ãƒ»è‰¯ã‹ã£ãŸã“ã¨</label>
        <textarea id="diaryGood" placeholder="ä¾‹ï¼šæœã«æ•£æ­©ï¼ã‚¬ãƒ¼ãƒ‡ãƒ‹ãƒ³ã‚°30åˆ†ï¼é¦–ã®å¼µã‚ŠãŒè»½ã‹ã£ãŸ ãªã©"></textarea>
      </div>
      <div>
        <label>ğŸ“Œ æ˜æ—¥ã‚„ã‚ŠãŸã„ã“ã¨</label>
        <input id="diaryNext" class="input" placeholder="ä¾‹ï¼šæœã«æ´—æ¿¯ï¼10åˆ†ã‚¹ãƒˆãƒ¬ãƒƒãƒ" style="width:100%">
      </div>
      <div>
        <label>ğŸ““ è‡ªç”±ãƒ¡ãƒ¢</label>
        <textarea id="diaryFree" placeholder="ãªã‚“ã§ã‚‚ã©ã†ã"></textarea>
      </div>
    </section>

    <!-- â‘¢ å…¥çœ å„€å¼ -->
    <section class="card" id="secSleep">
      <h2>â‘¢ å…¥çœ å„€å¼</h2>
      <div class="row" style="align-items:flex-start">
        <label class="checkbox"><input type="checkbox" id="r_rollerBreath">ãƒ­ãƒ¼ãƒ©ãƒ¼å‘¼å¸ <span class="small">ï¼ˆã¿ããŠã¡ä¸‹ã«ç½®ãå‘¼å¸ã€€2ã€œ3åˆ†ï¼‰</span></label>
        <label class="checkbox"><input type="checkbox" id="r_child">ãƒãƒ£ã‚¤ãƒ«ãƒ‰ãƒãƒ¼ã‚º <span class="small">ï¼ˆ1ã€œ2åˆ†ï¼‰</span></label>
        <label class="checkbox"><input type="checkbox" id="r_ear">è€³ã¾ã‚ã— <span class="small">ï¼ˆå‰â†’å¾Œï¼ä¸Šãƒ»ä¸­ãƒ»ä¸‹ï¼‰</span></label>
        <label class="checkbox"><input type="checkbox" id="r_breath">è‚©ã™ãã‚å‘¼å¸ <span class="small">ï¼ˆå¸=ã™ãã‚ã‚‹ï¼å=ã‚¹ãƒˆãƒ³ï¼‰</span></label>
      </div>
    </section>

    <!-- â‘£ éŸ³æ¥½ãƒ»ä¿å­˜ -->
    <section class="card" id="secMusic">
      <h2>â‘£ éŸ³æ¥½ãƒ»æ“ä½œ</h2>
      <div id="musicRow">
        <a id="playMusicBtn" class="btn primary" href="https://music.youtube.com/playlist?list=PLUwMnSYvjfDQ9B8qPyifyyfonuhTY3C6y&si=6ssi1DGhphTAT_k7" target="_blank" rel="noopener">ğŸµ éŸ³æ¥½ã‚’å†ç”Ÿ</a>
        <button id="saveBtn" class="btn primary">ğŸ’¾ ä¿å­˜</button>
        <span class="small">â€» YouTube Music ã®ç¡çœ ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’é–‹ãã¾ã™ã€‚</span>
      </div>
      <div id="goodnight" class="">ğŸ˜ª ãŠã‚„ã™ã¿</div>
    </section>

    <!-- å±¥æ­´ -->
    <section class="card">
      <div class="row" style="justify-content:space-between">
        <h2>å±¥æ­´</h2>
        <button id="reloadBtn" class="btn">å†èª­è¾¼</button>
      </div>
      <div id="history"></div>
    </section>

    <footer>
      ä¿å­˜å…ˆã¯ãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆlocalStorageï¼‰ã€‚åŒã˜URLãªã‚‰ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã—ã¦ã‚‚å±¥æ­´ã¯å¼•ãç¶™ãŒã‚Œã¾ã™ã€‚
    </footer>
  </div>

<script>
document.addEventListener('DOMContentLoaded', function(){
  const $ = s => document.querySelector(s);
  const z2 = n => String(n).padStart(2,"0");
  const tz = "Asia/Tokyo";
  const wdJP = ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"];
  const toKey = d => d.toLocaleDateString("ja-JP",{timeZone:tz});

  // Header date
  const today = new Date();
  (function renderHeaderDate(d){
    $("#mdM").textContent = z2(d.getMonth()+1);
    $("#mdD").textContent = z2(d.getDate());
    $("#mdY").textContent = String(d.getFullYear());
    $("#mdW").textContent = wdJP[d.getDay()] + "æ›œæ—¥";
  })(today);

  // Nav: Calendar (today)
  (function(){ const iso = new Date().toISOString().slice(0,10); $("#openCal").href = `./Calendar.html?date=${iso}`; })();

  // Storage helpers
  const KEY = "evening_logs_v2";
  const loadAll = () => JSON.parse(localStorage.getItem(KEY)||"[]");
  const saveAll = arr => localStorage.setItem(KEY, JSON.stringify(arr));
  const loadLog = key => loadAll().find(x=>x.date===key) || null;
  const upsert = payload => {
    const rest = loadAll().filter(x=>x.date!==payload.date);
    saveAll([payload, ...rest].sort((a,b)=> (a.date<b.date?1:-1)));
  };

  // ---------- Mood/Condition chips ----------
  const moods = ["æœ€é«˜","è‰¯ã„","æ™®é€š","ã„ã¾ã„ã¡","ã—ã‚“ã©ã„"];
  const conds = ["é¦–ãƒ»è‚©ã“ã‚Š","é ­ç—›","è…¹ç—›/ãŠè…¹ã®å¼µã‚Š","è…°ã®å¼µã‚Š/è…°ç—›","è‡ªå¾‹ç¥çµŒã®ä¹±ã‚Œ","èƒƒè…¸å¼±ã‚","ã‚€ãã¿","ç›®ã®ç–²ã‚Œ/ãƒ‰ãƒ©ã‚¤ã‚¢ã‚¤","ç¡çœ ã®è³ªä½ä¸‹","å†·ãˆ","å–‰ã®ç—›ã¿","é¼»æ°´/é¼»ã¥ã¾ã‚Š","è‚Œè’ã‚Œ/ã‹ã‚†ã¿","èŠ±ç²‰/ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼","ã ã‚‹ã•/å€¦æ€ æ„Ÿ","ã‚¤ãƒ©ã‚¤ãƒ©/ä¸å®‰","ãƒ¢ãƒãƒ™ä½ä¸‹","PMS","ç”Ÿç†"];

  const state = {
    habits: { bath:false, teeth:false, skin:false, hair:false, special:false, tomorrow:false },
    ritual: { rollerBreath:false, child:false, ear:false, breath:false },
    mood: "", condSel: [],
    wx: null,
    diaryGood: "", diaryNext: "", diaryFree: ""
  };

  function renderSingleChips(rootSel, items, getter, setter){
    const root = $(rootSel); root.innerHTML="";
    items.forEach(txt=>{
      const b=document.createElement('button');
      b.className='chip'; b.textContent=txt;
      if(getter()===txt) b.classList.add('on');
      b.addEventListener('click', ()=>{
        setter(getter()===txt ? "" : txt);
        renderSingleChips(rootSel, items, getter, setter);
        autoSave();
      });
      root.appendChild(b);
    });
  }
  function renderMultiChips(rootSel, items, getter, setter){
    const root = $(rootSel); root.innerHTML="";
    items.forEach(txt=>{
      const b=document.createElement('button');
      b.className='chip'; b.textContent=txt;
      if(getter().includes(txt)) b.classList.add('on');
      b.addEventListener('click', ()=>{
        const arr = getter().slice();
        const i = arr.indexOf(txt);
        if(i>-1) arr.splice(i,1); else arr.push(txt);
        setter(arr);
        b.classList.toggle('on');
        autoSave();
      });
      root.appendChild(b);
    });
  }

  renderSingleChips("#moodChips", moods, ()=>state.mood, v=>{state.mood=v;});
  renderMultiChips("#condChips", conds, ()=>state.condSel, v=>{state.condSel=v;});

  // Wire checkboxes (habits + rituals)
  const bind = (sel, obj, key) => $(sel).addEventListener("change",()=>{ obj[key] = $(sel).checked; autoSave(); });
  bind("#h_bath", state.habits, "bath"); bind("#h_teeth", state.habits, "teeth"); bind("#h_skin", state.habits, "skin");
  bind("#h_hair", state.habits, "hair"); bind("#h_special", state.habits, "special"); bind("#h_tomorrow", state.habits, "tomorrow");
  bind("#r_rollerBreath", state.ritual, "rollerBreath");
  bind("#r_child",        state.ritual, "child");
  bind("#r_ear",          state.ritual, "ear");
  bind("#r_breath",       state.ritual, "breath");

  // Wire diary fields
  ["Good","Next","Free"].forEach(k=>{
    const id = "#diary"+k;
    $(id).addEventListener("input", ()=>{ state["diary"+k] = $(id).value; autoSave(); });
  });

  // Save/history
  function currentKey(){ return toKey(new Date()); }
  function saveNow(){
    const payload = {
      date: currentKey(),
      habits: state.habits, ritual: state.ritual,
      mood: state.mood, condSel: state.condSel,
      wx: state.wx,
      diaryGood: state.diaryGood, diaryNext: state.diaryNext, diaryFree: state.diaryFree,
      ts: Date.now()
    };
    upsert(payload); renderHistory();
  }
  let t=null; function autoSave(){ clearTimeout(t); t=setTimeout(saveNow, 250); }
  $("#saveBtn").addEventListener("click", ()=>{ saveNow(); alert("ä¿å­˜ã—ã¾ã—ãŸ"); });

  function renderHistory(){
    const root = $("#history"); const logs = loadAll(); root.innerHTML="";
    if(!logs.length){ root.innerHTML = '<div class="small">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>'; return; }
    logs.forEach(l=>{
      const box = document.createElement("div"); box.className="historyItem";
      const lines = [];
      lines.push(`<b>${l.date}</b>`);
      const h = l.habits||{}; const r=l.ritual||{};
      const htxt = Object.entries({ãŠé¢¨å‘‚:"bath",æ­¯ç£¨ã:"teeth",ã‚¹ã‚­ãƒ³ã‚±ã‚¢:"skin",ãƒãƒ³ãƒ‰/ãƒ˜ã‚¢:"hair",ã‚¹ãƒšã‚·ãƒ£ãƒ«ã‚±ã‚¢:"special",æ˜æ—¥ã®æº–å‚™:"tomorrow"})
        .filter(([k,v]) => h[v]).map(([k])=>k).join(" / ") || "â€”";
      const rtxt = Object.entries({
        "ãƒ­ãƒ¼ãƒ©ãƒ¼å‘¼å¸":"rollerBreath",
        "ãƒãƒ£ã‚¤ãƒ«ãƒ‰ãƒãƒ¼ã‚º":"child",
        "è€³ã¾ã‚ã—":"ear",
        "è‚©ã™ãã‚å‘¼å¸":"breath"
      }).filter(([k,v]) => r[v]).map(([k])=>k).join(" / ") || "â€”";
      const press = (l.wx && l.wx.pressure!=null) ? Math.round(l.wx.pressure)+"hPa" : "â€”";
      const wtemp = (l.wx && l.wx.temp!=null) ? Math.round(l.wx.temp)+"Â°C" : "â€”";
      lines.push(`ç¿’æ…£ï¼š${htxt}ã€€å…¥çœ å„€å¼ï¼š${rtxt}`);
      lines.push(`æ„Ÿæƒ…ï¼š${l.mood||"â€”"}ã€€ä½“èª¿ï¼š${(l.condSel||[]).join("ã€")||"â€”"}ã€€å¤©æ°—ï¼š${wtemp}ãƒ»æ°—åœ§ï¼š${press}`);
      if(l.diaryGood) lines.push(`<div class="small">è‰¯ã‹ã£ãŸï¼š${l.diaryGood.replace(/\n/g," / ")}</div>`);
      if(l.diaryNext) lines.push(`<div class="small">æ˜æ—¥ï¼š${l.diaryNext}</div>`);
      if(l.diaryFree) lines.push(`<div class="small">ãƒ¡ãƒ¢ï¼š${l.diaryFree.replace(/\n/g," / ")}</div>`);
      box.innerHTML = lines.join("<br>");
      root.appendChild(box);
    });
  }

  // Weather/pressure with robust fallbacks + watchdog
  const WX_KEY = "evening_last_geo";
  function setLastGeo(lat, lon){ try{ localStorage.setItem(WX_KEY, JSON.stringify({lat,lon,ts:Date.now()})); }catch(e){} }
  function getLastGeo(){ try{ return JSON.parse(localStorage.getItem(WX_KEY)||"null"); }catch(e){ return null; } }
  function parseParamFloat(name){ const v=new URLSearchParams(location.search).get(name); return v?parseFloat(v):null; }
  const TOKYO = {lat:35.681236, lon:139.767125};

  const iconEl=$("#wxIcon"), textEl=$("#wxText");
  function wxIcon(code){ if(code>=61&&code<=65) return "ğŸŒ§ï¸"; if(code===0||code===1) return "â˜€ï¸"; if(code===2) return "ğŸŒ¤ï¸"; if(code===3) return "â˜ï¸"; return "ğŸŒ¦ï¸"; }
  function wxText(code){ const map={0:"å¿«æ™´",1:"æ™´ã‚Œ",2:"è–„æ›‡ã‚Š",3:"æ›‡ã‚Š",45:"éœ§",48:"éœ§æ°·",51:"å¼±ã„éœ§é›¨",53:"éœ§é›¨",55:"å¼·ã„éœ§é›¨",61:"å¼±ã„é›¨",63:"é›¨",65:"å¼·ã„é›¨",71:"å¼±ã„é›ª",73:"é›ª",75:"å¤§é›ª",95:"é›·é›¨"}; return map[code]||"â€”"; }
  function renderWx(){
    if(!state.wx){ iconEl.textContent='âš ï¸'; textEl.textContent='å¤©æ°—/æ°—åœ§ã®å–å¾—ã«å¤±æ•—ï¼ˆä½ç½®æƒ…å ±ã‚’è¨±å¯ã™ã‚‹ã‹ã€?lat & ?lon ã‚’ä»˜ã‘ã¦ãã ã•ã„ï¼‰'; return; }
    iconEl.textContent = wxIcon(state.wx.code);
    textEl.textContent = `${Math.round(state.wx.temp)}Â°Cã€€${wxText(state.wx.code)}ã€€æ°—åœ§ï¼š${state.wx.pressure?Math.round(state.wx.pressure)+"hPa":"â€”"}`;
  }
  function fetchWx(lat, lon){
    setLastGeo(lat, lon);
    const u=new URL('https://api.open-meteo.com/v1/forecast');
    u.searchParams.set('latitude', lat); u.searchParams.set('longitude', lon);
    u.searchParams.set('current_weather','true');
    u.searchParams.set('hourly','pressure_msl');
    u.searchParams.set('timezone', tz);
    fetch(u.toString()).then(r=>r.json()).then(data=>{
      const c=data.current_weather||{};
      const times=(data.hourly&&data.hourly.time)||[]; const idx=times.indexOf(c.time);
      const p = (idx>-1 && data.hourly.pressure_msl) ? data.hourly.pressure_msl[idx] : null;
      state.wx = { temp:c.temperature, wind:c.windspeed, code:c.weathercode, pressure:p };
      renderWx(); autoSave();
    }).catch(()=>{ renderWx(); });
  }
  (function initWeather(){
    let finished=false;
    const watchdog = setTimeout(()=>{
      if(!finished){ const last=getLastGeo(); fetchWx((last&&last.lat)||TOKYO.lat, (last&&last.lon)||TOKYO.lon); finished=true; }
    }, 5000);
    const qLat=parseParamFloat('lat'), qLon=parseParamFloat('lon');
    if(qLat!=null && qLon!=null){ fetchWx(qLat, qLon); finished=true; clearTimeout(watchdog); return; }
    if('geolocation' in navigator){
      navigator.geolocation.getCurrentPosition(
        pos=>{ if(!finished){ fetchWx(pos.coords.latitude, pos.coords.longitude); finished=true; clearTimeout(watchdog);} },
        ()=>{ if(!finished){ const last=getLastGeo(); fetchWx((last&&last.lat)||TOKYO.lat, (last&&last.lon)||TOKYO.lon); finished=true; clearTimeout(watchdog);} },
        {enableHighAccuracy:false, timeout:4000}
      );
    }else{
      const last=getLastGeo(); fetchWx((last&&last.lat)||TOKYO.lat, (last&&last.lon)||TOKYO.lon); finished=true; clearTimeout(watchdog);
    }
  })();

  // hydrate today's saved
  const saved = loadLog(toKey(new Date()));
  if(saved){
    Object.assign(state.habits, saved.habits||{});
    Object.assign(state.ritual, saved.ritual||{});
    state.mood = saved.mood||"";
    state.condSel = saved.condSel||[];
    state.wx = saved.wx||null;
    state.diaryGood = saved.diaryGood||"";
    state.diaryNext = saved.diaryNext||"";
    state.diaryFree = saved.diaryFree||"";
  }
  // reflect checkboxes
  [['#h_bath','habits','bath'],['#h_teeth','habits','teeth'],['#h_skin','habits','skin'],['#h_hair','habits','hair'],['#h_special','habits','special'],['#h_tomorrow','habits','tomorrow']]
    .forEach(([sel,grp,key])=>{ $(sel).checked = !!state[grp][key]; });
  [['#r_rollerBreath','ritual','rollerBreath'],['#r_child','ritual','child'],['#r_ear','ritual','ear'],['#r_breath','ritual','breath']]
    .forEach(([sel,grp,key])=>{ $(sel).checked = !!state[grp][key]; });

  // initial render
  renderSingleChips("#moodChips", moods, ()=>state.mood, v=>{state.mood=v;});
  renderMultiChips("#condChips", conds, ()=>state.condSel, v=>{state.condSel=v;});
  renderWx();
  renderHistory();

}); // DOMContentLoaded
</script>
</body>
</html>
