<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Evening Dash（夜の記録） v3</title>
<meta name="theme-color" content="#0b1220">
<style>
:root{
  /* ダーク（ネイビー）テーマ */
  --bg:#090f1c; --bg2:#0b1220;
  --fg:#e6edf7; --muted:#93a0b4;
  --card:#0f172a; --border:rgba(255,255,255,.10);
  --accent:#60a5fa; --accent-press:#3b82f6;
  --radius:16px; --shadow:0 10px 30px rgba(0,0,0,.35);
  --chip:#1e293b; --chip-on:#1d4ed8;
}
*{box-sizing:border-box}
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;background:linear-gradient(180deg,var(--bg),var(--bg2));color:var(--fg)}
.container{max-width:900px;margin:0 auto;padding:16px 16px 92px}
h1{margin:0 0 8px;font-size:28px}
h2{margin:0 0 10px;font-size:20px}
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;margin:10px 0}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.btn{appearance:none;border:1px solid var(--border);border-radius:14px;padding:10px 14px;background:rgba(255,255,255,.04);cursor:pointer;color:var(--fg);text-decoration:none}
.btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
.btn.primary:hover{background:var(--accent-press)}
.input, select, textarea{border:1px solid var(--border);border-radius:12px;padding:10px 12px;background:rgba(255,255,255,.04);color:var(--fg);font-size:14px}
textarea{width:100%;min-height:92px;resize:vertical}
.small{font-size:12px;color:var(--muted)}
.badge{border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted)}
.header{display:flex;justify-content:space-between;align-items:flex-end;gap:10px;flex-wrap:wrap;margin-bottom:8px}
.bigdate{display:flex;align-items:baseline;gap:6px}
.bigdate .md{font-weight:800;font-size:40px}
.bigdate .sep{font-size:28px;transform:translateY(-2px)}
.bigdate .y{font-weight:700;font-size:16px;color:var(--muted)}
.wday{font-weight:700}
#goodnight{display:none;font-size:40px;text-align:center;margin-top:12px}
footer{font-size:12px;color:var(--muted);margin-top:16px}
hr{border:none;border-top:1px solid var(--border);margin:12px 0}
.historyItem{padding:10px;border:1px dashed var(--border);border-radius:12px;margin-top:8px}
label.checkbox{display:flex;align-items:center;gap:8px;cursor:pointer}
label.checkbox input{transform:scale(1.2)}

/* 選択チップ */
.chips{display:flex;flex-wrap:wrap;gap:8px}
.chip{padding:8px 12px;border-radius:999px;background:var(--chip);border:1px solid var(--border);cursor:pointer;font-size:13px;color:var(--fg)}
.chip.on{background:var(--chip-on);border-color:transparent}

/* レイアウト細部 */
#musicRow{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.hide{display:none !important}
.ritual{display:grid;grid-template-columns:repeat(2,minmax(260px,1fr));gap:10px 14px}
@media (max-width:640px){ .ritual{grid-template-columns:1fr} }
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <div class="badge">Evening Dash</div>
        <div class="bigdate">
          <span class="md" id="mdM">08</span><span class="sep">/</span><span class="md" id="mdD">28</span>
          <span class="y" id="mdY">2025</span>
          <span class="wday" id="mdW">木曜日</span>
        </div>
      </div>
      <div class="row">
        <a href="./" class="btn">☀️ 朝の記録へ</a>
        <a id="openCal" href="#" class="btn">📅 カレンダー</a>
      </div>
    </div>

    <!-- ① 生活習慣チェック -->
    <section class="card" id="secHabits">
      <h2>① 生活習慣チェック</h2>
      <div class="row">
        <label class="checkbox"><input type="checkbox" id="h_bath"> お風呂</label>
        <label class="checkbox"><input type="checkbox" id="h_teeth"> 歯磨き</label>
        <label class="checkbox"><input type="checkbox" id="h_skin"> スキンケア</label>
        <label class="checkbox"><input type="checkbox" id="h_hair"> ハンド/ヘアケア</label>
        <label class="checkbox"><input type="checkbox" id="h_special"> スペシャルケア</label>
        <label class="checkbox"><input type="checkbox" id="h_tomorrow"> 明日の準備</label>
      </div>
    </section>

    <!-- ② 日記・記録（気圧+天気を最上段に自動取得） -->
    <section class="card" id="secDiary">
      <h2>② 日記・記録</h2>

      <!-- 自動取得ブロック（最上段） -->
      <div id="wxRow" class="row">
        <div id="wxIcon" style="font-size:22px">⏳</div>
        <div id="wxTemp" class="small">天気・気圧を取得中…</div>
      </div>

      <hr>

      <!-- 感情（単一選択チップ）・体調（複数選択チップ） -->
      <div class="small">感情記録</div>
      <div id="moodChips" class="chips" style="margin-bottom:8px"></div>

      <div class="small">体調記録（複数可）</div>
      <div id="condChips" class="chips"></div>

      <hr>

      <div>
        <label>📌 出来たこと・良かったこと</label>
        <textarea id="diaryGood" placeholder="例：朝に散歩／ガーデニング30分／首の張りが軽かった など"></textarea>
      </div>
      <div>
        <label>📌 明日やりたいこと</label>
        <input id="diaryNext" class="input" placeholder="例：朝に洗濯／10分ストレッチ" style="width:100%">
      </div>
      <div>
        <label>📓 自由メモ</label>
        <textarea id="diaryFree" placeholder="なんでもどうぞ"></textarea>
      </div>
    </section>

    <!-- ③ 入眠儀式（番号なしのチェック欄） -->
    <section class="card" id="secSleep">
      <h2>③ 入眠儀式</h2>

      <div class="ritual">
        <label class="checkbox"><input type="checkbox" id="r_roll">フォームローラー</label>

        <label class="checkbox"><input type="checkbox" id="r_ear">耳まわし <span class="small">（前→後／上・中・下）</span></label>

        <label class="checkbox"><input type="checkbox" id="r_breath">肩すくめ呼吸 <span class="small">（吸=すくめる／吐=ストン）</span></label>
      </div>
    </section>

    <!-- ④ 音楽・保存（保存は再生ボタンの隣） -->
    <section class="card" id="secMusic">
      <h2>④ 音楽・操作</h2>
      <div id="musicRow">
        <a id="playMusicBtn" class="btn primary" href="https://music.youtube.com/playlist?list=PLUwMnSYvjfDQ9B8qPyifyyfonuhTY3C6y&si=6ssi1DGhphTAT_k7" target="_blank" rel="noopener">🎵 音楽を再生</a>
        <button id="saveBtn" class="btn primary">💾 保存</button>
        <span class="small">※ YouTube Music の睡眠プレイリストを開きます。</span>
      </div>
      <div id="goodnight" class="">😪 おやすみ</div>
    </section>

    <!-- 履歴 -->
    <section class="card">
      <div class="row" style="justify-content:space-between">
        <h2>履歴</h2>
        <button id="reloadBtn" class="btn">再読込</button>
      </div>
      <div id="history"></div>
    </section>

    <footer>
      保存先はブラウザ（localStorage）。同じURLならアップデートしても履歴は引き継がれます。
    </footer>
  </div>

<script>
(function(){
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const z2 = n => String(n).padStart(2,"0");
  const tz = "Asia/Tokyo";
  const wdJP = ["日","月","火","水","木","金","土"];
  const toKey = d => d.toLocaleDateString("ja-JP",{timeZone:tz});

  // Header date
  function renderHeaderDate(d){
    $("#mdM").textContent = z2(d.getMonth()+1);
    $("#mdD").textContent = z2(d.getDate());
    $("#mdY").textContent = String(d.getFullYear());
    $("#mdW").textContent = wdJP[d.getDay()] + "曜日";
  }

  const today = new Date();
  let currentKey = toKey(today);
  renderHeaderDate(today);

  // Nav: Calendar link = today
  (function(){ const iso = new Date().toISOString().slice(0,10); $("#openCal").href = `./Calendar.html?date=${iso}`; })();

  // Storage helpers
  const KEY = "evening_logs_v2";
  const loadAll = () => JSON.parse(localStorage.getItem(KEY)||"[]");
  const saveAll = arr => localStorage.setItem(KEY, JSON.stringify(arr));
  const loadLog = key => loadAll().find(x=>x.date===key) || null;
  const upsert = payload => {
    const rest = loadAll().filter(x=>x.date!==payload.date);
    saveAll([payload, ...rest].sort((a,b)=> (a.date<b.date?1:-1)));
  };

  // ---------- Mood/Condition chips ----------
  const moods = ["最高","良い","普通","いまいち","しんどい"];
  const conds = ["首・肩こり","頭痛","腹痛/お腹の張り","腰の張り/腰痛","自律神経の乱れ","胃腸弱め","むくみ","目の疲れ/ドライアイ","睡眠の質低下","冷え","喉の痛み","鼻水/鼻づまり","肌荒れ/かゆみ","花粉/アレルギー","だるさ/倦怠感","イライラ/不安","モチベ低下","PMS","生理"];

  const state = {
    habits: { bath:false, teeth:false, skin:false, hair:false, special:false, tomorrow:false },
    ritual: { roll:false, ear:false, breath:false },
    mood: "", condSel: [],
    wx: null, // {temp, wind, code, pressure}
    diaryGood: "", diaryNext: "", diaryFree: ""
  };

  function chip(el){ el.classList.add('chip'); return el; }
  function renderMood(){
    const root=$("#moodChips"); root.innerHTML="";
    moods.forEach(m=>{
      const b=chip(document.createElement('button')); b.textContent=m;
      if(state.mood===m) b.classList.add('on');
      b.addEventListener('click',()=>{ state.mood = (state.mood===m?"":m); renderMood(); autoSave(); });
      root.appendChild(b);
    });
  }
  function renderCond(){
    const root=$("#condChips"); root.innerHTML="";
    conds.forEach(c=>{
      const b=chip(document.createElement('button')); b.textContent=c;
      if(state.condSel.includes(c)) b.classList.add('on');
      b.addEventListener('click',()=>{
        const i=state.condSel.indexOf(c);
        if(i>-1) state.condSel.splice(i,1); else state.condSel.push(c);
        b.classList.toggle('on');
        autoSave();
      });
      root.appendChild(b);
    });
  }
  renderMood(); renderCond();

  // Wire checkboxes (habits + rituals)
  const bind = (sel, obj, key) => $(sel).addEventListener("change",()=>{ obj[key] = $(sel).checked; autoSave(); });
  bind("#h_bath", state.habits, "bath"); bind("#h_teeth", state.habits, "teeth"); bind("#h_skin", state.habits, "skin");
  bind("#h_hair", state.habits, "hair"); bind("#h_special", state.habits, "special"); bind("#h_tomorrow", state.habits, "tomorrow");
  bind("#r_roll", state.ritual, "roll"); bind("#r_ear", state.ritual, "ear"); bind("#r_breath", state.ritual, "breath");

  // Wire text fields
  $("#diaryGood").addEventListener("input", ()=>{ state.diaryGood=$("#diaryGood").value; autoSave(); });
  $("#diaryNext").addEventListener("input", ()=>{ state.diaryNext=$("#diaryNext").value; autoSave(); });
  $("#diaryFree").addEventListener("input", ()=>{ state.diaryFree=$("#diaryFree").value; autoSave(); });

  // Save/history
  function saveNow(){
    const payload = {
      date: currentKey,
      habits: state.habits, ritual: state.ritual,
      mood: state.mood, condSel: state.condSel,
      wx: state.wx,
      diaryGood: state.diaryGood, diaryNext: state.diaryNext, diaryFree: state.diaryFree,
      ts: Date.now()
    };
    upsert(payload); renderHistory();
  }
  let t=null; function autoSave(){ clearTimeout(t); t=setTimeout(saveNow, 250); }
  $("#saveBtn").addEventListener("click", ()=>{ saveNow(); alert("保存しました"); });

  function renderHistory(){
    const root = $("#history"); const logs = loadAll(); root.innerHTML="";
    if(!logs.length){ root.innerHTML = '<div class="small">まだ記録がありません</div>'; return; }
    logs.forEach(l=>{
      const box = document.createElement("div"); box.className="historyItem";
      const lines = [];
      lines.push(`<b>${l.date}</b>`);
      const h = l.habits||{}; const r=l.ritual||{};
      const htxt = Object.entries({お風呂:"bath",歯磨き:"teeth",スキンケア:"skin",ハンド/ヘア:"hair",スペシャルケア:"special",明日の準備:"tomorrow"})
        .filter(([k,v]) => h[v]).map(([k])=>k).join(" / ") || "—";
      const rtxt = Object.entries({フォームローラー:"roll","耳まわし":"ear","肩すくめ呼吸":"breath"})
        .filter(([k,v]) => r[v]).map(([k])=>k).join(" / ") || "—";
      const press = (l.wx && l.wx.pressure!=null) ? Math.round(l.wx.pressure)+"hPa" : "—";
      const wtemp = (l.wx && l.wx.temp!=null) ? Math.round(l.wx.temp)+"°C" : "—";
      lines.push(`習慣：${htxt}　入眠儀式：${rtxt}`);
      lines.push(`感情：${l.mood||"—"}　体調：${(l.condSel||[]).join("、")||"—"}　天気：${wtemp}・気圧：${press}`);
      if(l.diaryGood) lines.push(`<div class="small">良かった：${l.diaryGood.replace(/\n/g," / ")}</div>`);
      if(l.diaryNext) lines.push(`<div class="small">明日：${l.diaryNext}</div>`);
      if(l.diaryFree) lines.push(`<div class="small">メモ：${l.diaryFree.replace(/\n/g," / ")}</div>`);
      box.innerHTML = lines.join("<br>");
      root.appendChild(box);
    });
  }

  // Weather/pressure via Open-Meteo
  const wxIcon = $("#wxIcon"), wxTemp=$("#wxTemp");
  function ico(code){ if(code>=61&&code<=65) return "🌧️"; if(code===0||code===1) return "☀️"; if(code===2) return "🌤️"; if(code===3) return "☁️"; return "🌦️"; }
  function wxtxt(code){ const map={0:"快晴",1:"晴れ",2:"薄曇り",3:"曇り",45:"霧",48:"霧氷",51:"弱い霧雨",53:"霧雨",55:"強い霧雨",61:"弱い雨",63:"雨",65:"強い雨",71:"弱い雪",73:"雪",75:"大雪",95:"雷雨"}; return map[code]||"—"; }
  function renderWx(){ if(!state.wx){ wxIcon.textContent='⚠️'; wxTemp.textContent='位置情報/天気の取得に失敗'; return; }
    wxIcon.textContent = ico(state.wx.code);
    wxTemp.textContent = `${Math.round(state.wx.temp)}°C　${wxtxt(state.wx.code)}　気圧：${state.wx.pressure?Math.round(state.wx.pressure)+"hPa":"—"}`;
  }
  function fetchWx(lat, lon){
    const u=new URL('https://api.open-meteo.com/v1/forecast');
    u.searchParams.set('latitude', lat); u.searchParams.set('longitude', lon);
    u.searchParams.set('current_weather','true');
    u.searchParams.set('hourly','pressure_msl');
    u.searchParams.set('timezone', tz);
    fetch(u.toString()).then(r=>r.json()).then(data=>{
      const c=data.current_weather||{};
      const times=(data.hourly&&data.hourly.time)||[]; const idx=times.indexOf(c.time);
      const p = (idx>-1 && data.hourly.pressure_msl) ? data.hourly.pressure_msl[idx] : null;
      state.wx = { temp:c.temperature, wind:c.windspeed, code:c.weathercode, pressure:p };
      renderWx(); autoSave();
    }).catch(()=>{ renderWx(); });
  }
  if('geolocation' in navigator){
    navigator.geolocation.getCurrentPosition(
      pos=>fetchWx(pos.coords.latitude, pos.coords.longitude),
      ()=>renderWx(),
      {enableHighAccuracy:false, timeout:8000}
    );
  }else{ renderWx(); }

  // Goodnight (おまけ)
  $("#playMusicBtn").addEventListener("click", ()=>{ $("#goodnight").style.display="block"; });

  // Init (hydrate if saved)
  const saved = loadLog(currentKey);
  if(saved){
    state.habits = Object.assign(state.habits, saved.habits||{});
    state.ritual = Object.assign(state.ritual, saved.ritual||{});
    state.mood = saved.mood||"";
    state.condSel = saved.condSel||[];
    state.wx = saved.wx||null;
    state.diaryGood = saved.diaryGood||"";
    state.diaryNext = saved.diaryNext||"";
    state.diaryFree = saved.diaryFree||"";
  }
  // reflect UI
  ['#h_bath','#h_teeth','#h_skin','#h_hair','#h_special','#h_tomorrow'].forEach((sel,i)=>{
    const keys=['bath','teeth','skin','hair','special','tomorrow']; $(sel).checked = !!state.habits[keys[i]];
  });
  ['#r_roll','#r_ear','#r_breath'].forEach((sel,i)=>{
    const keys=['roll','ear','breath']; $(sel).checked = !!state.ritual[keys[i]];
  });
  renderMood(); renderCond(); renderWx();
  $("#diaryGood").value = state.diaryGood; $("#diaryNext").value = state.diaryNext; $("#diaryFree").value = state.diaryFree;

  // Reload button
  $("#reloadBtn").addEventListener("click", renderHistory);
  // initial history render
  renderHistory();
})();</script>
</body>
</html>
