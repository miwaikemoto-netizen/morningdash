<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Evening Dash</title>
<meta name="theme-color" content="#0b1220">
<style>
:root{
  --bg:#090f1c; --bg2:#0b1220;
  --fg:#e6edf7; --muted:#a7b4c8;
  --card:#0f172a; --border:rgba(255,255,255,.12);
  --accent:#60a5fa; --accent-press:#3b82f6;
  --radius:16px; --shadow:0 10px 30px rgba(0,0,0,.35);
}
*{box-sizing:border-box;-webkit-tap-highlight-color: transparent}
html,body{margin:0;height:100%}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;background:linear-gradient(180deg,var(--bg),var(--bg2));color:var(--fg)}
.container{max-width:900px;margin:0 auto;padding:16px 16px 92px}
h1{margin:4px 0 10px;font-size:34px;line-height:1.2;font-weight:800}
h2{margin:0 0 10px;font-size:20px}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35);padding:16px;margin:12px 0}
.row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.btn{appearance:none;border:1px solid var(--border);border-radius:14px;padding:12px 16px;background:rgba(255,255,255,.04);cursor:pointer;color:var(--fg);text-decoration:none;font-size:16px}
.btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
.btn.primary:active{background:var(--accent-press)}
.input, select, textarea{border:1px solid var(--border);border-radius:12px;padding:12px 14px;background:rgba(255,255,255,.04);color:var(--fg);font-size:16px}
select[multiple]{min-height:132px}
textarea{width:100%;min-height:96px;resize:vertical}
.small{font-size:13px;color:var(--muted)}
.header{display:flex;justify-content:space-between;align-items:flex-end;gap:10px;flex-wrap:wrap;margin-bottom:6px}
.bigdate{display:flex;align-items:baseline;gap:6px}
.bigdate .md{font-weight:800;font-size:42px}
.bigdate .sep{font-size:30px;transform:translateY(-2px)}
.bigdate .y{font-weight:700;font-size:16px;color:var(--muted)}
.wday{font-weight:700}
#goodnight{display:none;font-size:40px;text-align:center;margin-top:12px}
footer{font-size:12px;color:var(--muted);margin-top:16px}
hr{border:none;border-top:1px solid var(--border);margin:12px 0}
.historyItem{padding:10px;border:1px dashed var(--border);border-radius:12px;margin-top:8px}
label.checkbox{display:flex;align-items:center;gap:10px;cursor:pointer;font-size:16px}
label.checkbox input{transform:scale(1.2)}
/* å¤©æ°—è¡¨ç¤ºå¤§ãã‚ */
.wxLine{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.wxIcon{font-size:30px;line-height:1}
#wxText{font-size:17px;font-weight:700}
#useGeo{margin-left:4px}
#musicRow{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <h1>ğŸŒ™ Evening Dash</h1>
        <div class="bigdate">
          <span class="md" id="mdM">--</span><span class="sep">/</span><span class="md" id="mdD">--</span>
          <span class="y" id="mdY">----</span>
          <span class="wday" id="mdW">---</span>
        </div>
      </div>
      <div class="row">
        <a href="./" class="btn">â˜€ï¸ æœã®è¨˜éŒ²ã¸</a>
        <a id="openCal" href="./Calendar.html" class="btn">ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</a>
      </div>
    </div>

    <!-- â‘  ç”Ÿæ´»ç¿’æ…£ãƒã‚§ãƒƒã‚¯ -->
    <section class="card" id="secHabits">
      <h2>â‘  ç”Ÿæ´»ç¿’æ…£ãƒã‚§ãƒƒã‚¯</h2>
      <div class="row">
        <label class="checkbox"><input type="checkbox" id="h_bath"> ãŠé¢¨å‘‚</label>
        <label class="checkbox"><input type="checkbox" id="h_teeth"> æ­¯ç£¨ã</label>
        <label class="checkbox"><input type="checkbox" id="h_skin"> ã‚¹ã‚­ãƒ³ã‚±ã‚¢</label>
        <label class="checkbox"><input type="checkbox" id="h_hair"> ãƒãƒ³ãƒ‰/ãƒ˜ã‚¢ã‚±ã‚¢</label>
        <label class="checkbox"><input type="checkbox" id="h_special"> ã‚¹ãƒšã‚·ãƒ£ãƒ«ã‚±ã‚¢</label>
        <label class="checkbox"><input type="checkbox" id="h_tomorrow"> æ˜æ—¥ã®æº–å‚™</label>
      </div>
    </section>

    <!-- â‘¡ æ—¥è¨˜ãƒ»è¨˜éŒ² -->
    <section class="card" id="secDiary">
      <h2>â‘¡ æ—¥è¨˜ãƒ»è¨˜éŒ²</h2>

      <!-- å¤©æ°—/æ°—åœ§ -->
      <div id="wxRow" class="wxLine">
        <div id="wxIcon" class="wxIcon">â³</div>
        <div id="wxText">å¤©æ°—ãƒ»æ°—åœ§ã‚’å–å¾—ä¸­â€¦</div>
        <button id="useGeo" class="btn">ğŸ“ ç¾åœ¨åœ°ã§æ›´æ–°</button>
      </div>

      <hr>

      <!-- æ„Ÿæƒ…ï¼ˆã‚»ãƒ¬ã‚¯ãƒˆï¼‰ -->
      <div class="row" style="align-items:center">
        <label for="moodSel" class="small">æ„Ÿæƒ…</label>
        <select id="moodSel" class="input">
          <option value="">ï¼ˆæœªé¸æŠï¼‰</option>
          <option>æœ€é«˜</option>
          <option>è‰¯ã„</option>
          <option>æ™®é€š</option>
          <option>ã„ã¾ã„ã¡</option>
          <option>ã—ã‚“ã©ã„</option>
        </select>
      </div>

      <!-- ä½“èª¿ï¼ˆãƒãƒ«ãƒã‚»ãƒ¬ã‚¯ãƒˆï¼‰ -->
      <div class="row" style="align-items:flex-start">
        <label for="condSel" class="small" style="padding-top:6px">ä½“èª¿ï¼ˆè¤‡æ•°å¯ï¼‰</label>
        <select id="condSel" class="input" multiple>
          <option>é¦–ãƒ»è‚©ã“ã‚Š</option><option>é ­ç—›</option><option>è…¹ç—›/ãŠè…¹ã®å¼µã‚Š</option><option>è…°ã®å¼µã‚Š/è…°ç—›</option>
          <option>è‡ªå¾‹ç¥çµŒã®ä¹±ã‚Œ</option><option>èƒƒè…¸å¼±ã‚</option><option>ã‚€ãã¿</option><option>ç›®ã®ç–²ã‚Œ/ãƒ‰ãƒ©ã‚¤ã‚¢ã‚¤</option>
          <option>ç¡çœ ã®è³ªä½ä¸‹</option><option>å†·ãˆ</option><option>å–‰ã®ç—›ã¿</option><option>é¼»æ°´/é¼»ã¥ã¾ã‚Š</option>
          <option>è‚Œè’ã‚Œ/ã‹ã‚†ã¿</option><option>èŠ±ç²‰/ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼</option><option>ã ã‚‹ã•/å€¦æ€ æ„Ÿ</option><option>ã‚¤ãƒ©ã‚¤ãƒ©/ä¸å®‰</option>
          <option>ãƒ¢ãƒãƒ™ä½ä¸‹</option><option>PMS</option><option>ç”Ÿç†</option>
        </select>
      </div>

      <hr>

      <div>
        <label>ğŸ“Œ å‡ºæ¥ãŸã“ã¨ãƒ»è‰¯ã‹ã£ãŸã“ã¨</label>
        <textarea id="diaryGood" placeholder="ä¾‹ï¼šæœã«æ•£æ­©ï¼ã‚¬ãƒ¼ãƒ‡ãƒ‹ãƒ³ã‚°30åˆ†ï¼é¦–ã®å¼µã‚ŠãŒè»½ã‹ã£ãŸ ãªã©"></textarea>
      </div>
      <div>
        <label>ğŸ“Œ æ˜æ—¥ã‚„ã‚ŠãŸã„ã“ã¨</label>
        <input id="diaryNext" class="input" placeholder="ä¾‹ï¼šæœã«æ´—æ¿¯ï¼10åˆ†ã‚¹ãƒˆãƒ¬ãƒƒãƒ" style="width:100%">
      </div>
      <div>
        <label>ğŸ““ è‡ªç”±ãƒ¡ãƒ¢</label>
        <textarea id="diaryFree" placeholder="ãªã‚“ã§ã‚‚ã©ã†ã"></textarea>
      </div>
    </section>

    <!-- â‘¢ å…¥çœ å„€å¼ -->
    <section class="card" id="secSleep">
      <h2>â‘¢ å…¥çœ å„€å¼</h2>
      <div class="row" style="align-items:flex-start">
        <label class="checkbox"><input type="checkbox" id="r_rollerBreath">ãƒ­ãƒ¼ãƒ©ãƒ¼å‘¼å¸ <span class="small">ï¼ˆè‚©ç”²éª¨ã®ä¸‹ã«ç½®ã 2ã€œ3åˆ†ï¼‰</span></label>
        <label class="checkbox"><input type="checkbox" id="r_child">ãƒãƒ£ã‚¤ãƒ«ãƒ‰ãƒãƒ¼ã‚º <span class="small">ï¼ˆ1ã€œ2åˆ†ï¼‰</span></label>
        <label class="checkbox"><input type="checkbox" id="r_ear">è€³ã¾ã‚ã— <span class="small">ï¼ˆå‰â†’å¾Œï¼ä¸Šãƒ»ä¸­ãƒ»ä¸‹ï¼‰</span></label>
        <label class="checkbox"><input type="checkbox" id="r_breath">è‚©ã™ãã‚å‘¼å¸ <span class="small">ï¼ˆå¸=ã™ãã‚ã‚‹ï¼å=ã‚¹ãƒˆãƒ³ï¼‰</span></label>
      </div>
    </section>

    <!-- â‘£ æ“ä½œ -->
    <section class="card" id="secMusic">
      <h2>â‘£ æ“ä½œ</h2>
      <div id="musicRow">
        <button id="saveBtn" class="btn primary">ğŸ’¾ ä¿å­˜</button>
        <a id="playMusicBtn" class="btn" href="https://music.youtube.com/playlist?list=PLUwMnSYvjfDQ9B8qPyifyyfonuhTY3C6y" target="_blank" rel="noopener">ğŸµ éŸ³æ¥½ã‚’å†ç”Ÿ</a>
      </div>
      <div id="goodnight" class="">ğŸ˜ª ãŠã‚„ã™ã¿</div>
    </section>

    <!-- å±¥æ­´ -->
    <section class="card">
      <div class="row" style="justify-content:space-between">
        <h2>å±¥æ­´</h2>
        <button id="reloadBtn" class="btn">å†èª­è¾¼</button>
      </div>
      <div id="history"></div>
    </section>

    <footer>
      ä¿å­˜å…ˆã¯ãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆlocalStorageï¼‰ã€‚åŒã˜URLãªã‚‰ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã—ã¦ã‚‚å±¥æ­´ã¯å¼•ãç¶™ãŒã‚Œã¾ã™ã€‚
    </footer>
  </div>

<script>
(function(){
  function z2(n){ n = Number(n)||0; return (n<10?"0":"")+n; }
  function $(s){ return document.querySelector(s); }

  document.addEventListener("DOMContentLoaded", function(){
    // æ—¥ä»˜ãƒ»ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
    var d=new Date();
    $("#mdM").textContent = z2(d.getMonth()+1);
    $("#mdD").textContent = z2(d.getDate());
    $("#mdY").textContent = d.getFullYear();
    $("#mdW").textContent = ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"][d.getDay()] + "æ›œæ—¥";
    $("#openCal").href = "./Calendar.html?date=" + d.toISOString().slice(0,10);

    // Storageï¼ˆå¤œã ã‘ç‹¬ç«‹ï¼‰
    var KEY="evening_logs_select_v1";
    function loadAll(){ try{ var v=localStorage.getItem(KEY); return v?JSON.parse(v):[]; }catch(e){ return []; } }
    function saveAll(arr){ try{ localStorage.setItem(KEY, JSON.stringify(arr)); }catch(e){} }
    function upsert(payload){
      var list = loadAll(); var i=-1;
      for(var k=0;k<list.length;k++){ if(list[k].date===payload.date){ i=k; break; } }
      if(i>-1){ list[i]=payload; } else { list.unshift(payload); }
      list.sort(function(a,b){ return a.date<b.date?1:-1; });
      saveAll(list);
    }
    function toKey(dt){ return dt.toLocaleDateString("ja-JP",{timeZone:"Asia/Tokyo"}); }

    // State
    var state = {
      habits:{bath:false,teeth:false,skin:false,hair:false,special:false,tomorrow:false},
      ritual:{rollerBreath:false,child:false,ear:false,breath:false},
      mood:"",
      condSel:[],
      wx:null,
      diaryGood:"", diaryNext:"", diaryFree:""
    };

    // Bind selects
    var moodSel=$("#moodSel");
    var condSel=$("#condSel");
    if(moodSel){ moodSel.addEventListener("change", function(){ state.mood = moodSel.value; autoSave(); }); }
    if(condSel){ condSel.addEventListener("change", function(){
      state.condSel = []; for(var i=0;i<condSel.options.length;i++){ var op=condSel.options[i]; if(op.selected) state.condSel.push(op.value); } autoSave();
    }); }

    // Checkbox binds
    function bind(sel, obj, key){ var el=$(sel); if(!el) return; el.addEventListener("change", function(){ obj[key]=el.checked; autoSave(); }); }
    var hb=["bath","teeth","skin","hair","special","tomorrow"];
    var hs=["#h_bath","#h_teeth","#h_skin","#h_hair","#h_special","#h_tomorrow"];
    for(var i=0;i<hb.length;i++) bind(hs[i], state.habits, hb[i]);
    var rb=["rollerBreath","child","ear","breath"];
    var rs=["#r_rollerBreath","#r_child","#r_ear","#r_breath"];
    for(var i=0;i<rb.length;i++) bind(rs[i], state.ritual, rb[i]);

    // Diary
    ["Good","Next","Free"].forEach(function(k){
      var el=$("#diary"+k);
      if(el) el.addEventListener("input", function(){ state["diary"+k] = el.value; autoSave(); });
    });

    // Save & history
    function saveNow(){
      var payload = {
        date: toKey(new Date()),
        habits: state.habits, ritual: state.ritual,
        mood: state.mood, condSel: state.condSel.slice(0),
        wx: state.wx,
        diaryGood: state.diaryGood, diaryNext: state.diaryNext, diaryFree: state.diaryFree,
        ts: Date.now()
      };
      upsert(payload); renderHistory();
    }
    var t=null; function autoSave(){ if(t) clearTimeout(t); t=setTimeout(saveNow, 200); }
    var saveBtn=$("#saveBtn"); if(saveBtn) saveBtn.addEventListener("click", function(){ saveNow(); alert("ä¿å­˜ã—ã¾ã—ãŸ"); });

    function renderHistory(){
      var root=$("#history"); if(!root) return;
      var logs = loadAll(); root.innerHTML="";
      if(!(logs && logs.length)){ root.innerHTML='<div class="small">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>'; return; }
      for(var i=0;i<logs.length;i++){
        var l=logs[i];
        var box=document.createElement("div"); box.className="historyItem";
        var h=l.habits||{}, r=l.ritual||{};
        function on(o,k){ return o && o[k]; }
        var htxt = (on(h,"bath")?"ãŠé¢¨å‘‚ / ":"") + (on(h,"teeth")?"æ­¯ç£¨ã / ":"") + (on(h,"skin")?"ã‚¹ã‚­ãƒ³ã‚±ã‚¢ / ":"") + (on(h,"hair")?"ãƒãƒ³ãƒ‰/ãƒ˜ã‚¢ / ":"") + (on(h,"special")?"ã‚¹ãƒšã‚·ãƒ£ãƒ« / ":"") + (on(h,"tomorrow")?"æ˜æ—¥æº–å‚™":"");
        if(htxt.replace(/\s|\/|ã€€/g,"")==="") htxt="â€”";
        var rtxt = (on(r,"rollerBreath")?"ãƒ­ãƒ¼ãƒ©ãƒ¼å‘¼å¸ / ":"") + (on(r,"child")?"ãƒãƒ£ã‚¤ãƒ«ãƒ‰ãƒãƒ¼ã‚º / ":"") + (on(r,"ear")?"è€³ã¾ã‚ã— / ":"") + (on(r,"breath")?"è‚©ã™ãã‚å‘¼å¸":"");
        if(rtxt.replace(/\s|\/|ã€€/g,"")==="") rtxt="â€”";
        var press = (l.wx && l.wx.pressure!=null) ? Math.round(l.wx.pressure)+"hPa" : "â€”";
        var wtemp = (l.wx && l.wx.temp!=null) ? Math.round(l.wx.temp)+"Â°C" : "â€”";
        var html = "<b>"+l.date+"</b><br>"+
          "ç¿’æ…£ï¼š"+htxt+"ã€€å…¥çœ å„€å¼ï¼š"+rtxt+"<br>"+
          "æ„Ÿæƒ…ï¼š"+(l.mood||"â€”")+"ã€€ä½“èª¿ï¼š"+((l.condSel||[]).join("ã€")||"â€”")+"ã€€å¤©æ°—ï¼š"+wtemp+"ãƒ»æ°—åœ§ï¼š"+press;
        if(l.diaryGood) html += "<br><div class='small'>è‰¯ã‹ã£ãŸï¼š"+l.diaryGood.replace(/\n/g," / ")+"</div>";
        if(l.diaryNext) html += "<br><div class='small'>æ˜æ—¥ï¼š"+l.diaryNext+"</div>";
        if(l.diaryFree) html += "<br><div class='small'>ãƒ¡ãƒ¢ï¼š"+l.diaryFree.replace(/\n/g," / ")+"</div>";
        box.innerHTML = html;
        root.appendChild(box);
      }
    }

    // Hydrate today's saved
    (function hydrate(){
      var logs = loadAll(); var key = toKey(new Date()); var saved=null;
      for(var i=0;i<logs.length;i++){ if(logs[i].date===key){ saved=logs[i]; break; } }
      if(saved){
        var k;
        for(k in saved.habits){ if(saved.habits.hasOwnProperty(k)) state.habits[k]=!!saved.habits[k]; }
        for(k in saved.ritual){ if(saved.ritual.hasOwnProperty(k)) state.ritual[k]=!!saved.ritual[k]; }
        state.mood = saved.mood || "";
        state.condSel = saved.condSel || [];
        state.wx = saved.wx || null;
        state.diaryGood = saved.diaryGood || "";
        state.diaryNext = saved.diaryNext || "";
        state.diaryFree = saved.diaryFree || "";
        ["#h_bath","#h_teeth","#h_skin","#h_hair","#h_special","#h_tomorrow"].forEach(function(q){
          var el=$(q); if(el){ var id=q.split("_")[1]; el.checked = !!state.habits[id]; }
        });
        var mapR={"#r_rollerBreath":"rollerBreath","#r_child":"child","#r_ear":"ear","#r_breath":"breath"};
        for(var sel in mapR){ var el=$(sel); if(el) el.checked = !!state.ritual[mapR[sel]]; }
        var moodSel=$("#moodSel"); if(moodSel){ moodSel.value = state.mood || ""; }
        var condSel=$("#condSel"); if(condSel){
          for(var i=0;i<condSel.options.length;i++){
            condSel.options[i].selected = state.condSel.indexOf(condSel.options[i].value)>-1;
          }
        }
      }
      renderHistory();
    })();

    // å¤©æ°—ï¼ˆauto + manualï¼‰
    var TOKYO={lat:35.681236, lon:139.767125};
    function wxIcon(code){ if(code>=61&&code<=65) return "ğŸŒ§ï¸"; if(code===0||code===1) return "â˜€ï¸"; if(code===2) return "ğŸŒ¤ï¸"; if(code===3) return "â˜ï¸"; return "ğŸŒ¦ï¸"; }
    function wxText(code){ var map={0:"å¿«æ™´",1:"æ™´ã‚Œ",2:"è–„æ›‡ã‚Š",3:"æ›‡ã‚Š",45:"éœ§",48:"éœ§æ°·",51:"å¼±ã„éœ§é›¨",53:"éœ§é›¨",55:"å¼·ã„éœ§é›¨",61:"å¼±ã„é›¨",63:"é›¨",65:"å¼·ã„é›¨",71:"å¼±ã„é›ª",73:"é›ª",75:"å¤§é›ª",95:"é›·é›¨"}; return map[code]||"â€”"; }
    function renderWx(obj){
      var icon=$("#wxIcon"), text=$("#wxText");
      if(!obj){ icon.textContent="âš ï¸"; text.textContent="å¤©æ°—/æ°—åœ§ã®å–å¾—ã«å¤±æ•—"; return; }
      icon.textContent = wxIcon(obj.code);
      text.textContent = Math.round(obj.temp)+"Â°Cã€€"+wxText(obj.code)+"ã€€æ°—åœ§ï¼š"+(obj.pressure!=null?Math.round(obj.pressure)+"hPa":"â€”");
    }
    function fetchWx(lat, lon){
      var url="https://api.open-meteo.com/v1/forecast?latitude="+lat+"&longitude="+lon+"&current_weather=true&hourly=pressure_msl&timezone=Asia%2FTokyo";
      return fetch(url).then(function(r){ return r.json(); }).then(function(data){
        var c=data.current_weather||{};
        var times=(data.hourly&&data.hourly.time)||[];
        var pArr=(data.hourly&&data.hourly.pressure_msl)||[];
        var idx=-1; for(var i=0;i<times.length;i++){ if(times[i]===c.time){ idx=i; break; } }
        var p = (idx>-1 && pArr) ? pArr[idx] : null;
        var out={ temp:c.temperature, wind:c.windspeed, code:c.weathercode, pressure:p };
        state.wx = out; renderWx(out); autoSave(); return out;
      }).catch(function(){ renderWx(null); });
    }
    function autoWx(){
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(
          function(pos){ fetchWx(pos.coords.latitude, pos.coords.longitude); },
          function(){ fetchWx(TOKYO.lat, TOKYO.lon); },
          {enableHighAccuracy:true, timeout:6000, maximumAge:600000}
        );
      }else{ fetchWx(TOKYO.lat, TOKYO.lon); }
    }
    $("#useGeo").addEventListener("click", function(){ autoWx(); });
    autoWx();

  });
})();
</script>
</body>
</html>
