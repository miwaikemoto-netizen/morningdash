<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>MorningDash – v12 preview</title>
<meta name="theme-color" content="#0f172a">
<style>
:root{
  --bg:#f6f7fb;
  --fg:#0f172a;
  --muted:#64748b;
  --card:#ffffff;
  --line:#e5e7eb;
  --accent:#0ea5e9;
  --accent-press:#0284c7;
  --radius:16px;
  --shadow:0 8px 28px rgba(2,8,23,.06);
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--fg);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial}
.container{max-width:980px;margin:0 auto;padding:16px}

/* 背景（天気で差し替え） */
.bg-sunny   {background:linear-gradient(180deg,#e0f2fe,#f8fafc)}
.bg-cloudy  {background:linear-gradient(180deg,#e5e7eb,#f8fafc)}
.bg-rainy   {background:linear-gradient(180deg,#c7d2fe,#eef2ff)}
.bg-storm   {background:linear-gradient(180deg,#cbd5e1,#f1f5f9)}
.bg-snow    {background:linear-gradient(180deg,#e2e8f0,#ffffff)}

/* タイトル行 */
.header{display:flex;align-items:center;justify-content:space-between;margin:6px 0 10px}
.app{font-size:28px;font-weight:800;letter-spacing:.2px}
.date{font-weight:600;color:var(--muted)}

/* カード */
.card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;margin:14px 0;overflow:hidden}
.card h2{font-size:18px;margin:0 0 8px 0}
.row{display:flex;gap:12px;flex-wrap:wrap}

/* KPIカード */
.kpi{flex:1 1 220px;min-width:220px}
.kpi .big{font-size:36px;font-weight:800;line-height:1.1}
.kpi .sub{color:var(--muted);margin-top:4px}

/* 天気カード */
.weather{display:flex;align-items:center;gap:14px}
.wx-emoji{font-size:44px}
.wx-lines{line-height:1.4}
.mono{font-feature-settings:"tnum";font-variant-numeric:tabular-nums}

/* 入力 */
.input{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fff}
textarea.input{min-height:96px}

/* チップ（未選択読めるよう固定） */
.chip{border:1px solid var(--line);background:#fff;color:var(--fg);border-radius:999px;padding:6px 10px;font-size:13px}
.chip.active{background:var(--accent);border-color:var(--accent);color:#fff}

/* ミニカレンダー */
.cal-head,.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
.cal-head div{font-size:12px;text-align:center;color:var(--muted)}
.cal-day{border:1px solid var(--line);border-radius:10px;padding:6px 0;text-align:center;background:#fff;font-size:12px}
.cal-day.today{border-color:#0f172a;border-width:2px}
.cal-day .dot{display:block;margin:4px auto 0;width:7px;height:7px;border-radius:999px;background:#cbd5e1}

/* ボタン */
.btn{appearance:none;border:1px solid var(--line);background:#fff;border-radius:12px;padding:10px 14px;cursor:pointer}
.btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
.btn.small{font-size:12px;padding:6px 10px}

/* 角丸にじみ対策（iOS）＋textareaはみ出し対策 */
.card{overflow:hidden;-webkit-mask-image:-webkit-radial-gradient(white, black)}
textarea,input{max-width:100%}
.footer{font-size:12px;color:var(--muted);margin:24px 0}
</style>
</head>
<body class="bg-sunny">
<div class="container">
  <div class="header">
    <div class="app">MorningDash ☀️</div>
    <div class="date" id="dateLabel"></div>
  </div>

  <!-- 天気 -->
  <section class="card">
    <h2>天気（現在地）</h2>
    <div id="wx" class="weather">
      <div class="wx-emoji" id="wxEmoji">⛅️</div>
      <div class="wx-lines" id="wxLines">
        <div class="mono" id="wxTemp">—°C</div>
        <div class="muted" id="wxDesc">位置情報の許可後に表示</div>
      </div>
    </div>
    <div style="margin-top:8px">
      <button id="btnWx" class="btn small">再取得</button>
    </div>
  </section>

  <!-- 今日の数値（KPI） -->
  <section class="row">
    <div class="card kpi">
      <h2>睡眠</h2>
      <div class="big mono" id="kpiSleep">—h —m</div>
      <div class="sub">直近入力 / 今日</div>
    </div>
    <div class="card kpi">
      <h2>体重</h2>
      <div class="big mono" id="kpiWeight">— kg</div>
      <div class="sub">直近入力 / 今日</div>
    </div>
    <div class="card kpi">
      <h2>体脂肪</h2>
      <div class="big mono" id="kpiBodyFat">— %</div>
      <div class="sub">直近入力 / 今日</div>
    </div>
    <div class="card kpi">
      <h2>気分・元気</h2>
      <div class="big" id="kpiMood">—</div>
      <div class="sub" id="kpiEnergy">—</div>
    </div>
  </section>

  <!-- メモ -->
  <section class="card">
    <h2>自由メモ</h2>
    <textarea id="note" class="input" placeholder="今日のメモ…"></textarea>
    <div style="margin-top:8px"><button id="btnSave" class="btn primary">今日の記録を保存</button></div>
  </section>

  <!-- 履歴（抜粋） -->
  <section class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2>履歴（最近）</h2>
      <button id="btnReload" class="btn small">再読込</button>
    </div>
    <div id="history"></div>
  </section>

  <!-- ミニカレンダー：一番下 -->
  <section class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2>ミニカレンダー</h2>
      <a class="btn small" href="./index.html">詳細ページへ</a>
    </div>
    <div class="cal-head"><div>日</div><div>月</div><div>火</div><div>水</div><div>木</div><div>金</div><div>土</div></div>
    <div id="miniCal" class="cal-grid"></div>
  </section>

  <div class="footer">
    Tips: 共有 → ホーム画面に追加 でアプリ風に使えます。保存先はこの端末のブラウザ（localStorage）。
  </div>
</div>

<script>
(function(){
  // ===== util =====
  const $ = s => document.querySelector(s);
  const toKey = d => d.toLocaleDateString("ja-JP",{timeZone:"Asia/Tokyo"});
  const today = new Date(); const todayKey = toKey(today);
  const LOGS_KEY = "md_logs_v2";  // 既存キーをそのまま使用

  $("#dateLabel").textContent = todayKey;

  const loadAll = () => JSON.parse(localStorage.getItem(LOGS_KEY) || "[]");
  const load = (k) => loadAll().find(x => x.date === k) || null;
  const upsert = (p) => {
    const arr = loadAll().filter(x => x.date !== p.date);
    localStorage.setItem(LOGS_KEY, JSON.stringify([p, ...arr]));
  };

  // ===== KPI表示 =====
  function showKPI(){
    const log = load(todayKey);
    // 今日 or 最近の値を拾う（空なら最新のある日の値）
    const logs = loadAll();
    const latestWith = (key) => {
      const f = logs.find(x => (x[key]!==null && x[key]!==undefined && x[key]!=="" && x[key]!==0));
      return f ? f[key] : null;
    };

    // 睡眠
    const sleepMin = log ? (log.sleepMin || 0) : (latestWith("sleepMin")||0);
    const h = Math.floor(sleepMin/60), m = sleepMin%60;
    $("#kpiSleep").textContent = (sleepMin ? `${h}h ${m}m` : "—h —m");

    // 体重・体脂肪
    const weight = (log && log.weight!=null) ? log.weight : latestWith("weight");
    $("#kpiWeight").textContent = (weight!=null ? `${weight} kg` : "— kg");
    const bodyFat = (log && log.bodyFat!=null) ? log.bodyFat : latestWith("bodyFat");
    $("#kpiBodyFat").textContent = (bodyFat!=null ? `${bodyFat} %` : "— %");

    // 気分・元気
    $("#kpiMood").textContent = (log && log.mood) || "—";
    $("#kpiEnergy").textContent = (log && log.energy) || "—";

    // メモ
    $("#note").value = (log && log.note) || "";
  }

  // ===== 履歴 =====
  function renderHistory(){
    const root = $("#history"); root.innerHTML = "";
    const logs = loadAll();
    if (!logs.length){ root.innerHTML = '<div class="muted">まだ記録がありません</div>'; return; }
    logs.slice(0,5).forEach(l=>{
      const div=document.createElement("div"); div.className="card"; div.style.margin="10px 0";
      const sm = l.sleepMin||0;
      div.innerHTML = `
        <div class="muted">${l.date}</div>
        <div style="margin-top:6px">
          気分：${l.mood||"—"}　元気：${l.energy||"—"}　睡眠：${Math.floor(sm/60)}時間${sm%60}分
          ${l.weight!=null?`　体重：${l.weight}kg`:""} ${l.bodyFat!=null?`　体脂肪：${l.bodyFat}%`:""}
        </div>
        ${l.note?`<div style="margin-top:4px">${l.note}</div>`:""}
      `;
      root.appendChild(div);
    });
  }

  // ===== ミニカレンダー =====
  function renderMiniCal(){
    const root = $("#miniCal"); root.innerHTML = "";
    const d0 = new Date(today.getFullYear(), today.getMonth(), 1);
    const firstDow = d0.getDay(); const days = new Date(today.getFullYear(), today.getMonth()+1, 0).getDate();
    for(let i=0;i<firstDow;i++){ root.appendChild(document.createElement("div")); }
    const byDate = new Map(loadAll().map(l=>[l.date,l]));
    for(let d=1; d<=days; d++){
      const cell=document.createElement("div"); cell.className="cal-day";
      const date = new Date(today.getFullYear(), today.getMonth(), d);
      const key = toKey(date);
      if (key===todayKey) cell.classList.add("today");
      cell.innerHTML = `${d}<span class="dot"></span>`;
      const rec = byDate.get(key);
      if (rec){
        const dot = cell.querySelector(".dot");
        if ((rec.energy||"").includes("❤️‍🔥")) dot.style.background="#be123c";
        else if ((rec.energy||"").includes("❤️まず")) dot.style.background="#f43f5e";
        else if ((rec.energy||"").includes("❤️‍🩹")) dot.style.background="#fecaca";
      }
      root.appendChild(cell);
    }
  }

  // ===== 天気 =====
  function codeToEmoji(code){
    // open-meteo weathercode → emoji & bg class
    if ([0,1].includes(code)) return {e:"☀️",bg:"bg-sunny",desc:"快晴/晴れ"};
    if ([2,3,45,48].includes(code)) return {e:"⛅️",bg:"bg-cloudy",desc:"曇り/霧"};
    if ([51,53,55,61,63,65].includes(code)) return {e:"🌧️",bg:"bg-rainy",desc:"雨"};
    if ([95,96,99].includes(code)) return {e:"⛈️",bg:"bg-storm",desc:"雷雨"};
    if ([71,73,75,85,86].includes(code)) return {e:"🌨️",bg:"bg-snow",desc:"雪"};
    return {e:"⛅️",bg:"bg-cloudy",desc:"—"};
  }
  function setBg(bg){ document.body.className = bg; }
  function renderWeather(w){
    const m = codeToEmoji(w.code||3);
    $("#wxEmoji").textContent = m.e;
    $("#wxTemp").textContent = `${Math.round(w.temp)}°C`;
    $("#wxDesc").textContent = `${m.desc}　風:${Math.round(w.wind)}m/s`;
    setBg(m.bg);
  }
  function fetchWeather(){
    if (!("geolocation" in navigator)){ $("#wxDesc").textContent="位置情報非対応"; return; }
    $("#wxDesc").textContent="取得中…";
    navigator.geolocation.getCurrentPosition(pos=>{
      const {latitude, longitude} = pos.coords;
      const u = new URL("https://api.open-meteo.com/v1/forecast");
      u.searchParams.set("latitude", latitude);
      u.searchParams.set("longitude", longitude);
      u.searchParams.set("current_weather","true");
      u.searchParams.set("timezone","Asia/Tokyo");
      fetch(u.toString()).then(r=>r.json()).then(d=>{
        const c = d.current_weather||{};
        renderWeather({temp:c.temperature, wind:c.windspeed, code:c.weathercode});
      }).catch(()=>{$("#wxDesc").textContent="取得失敗";});
    }, ()=>{$("#wxDesc").textContent="位置情報未許可";},{timeout:8000});
  }
  $("#btnWx").addEventListener("click", fetchWeather);
  fetchWeather();

  // ===== 保存（今日のメモだけ簡易） =====
  $("#btnSave").addEventListener("click", ()=>{
    const log = load(todayKey) || {date:todayKey, mood:"", energy:"", symptoms:[], sleepMin:0, weight:null, bodyFat:null, note:"", weather:null, quickTasks:[{done:false,text:""},{done:false,text:""},{done:false,text:""}]};
    log.note = $("#note").value||"";
    log.ts = Date.now();
    upsert(log);
    renderHistory();
    alert("保存しました");
  });

  $("#btnReload").addEventListener("click", ()=>{ showKPI(); renderHistory(); renderMiniCal(); });

  // 初期表示
  showKPI();
  renderHistory();
  renderMiniCal();
})();
</script>
</body>
</html>
