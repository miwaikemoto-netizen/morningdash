<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>MorningDash â€“ v12 preview</title>
<meta name="theme-color" content="#0f172a">
<style>
:root{
  --bg:#f6f7fb;
  --fg:#0f172a;
  --muted:#64748b;
  --card:#ffffff;
  --line:#e5e7eb;
  --accent:#0ea5e9;
  --accent-press:#0284c7;
  --radius:16px;
  --shadow:0 8px 28px rgba(2,8,23,.06);
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--fg);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial}
.container{max-width:980px;margin:0 auto;padding:16px}

/* èƒŒæ™¯ï¼ˆå¤©æ°—ã§å·®ã—æ›¿ãˆï¼‰ */
.bg-sunny   {background:linear-gradient(180deg,#e0f2fe,#f8fafc)}
.bg-cloudy  {background:linear-gradient(180deg,#e5e7eb,#f8fafc)}
.bg-rainy   {background:linear-gradient(180deg,#c7d2fe,#eef2ff)}
.bg-storm   {background:linear-gradient(180deg,#cbd5e1,#f1f5f9)}
.bg-snow    {background:linear-gradient(180deg,#e2e8f0,#ffffff)}

/* ã‚¿ã‚¤ãƒˆãƒ«è¡Œ */
.header{display:flex;align-items:center;justify-content:space-between;margin:6px 0 10px}
.app{font-size:28px;font-weight:800;letter-spacing:.2px}
.date{font-weight:600;color:var(--muted)}

/* ã‚«ãƒ¼ãƒ‰ */
.card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;margin:14px 0;overflow:hidden}
.card h2{font-size:18px;margin:0 0 8px 0}
.row{display:flex;gap:12px;flex-wrap:wrap}

/* KPIã‚«ãƒ¼ãƒ‰ */
.kpi{flex:1 1 220px;min-width:220px}
.kpi .big{font-size:36px;font-weight:800;line-height:1.1}
.kpi .sub{color:var(--muted);margin-top:4px}

/* å¤©æ°—ã‚«ãƒ¼ãƒ‰ */
.weather{display:flex;align-items:center;gap:14px}
.wx-emoji{font-size:44px}
.wx-lines{line-height:1.4}
.mono{font-feature-settings:"tnum";font-variant-numeric:tabular-nums}

/* å…¥åŠ› */
.input{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fff}
textarea.input{min-height:96px}

/* ãƒãƒƒãƒ—ï¼ˆæœªé¸æŠèª­ã‚ã‚‹ã‚ˆã†å›ºå®šï¼‰ */
.chip{border:1px solid var(--line);background:#fff;color:var(--fg);border-radius:999px;padding:6px 10px;font-size:13px}
.chip.active{background:var(--accent);border-color:var(--accent);color:#fff}

/* ãƒŸãƒ‹ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */
.cal-head,.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
.cal-head div{font-size:12px;text-align:center;color:var(--muted)}
.cal-day{border:1px solid var(--line);border-radius:10px;padding:6px 0;text-align:center;background:#fff;font-size:12px}
.cal-day.today{border-color:#0f172a;border-width:2px}
.cal-day .dot{display:block;margin:4px auto 0;width:7px;height:7px;border-radius:999px;background:#cbd5e1}

/* ãƒœã‚¿ãƒ³ */
.btn{appearance:none;border:1px solid var(--line);background:#fff;border-radius:12px;padding:10px 14px;cursor:pointer}
.btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
.btn.small{font-size:12px;padding:6px 10px}

/* è§’ä¸¸ã«ã˜ã¿å¯¾ç­–ï¼ˆiOSï¼‰ï¼‹textareaã¯ã¿å‡ºã—å¯¾ç­– */
.card{overflow:hidden;-webkit-mask-image:-webkit-radial-gradient(white, black)}
textarea,input{max-width:100%}
.footer{font-size:12px;color:var(--muted);margin:24px 0}
</style>
</head>
<body class="bg-sunny">
<div class="container">
  <div class="header">
    <div class="app">MorningDash â˜€ï¸</div>
    <div class="date" id="dateLabel"></div>
  </div>

  <!-- å¤©æ°— -->
  <section class="card">
    <h2>å¤©æ°—ï¼ˆç¾åœ¨åœ°ï¼‰</h2>
    <div id="wx" class="weather">
      <div class="wx-emoji" id="wxEmoji">â›…ï¸</div>
      <div class="wx-lines" id="wxLines">
        <div class="mono" id="wxTemp">â€”Â°C</div>
        <div class="muted" id="wxDesc">ä½ç½®æƒ…å ±ã®è¨±å¯å¾Œã«è¡¨ç¤º</div>
      </div>
    </div>
    <div style="margin-top:8px">
      <button id="btnWx" class="btn small">å†å–å¾—</button>
    </div>
  </section>

  <!-- ä»Šæ—¥ã®æ•°å€¤ï¼ˆKPIï¼‰ -->
  <section class="row">
    <div class="card kpi">
      <h2>ç¡çœ </h2>
      <div class="big mono" id="kpiSleep">â€”h â€”m</div>
      <div class="sub">ç›´è¿‘å…¥åŠ› / ä»Šæ—¥</div>
    </div>
    <div class="card kpi">
      <h2>ä½“é‡</h2>
      <div class="big mono" id="kpiWeight">â€” kg</div>
      <div class="sub">ç›´è¿‘å…¥åŠ› / ä»Šæ—¥</div>
    </div>
    <div class="card kpi">
      <h2>ä½“è„‚è‚ª</h2>
      <div class="big mono" id="kpiBodyFat">â€” %</div>
      <div class="sub">ç›´è¿‘å…¥åŠ› / ä»Šæ—¥</div>
    </div>
    <div class="card kpi">
      <h2>æ°—åˆ†ãƒ»å…ƒæ°—</h2>
      <div class="big" id="kpiMood">â€”</div>
      <div class="sub" id="kpiEnergy">â€”</div>
    </div>
  </section>

  <!-- ãƒ¡ãƒ¢ -->
  <section class="card">
    <h2>è‡ªç”±ãƒ¡ãƒ¢</h2>
    <textarea id="note" class="input" placeholder="ä»Šæ—¥ã®ãƒ¡ãƒ¢â€¦"></textarea>
    <div style="margin-top:8px"><button id="btnSave" class="btn primary">ä»Šæ—¥ã®è¨˜éŒ²ã‚’ä¿å­˜</button></div>
  </section>

  <!-- å±¥æ­´ï¼ˆæŠœç²‹ï¼‰ -->
  <section class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2>å±¥æ­´ï¼ˆæœ€è¿‘ï¼‰</h2>
      <button id="btnReload" class="btn small">å†èª­è¾¼</button>
    </div>
    <div id="history"></div>
  </section>

  <!-- ãƒŸãƒ‹ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼šä¸€ç•ªä¸‹ -->
  <section class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2>ãƒŸãƒ‹ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h2>
      <a class="btn small" href="./index.html">è©³ç´°ãƒšãƒ¼ã‚¸ã¸</a>
    </div>
    <div class="cal-head"><div>æ—¥</div><div>æœˆ</div><div>ç«</div><div>æ°´</div><div>æœ¨</div><div>é‡‘</div><div>åœŸ</div></div>
    <div id="miniCal" class="cal-grid"></div>
  </section>

  <div class="footer">
    Tips: å…±æœ‰ â†’ ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ  ã§ã‚¢ãƒ—ãƒªé¢¨ã«ä½¿ãˆã¾ã™ã€‚ä¿å­˜å…ˆã¯ã“ã®ç«¯æœ«ã®ãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆlocalStorageï¼‰ã€‚
  </div>
</div>

<script>
(function(){
  // ===== util =====
  const $ = s => document.querySelector(s);
  const toKey = d => d.toLocaleDateString("ja-JP",{timeZone:"Asia/Tokyo"});
  const today = new Date(); const todayKey = toKey(today);
  const LOGS_KEY = "md_logs_v2";  // æ—¢å­˜ã‚­ãƒ¼ã‚’ãã®ã¾ã¾ä½¿ç”¨

  $("#dateLabel").textContent = todayKey;

  const loadAll = () => JSON.parse(localStorage.getItem(LOGS_KEY) || "[]");
  const load = (k) => loadAll().find(x => x.date === k) || null;
  const upsert = (p) => {
    const arr = loadAll().filter(x => x.date !== p.date);
    localStorage.setItem(LOGS_KEY, JSON.stringify([p, ...arr]));
  };

  // ===== KPIè¡¨ç¤º =====
  function showKPI(){
    const log = load(todayKey);
    // ä»Šæ—¥ or æœ€è¿‘ã®å€¤ã‚’æ‹¾ã†ï¼ˆç©ºãªã‚‰æœ€æ–°ã®ã‚ã‚‹æ—¥ã®å€¤ï¼‰
    const logs = loadAll();
    const latestWith = (key) => {
      const f = logs.find(x => (x[key]!==null && x[key]!==undefined && x[key]!=="" && x[key]!==0));
      return f ? f[key] : null;
    };

    // ç¡çœ 
    const sleepMin = log ? (log.sleepMin || 0) : (latestWith("sleepMin")||0);
    const h = Math.floor(sleepMin/60), m = sleepMin%60;
    $("#kpiSleep").textContent = (sleepMin ? `${h}h ${m}m` : "â€”h â€”m");

    // ä½“é‡ãƒ»ä½“è„‚è‚ª
    const weight = (log && log.weight!=null) ? log.weight : latestWith("weight");
    $("#kpiWeight").textContent = (weight!=null ? `${weight} kg` : "â€” kg");
    const bodyFat = (log && log.bodyFat!=null) ? log.bodyFat : latestWith("bodyFat");
    $("#kpiBodyFat").textContent = (bodyFat!=null ? `${bodyFat} %` : "â€” %");

    // æ°—åˆ†ãƒ»å…ƒæ°—
    $("#kpiMood").textContent = (log && log.mood) || "â€”";
    $("#kpiEnergy").textContent = (log && log.energy) || "â€”";

    // ãƒ¡ãƒ¢
    $("#note").value = (log && log.note) || "";
  }

  // ===== å±¥æ­´ =====
  function renderHistory(){
    const root = $("#history"); root.innerHTML = "";
    const logs = loadAll();
    if (!logs.length){ root.innerHTML = '<div class="muted">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>'; return; }
    logs.slice(0,5).forEach(l=>{
      const div=document.createElement("div"); div.className="card"; div.style.margin="10px 0";
      const sm = l.sleepMin||0;
      div.innerHTML = `
        <div class="muted">${l.date}</div>
        <div style="margin-top:6px">
          æ°—åˆ†ï¼š${l.mood||"â€”"}ã€€å…ƒæ°—ï¼š${l.energy||"â€”"}ã€€ç¡çœ ï¼š${Math.floor(sm/60)}æ™‚é–“${sm%60}åˆ†
          ${l.weight!=null?`ã€€ä½“é‡ï¼š${l.weight}kg`:""} ${l.bodyFat!=null?`ã€€ä½“è„‚è‚ªï¼š${l.bodyFat}%`:""}
        </div>
        ${l.note?`<div style="margin-top:4px">${l.note}</div>`:""}
      `;
      root.appendChild(div);
    });
  }

  // ===== ãƒŸãƒ‹ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ =====
  function renderMiniCal(){
    const root = $("#miniCal"); root.innerHTML = "";
    const d0 = new Date(today.getFullYear(), today.getMonth(), 1);
    const firstDow = d0.getDay(); const days = new Date(today.getFullYear(), today.getMonth()+1, 0).getDate();
    for(let i=0;i<firstDow;i++){ root.appendChild(document.createElement("div")); }
    const byDate = new Map(loadAll().map(l=>[l.date,l]));
    for(let d=1; d<=days; d++){
      const cell=document.createElement("div"); cell.className="cal-day";
      const date = new Date(today.getFullYear(), today.getMonth(), d);
      const key = toKey(date);
      if (key===todayKey) cell.classList.add("today");
      cell.innerHTML = `${d}<span class="dot"></span>`;
      const rec = byDate.get(key);
      if (rec){
        const dot = cell.querySelector(".dot");
        if ((rec.energy||"").includes("â¤ï¸â€ğŸ”¥")) dot.style.background="#be123c";
        else if ((rec.energy||"").includes("â¤ï¸ã¾ãš")) dot.style.background="#f43f5e";
        else if ((rec.energy||"").includes("â¤ï¸â€ğŸ©¹")) dot.style.background="#fecaca";
      }
      root.appendChild(cell);
    }
  }

  // ===== å¤©æ°— =====
  function codeToEmoji(code){
    // open-meteo weathercode â†’ emoji & bg class
    if ([0,1].includes(code)) return {e:"â˜€ï¸",bg:"bg-sunny",desc:"å¿«æ™´/æ™´ã‚Œ"};
    if ([2,3,45,48].includes(code)) return {e:"â›…ï¸",bg:"bg-cloudy",desc:"æ›‡ã‚Š/éœ§"};
    if ([51,53,55,61,63,65].includes(code)) return {e:"ğŸŒ§ï¸",bg:"bg-rainy",desc:"é›¨"};
    if ([95,96,99].includes(code)) return {e:"â›ˆï¸",bg:"bg-storm",desc:"é›·é›¨"};
    if ([71,73,75,85,86].includes(code)) return {e:"ğŸŒ¨ï¸",bg:"bg-snow",desc:"é›ª"};
    return {e:"â›…ï¸",bg:"bg-cloudy",desc:"â€”"};
  }
  function setBg(bg){ document.body.className = bg; }
  function renderWeather(w){
    const m = codeToEmoji(w.code||3);
    $("#wxEmoji").textContent = m.e;
    $("#wxTemp").textContent = `${Math.round(w.temp)}Â°C`;
    $("#wxDesc").textContent = `${m.desc}ã€€é¢¨:${Math.round(w.wind)}m/s`;
    setBg(m.bg);
  }
  function fetchWeather(){
    if (!("geolocation" in navigator)){ $("#wxDesc").textContent="ä½ç½®æƒ…å ±éå¯¾å¿œ"; return; }
    $("#wxDesc").textContent="å–å¾—ä¸­â€¦";
    navigator.geolocation.getCurrentPosition(pos=>{
      const {latitude, longitude} = pos.coords;
      const u = new URL("https://api.open-meteo.com/v1/forecast");
      u.searchParams.set("latitude", latitude);
      u.searchParams.set("longitude", longitude);
      u.searchParams.set("current_weather","true");
      u.searchParams.set("timezone","Asia/Tokyo");
      fetch(u.toString()).then(r=>r.json()).then(d=>{
        const c = d.current_weather||{};
        renderWeather({temp:c.temperature, wind:c.windspeed, code:c.weathercode});
      }).catch(()=>{$("#wxDesc").textContent="å–å¾—å¤±æ•—";});
    }, ()=>{$("#wxDesc").textContent="ä½ç½®æƒ…å ±æœªè¨±å¯";},{timeout:8000});
  }
  $("#btnWx").addEventListener("click", fetchWeather);
  fetchWeather();

  // ===== ä¿å­˜ï¼ˆä»Šæ—¥ã®ãƒ¡ãƒ¢ã ã‘ç°¡æ˜“ï¼‰ =====
  $("#btnSave").addEventListener("click", ()=>{
    const log = load(todayKey) || {date:todayKey, mood:"", energy:"", symptoms:[], sleepMin:0, weight:null, bodyFat:null, note:"", weather:null, quickTasks:[{done:false,text:""},{done:false,text:""},{done:false,text:""}]};
    log.note = $("#note").value||"";
    log.ts = Date.now();
    upsert(log);
    renderHistory();
    alert("ä¿å­˜ã—ã¾ã—ãŸ");
  });

  $("#btnReload").addEventListener("click", ()=>{ showKPI(); renderHistory(); renderMiniCal(); });

  // åˆæœŸè¡¨ç¤º
  showKPI();
  renderHistory();
  renderMiniCal();
})();
</script>
</body>
</html>
