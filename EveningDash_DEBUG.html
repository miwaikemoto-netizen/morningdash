<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Evening Dash (Debug)</title>
<meta name="theme-color" content="#0b1220">
<style>
:root{
  --bg:#090f1c; --bg2:#0b1220;
  --fg:#e6edf7; --muted:#a7b4c8;
  --card:#0f172a; --border:rgba(255,255,255,.12);
  --accent:#60a5fa; --accent-press:#3b82f6;
  --radius:16px; --shadow:0 10px 30px rgba(0,0,0,.35);
  --chip:#1e293b; --chip-on:#1d4ed8;
}
*{box-sizing:border-box;-webkit-tap-highlight-color: transparent}
html,body{margin:0;height:100%}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;background:linear-gradient(180deg,var(--bg),var(--bg2));color:var(--fg)}
.container{max-width:900px;margin:0 auto;padding:16px 16px 92px}
h1{margin:4px 0 10px;font-size:34px;line-height:1.2;font-weight:800}
h2{margin:0 0 10px;font-size:20px}
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;margin:12px 0}
.row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.btn{appearance:none;border:1px solid var(--border);border-radius:14px;padding:12px 16px;background:rgba(255,255,255,.04);cursor:pointer;color:var(--fg);text-decoration:none;font-size:16px}
.small{font-size:13px;color:var(--muted)}
.header{display:flex;justify-content:space-between;align-items:flex-end;gap:10px;flex-wrap:wrap;margin-bottom:6px}
.bigdate{display:flex;align-items:baseline;gap:6px}
.bigdate .md{font-weight:800;font-size:42px}
.bigdate .sep{font-size:30px;transform:translateY(-2px)}
.bigdate .y{font-weight:700;font-size:16px;color:var(--muted)}
.wday{font-weight:700}
hr{border:none;border-top:1px solid var(--border);margin:12px 0}
.chips{display:flex;flex-wrap:wrap;gap:10px}
.chip{padding:12px 16px;border-radius:999px;background:var(--chip);border:1px solid var(--border);cursor:pointer;font-size:16px}
.chip.on{background:var(--chip-on);border-color:transparent}
.wxIcon{font-size:24px}
.wxLine{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
#log{white-space:pre-wrap;background:#0b1220;border:1px solid rgba(255,255,255,.2);border-radius:12px;padding:10px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-size:12px;max-height:240px;overflow:auto}
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <h1>ğŸŒ™ Evening Dashï¼ˆãƒ‡ãƒãƒƒã‚°ï¼‰</h1>
        <div class="bigdate">
          <span class="md" id="mdM">--</span><span class="sep">/</span><span class="md" id="mdD">--</span>
          <span class="y" id="mdY">----</span>
          <span class="wday" id="mdW">---</span>
        </div>
      </div>
      <div class="row">
        <a href="./" class="btn">â˜€ï¸ æœã®è¨˜éŒ²ã¸</a>
        <a id="openCal" href="./Calendar.html" class="btn">ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</a>
      </div>
    </div>

    <!-- å¤©æ°— -->
    <section class="card">
      <h2>å¤©æ°—ãƒ»æ°—åœ§</h2>
      <div class="wxLine">
        <div id="wxIcon" class="wxIcon">â³</div>
        <div id="wxText" class="small">å–å¾—ä¸­â€¦</div>
        <button id="useGeo" class="btn">ğŸ“ ç¾åœ¨åœ°</button>
        <button id="useTokyo" class="btn">ğŸ—¼ æ±äº¬ã§ãƒ†ã‚¹ãƒˆ</button>
      </div>
    </section>

    <!-- æ„Ÿæƒ…ï¼ä½“èª¿ -->
    <section class="card">
      <h2>æ„Ÿæƒ…ãƒ»ä½“èª¿</h2>
      <div>æ„Ÿæƒ…è¨˜éŒ²</div>
      <div id="moodChips" class="chips" style="margin-bottom:8px">
        <button class="chip">æœ€é«˜</button><button class="chip">è‰¯ã„</button><button class="chip">æ™®é€š</button><button class="chip">ã„ã¾ã„ã¡</button><button class="chip">ã—ã‚“ã©ã„</button>
      </div>
      <div>ä½“èª¿è¨˜éŒ²ï¼ˆè¤‡æ•°å¯ï¼‰</div>
      <div id="condChips" class="chips">
        <button class="chip">é¦–ãƒ»è‚©ã“ã‚Š</button><button class="chip">é ­ç—›</button><button class="chip">è…¹ç—›/ãŠè…¹ã®å¼µã‚Š</button><button class="chip">è…°ã®å¼µã‚Š/è…°ç—›</button>
        <button class="chip">è‡ªå¾‹ç¥çµŒã®ä¹±ã‚Œ</button><button class="chip">èƒƒè…¸å¼±ã‚</button><button class="chip">ã‚€ãã¿</button><button class="chip">ç›®ã®ç–²ã‚Œ/ãƒ‰ãƒ©ã‚¤ã‚¢ã‚¤</button>
        <button class="chip">ç¡çœ ã®è³ªä½ä¸‹</button><button class="chip">å†·ãˆ</button><button class="chip">å–‰ã®ç—›ã¿</button><button class="chip">é¼»æ°´/é¼»ã¥ã¾ã‚Š</button>
        <button class="chip">è‚Œè’ã‚Œ/ã‹ã‚†ã¿</button><button class="chip">èŠ±ç²‰/ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼</button>
        <button class="chip">ã ã‚‹ã•/å€¦æ€ æ„Ÿ</button><button class="chip">ã‚¤ãƒ©ã‚¤ãƒ©/ä¸å®‰</button>
        <button class="chip">ãƒ¢ãƒãƒ™ä½ä¸‹</button><button class="chip">PMS</button><button class="chip">ç”Ÿç†</button>
      </div>
    </section>

    <!-- è¨ºæ–­ãƒ­ã‚° -->
    <section class="card">
      <h2>è¨ºæ–­ãƒ­ã‚°</h2>
      <div id="log"></div>
    </section>
  </div>

<script>
(function(){
  function z2(n){ n = Number(n)||0; return (n<10?"0":"")+n; }
  function $(s){ return document.querySelector(s); }
  function log(){ try{ var out = $("#log"); var msg = Array.prototype.slice.call(arguments).join(" "); out.textContent += msg + "\\n"; console.log.apply(console, arguments);}catch(e){} }

  window.onerror = function(msg, src, line, col, err){ log("JS-ERROR:", msg, "@", src, ":", line); };

  document.addEventListener("DOMContentLoaded", function(){
    try{
      // æ—¥ä»˜ï¼†ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
      var d=new Date();
      $("#mdM").textContent = z2(d.getMonth()+1);
      $("#mdD").textContent = z2(d.getDate());
      $("#mdY").textContent = d.getFullYear();
      $("#mdW").textContent = ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"][d.getDay()] + "æ›œæ—¥";
      $("#openCal").href = "./Calendar.html?date=" + d.toISOString().slice(0,10);
      log("boot ok");

      // ãƒãƒƒãƒ—ï¼ˆãƒ—ãƒªãƒ¬ãƒ³ãƒ€ãƒ¼ï¼‰ãƒã‚¤ãƒ³ãƒ‰
      (function(){
        var mBtns = $("#moodChips").querySelectorAll(".chip");
        for(var i=0;i<mBtns.length;i++){
          (function(btn){
            btn.addEventListener("click", function(){
              for(var j=0;j<mBtns.length;j++){ mBtns[j].classList.remove("on"); }
              btn.classList.add("on");
            });
          })(mBtns[i]);
        }
        var cBtns = $("#condChips").querySelectorAll(".chip");
        for(var i=0;i<cBtns.length;i++){
          (function(btn){
            btn.addEventListener("click", function(){ btn.classList.toggle("on"); });
          })(cBtns[i]);
        }
        log("chips ready:", mBtns.length, cBtns.length);
      })();

      // å¤©æ°—/æ°—åœ§
      var TOKYO={lat:35.681236, lon:139.767125};
      function wxIcon(code){ if(code>=61&&code<=65) return "ğŸŒ§ï¸"; if(code===0||code===1) return "â˜€ï¸"; if(code===2) return "ğŸŒ¤ï¸"; if(code===3) return "â˜ï¸"; return "ğŸŒ¦ï¸"; }
      function wxText(code){ var map={0:"å¿«æ™´",1:"æ™´ã‚Œ",2:"è–„æ›‡ã‚Š",3:"æ›‡ã‚Š",45:"éœ§",48:"éœ§æ°·",51:"å¼±ã„éœ§é›¨",53:"éœ§é›¨",55:"å¼·ã„éœ§é›¨",61:"å¼±ã„é›¨",63:"é›¨",65:"å¼·ã„é›¨",71:"å¼±ã„é›ª",73:"é›ª",75:"å¤§é›ª",95:"é›·é›¨"}; return map[code]||"â€”"; }
      function renderWx(obj){
        if(!obj){ $("#wxIcon").textContent="âš ï¸"; $("#wxText").textContent="å–å¾—å¤±æ•—"; return; }
        $("#wxIcon").textContent = wxIcon(obj.code);
        $("#wxText").textContent = Math.round(obj.temp)+"Â°Cã€€"+wxText(obj.code)+"ã€€æ°—åœ§ï¼š"+(obj.pressure!=null?Math.round(obj.pressure)+"hPa":"â€”");
      }
      function fetchWx(lat, lon){
        var url="https://api.open-meteo.com/v1/forecast?latitude="+lat+"&longitude="+lon+"&current_weather=true&hourly=pressure_msl&timezone=Asia%2FTokyo";
        log("fetch:", url);
        return fetch(url).then(function(r){ log("resp:", r.status); return r.json(); }).then(function(data){
          log("json ok");
          var c=data.current_weather||{};
          var times=(data.hourly&&data.hourly.time)||[];
          var pArr=(data.hourly&&data.hourly.pressure_msl)||[];
          var idx=-1; for(var i=0;i<times.length;i++){ if(times[i]===c.time){ idx=i; break; } }
          var p = (idx>-1 && pArr) ? pArr[idx] : null;
          var out={ temp:c.temperature, wind:c.windspeed, code:c.weathercode, pressure:p };
          renderWx(out);
          return out;
        }).catch(function(e){ log("fetch err:", e && (e.message||e)); renderWx(null); });
      }

      function autoWx(){
        if(navigator.geolocation){
          log("geo: getCurrentPosition...");
          navigator.geolocation.getCurrentPosition(
            function(pos){ log("geo ok:", pos.coords.latitude, pos.coords.longitude); fetchWx(pos.coords.latitude, pos.coords.longitude); },
            function(err){ log("geo err:", err && (err.code+":"+err.message)); fetchWx(TOKYO.lat, TOKYO.lon); },
            {enableHighAccuracy:true, timeout:6000, maximumAge:600000}
          );
        }else{
          log("geo unsupported -> Tokyo");
          fetchWx(TOKYO.lat, TOKYO.lon);
        }
      }

      $("#useGeo").addEventListener("click", function(){ log("btn geo"); autoWx(); });
      $("#useTokyo").addEventListener("click", function(){ log("btn tokyo"); fetchWx(TOKYO.lat, TOKYO.lon); });

      // èµ·å‹•ç›´å¾Œã¯è‡ªå‹•å–å¾—
      autoWx();

    }catch(e){
      log("boot error:", e && e.message);
    }
  });
})();
</script>
</body>
</html>
