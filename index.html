<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>MorningDash â€” v14.1</title>
<meta name="theme-color" content="#0f172a">

<style>
:root{
  --bg:#eef2ff;            /* ã»ã‚“ã®ã‚Šé’ */
  --card:#fff;             /* ã‚«ãƒ¼ãƒ‰ */
  --line:#e5e7eb;          /* æ ç·š */
  --text:#0f172a;          /* æœ¬æ–‡ */
  --muted:#64748b;         /* è£œåŠ© */
  --accent:#0ea5e9;        /* ãƒœã‚¿ãƒ³ */
  --accent-press:#0284c7;
  --radius:16px;
  --shadow:0 6px 20px rgba(2,8,23,.06);

  /* v14 ä½™ç™½ã‚’å…¨ä½“çš„ã«è©°ã‚ã‚‹ */
  --tight:1.15;
  --gap-s:8px;
  --gap-m:12px;
  --gap-l:16px;
}

html,body{background:var(--bg);color:var(--text)}
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"SF Pro","Hiragino Sans",Roboto,"Noto Sans JP","ãƒ¡ã‚¤ãƒªã‚ª",sans-serif;line-height:var(--tight)}
.container{max-width:960px;margin:0 auto;padding:16px}

h1,h2,h3{margin:0 0 10px 0}
h1{font-size:28px;font-weight:800}
h2{font-size:20px;font-weight:700}
h3{font-size:14px;font-weight:700}

.card{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:16px;
  margin:12px 0;
  overflow:hidden;
  -webkit-mask-image: -webkit-radial-gradient(white, black);
}

.row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
.text{font-size:14px}
.muted{color:var(--muted)}

.input{border:1px solid var(--line);border-radius:12px;padding:10px 12px;font-size:14px;background:#fff}
.number{width:72px;text-align:center}
.badge{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#fff}

.btn{appearance:none;border:1px solid var(--line);border-radius:14px;padding:10px 14px;background:#fff;cursor:pointer}
.btn.primary{background:var(--accent);border-color:var(--accent);color:#fff;box-shadow:0 6px 16px rgba(14,165,233,.28)}
.btn.small{font-size:12px;padding:6px 10px;border-radius:12px}
.btn.tiny{font-size:11px;padding:4px 8px;border-radius:10px}

.chip{border:1px solid var(--line);border-radius:999px;padding:6px 10px;background:#fff;cursor:pointer;font-size:13px;color:var(--text)}
.chip.active{background:var(--accent);border-color:var(--accent);color:#fff}

.symptom-group{border:1px dashed var(--line);border-radius:12px;padding:10px;margin:8px 0}

/* ====== v14 ãƒ’ãƒ¼ãƒ­ãƒ¼ï¼ˆä¸Šéƒ¨ï¼‰ ====== */
.header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:8px}
.brand{
  font-weight:800;
  font-size:28px;
  letter-spacing:.5px;
  color:#0f172a;
  opacity:.55;           /* å­˜åœ¨æ„Ÿã¯å‡ºã—ã¤ã¤è–„ã‚ */
  transform:scale(1.0);
}
.hero{display:flex;gap:16px;align-items:flex-start}
.date-mmdd{
  font-size: clamp(40px, 12vw, 88px);
  font-weight:800;
  letter-spacing:2px;
  line-height:.95;
}
.meta{
  display:flex;flex-direction:column;gap:6px; margin-top:4px;
}
.meta .y{font-size:20px;font-weight:800}
.meta .w{font-size:20px;color:#0891b2;font-weight:800}
.meta .t{font-size:20px;font-style:italic;font-weight:800}

/* æ—¥ä»˜ãƒœã‚¿ãƒ³ã ã‘ä¸Šã«æ®‹ã™ã€‚ä»–ãƒœã‚¿ãƒ³ã¯ä¸‹ã¸ */
.top-actions{display:flex;gap:12px;flex-wrap:wrap;margin:8px 0 6px}

/* ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¦‹å‡ºã—ã‚’å°‘ã—å°ã•ã */
.section-title{font-size:22px;font-weight:800;margin-bottom:6px}

/* å¤©æ°—ã‚«ãƒ¼ãƒ‰å†…ã§å†å–å¾—ã‚’å³ç«¯ã« */
.wx-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}

/* ã‚«ãƒ¼ãƒ‰é–“ã®ä½™ç™½ã‚’ã•ã‚‰ã«åœ§ç¸® */
.card + .card{margin-top:10px}

/* ãƒ•ãƒƒã‚¿ãƒ¼æ“ä½œç¾¤ï¼ˆä¿å­˜/CSV/JSONï¼‰ */
.footer-actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-start;margin-top:10px}
.footer-actions .btn.primary{font-weight:800}

/* ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã¯ã¯ã¿å‡ºã•ãªã„ */
textarea, input[type="text"], input[type="number"], select{
  display:block; width:100%; max-width:100%; box-sizing:border-box;
}
</style>
</head>
<body>
  <div class="container">

    <!-- ===== Hero ===== -->
    <div class="header">
      <div class="hero">
        <div class="date-mmdd" id="mmdd">08 / 16</div>
        <div class="meta">
          <div class="y" id="yyyy">2025</div>
          <div class="w" id="wday">åœŸæ›œæ—¥</div>
          <div class="t" id="clock">19:03</div>
        </div>
      </div>
      <div class="brand">MorningDash</div>
    </div>

    <!-- date pickerï¼ˆæ®‹ã™ï¼‰ -->
    <div class="top-actions">
      <input id="datePicker" type="date" class="input">
      <span id="editBadge" class="badge" style="display:none">ç·¨é›†ãƒ¢ãƒ¼ãƒ‰</span>
    </div>

    <!-- å¤©æ°— -->
    <section class="card">
      <div class="wx-head">
        <h2 class="section-title">å¤©æ°—ï¼ˆç¾åœ¨åœ°ï¼‰</h2>
        <button id="retryWx" class="btn small">å†å–å¾—</button>
      </div>
      <div id="wxError" class="text danger"></div>
      <div id="wxBlock" class="row"></div>
    </section>

    <!-- æ°—åˆ†ãƒ»å…ƒæ°—åº¦ -->
    <section class="row">
      <div class="card" style="flex:1 1 300px;min-width:280px">
        <h2 class="section-title">æ°—åˆ†</h2>
        <div id="moodBtns" class="row"></div>
      </div>
      <div class="card" style="flex:1 1 300px;min-width:280px">
        <h2 class="section-title">å…ƒæ°—åº¦</h2>
        <div id="energyBtns" class="row"></div>
      </div>
    </section>

    <!-- ä½“èª¿ãƒ¡ãƒ¢ & ç¡çœ /ãƒ˜ãƒ«ã‚¹ -->
    <section class="row">
      <div class="card" style="flex:1 1 300px;min-width:280px">
        <h2 class="section-title">ä½“èª¿ãƒ¡ãƒ¢</h2>
        <div class="symptom-group">
          <h3>â‘  ã‚ˆãã‚ã‚‹ä¸èª¿</h3>
          <div id="symptomGroup1" class="row"></div>
        </div>
        <div class="symptom-group">
          <h3>â‘¡ å­£ç¯€ãƒ»ç”Ÿæ´»ãƒªã‚ºãƒ </h3>
          <div id="symptomGroup2" class="row"></div>
        </div>
        <div class="symptom-group">
          <h3>â‘¢ ãƒ¡ãƒ³ã‚¿ãƒ«ãƒ»ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³</h3>
          <div id="symptomGroup3" class="row"></div>
        </div>
        <textarea id="note" class="input" rows="3" placeholder="è‡ªç”±ãƒ¡ãƒ¢ï¼ˆä¾‹ï¼šé¦–ã®å¼µã‚Šå¼·ã‚ï¼å†·ãˆæ°—å‘³ ãªã©ï¼‰"></textarea>
      </div>

      <div class="card" style="flex:1 1 300px;min-width:280px">
        <h2 class="section-title">ç¡çœ </h2>
        <div class="row" style="align-items:center;margin-bottom:6px">
          <input id="sleepH" class="input number" type="number" min="0" max="23" value="0"><span>æ™‚é–“</span>
          <input id="sleepM" class="input number" type="number" min="0" max="59" value="0"><span>åˆ†</span>
          <span class="muted" style="margin-left:6px">åˆè¨ˆï¼š<b id="sleepTotal">0æ™‚é–“0åˆ†</b></span>
        </div>
        <div class="card" style="margin-top:8px">
          <h3>ãƒ˜ãƒ«ã‚¹ï¼ˆä»»æ„ï¼‰</h3>
          <div class="row" style="align-items:center">
            <span>ä½“é‡</span><input id="weight" class="input number" type="number" step="0.1" min="0" style="width:90px"><span>kg</span>
            <span>ä½“è„‚è‚ª</span><input id="bodyFat" class="input number" type="number" step="0.1" min="0" max="100" style="width:90px"><span>%</span>
          </div>
          <div class="text muted" style="margin-top:6px">â€» ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã§URLã« <code>?sleepMin=&weight=&bodyFat=</code> ã‚’æ¸¡ã™ã¨è‡ªå‹•å…¥åŠ›ï¼†ä¿å­˜</div>
        </div>
      </div>
    </section>

    <!-- å±¥æ­´ -->
    <section class="card">
      <div class="row" style="justify-content:space-between">
        <h2 class="section-title">å±¥æ­´</h2>
        <button id="reloadHistory" class="btn small">å±¥æ­´ã‚’å†èª­è¾¼</button>
      </div>
      <div id="history"></div>
    </section>

    <!-- ä¸€ç•ªä¸‹ï¼šæ“ä½œç¾¤ï¼ˆä¿å­˜/CSV/JSONï¼‰ -->
    <section class="card">
      <div class="footer-actions">
        <button id="saveLog" class="btn primary">ä¿å­˜</button>
        <button id="exportCSV" class="btn">CSV</button>
        <button id="exportJSON" class="btn">JSON</button>
        <label class="btn small" for="importJSON" style="cursor:pointer">JSONã‚’èª­ã¿è¾¼ã¿</label>
        <input id="importJSON" type="file" accept="application/json" style="display:none">
      </div>
    </section>

    <div class="text muted" style="margin:12px 0 24px">
      ä¿å­˜å…ˆï¼šã“ã®ç«¯æœ«ã®ãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆlocalStorageï¼‰ï¼åŒã˜URLãªã‚‰ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã—ã¦ã‚‚å±¥æ­´ã¯ç¶™ç¶šåˆ©ç”¨ã§ãã¾ã™ã€‚
    </div>
  </div>

<script>
(function(){
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const tz = "Asia/Tokyo";
  const toKey = d => d.toLocaleDateString("ja-JP",{timeZone:tz});
  const z2 = n => String(n).padStart(2,"0");
  const toInputDate = d => `${d.getFullYear()}-${z2(d.getMonth()+1)}-${z2(d.getDate())}`;
  const fromInputDate = s => { const [y,m,d]=s.split("-").map(Number); return new Date(y,m-1,d); };
  const WDAY = ["æ—¥æ›œæ—¥","æœˆæ›œæ—¥","ç«æ›œæ—¥","æ°´æ›œæ—¥","æœ¨æ›œæ—¥","é‡‘æ›œæ—¥","åœŸæ›œæ—¥"];

  const today = new Date();
  const todayKey = toKey(today);
  let currentDateKey = todayKey;

  /* ===== ãƒ˜ãƒƒãƒ€ãƒ¼è¡¨ç¤º ===== */
  function renderHeaderFromKey(k){
    const [y,m,d] = k.split("/").map(Number);
    $("#mmdd").textContent = `${z2(m)} / ${z2(d)}`;
    $("#yyyy").textContent = y;
    const dt = new Date(y, m-1, d);
    $("#wday").textContent = WDAY[dt.getDay()];
    $("#datePicker").value = toInputDate(dt);
    $("#editBadge").style.display = (k===todayKey) ? "none" : "inline-block";
  }
  function tickClock(){
    const now = new Date();
    $("#clock").textContent = `${z2(now.getHours())}:${z2(now.getMinutes())}`;
  }
  setInterval(tickClock, 1000*15); tickClock();
  renderHeaderFromKey(currentDateKey);
  $("#datePicker").value = toInputDate(today);

  /* ====== ã‚¹ãƒ†ãƒ¼ãƒˆ ====== */
  const state = {
    mood:"", energy:"", symptoms:[], note:"",
    sleepH:0, sleepM:0, weight:null, bodyFat:null,
    weather:null
  };

  /* ====== UI ====== */
  const moods = [{v:"ğŸ™‚",label:"è‰¯ã„"},{v:"ğŸ˜",label:"ãµã¤ã†"},{v:"ğŸ™",label:"ã„ã¾ã„ã¡"}];
  const energies = ["â¤ï¸â€ğŸ”¥å…ƒæ°—","â¤ï¸ã¾ãšã¾ãš","â¤ï¸â€ğŸ©¹ã ã‚‹ã„"];
  const group1 = ["é¦–ãƒ»è‚©ã“ã‚Š","é ­ç—›","è…¹ç—›ï¼ãŠè…¹ã®å¼µã‚Š","è…°ã®å¼µã‚Šï¼è…°ç—›","èƒƒè…¸å¼±ã‚ï¼ˆèƒƒã‚‚ãŸã‚Œãƒ»ä¸‹ç—¢ãƒ»ä¾¿ç§˜ãªã©ï¼‰","ã‚€ãã¿","ç›®ã®ç–²ã‚Œï¼ãƒ‰ãƒ©ã‚¤ã‚¢ã‚¤","è‡ªå¾‹ç¥çµŒã®ä¹±ã‚Œ","ç¡çœ ã®è³ªä½ä¸‹ï¼ˆæµ…ã„çœ ã‚Šãƒ»é€”ä¸­è¦šé†’ï¼‰","ç”Ÿç†"];
  const group2 = ["å†·ãˆï¼ˆæ‰‹è¶³ã®å†·ãˆãƒ»å…¨èº«ï¼‰","æš‘ã•ãƒãƒ†ï¼ç†±ã£ã½ã•","å–‰ã®ç—›ã¿ãƒ»å£°æ¯ã‚Œ","é¼»æ°´ãƒ»é¼»ã¥ã¾ã‚Š","è‚Œè’ã‚Œï¼ã‹ã‚†ã¿","èŠ±ç²‰ãƒ»ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ç—‡çŠ¶"];
  const group3 = ["é›†ä¸­åŠ›ä½ä¸‹","ã‚¤ãƒ©ã‚¤ãƒ©ï¼ä¸å®‰æ„Ÿ","ã ã‚‹ã•ï¼å€¦æ€ æ„Ÿ","ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ä½ä¸‹","PMSï¼ˆç”Ÿç†å‰ç—‡çŠ¶ï¼‰"];
  const allSymptoms = [...group1,...group2,...group3];

  function buildChips(root, options, isActive, onClick){
    root.innerHTML=""; options.forEach(opt=>{
      const v = typeof opt==="string" ? opt : opt.v;
      const label = typeof opt==="string" ? opt : (opt.v+" "+opt.label);
      const b=document.createElement("button");
      b.className="chip"+(isActive(v)?" active":"");
      b.textContent=label;
      b.onclick=()=>onClick(v);
      root.appendChild(b);
    });
  }
  function renderChips(){
    buildChips($("#moodBtns"), moods, v=>state.mood===v, v=>{state.mood=v; renderChips(); autoSave();});
    buildChips($("#energyBtns"), energies, v=>state.energy===v, v=>{state.energy=v; renderChips(); autoSave();});

    const mk = (id, arr)=> buildChips($(id), arr, v=>state.symptoms.includes(v), v=>{
      if(state.symptoms.includes(v)) state.symptoms = state.symptoms.filter(x=>x!==v);
      else state.symptoms = [...state.symptoms, v];
      renderChips(); autoSave();
    });
    mk("#symptomGroup1", group1);
    mk("#symptomGroup2", group2);
    mk("#symptomGroup3", group3);
  }
  renderChips();

  /* ====== å…¥åŠ› ====== */
  const sleepH=$("#sleepH"), sleepM=$("#sleepM"), sleepTotal=$("#sleepTotal");
  const weight=$("#weight"), bodyFat=$("#bodyFat"), note=$("#note");
  function updateSleepLabel(){ sleepTotal.textContent = `${Math.floor(state.sleepH)}æ™‚é–“${state.sleepM%60}åˆ†`; }

  sleepH.oninput = ()=>{ state.sleepH = parseInt(sleepH.value||0,10); updateSleepLabel(); autoSave(); };
  sleepM.oninput = ()=>{ state.sleepM = parseInt(sleepM.value||0,10); updateSleepLabel(); autoSave(); };
  weight.oninput = ()=>{ state.weight = weight.value===""?null:parseFloat(weight.value); autoSave(); };
  bodyFat.oninput = ()=>{ state.bodyFat = bodyFat.value===""?null:parseFloat(bodyFat.value); autoSave(); };
  note.oninput = ()=>{ state.note = note.value; autoSave(); };

  /* ====== å¤©æ°— ====== */
  function wxCodeToEmoji(code){
    if([0,1].includes(code)) return "â˜€ï¸";
    if([2,3].includes(code)) return "â›…ï¸";
    if([51,53,55].includes(code)) return "ğŸŒ¦";
    if([61,63,65,95].includes(code)) return "ğŸŒ§";
    if([71,73,75].includes(code)) return "ğŸŒ¨";
    return "ğŸŒ¤";
  }
  function renderWeather(){
    const root=$("#wxBlock"); root.innerHTML="";
    if(!state.weather){ root.innerHTML = `<span class="muted">ä½ç½®æƒ…å ±ã®è¨±å¯å¾Œã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</span>`; return; }
    const icon=document.createElement("div"); icon.style.fontSize="56px"; icon.textContent=wxCodeToEmoji(state.weather.code);
    const big=document.createElement("div"); big.style.fontSize="56px"; big.style.fontWeight="800"; big.textContent=`${Math.round(state.weather.temp)}Â°C`;
    const info=document.createElement("div"); info.className="text"; info.innerHTML=`çŠ¶æ³ï¼š${state.weather.condition}ã€€é¢¨ï¼š${Math.round(state.weather.wind)}m/s`;
    root.append(icon,big,info);
  }
  function fetchWeatherFromGeo(lat, lon){
    $("#wxError").textContent="";
    const u = new URL("https://api.open-meteo.com/v1/forecast");
    u.searchParams.set("latitude", lat);
    u.searchParams.set("longitude", lon);
    u.searchParams.set("current_weather","true");
    u.searchParams.set("timezone", tz);
    fetch(u).then(r=>r.json()).then(d=>{
      const c=d.current_weather||{};
      const map={0:"å¿«æ™´",1:"æ™´ã‚Œ",2:"è–„æ›‡ã‚Š",3:"æ›‡ã‚Š",51:"å¼±ã„éœ§é›¨",53:"éœ§é›¨",55:"å¼·ã„éœ§é›¨",61:"å¼±ã„é›¨",63:"é›¨",65:"å¼·ã„é›¨",71:"å¼±ã„é›ª",73:"é›ª",75:"å¤§é›ª",95:"é›·é›¨"};
      state.weather={ temp:c.temperature, wind:c.windspeed, code:c.weathercode, condition: map[c.weathercode]||"â€”" };
      renderWeather(); autoSave();
    }).catch(()=> $("#wxError").textContent="å¤©æ°—ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
  }
  function askGeo(){
    if(!("geolocation" in navigator)){ $("#wxError").textContent="ã“ã®ç«¯æœ«ã¯ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚"; return; }
    navigator.geolocation.getCurrentPosition(
      pos=> fetchWeatherFromGeo(pos.coords.latitude, pos.coords.longitude),
      err=> $("#wxError").textContent="ä½ç½®æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆè¨­å®šã‚’ç¢ºèªï¼‰",
      {enableHighAccuracy:false, timeout:8000}
    );
  }
  $("#retryWx").onclick = askGeo; askGeo();

  /* ====== ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ ====== */
  const LOGS_KEY="md_logs_v2";
  const loadAll = ()=> JSON.parse(localStorage.getItem(LOGS_KEY)||"[]");
  const saveAll = arr => localStorage.setItem(LOGS_KEY, JSON.stringify(arr));
  const loadLog = k => loadAll().find(x=>x.date===k)||null;
  const upsertLog = payload => {
    const rest = loadAll().filter(x=>x.date!==payload.date);
    saveAll([payload, ...rest].sort((a,b)=> (a.date<b.date?1:-1)));
  };

  function syncFormFromState(){
    sleepH.value = state.sleepH;
    sleepM.value = state.sleepM;
    weight.value = state.weight ?? "";
    bodyFat.value = state.bodyFat ?? "";
    note.value = state.note;
    updateSleepLabel();
  }
  function loadLogToForm(log){
    if(!log){
      state.mood=""; state.energy=""; state.symptoms=[]; state.note="";
      state.sleepH=0; state.sleepM=0; state.weight=null; state.bodyFat=null;
    }else{
      state.mood=log.mood||""; state.energy=log.energy||"";
      state.symptoms=Array.isArray(log.symptoms)?log.symptoms.filter(s=>allSymptoms.includes(s)):[];
      const sm=parseInt(log.sleepMin||0,10); state.sleepH=Math.floor(sm/60); state.sleepM=sm%60;
      state.weight = log.weight ?? null; state.bodyFat = log.bodyFat ?? null;
      state.note=log.note||""; state.weather = log.weather || state.weather;
    }
    renderChips(); syncFormFromState();
  }

  /* ====== è‡ªå‹•ä¿å­˜ ====== */
  let timer=null;
  function autoSave(){
    clearTimeout(timer);
    timer=setTimeout(()=>{
      const payload={
        date: currentDateKey,
        mood: state.mood, energy: state.energy, symptoms: state.symptoms,
        sleepMin: (parseInt(state.sleepH,10)||0)*60 + (parseInt(state.sleepM,10)||0),
        weight: state.weight, bodyFat: state.bodyFat,
        note: state.note, weather: state.weather, ts: Date.now()
      };
      upsertLog(payload); renderHistory();
    },300);
  }

  /* ====== å±¥æ­´ ====== */
  function renderHistory(){
    const root=$("#history"); const logs=loadAll(); root.innerHTML="";
    if(!logs.length){ root.innerHTML=`<p class="muted">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p>`; return; }
    logs.forEach(l=>{
      const box=document.createElement("div"); box.className="card"; box.style.marginTop="8px";
      const head=document.createElement("div"); head.className="text"; head.innerHTML = `<span class="muted">${l.date}</span>`;
      const row=document.createElement("div"); row.className="row text"; row.style.marginTop="4px";
      row.innerHTML = `<div>æ°—åˆ†ï¼š${l.mood||"â€”"}</div>
                       <div>å…ƒæ°—åº¦ï¼š${l.energy||"â€”"}</div>
                       <div>ç¡çœ ï¼š${Math.floor((l.sleepMin||0)/60)}æ™‚é–“${(l.sleepMin||0)%60}åˆ†</div>
                       ${l.weight!=null?`<div>ä½“é‡ï¼š${l.weight}kg</div>`:""}
                       ${l.bodyFat!=null?`<div>ä½“è„‚è‚ªï¼š${l.bodyFat}%</div>`:""}`;
      const memo=document.createElement("div"); memo.className="text"; if(l.note){ memo.textContent="ãƒ¡ãƒ¢ï¼š"+l.note; }
      const actions=document.createElement("div"); actions.className="row"; actions.style.marginTop="6px";
      const edit=document.createElement("button"); edit.className="btn small"; edit.textContent="ç·¨é›†";
      edit.onclick=()=>{ currentDateKey = l.date; renderHeaderFromKey(currentDateKey); loadLogToForm(l); window.scrollTo({top:0,behavior:"smooth"}); };
      const del=document.createElement("button"); del.className="btn small"; del.textContent="å‰Šé™¤";
      del.onclick=()=>{ if(!confirm(`${l.date} ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`))return; saveAll(loadAll().filter(x=>x.date!==l.date)); renderHistory(); if(currentDateKey===l.date){currentDateKey=todayKey; renderHeaderFromKey(currentDateKey); loadLogToForm(loadLog(currentDateKey));}};
      actions.append(edit,del);
      box.append(head,row); if(memo.textContent) box.appendChild(memo); box.appendChild(actions); root.appendChild(box);
    });
  }

  /* ====== ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆ/ä¿å­˜ ====== */
  $("#saveLog").onclick = ()=>{ autoSave(); alert(`${currentDateKey} ã‚’ä¿å­˜ã—ã¾ã—ãŸ`); };
  $("#exportJSON").onclick = ()=>{
    const data = JSON.stringify(loadAll(), null, 2);
    const a=document.createElement("a"); a.href=URL.createObjectURL(new Blob([data],{type:"application/json"}));
    a.download="MorningDash_logs.json"; a.click();
  };
  $("#exportCSV").onclick = ()=>{
    const logs=loadAll();
    const header=["date","mood","energy","sleepMin","weight","bodyFat","note"];
    const rows=[header.join(",")].concat(logs.map(l=>[l.date,l.mood||"",l.energy||"",l.sleepMin||0,l.weight??"",l.bodyFat??"", (l.note||"").replaceAll('"','""')].join(",")));
    const a=document.createElement("a"); a.href=URL.createObjectURL(new Blob([rows.join("\n")],{type:"text/csv"}));
    a.download="MorningDash_logs.csv"; a.click();
  };
  $("#importJSON").onchange = (e)=>{
    const f=e.target.files?.[0]; if(!f) return;
    const r=new FileReader(); r.onload=()=>{ try{ const arr=JSON.parse(r.result); if(Array.isArray(arr)) saveAll(arr); renderHistory(); alert("èª­ã¿è¾¼ã¿ã¾ã—ãŸ"); }catch(e){ alert("JSONãŒä¸æ­£ã§ã™"); } };
    r.readAsText(f);
  };
  $("#reloadHistory").onclick = renderHistory;

  /* ====== æ—¥ä»˜å¤‰æ›´ ====== */
  $("#datePicker").onchange = ()=>{
    const d = fromInputDate($("#datePicker").value);
    currentDateKey = toKey(d);
    renderHeaderFromKey(currentDateKey);
    loadLogToForm(loadLog(currentDateKey));
  };

  /* ====== åˆæœŸãƒ­ãƒ¼ãƒ‰ ====== */
  function init(){
    renderHistory();
    loadLogToForm(loadLog(todayKey));
    // QP å–ã‚Šè¾¼ã¿ï¼ˆã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆï¼‰
    const url = new URL(location.href);
    const payload={};
    if(url.searchParams.has("sleepMin")) payload.sleepMin = parseInt(url.searchParams.get("sleepMin")||"0",10);
    if(url.searchParams.has("weight"))   payload.weight = parseFloat(url.searchParams.get("weight"));
    if(url.searchParams.has("bodyFat"))  payload.bodyFat = parseFloat(url.searchParams.get("bodyFat"));
    if(Object.keys(payload).length){
      // æ—¢å­˜ãƒ­ã‚°ã«åæ˜ 
      const base = loadLog(todayKey) || {date: todayKey};
      const sm = payload.sleepMin ?? base.sleepMin ?? 0;
      const wh = payload.weight ?? base.weight ?? null;
      const bf = payload.bodyFat ?? base.bodyFat ?? null;
      const merged = {...base, sleepMin: sm, weight: wh, bodyFat: bf, ts: Date.now()};
      upsertLog(merged);
      currentDateKey = todayKey; renderHeaderFromKey(currentDateKey); loadLogToForm(merged); renderHistory();
      alert("ä¿å­˜ã—ã¾ã—ãŸï¼ˆã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆé€£æºï¼‰");
    }
  }
  init();
})();
</script>
</body>
</html>
