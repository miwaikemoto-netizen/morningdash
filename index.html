<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Morning Dash</title>
<meta name="theme-color" content="#d6f0ff" id="themeColor">
<meta name="x-build-id" content="MorningDash merge-history build">
<style>
:root{--md-bg:#88c8ff;--md-bg2:#d6f0ff;--fg:#0e1726;--card:#ffffffd9;--border:#0000001a;--accent:#2563eb;--accent-press:#1d4ed8}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{margin:0;height:100%;color:var(--fg);transition:background .35s ease}
body{
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
  /* åè»¢ã‚°ãƒ©ãƒ‡ï¼šé’â†’ç™½â†’ç™½â†’é’ */
  background:linear-gradient(180deg,var(--md-bg) 0%,var(--md-bg2) 50%,var(--md-bg2) 50%,var(--md-bg) 100%)
}
.container{max-width:900px;margin:0 auto;padding:16px 16px 92px}
h1{margin:4px 0 4px;font-size:28px;font-weight:800;display:flex;gap:10px;align-items:baseline;flex-wrap:wrap}
h2{margin:0 0 10px;font-size:18px}
.card{background:var(--card);backdrop-filter:saturate(1.1) blur(2px);border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 30px #0003;padding:16px;margin:12px 0}
.row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.row.nw{flex-wrap:nowrap}
.btn{appearance:none;border:1px solid var(--border);border-radius:14px;padding:8px 12px;background:#ffffffb3;cursor:pointer;color:#0e1726;text-decoration:none;font-size:14px}
.btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
.btn.primary:active{background:var(--accent-press)}
.btn.small{padding:6px 10px;font-size:13px}
.input,select,textarea{border:1px solid var(--border);border-radius:12px;padding:10px 12px;background:#ffffffcc;color:#0e1726;font-size:16px}
select[multiple]{min-height:132px}
textarea{width:100%;min-height:96px;resize:vertical}
.small{font-size:13px;color:#475569}
.labelBig{font-size:15px;font-weight:700;margin-right:6px}
.header{display:flex;justify-content:space-between;align-items:flex-end;gap:10px;flex-wrap:wrap;margin-bottom:6px}
.bigdate{display:flex;align-items:baseline;gap:8px}
.bigdate .date{font-weight:800;font-size:30px}
.bigdate .wday{font-weight:700}
#year{font-size:16px;font-weight:400;color:#64748b}
.historyItem{padding:12px;border:1px dashed var(--border);border-radius:12px;margin-top:10px;background:#fff}
.historyItem .hline{margin:6px 0;color:#334155}
.badge{display:inline-block;border:1px solid #0000001a;border-radius:999px;padding:2px 8px;margin-right:6px;background:#f8fafc;color:#334155;font-size:12px}
label.checkbox{display:flex;align-items:center;gap:10px;cursor:pointer;font-size:16px}
label.checkbox input{transform:scale(1.2)}
.weatherTitle{display:flex;justify-content:space-between;align-items:center;gap:8px}
#wxMain{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.wxIcon{font-size:30px}
#wxTemp{font-size:22px;font-weight:800}
.wxLine{font-size:15px;font-weight:700;margin-top:6px}
#navRow{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.input.compact{width:120px}
.input.compact.short{width:86px}
@media (max-width:420px){.input.compact{width:110px}.input.compact.short{width:78px}}
/* å³ä¸‹ãƒ“ãƒ«ãƒ‰ãƒãƒƒãƒ—ï¼ˆèª­ã¿è¾¼ã¾ã‚ŒãŸç‰ˆã®ç¢ºèªç”¨ï¼‰ */
#buildChip{
  position:fixed;right:10px;bottom:10px;z-index:9999;
  font-size:12px;color:#334155;background:#ffffffc8;
  padding:6px 10px;border:1px solid #0000001a;border-radius:12px;
  backdrop-filter:saturate(1.2) blur(2px)
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div>
      <h1>â˜€ï¸ Morning Dash <span id="year">2025</span></h1>
      <div class="bigdate"><span class="date" id="ymd">--/--</span><span class="wday" id="wday">---</span></div>
    </div>
    <div id="navRow">
      <a href="./EveningDash.html" class="btn">ğŸŒ™ å¤œã®è¨˜éŒ²ã¸</a>
      <a id="openCal" href="./Calendar.html" class="btn">ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</a>
    </div>
  </div>

  <!-- â‘  å¤©æ°— -->
  <section class="card" id="secWeather">
    <div class="weatherTitle">
      <h2>â‘  å¤©æ°—ï¼ˆè‡ªå‹•å–å¾—ï¼‰</h2>
      <button id="useGeo" class="btn small">å†å–å¾—</button>
    </div>
    <div id="wxMain"><div id="wxIcon" class="wxIcon">â³</div><div id="wxTemp">--Â°C</div></div>
    <div id="wxLine1" class="wxLine">çŠ¶æ³ï¼šâ€”ã€€é™æ°´ç¢ºç‡ï¼šâ€”</div>
    <div id="wxLine2" class="wxLine">æ¹¿åº¦ï¼šâ€”ã€€æ°—åœ§ï¼šâ€”</div>
  </section>

  <!-- â‘¡ æ—¥è¨˜ãƒ»è¨˜éŒ² -->
  <section class="card" id="secDiary">
    <h2>â‘¡ æ—¥è¨˜ãƒ»è¨˜éŒ²</h2>
    <div class="row">
      <label for="moodSel" class="labelBig">æ„Ÿæƒ…</label>
      <select id="moodSel" class="input">
        <option value="">ï¼ˆæœªé¸æŠï¼‰</option><option>æœ€é«˜</option><option>è‰¯ã„</option><option>æ™®é€š</option><option>ã„ã¾ã„ã¡</option><option>ã—ã‚“ã©ã„</option>
      </select>
    </div>
    <div class="row">
      <label for="condSel" class="labelBig">ä½“èª¿ï¼ˆè¤‡æ•°å¯ï¼‰</label>
      <select id="condSel" class="input" multiple>
        <option>é¦–ãƒ»è‚©ã“ã‚Š</option><option>é ­ç—›</option><option>è…¹ç—›/ãŠè…¹ã®å¼µã‚Š</option><option>è…°ã®å¼µã‚Š/è…°ç—›</option>
        <option>è‡ªå¾‹ç¥çµŒã®ä¹±ã‚Œ</option><option>èƒƒè…¸å¼±ã‚</option><option>ã‚€ãã¿</option><option>ç›®ã®ç–²ã‚Œ/ãƒ‰ãƒ©ã‚¤ã‚¢ã‚¤</option>
        <option>ç¡çœ ã®è³ªä½ä¸‹</option><option>å†·ãˆ</option><option>å–‰ã®ç—›ã¿</option><option>é¼»æ°´/é¼»ã¥ã¾ã‚Š</option>
        <option>è‚Œè’ã‚Œ/ã‹ã‚†ã¿</option><option>èŠ±ç²‰/ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼</option><option>ã ã‚‹ã•/å€¦æ€ æ„Ÿ</option><option>ã‚¤ãƒ©ã‚¤ãƒ©/ä¸å®‰</option>
        <option>ãƒ¢ãƒãƒ™ä½ä¸‹</option><option>PMS</option><option>ç”Ÿç†</option>
      </select>
    </div>
    <div class="row nw">
      <label class="labelBig" for="sleepH">ç¡çœ </label>
      <input id="sleepH" class="input compact short" type="number" min="0"><span>æ™‚é–“</span>
      <input id="sleepM" class="input compact short" type="number" min="0" max="59"><span>åˆ†</span>
      <span id="sleepLabel" class="small"></span>
    </div>
    <div class="row">
      <label class="labelBig" for="weight">ä½“é‡</label>
      <input id="weight" class="input compact" type="number" step="0.1"><span>kg</span>
    </div>
    <div class="row">
      <label class="labelBig" for="bodyFat">ä½“è„‚è‚ª</label>
      <input id="bodyFat" class="input compact" type="number" step="0.1"><span>%</span>
      <span id="wbLabel" class="small"></span>
    </div>
    <div style="margin-top:12px"><label for="freeMemo">ğŸ““ è‡ªç”±ãƒ¡ãƒ¢</label><textarea id="freeMemo" placeholder="ãªã‚“ã§ã‚‚ã©ã†ã"></textarea></div>
  </section>

  <!-- â‘¢ ç”Ÿæ´»ç¿’æ…£ãƒã‚§ãƒƒã‚¯ -->
  <section class="card" id="secHabits"><h2>â‘¢ ç”Ÿæ´»ç¿’æ…£ãƒã‚§ãƒƒã‚¯</h2>
    <div class="row">
      <label class="checkbox"><input type="checkbox" id="h_curtain"> ã‚«ãƒ¼ãƒ†ãƒ³ã‚’é–‹ã‘ã‚‹</label>
      <label class="checkbox"><input type="checkbox" id="h_bed"> å¸ƒå›£ã‚’ç›´ã™</label>
      <label class="checkbox"><input type="checkbox" id="h_change"> ç€æ›¿ãˆã‚’ã™ã‚‹</label>
      <label class="checkbox"><input type="checkbox" id="h_teeth"> æ­¯ç£¨ã</label>
      <label class="checkbox"><input type="checkbox" id="h_skin"> ã‚¹ã‚­ãƒ³ã‚±ã‚¢</label>
      <label class="checkbox"><input type="checkbox" id="h_hair"> ãƒ˜ã‚¢ã‚±ã‚¢</label>
    </div>
  </section>

  <section class="card" id="secSave"><div class="row"><button id="saveBtn" class="btn primary">ğŸ’¾ ä¿å­˜</button></div></section>

  <section class="card">
    <div class="row" style="justify-content:space-between"><h2>å±¥æ­´</h2><button id="reloadBtn" class="btn">å†èª­è¾¼</button></div>
    <div id="history"></div>
  </section>
</div>

<!-- å³ä¸‹ï¼šãƒ“ãƒ«ãƒ‰IDè¡¨ç¤º -->
<div id="buildChip" title="ã‚¿ãƒƒãƒ—ã§ã‚³ãƒ”ãƒ¼"></div>

<script>
(function(){
  const $=(s)=>document.querySelector(s);
  const z2=(n)=>((n=+n||0)<10?"0":"")+n;

  document.addEventListener("DOMContentLoaded",function(){
    // æ—¥ä»˜ãƒ»ãƒªãƒ³ã‚¯
    const d=new Date();
    $("#year").textContent=d.getFullYear();
    $("#ymd").textContent=z2(d.getMonth()+1)+"/"+z2(d.getDate());
    $("#wday").textContent=["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"][d.getDay()]+"æ›œæ—¥";
    $("#openCal").href="./Calendar.html?date="+d.toISOString().slice(0,10);

    // â”€â”€ ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆå–ã‚Šè¾¼ã¿ + ãƒ©ãƒ™ãƒ« â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function updateLabels(){
      const h=Number($("#sleepH").value)||0, m=Number($("#sleepM").value)||0;
      $("#sleepLabel").textContent=(h||m)?("ã€€â†’ "+h+"æ™‚é–“"+m+"åˆ†"):"";
      const w=$("#weight").value, bf=$("#bodyFat").value;
      const bfTxt=(bf!=="" && !isNaN(bf))?(Number(bf).toFixed(1)+"%"):"";
      const wTxt =(w!==""  && !isNaN(w)) ?(Number(w)+"kg"):"";
      $("#wbLabel").textContent=(wTxt||bfTxt)?("ã€€â†’ "+[wTxt,bfTxt].filter(Boolean).join(" / ")):"";
    }
    try{
      const usp=new URLSearchParams(location.search);
      if(usp.has("sleepMin")){
        const sm=Math.max(0,Math.floor(Number(usp.get("sleepMin"))||0));
        $("#sleepH").value=Math.floor(sm/60);
        $("#sleepM").value=sm%60;
      }
      if(usp.has("weight"))  $("#weight").value = String(usp.get("weight")).replace(",", ".");
      if(usp.has("bodyFat")) $("#bodyFat").value= String(usp.get("bodyFat")).replace(",", ".");
      updateLabels();
    }catch(e){}
    ["sleepH","sleepM","weight","bodyFat"].forEach(id=>{
      const el=$("#"+id); if(el) el.addEventListener("input",updateLabels);
    });

    // â”€â”€ ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸åŸºç›¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const KEY="morning_logs_index_gradient";
    const loadAll=()=>{try{const v=localStorage.getItem(KEY);return v?JSON.parse(v):[]}catch(e){return[]}};
    const saveAll=(a)=>{try{localStorage.setItem(KEY,JSON.stringify(a))}catch(e){}};
    const toKey=(dt)=>dt.toLocaleDateString("ja-JP",{timeZone:"Asia/Tokyo"});
    const uniq=(arr)=>Array.from(new Set(arr));

    // â”€â”€ ãƒãƒ¼ã‚¸è¦å‰‡ï¼ˆä¸Šæ›¸ãã§ãªãè¿½è¨˜ï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function mergePayload(oldP, newP){
      const out = {...oldP};

      // å˜é …ç›®ï¼šç©ºã§ãªã‘ã‚Œã°ä¸Šæ›¸ãã€ç©ºãªã‚‰æ—§å€¤ç¶­æŒ
      const take = (key, isEmptyFn = v => (v==null || v==="")) => {
        if(!isEmptyFn(newP[key])) out[key] = newP[key];
      };
      take('mood');
      take('sleepH', v => !Number.isFinite(v));
      take('sleepM', v => !Number.isFinite(v));
      take('weight', v => v==null || Number.isNaN(v));
      take('bodyFat', v => v==null || Number.isNaN(v));

      // conditionsï¼šçµåˆï¼‹ãƒ¦ãƒ‹ãƒ¼ã‚¯
      const oldCond = Array.isArray(oldP.conditions) ? oldP.conditions : [];
      const newCond = Array.isArray(newP.conditions) ? newP.conditions : [];
      out.conditions = uniq([...oldCond, ...newCond].filter(Boolean));

      // habitsï¼šå„é …ç›®ã¯ OR
      const hKeys = ['curtain','bed','change','teeth','skin','hair'];
      const oldH = oldP.habits || {};
      const newH = newP.habits || {};
      out.habits = {};
      hKeys.forEach(k => { out.habits[k] = Boolean(oldH[k]) || Boolean(newH[k]); });

      // memoï¼šæ–°è¦ãŒç©ºã§ãªã‘ã‚Œã°æ™‚åˆ»ã‚¿ã‚°ä»˜ãã§è¿½è¨˜
      const nowTag = new Date().toLocaleTimeString('ja-JP', {hour:'2-digit', minute:'2-digit'});
      if(newP.memo && String(newP.memo).trim()){
        const base = (oldP.memo && String(oldP.memo).trim()) ? oldP.memo.trim() + "\n" : "";
        out.memo = base + `ã€${nowTag}ã€‘ ` + String(newP.memo).trim();
      }else{
        out.memo = oldP.memo || "";
      }

      // å¤©æ°—ã¯å¸¸ã«æœ€æ–°ã‚’æ¡ç”¨
      out.wx = newP.wx || oldP.wx || null;

      // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—æ›´æ–°ãƒ»dateã¯ãã®ã¾ã¾
      out.ts = Date.now();
      out.date = oldP.date || newP.date;

      return out;
    }

    // â”€â”€ å±¥æ­´è¡¨ç¤º â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderHistory(){
      const root=$("#history"); root.innerHTML="";
      const logs=loadAll(); if(!logs.length){root.innerHTML='<div class="small">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';return;}
      logs.forEach(l=>{
        const press=l.wx&&l.wx.pressure!=null?Math.round(l.wx.pressure)+'hPa':'â€”';
        const hum  =l.wx&&l.wx.humidity!=null?Math.round(l.wx.humidity)+'%':'â€”';
        const pprob=l.wx&&l.wx.pprob!=null?Math.round(l.wx.pprob)+'%':'â€”';
        const wtemp=l.wx&&l.wx.temp!=null?Math.round(l.wx.temp)+'Â°C':'â€”';
        const trend=(l.wx&&l.wx.trend)||'â€”';

        const box=document.createElement('div'); box.className='historyItem';
        const mood = l.mood ? ('<span class="badge">æ„Ÿæƒ…ï¼š'+l.mood+'</span>') : '';
        const cond = l.conditions && l.conditions.length ? ('<span class="badge">ä½“èª¿ï¼š'+l.conditions.join('ï¼')+'</span>') : '';
        const sleep= (l.sleepH||l.sleepM) ? ('<span class="badge">ç¡çœ ï¼š'+(l.sleepH||0)+'æ™‚é–“'+(l.sleepM||0)+'åˆ†</span>') : '';
        const wb   = (l.weight||l.bodyFat) ? ('<span class="badge">ä½“é‡ãƒ»ä½“è„‚è‚ªï¼š'+(l.weight?l.weight+'kg':'â€”')+' / '+(l.bodyFat?Number(l.bodyFat).toFixed(1)+'%':'â€”')+'</span>') : '';
        const habits = l.habits ? Object.entries(l.habits).filter(([k,v])=>v).map(([k,_])=>({curtain:'ã‚«ãƒ¼ãƒ†ãƒ³',bed:'å¸ƒå›£',change:'ç€æ›¿ãˆ',teeth:'æ­¯ç£¨ã',skin:'ã‚¹ã‚­ãƒ³',hair:'ãƒ˜ã‚¢'}[k])).join('ãƒ»') : '';
        const memo = l.memo ? ('<div class="hline">ğŸ“ '+(l.memo||'').replace(/</g,'&lt;').replace(/\n/g,'<br>')+'</div>') : '';

        box.innerHTML = '<b>'+l.date+'</b>'
          +'ã€€å¤©æ°—ï¼š'+wtemp+'ãƒ»é™æ°´ç¢ºç‡ï¼š'+pprob+'ãƒ»æ¹¿åº¦ï¼š'+hum+'ãƒ»æ°—åœ§ï¼š'+press+' ['+trend+']'
          + '<div class="hline">'+mood+cond+sleep+wb+(habits?('<span class="badge">ç¿’æ…£ï¼š'+habits+'</span>'):'')+'</div>'
          + memo;
        root.appendChild(box);
      });
    }
    document.getElementById("reloadBtn").addEventListener("click",renderHistory);

    // â”€â”€ å¤©æ°— + èƒŒæ™¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const state={wx:null}; window.state = state;
    const fallback={lat:35.681236,lon:139.767125}; // æ±äº¬é§…
    function themeFromCode(code){
      if(code===0||code===1) return ['#88c8ff','#d6f0ff'];
      if(code===2)          return ['#a6c1de','#eaf1fb'];
      if(code===3||code===45||code===48) return ['#8ea1b5','#d4dbe3'];
      if((code>=51&&code<=55)||(code>=61&&code<=67)) return ['#5f7f92','#b8d2db'];
      if(code>=71&&code<=86) return ['#bfe2ff','#eef7ff'];
      if(code>=95)           return ['#3f2b96','#a8c0ff'];
      return ['#90b7d6','#dbe6f1'];
    }
    function applyThemeByCode(code){
      const t=themeFromCode(code||1);
      document.documentElement.style.setProperty('--md-bg',t[0]);
      document.documentElement.style.setProperty('--md-bg2',t[1]);
      document.body.style.background='linear-gradient(180deg,'+t[0]+' 0%,'+t[1]+' 50%,'+t[1]+' 50%,'+t[0]+' 100%)';
      document.getElementById('themeColor').setAttribute('content',t[1]);
    }
    const wxIcon=(c)=>c>=95?'â›ˆï¸':(c>=71&&c<=86?'ğŸŒ¨ï¸':(c>=61&&c<=67?'ğŸŒ§ï¸':(c===0||c===1?'â˜€ï¸':(c===2?'ğŸŒ¤ï¸':(c===3?'â˜ï¸':'ğŸŒ¦ï¸')))));
    const wxText=(c)=>({0:'å¿«æ™´',1:'æ™´ã‚Œ',2:'è–„æ›‡ã‚Š',3:'æ›‡ã‚Š',45:'éœ§',48:'éœ§æ°·',51:'å¼±ã„éœ§é›¨',53:'éœ§é›¨',55:'å¼·ã„éœ§é›¨',61:'å¼±ã„é›¨',63:'é›¨',65:'å¼·ã„é›¨',71:'å¼±ã„é›ª',73:'é›ª',75:'å¤§é›ª',95:'é›·é›¨'})[c]||'â€”';
    function nearestIndex(times,targetISO){let k=-1,diff=1e18,t0=new Date(targetISO).getTime();for(let i=0;i<times.length;i++){const dt=new Date(times[i]).getTime(),dd=Math.abs(dt-t0);if(dd<diff){k=i;diff=dd}}return k}
    function pressureTrend(arr,idx){return !arr||!arr.length||idx<1?'å®‰å®š':(arr[idx]-arr[idx-1]>1.5?'ä¸Šæ˜‡':(arr[idx]-arr[idx-1]<-1.5?'ä¸‹é™':'å®‰å®š'))}
    function renderWx(o){
      const icon=$("#wxIcon"), temp=$("#wxTemp"), l1=$("#wxLine1"), l2=$("#wxLine2");
      if(!o){icon.textContent='âš ï¸'; temp.textContent='--Â°C'; l1.textContent='çŠ¶æ³ï¼šå–å¾—å¤±æ•—ã€€é™æ°´ç¢ºç‡ï¼šâ€”'; l2.textContent='æ¹¿åº¦ï¼šâ€”ã€€æ°—åœ§ï¼šâ€”'; applyThemeByCode(null); return;}
      icon.textContent=wxIcon(o.code); temp.textContent=Math.round(o.temp)+'Â°C';
      l1.textContent='çŠ¶æ³ï¼š'+wxText(o.code)+'ã€€é™æ°´ç¢ºç‡ï¼š'+(o.pprob!=null?Math.round(o.pprob)+'%':'â€”');
      l2.textContent='æ¹¿åº¦ï¼š'+(o.humidity!=null?Math.round(o.humidity)+'%':'â€”')+'ã€€æ°—åœ§ï¼š'+(o.pressure!=null?Math.round(o.pressure)+'hPa':'â€”')+' ['+o.trend+']';
      applyThemeByCode(o.code);
    }
    function fetchWx(lat,lon){
      const url='https://api.open-meteo.com/v1/forecast?latitude='+lat+'&longitude='+lon+'&current_weather=true&hourly=pressure_msl,relative_humidity_2m,precipitation_probability&timezone=Asia%2FTokyo';
      fetch(url).then(r=>r.json()).then(data=>{
        const c=data.current_weather||{};
        const times=(data.hourly&&data.hourly.time)||[];
        const pArr=(data.hourly&&data.hourly.pressure_msl)||[];
        const hArr=(data.hourly&&data.hourly.relative_humidity_2m)||[];
        const prArr=(data.hourly&&data.hourly.precipitation_probability)||[];
        const idx=(c.time&&times.length)?nearestIndex(times,c.time):-1;
        const p=(idx>-1&&pArr.length)?pArr[idx]:null;
        const h=(idx>-1&&hArr.length)?hArr[idx]:null;
        const pr=(idx>-1&&prArr.length)?prArr[idx]:null;
        const trend=(idx>-1)?pressureTrend(pArr,idx):'å®‰å®š';
        state.wx={temp:c.temperature,code:c.weathercode,pressure:p,humidity:h,pprob:pr,trend:trend};
        renderWx(state.wx);
      }).catch(()=>renderWx(null));
    }
    function autoWx(){
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(
          pos=>fetchWx(pos.coords.latitude,pos.coords.longitude),
          ()=>fetchWx(fallback.lat,fallback.lon),
          {enableHighAccuracy:true,timeout:6000,maximumAge:600000}
        );
      }else{ fetchWx(fallback.lat,fallback.lon); }
    }
    document.getElementById("useGeo").addEventListener("click",autoWx);
    autoWx();

    // â”€â”€ ä¿å­˜ï¼ˆãƒãƒ¼ã‚¸ä¿å­˜ï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById("saveBtn").addEventListener("click",function(){
      const payload = {
        date: toKey(new Date()),
        wx: state.wx,
        mood: $("#moodSel").value || "",
        conditions: Array.from($("#condSel").selectedOptions).map(o=>o.text),
        sleepH: Number($("#sleepH").value)||0,
        sleepM: Number($("#sleepM").value)||0,
        weight: $("#weight").value ? Number($("#weight").value) : null,
        bodyFat: $("#bodyFat").value ? Number($("#bodyFat").value) : null,
        memo: $("#freeMemo").value || "",
        habits: {
          curtain: $("#h_curtain").checked,
          bed:     $("#h_bed").checked,
          change:  $("#h_change").checked,
          teeth:   $("#h_teeth").checked,
          skin:    $("#h_skin").checked,
          hair:    $("#h_hair").checked
        },
        ts: Date.now()
      };

      const all = loadAll();
      const idx = all.findIndex(x => x.date === payload.date);
      const merged = (idx >= 0) ? mergePayload(all[idx], payload) : payload;

      if(idx >= 0) all[idx] = merged; else all.unshift(merged);
      all.sort((a,b)=>a.date < b.date ? 1 : -1);
      saveAll(all);

      renderHistory();
      alert("ä¿å­˜ï¼ˆè¿½è¨˜ï¼‰ã—ã¾ã—ãŸ");
    });

    // åˆå›å±¥æ­´è¡¨ç¤º
    renderHistory();

    // ãƒ“ãƒ«ãƒ‰IDè¡¨ç¤ºï¼†ã‚³ãƒ”ãƒ¼
    const chip=$("#buildChip");
    chip.textContent=document.querySelector('meta[name="x-build-id"]').content;
    chip.addEventListener('click',()=>{
      navigator.clipboard && navigator.clipboard.writeText(chip.textContent);
      chip.textContent='âœ… ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ';
      setTimeout(()=>chip.textContent=document.querySelector('meta[name="x-build-id"]').content,1200);
    });
  });
})();
</script>
</body>
</html>
