<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>MorningDash â€” v13</title>
<meta name="theme-color" content="#0f172a">

<!-- ===== base theme ===== -->
<!-- v14 header/spacing patch (inline) -->
<style id="md-v14-patch">
:root{
  --md-hero-gap: 8px;         /* ä»¥å‰ã‚ˆã‚Šã•ã‚‰ã«è©°ã‚ã‚‹ */
  --md-brand-opacity:.5; 
  --md-brand-scale:.55; 
  --md-line-tight:1.12;       /* å…¨ä½“ã®è¡Œé–“ã‚’ã•ã‚‰ã«ã‚¿ã‚¤ãƒˆã« */
}
/* å…¨ä½“ã®è¡Œé–“ã‚’çµ±ä¸€ã—ã¦å°‘ã—ã ã‘è©°ã‚ã‚‹ */
body,.container,.card,.text,.row,h1,h2,h3,p,li,label,input,button{
  line-height:var(--md-line-tight);
}

/* ãƒ’ãƒ¼ãƒ­ãƒ¼ï¼ˆä¸Šéƒ¨ï¼‰ã®2ã‚«ãƒ©ãƒ ã€‚å·¦ï¼šæ—¥ä»˜ã€å³ï¼šå¹´/æ›œæ—¥/æ™‚åˆ»/ãƒ­ã‚´ */
.header,.titlebar{align-items:flex-start;}
.md-hero{
  display:flex; justify-content:space-between; align-items:flex-start;
  gap:var(--md-hero-gap);
  margin-bottom:clamp(6px,2vh,18px);
}

/* å·¦ï¼šæœˆ/æ—¥ï¼ˆå¤§ãã„è¡¨ç¤ºï¼‰ */
.md-hero .date-mmdd,.date-big{
  font-weight:800;
  font-size:clamp(44px,12vw,92px);
  letter-spacing:.02em;
  margin:0;
}

/* å³ã‚¹ã‚¿ãƒƒã‚¯ï¼ˆå¹´â†’æ›œæ—¥â†’æ™‚åˆ»ï¼‰ã€‚è¡Œé–“ã‚’ã•ã‚‰ã«è©°ã‚ã‚‹ */
.md-hero .right-stack{
  display:flex; flex-direction:column; align-items:flex-start;
  gap:2px;        /* â†è¡Œé–“ã‚’è©°ã‚ã‚‹è¦ */
}
.md-hero .year{ font-size:clamp(14px,3.6vw,20px); font-weight:700; }
.md-hero .dow{  font-size:clamp(16px,4.2vw,22px); font-weight:800; color:#0ea5e9; }
.md-hero .time{ font-size:clamp(16px,4.2vw,24px); font-weight:800; font-style:italic; }

/* å³ä¸Šã®ã€ŒMorningDashã€ã‚’å³å¯„ã›ãƒ»åŠé€æ˜ãƒ»ã‚„ã‚„å°ã•ã */
.md-brand{
  position:absolute; right:12px; top:10px;
  transform:scale(var(--md-brand-scale)); transform-origin:top right;
  opacity:var(--md-brand-opacity); font-weight:800;
}

/* ã€Œæ—¥ä»˜ãƒœã‚¿ãƒ³ï¼ä¿å­˜ï¼CSVï¼JSONã€è¡Œã®é«˜ã•ã¨ä½™ç™½ã‚’çœã‚¹ãƒšãƒ¼ã‚¹åŒ– */
.toolbar-compact{ display:flex; flex-wrap:wrap; gap:8px 10px; margin:8px 0 12px; }
.toolbar-compact .btn{ padding:8px 12px; border-radius:12px; }
.toolbar-compact .btn.small{ padding:6px 10px; }
.toolbar-compact .chip{ padding:6px 10px; }

/* ã‚»ã‚¯ã‚·ãƒ§ãƒ³é–“ã®ä¸Šä¸‹ãƒãƒ¼ã‚¸ãƒ³ã‚‚è©°ã‚ã‚‹ */
.section,.card,.panel{ margin-block:10px !important; }

/* ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå†…ã®è¡Œé–“ã‚‚å°‘ã—è©°ã‚ã‚‹ï¼ˆè¦‹å‡ºã—ã¾ã‚ã‚Šï¼‰ */
.card h2{ margin:0 0 8px 0; }
/* ç”»é¢å¹…ãŒç‹­ã„æ™‚ã®å¾®èª¿æ•´ */
@media (max-width:420px){
  .md-hero .date-mmdd,.date-big{ font-size:clamp(40px,15vw,84px); }
}
</style>

</head>

<body>
  <div class="container">
    <!-- ===== Header (v13) ===== -->
    <div class="head">
      <div class="brandGhost">MorningDash</div>
      <div class="dateWrap">
        <div class="bigDate">
          <span class="bigMD" id="mdM">08</span>
          <span class="mdSep">/</span>
          <span class="bigMD" id="mdD">16</span>
        </div>
        <div class="sideInfo">
          <div class="year" id="mdY">2025</div>
          <div class="wday" id="mdW">åœŸæ›œæ—¥</div>
          <div class="clock" id="mdT">11:16</div>
        </div>
      </div>
    </div>

    <!-- ===== Tool bar ===== -->
    <div class="row" style="justify-content:space-between;align-items:center;margin:4px 2px 8px">
      <div class="row">
        <input id="datePicker" type="date" class="input" style="padding:8px 10px">
        <span id="editBadge" class="badge" style="display:none">ç·¨é›†ãƒ¢ãƒ¼ãƒ‰</span>
      </div>
      <div class="row">
        <button id="saveLog" class="btn primary">ã“ã®æ—¥ã®è¨˜éŒ²ã‚’ä¿å­˜</button>
        <button id="exportCSV" class="btn">CSV</button>
        <button id="exportJSON" class="btn">JSON</button>
        <label class="btn small" for="importJSON" style="cursor:pointer">JSONã‚’èª­ã¿è¾¼ã¿</label>
        <input id="importJSON" type="file" accept="application/json" style="display:none">
      </div>
    </div>

    <!-- ===== Weather ===== -->
    <section class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h2>å¤©æ°—ï¼ˆç¾åœ¨åœ°ï¼‰</h2>
        <span id="wxLoading" class="muted" style="display:none">å–å¾—ä¸­â€¦</span>
      </div>
      <div id="wxError" class="text danger"></div>
      <div id="wxBlock" class="row"></div>
      <div class="row" style="margin-top:8px">
        <button id="retryWx" class="btn small">å†å–å¾—</button>
      </div>
    </section>

    <!-- ===== Mood & Energy ===== -->
    <section class="grid2">
      <div class="card">
        <h2>æ°—åˆ†</h2>
        <div id="moodBtns" class="row"></div>
      </div>
      <div class="card">
        <h2>å…ƒæ°—åº¦</h2>
        <div id="energyBtns" class="row"></div>
      </div>
    </section>

    <!-- ===== Symptoms & Sleep ===== -->
    <section class="grid2">
      <div class="card">
        <h2>ä½“èª¿ãƒ¡ãƒ¢</h2>
        <div class="section" style="margin:8px 0">
          <h3>â‘  ã‚ˆãã‚ã‚‹ä¸èª¿</h3>
          <div id="symptomGroup1" class="row"></div>
        </div>
        <div class="section" style="margin:8px 0">
          <h3>â‘¡ å­£ç¯€ãƒ»ç”Ÿæ´»ãƒªã‚ºãƒ </h3>
          <div id="symptomGroup2" class="row"></div>
        </div>
        <div class="section" style="margin:8px 0">
          <h3>â‘¢ ãƒ¡ãƒ³ã‚¿ãƒ«ãƒ»ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³</h3>
          <div id="symptomGroup3" class="row"></div>
        </div>
        <textarea id="note" rows="3" placeholder="è‡ªç”±ãƒ¡ãƒ¢ï¼ˆä¾‹ï¼šé¦–ã®å¼µã‚Šå¼·ã‚ï¼å†·ãˆæ°—å‘³ ãªã©ï¼‰"></textarea>
      </div>

      <div class="card">
        <h2>ç¡çœ </h2>
        <div class="row" style="align-items:center;margin-bottom:8px">
          <div style="flex:1">
            <label class="muted">æ™‚é–“</label>
            <input id="sleepH" class="input" type="number" min="0" max="23" value="0">
          </div>
          <div style="flex:1">
            <label class="muted">åˆ†</label>
            <input id="sleepM" class="input" type="number" min="0" max="59" value="0">
          </div>
        </div>
        <div class="text muted" style="margin-bottom:6px">â€» ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆé€£æºã§è‡ªå‹•å…¥åŠ›ï¼ˆ?sleepMin=åˆè¨ˆåˆ†ï¼‰</div>
        <div class="text">åˆè¨ˆï¼š<b id="sleepTotal">0æ™‚é–“0åˆ†</b></div>

        <div class="card" style="margin-top:12px">
          <h3>ãƒ˜ãƒ«ã‚¹ï¼ˆä»»æ„ï¼‰</h3>
          <div class="row" style="align-items:center">
            <span>ä½“é‡</span>
            <input id="weight" class="input" type="number" step="0.1" min="0" style="width:90px">
            <span>kg</span>
            <span style="margin-left:8px">ä½“è„‚è‚ª</span>
            <input id="bodyFat" class="input" type="number" step="0.1" min="0" max="100" style="width:90px">
            <span>%</span>
          </div>
          <div class="row" style="align-items:center;margin-top:8px">
            <button id="copyHealthShortcut" class="btn small">ãƒ˜ãƒ«ã‚¹å–ã‚Šè¾¼ã¿ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆç”¨URLã‚’ã‚³ãƒ”ãƒ¼</button>
          </div>
          <div class="text muted" style="margin-top:6px">â€» ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã§ãƒ˜ãƒ«ã‚¹ã‚±ã‚¢ã‹ã‚‰å–å¾—â†’URLã§ <code>?sleepMin=&weight=&bodyFat=</code> ã‚’æ¸¡ã™ã¨è‡ªå‹•å…¥åŠ›</div>
        </div>
      </div>
    </section>

    <!-- ===== History ===== -->
    <section class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h2>å±¥æ­´</h2>
        <button id="reloadHistory" class="btn small">å±¥æ­´ã‚’å†èª­è¾¼</button>
      </div>
      <div id="history"></div>
    </section>

    <div class="footer">
      <p>Tips: å…±æœ‰ â†’ ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ  ã§ã‚¢ãƒ—ãƒªé¢¨ã«ä½¿ãˆã¾ã™ã€‚</p>
      <p>ä¿å­˜å…ˆã¯ã“ã®ç«¯æœ«ã®ãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆlocalStorageï¼‰ã€‚åŒã˜URLãªã‚‰ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã—ã¦ã‚‚å±¥æ­´ã¯ç¶™ç¶šåˆ©ç”¨ã•ã‚Œã¾ã™ã€‚</p>
    </div>
  </div>

<script>
(function(){
  const $ = (s) => document.querySelector(s);
  const $$ = (s) => Array.from(document.querySelectorAll(s));

  // ===== date/time =====
  const tz = "Asia/Tokyo";
  const z2 = n => String(n).padStart(2,"0");
  const toKey = (d) => d.toLocaleDateString("ja-JP", { timeZone: tz });
  const toInputDate = d => `${d.getFullYear()}-${z2(d.getMonth()+1)}-${z2(d.getDate())}`;
  const fromInputDate = s => { const [y,m,da]=s.split("-").map(Number); return new Date(y, m-1, da); };

  const wdJP = ["æ—¥æ›œæ—¥","æœˆæ›œæ—¥","ç«æ›œæ—¥","æ°´æ›œæ—¥","æœ¨æ›œæ—¥","é‡‘æ›œæ—¥","åœŸæ›œæ—¥"];
  function renderHeaderDate(d){
    $("#mdM").textContent = z2(d.getMonth()+1);
    $("#mdD").textContent = z2(d.getDate());
    $("#mdY").textContent = String(d.getFullYear());
    $("#mdW").textContent = wdJP[d.getDay()];
  }
  function tickClock(){
    const now = new Date();
    $("#mdT").textContent = now.toLocaleTimeString("ja-JP",{hour:"2-digit",minute:"2-digit",hour12:false});
  }
  setInterval(tickClock, 1000); tickClock();

  const today = new Date();
  const todayKey = toKey(today);
  let currentDateKey = todayKey;
  let currentDate = today;

  const datePicker = $("#datePicker");
  datePicker.value = toInputDate(today);
  renderHeaderDate(today);
  $("#editBadge").style.display = "none";

  datePicker.addEventListener("change", () => {
    const d = fromInputDate(datePicker.value);
    currentDate = d; currentDateKey = toKey(d);
    renderHeaderDate(d);
    $("#editBadge").style.display = (currentDateKey === todayKey) ? "none" : "inline-block";
    loadLogToForm(loadLog(currentDateKey));
  });

  // ===== state =====
  const state = {
    mood: "", energy: "", symptoms: [], note:"",
    sleepH:0, sleepM:0, weight:null, bodyFat:null,
    weather:null,
    quickTasks:[{done:false,text:""},{done:false,text:""},{done:false,text:""}],
  };

  // UI chips
  const moods = [{v:"ğŸ™‚",label:"è‰¯ã„"},{v:"ğŸ˜",label:"ãµã¤ã†"},{v:"ğŸ™",label:"ã„ã¾ã„ã¡"}];
  const energies = ["â¤ï¸â€ğŸ”¥å…ƒæ°—","â¤ï¸ã¾ãšã¾ãš","â¤ï¸â€ğŸ©¹ã ã‚‹ã„"];
  const group1 = ["é¦–ãƒ»è‚©ã“ã‚Š","é ­ç—›","è…¹ç—›ï¼ãŠè…¹ã®å¼µã‚Š","è…°ã®å¼µã‚Šï¼è…°ç—›","èƒƒè…¸å¼±ã‚ï¼ˆèƒƒã‚‚ãŸã‚Œãƒ»ä¸‹ç—¢ãƒ»ä¾¿ç§˜ãªã©ï¼‰","ã‚€ãã¿","ç›®ã®ç–²ã‚Œï¼ãƒ‰ãƒ©ã‚¤ã‚¢ã‚¤","è‡ªå¾‹ç¥çµŒã®ä¹±ã‚Œ","ç¡çœ ã®è³ªä½ä¸‹ï¼ˆæµ…ã„çœ ã‚Šãƒ»é€”ä¸­è¦šé†’ï¼‰","ç”Ÿç†"];
  const group2 = ["å†·ãˆï¼ˆæ‰‹è¶³ã®å†·ãˆãƒ»å…¨èº«ï¼‰","æš‘ã•ãƒãƒ†ï¼ç†±ã£ã½ã•","å–‰ã®ç—›ã¿ãƒ»å£°æ¯ã‚Œ","é¼»æ°´ãƒ»é¼»ã¥ã¾ã‚Š","è‚Œè’ã‚Œï¼ã‹ã‚†ã¿","èŠ±ç²‰ãƒ»ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ç—‡çŠ¶"];
  const group3 = ["é›†ä¸­åŠ›ä½ä¸‹","ã‚¤ãƒ©ã‚¤ãƒ©ï¼ä¸å®‰æ„Ÿ","ã ã‚‹ã•ï¼å€¦æ€ æ„Ÿ","ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ä½ä¸‹","PMSï¼ˆç”Ÿç†å‰ç—‡çŠ¶ï¼‰"];
  const allSymptoms = [...group1,...group2,...group3];

  function buildChips(root, options, isActive, onClick){
    root.innerHTML = "";
    options.forEach(opt => {
      const v = typeof opt === "string" ? opt : opt.v;
      const label = typeof opt === "string" ? opt : (opt.v+" "+opt.label);
      const b = document.createElement("button");
      b.className = "chip" + (isActive(v) ? " active" : "");
      b.textContent = label;
      b.addEventListener("click", () => onClick(v));
      root.appendChild(b);
    });
  }
  function renderChips(){
    buildChips($("#moodBtns"), moods, v => state.mood===v, v => { state.mood=v; renderChips(); autoSave(); });
    buildChips($("#energyBtns"), energies, v => state.energy===v, v => { state.energy=v; renderChips(); autoSave(); });
    const mk = (id, arr) => buildChips($(id), arr, v => state.symptoms.includes(v), v => {
      if (state.symptoms.includes(v)) state.symptoms = state.symptoms.filter(x=>x!==v);
      else state.symptoms = [...state.symptoms, v];
      renderChips(); autoSave();
    });
    mk("#symptomGroup1", group1); mk("#symptomGroup2", group2); mk("#symptomGroup3", group3);
  }
  renderChips();

  // ===== Weather =====
  const wxLoading=$("#wxLoading"), wxError=$("#wxError"), wxBlock=$("#wxBlock");
  function wxCodeToText(code){ const map={0:"å¿«æ™´",1:"æ™´ã‚Œ",2:"è–„æ›‡ã‚Š",3:"æ›‡ã‚Š",45:"éœ§",48:"éœ§æ°·",51:"å¼±ã„éœ§é›¨",53:"éœ§é›¨",55:"å¼·ã„éœ§é›¨",61:"å¼±ã„é›¨",63:"é›¨",65:"å¼·ã„é›¨",71:"å¼±ã„é›ª",73:"é›ª",75:"å¤§é›ª",95:"é›·é›¨"}; return map[code]||"â€”"; }
  function renderWeather(){
    wxBlock.innerHTML="";
    if (!state.weather){ const p=document.createElement("p"); p.className="text muted"; p.textContent="ä½ç½®æƒ…å ±ã®è¨±å¯å¾Œã€è‡ªå‹•è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚"; wxBlock.appendChild(p); return; }
    const icon = document.createElement("div");
    icon.style.fontSize="48px";
    const code = state.weather.code||0;
    icon.textContent = (code>=61&&code<=65) ? "ğŸŒ§ï¸" : (code===0||code===1?"â˜€ï¸": (code===2?"ğŸŒ¤ï¸": (code===3?"â˜ï¸":"ğŸŒ¦ï¸")));
    const big=document.createElement("div"); big.style.fontSize="40px"; big.style.fontWeight="700"; big.textContent=Math.round(state.weather.temp)+"Â°C";
    const small=document.createElement("div"); small.className="text"; small.style.marginTop="4px";
    const lines=[]; lines.push("çŠ¶æ³ï¼š"+state.weather.condition); lines.push("é¢¨ï¼š"+Math.round(state.weather.wind)+"m/s");
    if (state.weather.humidity!=null) lines.push("æ¹¿åº¦ï¼š"+Math.round(state.weather.humidity)+"%");
    small.innerHTML = lines.join("ã€€");
    const wrap=document.createElement("div"); wrap.className="row"; wrap.style.alignItems="center";
    wrap.appendChild(icon); wrap.appendChild(big); wrap.appendChild(small);
    wxBlock.appendChild(wrap);
  }
  function fetchWeatherFromGeo(lat, lon){
    wxLoading.style.display="inline"; wxError.textContent="";
    const u = new URL("https://api.open-meteo.com/v1/forecast");
    u.searchParams.set("latitude", lat);
    u.searchParams.set("longitude", lon);
    u.searchParams.set("current_weather","true");
    u.searchParams.set("hourly","precipitation_probability,relativehumidity_2m");
    u.searchParams.set("timezone","Asia/Tokyo");
    fetch(u.toString()).then(r=>r.json()).then(data=>{
      const c=data.current_weather||{};
      const times=(data.hourly&&data.hourly.time)||[]; const idx = times.indexOf(c.time);
      const hum = (idx>-1 && data.hourly.relativehumidity_2m) ? data.hourly.relativehumidity_2m[idx] : null;
      state.weather={
        temp:c.temperature, wind:c.windspeed, code:c.weathercode, condition:wxCodeToText(c.weathercode),
        humidity:hum
      };
      renderWeather(); autoSave();
    }).catch(e=>{ wxError.textContent="å¤©æ°—ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"; })
     .finally(()=>{ wxLoading.style.display="none"; });
  }
  function askGeo(){
    wxLoading.style.display="inline"; wxError.textContent="";
    if (!("geolocation" in navigator)){ wxError.textContent="ã“ã®ç«¯æœ«ã¯ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚"; wxLoading.style.display="none"; return; }
    navigator.geolocation.getCurrentPosition(
      pos => { const {latitude, longitude}=pos.coords; fetchWeatherFromGeo(latitude, longitude); },
      err => { wxError.textContent="ä½ç½®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚è¨­å®šã§Safariã«ä½ç½®æƒ…å ±ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚"; wxLoading.style.display="none"; },
      { enableHighAccuracy:false, timeout:8000 }
    );
  }
  $("#retryWx").addEventListener("click", askGeo);
  askGeo();

  // ===== Storage & history =====
  const LOGS_KEY="md_logs_v2";
  function loadAllLogs(){ return JSON.parse(localStorage.getItem(LOGS_KEY)||"[]"); }
  function saveAllLogs(arr){ localStorage.setItem(LOGS_KEY, JSON.stringify(arr)); }
  function loadLog(dateKey){ const logs = loadAllLogs(); return logs.find(l => l.date === dateKey) || null; }
  function upsertLog(payload){
    const logs = loadAllLogs();
    const rest = logs.filter(l => l.date !== payload.date);
    saveAllLogs([payload, ...rest].sort((a,b)=> (a.date < b.date ? 1 : -1)));
  }

  // ===== form sync =====
  function updateSleepLabel(){ $("#sleepTotal").textContent = Math.floor(state.sleepH)+"æ™‚é–“"+(state.sleepM%60)+"åˆ†"; }
  function syncFormFromState(){
    $("#sleepH").value = state.sleepH; $("#sleepM").value = state.sleepM; updateSleepLabel();
    $("#note").value = state.note;
    $("#weight").value = state.weight ?? "";
    $("#bodyFat").value = state.bodyFat ?? "";
  }
  function loadLogToForm(log){
    if (!log){
      state.mood=""; state.energy=""; state.symptoms=[]; state.note="";
      state.sleepH=0; state.sleepM=0; state.weight=null; state.bodyFat=null;
    }else{
      state.mood=log.mood||""; state.energy=log.energy||"";
      state.symptoms=Array.isArray(log.symptoms)? log.symptoms.filter(s=>allSymptoms.includes(s)):[];
      const sm=parseInt(log.sleepMin||0,10); state.sleepH=Math.floor(sm/60); state.sleepM=sm%60;
      state.weight = (log.weight ?? null); state.bodyFat=(log.bodyFat ?? null);
      state.note=log.note||""; state.weather=log.weather||state.weather;
    }
    renderChips(); syncFormFromState(); renderHistory();
  }

  // ===== auto-save =====
  let saveTimer=null;
  function autoSave(){
    clearTimeout(saveTimer);
    saveTimer = setTimeout(()=>{
      const payload = {
        date: currentDateKey,
        mood: state.mood, energy: state.energy, symptoms: state.symptoms,
        sleepMin: (parseInt(state.sleepH,10)||0)*60 + (parseInt(state.sleepM,10)||0),
        weight: state.weight, bodyFat: state.bodyFat,
        note: state.note, weather: state.weather, quickTasks: state.quickTasks, ts: Date.now()
      };
      upsertLog(payload); renderHistory();
    }, 350);
  }

  // ===== history render =====
  function renderHistory(){
    const root=$("#history"); const logs=loadAllLogs(); root.innerHTML="";
    if (!logs.length){ const p=document.createElement("p"); p.className="text muted"; p.textContent="ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“"; root.appendChild(p); return; }
    logs.forEach(l=>{
      const box=document.createElement("div"); box.className="card"; box.style.marginTop="8px";
      const head=document.createElement("div"); head.className="text"; head.innerHTML=`<span class="muted">${l.date}</span>`;
      const row=document.createElement("div"); row.className="row text"; row.style.marginTop="6px";
      row.innerHTML=`<div>æ°—åˆ†ï¼š${l.mood||"â€”"}</div>
                     <div>å…ƒæ°—åº¦ï¼š${l.energy||"â€”"}</div>
                     <div>ç¡çœ ï¼š${Math.floor((l.sleepMin||0)/60)}æ™‚é–“${(l.sleepMin||0)%60}åˆ†</div>
                     ${l.weight!=null?`<div>ä½“é‡ï¼š${l.weight}kg</div>`:""}
                     ${l.bodyFat!=null?`<div>ä½“è„‚è‚ªï¼š${l.bodyFat}%</div>`:""}`;
      const memo=document.createElement("div"); memo.className="text"; if(l.note){ memo.textContent="ãƒ¡ãƒ¢ï¼š"+l.note; }
      const actions=document.createElement("div"); actions.className="row"; actions.style.marginTop="8px";
      const editBtn=document.createElement("button"); editBtn.className="btn small"; editBtn.textContent="ç·¨é›†";
      editBtn.onclick=()=>{ currentDateKey=l.date; currentDate = new Date(l.date); renderHeaderDate(currentDate); $("#editBadge").style.display="inline-block"; loadLogToForm(l); window.scrollTo({top:0,behavior:"smooth"}); };
      const delBtn=document.createElement("button"); delBtn.className="btn small"; delBtn.textContent="å‰Šé™¤";
      delBtn.onclick=()=>{ if(!confirm(`${l.date} ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`))return; const rest=loadAllLogs().filter(x=>x.date!==l.date); saveAllLogs(rest); renderHistory(); };
      actions.appendChild(editBtn); actions.appendChild(delBtn);
      box.appendChild(head); box.appendChild(row); if(memo.textContent)box.appendChild(memo); box.appendChild(actions);
      root.appendChild(box);
    });
  }
  $("#reloadHistory").addEventListener("click", renderHistory);

  // ===== buttons & helpers =====
  $("#saveLog").addEventListener("click", ()=>{ autoSave(); alert(`${currentDateKey} ã®è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸ`); });

  $("#exportCSV").addEventListener("click", ()=>{
    const logs=loadAllLogs(); if(!logs.length){ alert("ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“"); return; }
    const header=["date","mood","energy","sleepMin","weight","bodyFat","note"].join(",");
    const rows=logs.map(l=>[l.date,l.mood||"",l.energy||"",l.sleepMin||0,l.weight??"",l.bodyFat??"", (l.note||"").replace(/,/g," ")] .join(","));
    const csv=[header,...rows].join("\n");
    const blob=new Blob([csv],{type:"text/csv"}); const url=URL.createObjectURL(blob);
    const a=document.createElement("a"); a.href=url; a.download="morningdash.csv"; a.click(); URL.revokeObjectURL(url);
  });
  $("#exportJSON").addEventListener("click", ()=>{
    const data = JSON.stringify(loadAllLogs(), null, 2);
    const blob=new Blob([data],{type:"application/json"}); const url=URL.createObjectURL(blob);
    const a=document.createElement("a"); a.href=url; a.download="morningdash.json"; a.click(); URL.revokeObjectURL(url);
  });
  $("#importJSON").addEventListener("change", async (e)=>{
    const f=e.target.files?.[0]; if(!f) return;
    const txt=await f.text(); try{ const arr=JSON.parse(txt); if(Array.isArray(arr)){ saveAllLogs(arr); alert("èª­ã¿è¾¼ã¿ã¾ã—ãŸ"); renderHistory(); } }catch(_){ alert("JSONã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ"); }
  });
  $("#copyHealthShortcut").addEventListener("click", async ()=>{
    const base = window.location.origin + window.location.pathname;
    const template = `${base}?sleepMin=[[åˆè¨ˆç¡çœ åˆ†]]&weight=[[ä½“é‡_kg]]&bodyFat=[[ä½“è„‚è‚ª_%]]`;
    try{ await navigator.clipboard.writeText(template); alert("ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆç”¨URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"); }catch(e){ alert(template); }
  });

  // ===== URL params ingest (sleepMin/weight/bodyFat ã»ã‹) =====
  const url = new URL(window.location.href);
  const qp = k => url.searchParams.get(k);
  function parseNumMaybe(v){ if(v==null) return null; const n=parseFloat(String(v)); return isNaN(n)?null:n; }
  const payload = {};
  if (qp("sleepMin")!=null) payload.sleepMin = parseInt(qp("sleepMin"),10)||0;
  if (qp("mood")) payload.mood = qp("mood");
  if (qp("energy")) payload.energy = qp("energy");
  if (qp("symptoms")) payload.symptoms = qp("symptoms").split(",").filter(Boolean);
  if (qp("note")) payload.note = qp("note");
  const wnum=parseNumMaybe(qp("weight")); if(wnum!=null) payload.weight = wnum;
  const bnum=parseNumMaybe(qp("bodyFat")); if(bnum!=null) payload.bodyFat = bnum;

  // ===== initial load =====
  function initial(){
    renderHistory();
    // æ—¢å­˜ãƒ­ã‚°ã‚’èª­ã¿è¾¼ã¿
    const saved=loadLog(todayKey);
    if (saved) loadLogToForm(saved); else loadLogToForm(null);

    // QP override
    let changed=false;
    if (payload.sleepMin!=null){ state.sleepH=Math.floor(payload.sleepMin/60); state.sleepM=payload.sleepMin%60; changed=true; }
    if (payload.mood){ state.mood=payload.mood; changed=true; }
    if (payload.energy){ state.energy=payload.energy; changed=true; }
    if (payload.symptoms){ state.symptoms=payload.symptoms; changed=true; }
    if (payload.note){ state.note=payload.note; changed=true; }
    if (payload.weight!=null){ state.weight=payload.weight; changed=true; }
    if (payload.bodyFat!=null){ state.bodyFat=payload.bodyFat; changed=true; }
    if (changed){ renderChips(); syncFormFromState(); autoSave(); }
  }
  initial();

  // form handlers
  $("#sleepH").addEventListener("input", ()=>{ state.sleepH=parseInt($("#sleepH").value||0,10); updateSleepLabel(); autoSave(); });
  $("#sleepM").addEventListener("input", ()=>{ state.sleepM=parseInt($("#sleepM").value||0,10); updateSleepLabel(); autoSave(); });
  $("#note").addEventListener("input", ()=>{ state.note=$("#note").value; autoSave(); });
  $("#weight").addEventListener("input", ()=>{ const n=parseFloat($("#weight").value); state.weight=isNaN(n)?null:n; autoSave(); });
  $("#bodyFat").addEventListener("input", ()=>{ const n=parseFloat($("#bodyFat").value); state.bodyFat=isNaN(n)?null:n; autoSave(); });
})();
</script>
</body>
</html>
