<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>MorningDash â€” v14</title>
<meta name="theme-color" content="#0f172a" />

<!-- ===== unified styles (v14) ===== -->
<style>
:root{
  /* è‰² */
  --bg1:#ffffff; --bg2:#f1f5f9; --fg:#0f172a; --muted:#64748b;
  --accent:#0ea5e9; --accent-press:#0284c7;
  --card:#ffffff; --border:#e5e7eb;

  /* ä½™ç™½ãƒ»è§’ä¸¸ãƒ»å½± */
  --radius:16px; --shadow:0 6px 20px rgba(2,8,23,.06);

  /* v14 è¿½åŠ ï¼ˆè¡Œé–“ï¼†ãƒ˜ãƒƒãƒ€ãƒ¼é–“éš”ï¼‰ */
  --line-tight:1.12;
  --hero-gap:8px;
  --brand-scale:.55;
  --brand-opacity:.5;
}

/* ãƒ™ãƒ¼ã‚¹ */
html,body{height:100%; background:linear-gradient(var(--bg1),var(--bg2)); color:var(--fg);}
body{margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";}
*,*::before,*::after{box-sizing:border-box}
p,li,label,button,input,textarea,h1,h2,h3,.row,.card,.container{ line-height:var(--line-tight); }

.container{max-width:980px; margin:0 auto; padding:16px;}

/* ã‚«ãƒ¼ãƒ‰/ãƒ‘ãƒãƒ« */
.card,.panel,.section{
  background:var(--card); border:1px solid var(--border); border-radius:var(--radius);
  box-shadow:var(--shadow); padding:16px; margin-block:10px;
  overflow:hidden;                                   /* iOSè§’ä¸¸ã«ã˜ã¿å¯¾ç­– */
  -webkit-mask-image: -webkit-radial-gradient(white, black);
}
.card h2{margin:0 0 8px 0}
h1{font-size:28px; margin:0}

/* ãƒœã‚¿ãƒ³ */
.btn{appearance:none; border:1px solid var(--border); border-radius:14px; padding:10px 14px; background:#fff; cursor:pointer}
.btn.primary{background:var(--accent); border-color:var(--accent); color:#fff}
.btn.small{font-size:12px; padding:6px 10px}
.btn.tiny{font-size:11px; padding:4px 8px; border-radius:10px}
.btn:hover{filter:brightness(0.98)} .btn.primary:hover{background:var(--accent-press)}
.input{border:1px solid var(--border); border-radius:12px; padding:10px 12px; font-size:14px; background:#fff}

/* ãƒ•ãƒ¬ãƒƒã‚¯ã‚¹è¡Œ */
.row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}

/* ---- v14 ãƒ’ãƒ¼ãƒ­ãƒ¼ï¼ˆä¸Šéƒ¨ãƒ˜ãƒƒãƒ€ãƒ¼ï¼‰ ---- */
.head{position:relative; margin-bottom:clamp(6px,2vh,18px);}
.brandGhost{
  position:absolute; right:12px; top:10px; opacity:var(--brand-opacity);
  transform:scale(var(--brand-scale)); transform-origin:top right; font-weight:800;
}
.dateWrap{display:flex; gap:var(--hero-gap); align-items:flex-start}
.bigDate{display:flex; align-items:flex-end; gap:4px}
.bigMD{font-weight:800; font-size:clamp(44px,12vw,92px); letter-spacing:.02em}
.mdSep{font-size:clamp(28px,8vw,56px); transform:translateY(-4px)}
.sideInfo{display:flex; flex-direction:column; gap:2px; align-items:flex-start; margin-top:2px}
.sideInfo .year{font-size:clamp(14px,3.6vw,20px); font-weight:700}
.sideInfo .wday{font-size:clamp(16px,4.2vw,22px); font-weight:800; color:var(--accent)}
.sideInfo .clock{font-size:clamp(16px,4.2vw,24px); font-weight:800; font-style:italic}

/* æ–‡å­—ãƒ»ãƒ©ãƒ™ãƒ« */
.muted{color:var(--muted); opacity:.95}
.text{font-size:14px}

/* ãƒãƒƒãƒ—ï¼ˆé¸æŠè‚¢ãƒœã‚¿ãƒ³ï¼‰ */
.chip{
  border:1px solid var(--border); border-radius:999px; padding:6px 10px; background:#fff; cursor:pointer; font-size:13px;
  color:var(--fg) !important;
}
.chip.active{background:var(--accent) !important; border-color:var(--accent) !important; color:#fff !important}

/* å…¥åŠ›ã®ã¯ã¿å‡ºã—å¯¾ç­–ï¼ˆè‡ªç”±ãƒ¡ãƒ¢å³ç«¯ï¼‰ */
textarea, input[type="text"], input[type="number"], select{
  display:block; width:100%; max-width:100%; box-sizing:border-box;
}

/* ã‚°ãƒªãƒƒãƒ‰2åˆ—ï¼ˆãƒ¢ãƒã‚¤ãƒ«ã§ç¸¦ç©ã¿ï¼‰ */
.grid2{display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:12px}

/* ãƒãƒƒã‚¸ãªã© */
.badge{font-size:12px; padding:3px 8px; border-radius:999px; border:1px solid var(--border)}
.danger{color:#b91c1c}
.footer{font-size:12px; opacity:.7; margin-top:18px; line-height:1.6}
</style>
</head>

<body>
  <div class="container">
    <!-- ===== Header ===== -->
    <div class="head">
      <div class="brandGhost">Morning Dash</div>
      <div class="dateWrap">
        <div class="bigDate">
          <span class="bigMD" id="mdM">08</span><span class="mdSep">/</span><span class="bigMD" id="mdD">16</span>
        </div>
        <div class="sideInfo">
          <div class="year" id="mdY">2025</div>
          <div class="wday" id="mdW">åœŸæ›œæ—¥</div>
          <div class="clock" id="mdT">09:41</div>
        </div>
      </div>
    </div>

    <!-- ===== Tool bar ===== -->
    <div class="row" style="justify-content:space-between; margin:6px 2px 10px">
      <div class="row">
        <input id="datePicker" type="date" class="input" style="padding:8px 10px">
        <span id="editBadge" class="badge" style="display:none">ç·¨é›†ãƒ¢ãƒ¼ãƒ‰</span>
      </div>
      <div class="row">
        <button id="saveLog" class="btn primary">ã“ã®æ—¥ã®è¨˜éŒ²ã‚’ä¿å­˜</button>
        <button id="exportCSV" class="btn">CSV</button>
        <button id="exportJSON" class="btn">JSON</button>
        <label class="btn small" for="importJSON" style="cursor:pointer">JSONã‚’èª­ã¿è¾¼ã¿</label>
        <input id="importJSON" type="file" accept="application/json" style="display:none">
      </div>
    </div>

    <!-- ===== Weather ===== -->
    <section class="card">
      <div class="row" style="justify-content:space-between">
        <h2>å¤©æ°—ï¼ˆç¾åœ¨åœ°ï¼‰</h2>
        <span id="wxLoading" class="muted" style="display:none">å–å¾—ä¸­â€¦</span>
      </div>
      <div id="wxError" class="text danger"></div>
      <div id="wxBlock" class="row"></div>
      <div class="row" style="margin-top:6px">
        <button id="retryWx" class="btn small">å†å–å¾—</button>
      </div>
    </section>

    <!-- ===== Mood & Energy ===== -->
    <section class="grid2">
      <div class="card">
        <h2>æ°—åˆ†</h2>
        <div id="moodBtns" class="row"></div>
      </div>
      <div class="card">
        <h2>å…ƒæ°—åº¦</h2>
        <div id="energyBtns" class="row"></div>
      </div>
    </section>

    <!-- ===== Symptoms & Sleep ===== -->
    <section class="grid2">
      <div class="card">
        <h2>ä½“èª¿ãƒ¡ãƒ¢</h2>
        <div class="section" style="margin:8px 0">
          <h3 style="margin:0 0 6px">â‘  ã‚ˆãã‚ã‚‹ä¸èª¿</h3>
          <div id="symptomGroup1" class="row"></div>
        </div>
        <div class="section" style="margin:8px 0">
          <h3 style="margin:0 0 6px">â‘¡ å­£ç¯€ãƒ»ç”Ÿæ´»ãƒªã‚ºãƒ </h3>
          <div id="symptomGroup2" class="row"></div>
        </div>
        <div class="section" style="margin:8px 0">
          <h3 style="margin:0 0 6px">â‘¢ ãƒ¡ãƒ³ã‚¿ãƒ«ãƒ»ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³</h3>
          <div id="symptomGroup3" class="row"></div>
        </div>
        <textarea id="note" rows="3" placeholder="è‡ªç”±ãƒ¡ãƒ¢ï¼ˆä¾‹ï¼šé¦–ã®å¼µã‚Šå¼·ã‚ï¼å†·ãˆæ°—å‘³ ãªã©ï¼‰"></textarea>
      </div>

      <div class="card">
        <h2>ç¡çœ </h2>
        <div class="row" style="align-items:center; margin-bottom:6px">
          <div style="flex:1">
            <label class="muted">æ™‚é–“</label>
            <input id="sleepH" class="input" type="number" min="0" max="23" value="0">
          </div>
          <div style="flex:1">
            <label class="muted">åˆ†</label>
            <input id="sleepM" class="input" type="number" min="0" max="59" value="0">
          </div>
        </div>
        <div class="text muted" style="margin-bottom:4px">â€» ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆé€£æºã§è‡ªå‹•å…¥åŠ›ï¼ˆ?sleepMin=åˆè¨ˆåˆ†ï¼‰</div>
        <div class="text">åˆè¨ˆï¼š<b id="sleepTotal">0æ™‚é–“0åˆ†</b></div>

        <div class="card" style="margin-top:10px">
          <h3 style="margin:0 0 6px">ãƒ˜ãƒ«ã‚¹ï¼ˆä»»æ„ï¼‰</h3>
          <div class="row" style="align-items:center">
            <span>ä½“é‡</span>
            <input id="weight" class="input" type="number" step="0.1" min="0" style="width:90px">
            <span>kg</span>
            <span style="margin-left:8px">ä½“è„‚è‚ª</span>
            <input id="bodyFat" class="input" type="number" step="0.1" min="0" max="100" style="width:90px">
            <span>%</span>
          </div>
          <div class="row" style="align-items:center; margin-top:8px">
            <button id="copyHealthShortcut" class="btn small">ãƒ˜ãƒ«ã‚¹å–ã‚Šè¾¼ã¿ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆç”¨URLã‚’ã‚³ãƒ”ãƒ¼</button>
          </div>
          <div class="text muted" style="margin-top:4px">â€» URL ã§ <code>?sleepMin=&weight=&bodyFat=</code> ã‚’æ¸¡ã™ã¨è‡ªå‹•å…¥åŠ›</div>
        </div>
      </div>
    </section>

    <!-- ===== History ===== -->
    <section class="card">
      <div class="row" style="justify-content:space-between">
        <h2>å±¥æ­´</h2>
        <button id="reloadHistory" class="btn small">å†èª­è¾¼</button>
      </div>
      <div id="history"></div>
    </section>

    <div class="footer">
      <p>Tips: å…±æœ‰ â†’ ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ  ã§ã‚¢ãƒ—ãƒªé¢¨ã«ä½¿ãˆã¾ã™ã€‚</p>
      <p>ä¿å­˜å…ˆã¯ã“ã®ç«¯æœ«ã®ãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆlocalStorageï¼‰ã€‚åŒã˜URLãªã‚‰ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã—ã¦ã‚‚å±¥æ­´ã¯ç¶™ç¶šåˆ©ç”¨ã•ã‚Œã¾ã™ã€‚</p>
    </div>
  </div>

<!-- ===== Script ===== -->
<script>
(function(){
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));

  /* ==== æ—¥ä»˜ãƒ»æ™‚åˆ» ==== */
  const tz = "Asia/Tokyo";
  const z2 = n => String(n).padStart(2,"0");
  const wdJP = ["æ—¥æ›œæ—¥","æœˆæ›œæ—¥","ç«æ›œæ—¥","æ°´æ›œæ—¥","æœ¨æ›œæ—¥","é‡‘æ›œæ—¥","åœŸæ›œæ—¥"];
  const toKey = d => d.toLocaleDateString("ja-JP",{timeZone:tz});
  const toInputDate = d => `${d.getFullYear()}-${z2(d.getMonth()+1)}-${z2(d.getDate())}`;
  const fromInputDate = s => { const [y,m,d]=s.split("-").map(Number); return new Date(y, m-1, d); };

  function renderHeaderDate(d){
    $("#mdM").textContent = z2(d.getMonth()+1);
    $("#mdD").textContent = z2(d.getDate());
    $("#mdY").textContent = String(d.getFullYear());
    $("#mdW").textContent = wdJP[d.getDay()];
  }
  function tickClock(){
    const now = new Date();
    $("#mdT").textContent = now.toLocaleTimeString("ja-JP",{hour:"2-digit",minute:"2-digit",hour12:false});
  }
  setInterval(tickClock, 1000); tickClock();

  const today = new Date();
  const todayKey = toKey(today);
  let currentDateKey = todayKey;

  /* ==== ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ ==== */
  const datePicker = $("#datePicker");
  datePicker.value = toInputDate(today);
  renderHeaderDate(today);
  $("#editBadge").style.display = "none";

  datePicker.addEventListener("change", ()=>{
    const d = fromInputDate(datePicker.value);
    currentDateKey = toKey(d);
    renderHeaderDate(d);
    $("#editBadge").style.display = (currentDateKey === todayKey) ? "none" : "inline-block";
    loadLogToForm(loadLog(currentDateKey));
  });

  /* ==== ã‚¹ãƒ†ãƒ¼ãƒˆ ==== */
  const state = {
    mood:"", energy:"", symptoms:[], note:"",
    sleepH:0, sleepM:0, weight:null, bodyFat:null,
    weather:null,
    quickTasks:[{done:false,text:""},{done:false,text:""},{done:false,text:""}],
  };

  /* ==== ãƒãƒƒãƒ—UI ==== */
  const moods = [{v:"ğŸ™‚",label:"è‰¯ã„"},{v:"ğŸ˜",label:"ãµã¤ã†"},{v:"ğŸ™",label:"ã„ã¾ã„ã¡"}];
  const energies = ["â¤ï¸â€ğŸ”¥å…ƒæ°—","â¤ï¸ã¾ãšã¾ãš","â¤ï¸â€ğŸ©¹ã ã‚‹ã„"];
  const group1 = ["é¦–ãƒ»è‚©ã“ã‚Š","é ­ç—›","è…¹ç—›ï¼ãŠè…¹ã®å¼µã‚Š","è…°ã®å¼µã‚Šï¼è…°ç—›","èƒƒè…¸å¼±ã‚ï¼ˆèƒƒã‚‚ãŸã‚Œãƒ»ä¸‹ç—¢ãƒ»ä¾¿ç§˜ãªã©ï¼‰","ã‚€ãã¿","ç›®ã®ç–²ã‚Œï¼ãƒ‰ãƒ©ã‚¤ã‚¢ã‚¤","è‡ªå¾‹ç¥çµŒã®ä¹±ã‚Œ","ç¡çœ ã®è³ªä½ä¸‹ï¼ˆæµ…ã„çœ ã‚Šãƒ»é€”ä¸­è¦šé†’ï¼‰","ç”Ÿç†"];
  const group2 = ["å†·ãˆï¼ˆæ‰‹è¶³ã®å†·ãˆãƒ»å…¨èº«ï¼‰","æš‘ã•ãƒãƒ†ï¼ç†±ã£ã½ã•","å–‰ã®ç—›ã¿ãƒ»å£°æ¯ã‚Œ","é¼»æ°´ãƒ»é¼»ã¥ã¾ã‚Š","è‚Œè’ã‚Œï¼ã‹ã‚†ã¿","èŠ±ç²‰ãƒ»ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ç—‡çŠ¶"];
  const group3 = ["é›†ä¸­åŠ›ä½ä¸‹","ã‚¤ãƒ©ã‚¤ãƒ©ï¼ä¸å®‰æ„Ÿ","ã ã‚‹ã•ï¼å€¦æ€ æ„Ÿ","ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ä½ä¸‹","PMSï¼ˆç”Ÿç†å‰ç—‡çŠ¶ï¼‰"];
  const allSymptoms = [...group1,...group2,...group3];

  function buildChips(root, options, isActive, onClick){
    root.innerHTML = "";
    options.forEach(opt=>{
      const v = typeof opt==="string" ? opt : opt.v;
      const label = typeof opt==="string" ? opt : (opt.v+" "+opt.label);
      const b=document.createElement("button");
      b.className="chip"+(isActive(v)?" active":"");
      b.textContent=label;
      b.addEventListener("click",()=>onClick(v));
      root.appendChild(b);
    });
  }
  function renderChips(){
    buildChips($("#moodBtns"), moods, v=>state.mood===v, v=>{state.mood=v; renderChips(); autoSave();});
    buildChips($("#energyBtns"), energies, v=>state.energy===v, v=>{state.energy=v; renderChips(); autoSave();});
    const mk=(id,arr)=>buildChips($(id), arr, v=>state.symptoms.includes(v), v=>{
      if(state.symptoms.includes(v)) state.symptoms=state.symptoms.filter(x=>x!==v);
      else state.symptoms=[...state.symptoms, v];
      renderChips(); autoSave();
    });
    mk("#symptomGroup1", group1); mk("#symptomGroup2", group2); mk("#symptomGroup3", group3);
  }
  renderChips();

  /* ==== å¤©æ°— ==== */
  const wxLoading=$("#wxLoading"), wxError=$("#wxError"), wxBlock=$("#wxBlock");
  const wxMap={0:"å¿«æ™´",1:"æ™´ã‚Œ",2:"è–„æ›‡ã‚Š",3:"æ›‡ã‚Š",45:"éœ§",48:"éœ§æ°·",51:"å¼±ã„éœ§é›¨",53:"éœ§é›¨",55:"å¼·ã„éœ§é›¨",61:"å¼±ã„é›¨",63:"é›¨",65:"å¼·ã„é›¨",71:"å¼±ã„é›ª",73:"é›ª",75:"å¤§é›ª",95:"é›·é›¨"};
  const wxCodeToText = code => wxMap[code]||"â€”";
  function renderWeather(){
    wxBlock.innerHTML="";
    if(!state.weather){ const p=document.createElement("p"); p.className="text muted"; p.textContent="ä½ç½®æƒ…å ±ã®è¨±å¯å¾Œã€è‡ªå‹•è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚"; wxBlock.appendChild(p); return; }
    const icon = document.createElement("div"); icon.style.fontSize="48px";
    const code = state.weather.code||0;
    icon.textContent = (code>=61&&code<=65) ? "ğŸŒ§ï¸" : (code===0||code===1?"â˜€ï¸": (code===2?"ğŸŒ¤ï¸": (code===3?"â˜ï¸":"ğŸŒ¦ï¸")));
    const big=document.createElement("div"); big.style.fontSize="40px"; big.style.fontWeight="700"; big.textContent=Math.round(state.weather.temp)+"Â°C";
    const small=document.createElement("div"); small.className="text"; small.style.marginTop="4px";
    const lines=[]; lines.push("çŠ¶æ³ï¼š"+state.weather.condition); lines.push("é¢¨ï¼š"+Math.round(state.weather.wind)+"m/s");
    if(state.weather.humidity!=null) lines.push("æ¹¿åº¦ï¼š"+Math.round(state.weather.humidity)+"%");
    small.innerHTML=lines.join("ã€€");
    const wrap=document.createElement("div"); wrap.className="row"; wrap.style.alignItems="center";
    wrap.appendChild(icon); wrap.appendChild(big); wrap.appendChild(small);
    wxBlock.appendChild(wrap);
  }
  function fetchWeatherFromGeo(lat, lon){
    wxLoading.style.display="inline"; wxError.textContent="";
    const u=new URL("https://api.open-meteo.com/v1/forecast");
    u.searchParams.set("latitude", lat);
    u.searchParams.set("longitude", lon);
    u.searchParams.set("current_weather","true");
    u.searchParams.set("hourly","precipitation_probability,relativehumidity_2m");
    u.searchParams.set("timezone","Asia/Tokyo");
    fetch(u.toString()).then(r=>r.json()).then(data=>{
      const c=data.current_weather||{};
      const times=(data.hourly&&data.hourly.time)||[]; const idx=times.indexOf(c.time);
      const hum = (idx>-1 && data.hourly.relativehumidity_2m) ? data.hourly.relativehumidity_2m[idx] : null;
      state.weather={temp:c.temperature, wind:c.windspeed, code:c.weathercode, condition:wxCodeToText(c.weathercode), humidity:hum};
      renderWeather(); autoSave();
    }).catch(()=>{ wxError.textContent="å¤©æ°—ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"; })
      .finally(()=>{ wxLoading.style.display="none"; });
  }
  function askGeo(){
    wxLoading.style.display="inline"; wxError.textContent="";
    if(!("geolocation" in navigator)){ wxError.textContent="ã“ã®ç«¯æœ«ã¯ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚"; wxLoading.style.display="none"; return; }
    navigator.geolocation.getCurrentPosition(
      pos=>{ const {latitude, longitude}=pos.coords; fetchWeatherFromGeo(latitude, longitude); },
      ()=>{ wxError.textContent="ä½ç½®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚è¨­å®šã§Safariã«ä½ç½®æƒ…å ±ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚"; wxLoading.style.display="none"; },
      { enableHighAccuracy:false, timeout:8000 }
    );
  }
  $("#retryWx").addEventListener("click", askGeo); askGeo();

  /* ==== ä¿å­˜é ˜åŸŸ ==== */
  const LOGS_KEY="md_logs_v2";
  const loadAllLogs =()=> JSON.parse(localStorage.getItem(LOGS_KEY)||"[]");
  const saveAllLogs =arr=> localStorage.setItem(LOGS_KEY, JSON.stringify(arr));
  const loadLog =key=> loadAllLogs().find(l=>l.date===key)||null;
  const upsertLog =payload=>{
    const logs=loadAllLogs();
    const rest=logs.filter(l=>l.date!==payload.date);
    saveAllLogs([payload, ...rest].sort((a,b)=> (a.date<b.date ? 1 : -1)));
  };

  /* ==== ãƒ•ã‚©ãƒ¼ãƒ åŒæœŸ ==== */
  function updateSleepLabel(){ $("#sleepTotal").textContent = Math.floor(state.sleepH)+"æ™‚é–“"+(state.sleepM%60)+"åˆ†"; }
  function syncFormFromState(){
    $("#sleepH").value=state.sleepH; $("#sleepM").value=state.sleepM; updateSleepLabel();
    $("#note").value=state.note;
    $("#weight").value=state.weight??""; $("#bodyFat").value=state.bodyFat??"";
  }
  function loadLogToForm(log){
    if(!log){
      state.mood=""; state.energy=""; state.symptoms=[]; state.note="";
      state.sleepH=0; state.sleepM=0; state.weight=null; state.bodyFat=null;
    }else{
      state.mood=log.mood||""; state.energy=log.energy||"";
      state.symptoms=Array.isArray(log.symptoms)? log.symptoms.filter(s=>allSymptoms.includes(s)):[];
      const sm=parseInt(log.sleepMin||0,10); state.sleepH=Math.floor(sm/60); state.sleepM=sm%60;
      state.weight=(log.weight ?? null); state.bodyFat=(log.bodyFat ?? null);
      state.note=log.note||""; state.weather=log.weather||state.weather;
    }
    renderChips(); syncFormFromState(); renderHistory();
  }

  /* ==== è‡ªå‹•ä¿å­˜ ==== */
  let saveTimer=null;
  function autoSave(){
    clearTimeout(saveTimer);
    saveTimer=setTimeout(()=>{
      const payload={
        date: currentDateKey,
        mood:state.mood, energy:state.energy, symptoms:state.symptoms,
        sleepMin:(parseInt(state.sleepH,10)||0)*60 + (parseInt(state.sleepM,10)||0),
        weight:state.weight, bodyFat:state.bodyFat,
        note:state.note, weather:state.weather, quickTasks:state.quickTasks, ts:Date.now()
      };
      upsertLog(payload); renderHistory();
    }, 300);
  }

  /* ==== å±¥æ­´ ==== */
  function renderHistory(){
    const root=$("#history"); const logs=loadAllLogs(); root.innerHTML="";
    if(!logs.length){ const p=document.createElement("p"); p.className="text muted"; p.textContent="ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“"; root.appendChild(p); return; }
    logs.forEach(l=>{
      const box=document.createElement("div"); box.className="card"; box.style.marginTop="8px";
      const head=document.createElement("div"); head.className="text"; head.innerHTML=`<span class="muted">${l.date}</span>`;
      const row=document.createElement("div"); row.className="row text"; row.style.marginTop="6px";
      row.innerHTML=`<div>æ°—åˆ†ï¼š${l.mood||"â€”"}</div>
                     <div>å…ƒæ°—åº¦ï¼š${l.energy||"â€”"}</div>
                     <div>ç¡çœ ï¼š${Math.floor((l.sleepMin||0)/60)}æ™‚é–“${(l.sleepMin||0)%60}åˆ†</div>
                     ${l.weight!=null?`<div>ä½“é‡ï¼š${l.weight}kg</div>`:""}
                     ${l.bodyFat!=null?`<div>ä½“è„‚è‚ªï¼š${l.bodyFat}%</div>`:""}`;
      const memo=document.createElement("div"); memo.className="text"; if(l.note){ memo.textContent="ãƒ¡ãƒ¢ï¼š"+l.note; }
      const actions=document.createElement("div"); actions.className="row"; actions.style.marginTop="8px";
      const editBtn=document.createElement("button"); editBtn.className="btn small"; editBtn.textContent="ç·¨é›†";
      editBtn.onclick=()=>{ currentDateKey=l.date; renderHeaderDate(new Date(l.date)); $("#editBadge").style.display="inline-block"; loadLogToForm(l); window.scrollTo({top:0,behavior:"smooth"}); };
      const delBtn=document.createElement("button"); delBtn.className="btn small"; delBtn.textContent="å‰Šé™¤";
      delBtn.onclick=()=>{ if(!confirm(`${l.date} ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`))return; const rest=loadAllLogs().filter(x=>x.date!==l.date); saveAllLogs(rest); renderHistory(); };
      actions.appendChild(editBtn); actions.appendChild(delBtn);
      box.appendChild(head); box.appendChild(row); if(memo.textContent) box.appendChild(memo); box.appendChild(actions);
      root.appendChild(box);
    });
  }
  $("#reloadHistory").addEventListener("click", renderHistory);

  /* ==== ãƒœã‚¿ãƒ³ ==== */
  $("#saveLog").addEventListener("click", ()=>{ autoSave(); alert(`${currentDateKey} ã®è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸ`); });
  $("#exportCSV").addEventListener("click", ()=>{
    const logs=loadAllLogs(); if(!logs.length){ alert("ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“"); return; }
    const header=["date","mood","energy","sleepMin","weight","bodyFat","note"].join(",");
    const rows=logs.map(l=>[l.date,l.mood||"",l.energy||"",l.sleepMin||0,l.weight??"",l.bodyFat??"", (l.note||"").replace(/,/g," ")].join(","));
    const csv=[header,...rows].join("\n");
    const blob=new Blob([csv],{type:"text/csv"}); const url=URL.createObjectURL(blob);
    const a=document.createElement("a"); a.href=url; a.download="morningdash.csv"; a.click(); URL.revokeObjectURL(url);
  });
  $("#exportJSON").addEventListener("click", ()=>{
    const data = JSON.stringify(loadAllLogs(), null, 2);
    const blob=new Blob([data],{type:"application/json"}); const url=URL.createObjectURL(blob);
    const a=document.createElement("a"); a.href=url; a.download="morningdash.json"; a.click(); URL.revokeObjectURL(url);
  });
  $("#importJSON").addEventListener("change", async (e)=>{
    const f=e.target.files?.[0]; if(!f) return;
    const txt=await f.text(); try{ const arr=JSON.parse(txt); if(Array.isArray(arr)){ saveAllLogs(arr); alert("èª­ã¿è¾¼ã¿ã¾ã—ãŸ"); renderHistory(); } }catch(_){ alert("JSONã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ"); }
  });
  $("#copyHealthShortcut").addEventListener("click", async ()=>{
    const base = window.location.origin + window.location.pathname;
    const template = `${base}?sleepMin=[[åˆè¨ˆç¡çœ åˆ†]]&weight=[[ä½“é‡_kg]]&bodyFat=[[ä½“è„‚è‚ª_%]]`;
    try{ await navigator.clipboard.writeText(template); alert("ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆç”¨URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"); }catch(e){ alert(template); }
  });

  /* ==== URL ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å–ã‚Šè¾¼ã¿ ==== */
  const url = new URL(window.location.href);
  const qp = k => url.searchParams.get(k);
  const numMaybe = v => (v==null? null : (isNaN(parseFloat(v))? null : parseFloat(v)));
  const payload={};
  if(qp("sleepMin")!=null) payload.sleepMin = parseInt(qp("sleepMin"),10)||0;
  if(qp("mood")) payload.mood = qp("mood");
  if(qp("energy")) payload.energy = qp("energy");
  if(qp("symptoms")) payload.symptoms = qp("symptoms").split(",").filter(Boolean);
  if(qp("note")) payload.note = qp("note");
  const w = numMaybe(qp("weight")); if(w!=null) payload.weight = w;
  const b = numMaybe(qp("bodyFat")); if(b!=null) payload.bodyFat = b;

  /* ==== åˆæœŸæç”» ==== */
  function initial(){
    renderHistory();
    const saved = loadLog(todayKey);
    if(saved) loadLogToForm(saved); else loadLogToForm(null);

    let changed=false;
    if(payload.sleepMin!=null){ state.sleepH=Math.floor(payload.sleepMin/60); state.sleepM=payload.sleepMin%60; changed=true; }
    if(payload.mood){ state.mood=payload.mood; changed=true; }
    if(payload.energy){ state.energy=payload.energy; changed=true; }
    if(payload.symptoms){ state.symptoms=payload.symptoms; changed=true; }
    if(payload.note){ state.note=payload.note; changed=true; }
    if(payload.weight!=null){ state.weight=payload.weight; changed=true; }
    if(payload.bodyFat!=null){ state.bodyFat=payload.bodyFat; changed=true; }
    if(changed){ renderChips(); syncFormFromState(); autoSave(); }
  }
  initial();

  /* å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆ */
  $("#sleepH").addEventListener("input", ()=>{ state.sleepH=parseInt($("#sleepH").value||0,10); updateSleepLabel(); autoSave(); });
  $("#sleepM").addEventListener("input", ()=>{ state.sleepM=parseInt($("#sleepM").value||0,10); updateSleepLabel(); autoSave(); });
  $("#note").addEventListener("input", ()=>{ state.note=$("#note").value; autoSave(); });
  $("#weight").addEventListener("input", ()=>{ const n=parseFloat($("#weight").value); state.weight=isNaN(n)?null:n; autoSave(); });
  $("#bodyFat").addEventListener("input", ()=>{ const n=parseFloat($("#bodyFat").value); state.bodyFat=isNaN(n)?null:n; autoSave(); });
})();
</script>
</body>
</html>
