<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Morning Dash v24</title>
<meta name="theme-color" content="#0b1220">
<style>
:root{
  --bg:#090f1c; --bg2:#0b1220;
  --fg:#e6edf7; --muted:#a7b4c8;
  --card:#0f172a; --border:rgba(255,255,255,.12);
  --accent:#60a5fa; --accent-press:#3b82f6;
}
/* Weather themes */
body.theme-sunny{ --bg:#0b1220; --bg2:#13315c; }
body.theme-cloudy{ --bg:#101522; --bg2:#1b2133; }
body.theme-rain{ --bg:#0b1020; --bg2:#0e1730; }
body.theme-snow{ --bg:#0a0f1a; --bg2:#16263d; }
body.theme-storm{ --bg:#080b14; --bg2:#11182a; }
*{box-sizing:border-box;-webkit-tap-highlight-color: transparent}
html,body{margin:0;height:100%}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;background:linear-gradient(180deg,var(--bg),var(--bg2));color:var(--fg);transition:background 0.5s ease}
.container{max-width:900px;margin:0 auto;padding:16px 16px 92px}
h1{margin:4px 0 4px;font-size:30px;line-height:1.2;font-weight:800;display:flex;gap:10px;align-items:baseline;flex-wrap:wrap}
h2{margin:0 0 10px;font-size:20px}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35);padding:16px;margin:12px 0}
.row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.row.nw{flex-wrap:nowrap}
.btn{appearance:none;border:1px solid var(--border);border-radius:14px;padding:8px 12px;background:rgba(255,255,255,.04);cursor:pointer;color:var(--fg);text-decoration:none;font-size:14px}
.btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
.btn.primary:active{background:var(--accent-press)}
.btn.small{padding:6px 10px;font-size:13px}
.input, select, textarea{border:1px solid var(--border);border-radius:12px;padding:10px 12px;background:rgba(255,255,255,.04);color:var(--fg);font-size:16px}
select[multiple]{min-height:132px}
textarea{width:100%;min-height:96px;resize:vertical}
.small{font-size:13px;color:var(--muted)}
.labelBig{font-size:15px;font-weight:600;margin-right:6px}
.header{display:flex;justify-content:space-between;align-items:flex-end;gap:10px;flex-wrap:wrap;margin-bottom:6px}
.bigdate{display:flex;align-items:baseline;gap:8px}
.bigdate .date{font-weight:800;font-size:32px}
.bigdate .wday{font-weight:700}
#year{font-size:16px;font-weight:400;color:var(--muted)}
footer{font-size:12px;color:var(--muted);margin-top:16px}
hr{border:none;border-top:1px solid var(--border);margin:12px 0}
.historyItem{padding:10px;border:1px dashed var(--border);border-radius:12px;margin-top:8px}
label.checkbox{display:flex;align-items:center;gap:10px;cursor:pointer;font-size:16px}
label.checkbox input{transform:scale(1.2)}
.weatherTitle{display:flex;justify-content:space-between;align-items:center;gap:8px}
#wxMain{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.wxIcon{font-size:30px;line-height:1}
#wxTemp{font-size:22px;font-weight:800}
.wxLine{font-size:15px;font-weight:600;margin-top:6px}
#navRow{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
/* ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆå…¥åŠ›ï¼ˆã‚¹ãƒãƒ›1è¡Œå¯¾ç­–ï¼‰ */
.input.compact{width:120px}
.input.compact.short{width:86px}
@media (max-width:420px){ .input.compact{width:110px} .input.compact.short{width:78px} }
</style>
</head>
<body class="theme-sunny">
  <div class="container">
    <div class="header">
      <div>
        <h1>â˜€ï¸ Morning Dash <span id="year">2025</span></h1>
        <div class="bigdate">
          <span class="date" id="ymd">--/--</span>
          <span class="wday" id="wday">---</span>
        </div>
      </div>
      <div id="navRow">
        <a href="./EveningDash.html" class="btn">ğŸŒ™ å¤œã®è¨˜éŒ²ã¸</a>
        <a id="openCal" href="./Calendar.html" class="btn">ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</a>
      </div>
    </div>

    <!-- â‘  å¤©æ°— -->
    <section class="card" id="secWeather">
      <div class="weatherTitle">
        <h2>â‘  å¤©æ°—ï¼ˆè‡ªå‹•å–å¾—ï¼‰</h2>
        <button id="useGeo" class="btn small">å†å–å¾—</button>
      </div>
      <div id="wxMain">
        <div id="wxIcon" class="wxIcon">â³</div>
        <div id="wxTemp">--Â°C</div>
      </div>
      <div id="wxLine1" class="wxLine">çŠ¶æ³ï¼šâ€”ã€€é™æ°´ç¢ºç‡ï¼šâ€”</div>
      <div id="wxLine2" class="wxLine">æ¹¿åº¦ï¼šâ€”ã€€æ°—åœ§ï¼šâ€”</div>
    </section>

    <!-- â‘¡ æ—¥è¨˜ãƒ»è¨˜éŒ² -->
    <section class="card" id="secDiary">
      <h2>â‘¡ æ—¥è¨˜ãƒ»è¨˜éŒ²</h2>

      <div class="row" style="align-items:center">
        <label for="moodSel" class="labelBig">æ„Ÿæƒ…</label>
        <select id="moodSel" class="input">
          <option value="">ï¼ˆæœªé¸æŠï¼‰</option>
          <option>æœ€é«˜</option><option>è‰¯ã„</option><option>æ™®é€š</option><option>ã„ã¾ã„ã¡</option><option>ã—ã‚“ã©ã„</option>
        </select>
      </div>

      <div class="row" style="align-items:flex-start">
        <label for="condSel" class="labelBig">ä½“èª¿ï¼ˆè¤‡æ•°å¯ï¼‰</label>
        <select id="condSel" class="input" multiple>
          <option>é¦–ãƒ»è‚©ã“ã‚Š</option><option>é ­ç—›</option><option>è…¹ç—›/ãŠè…¹ã®å¼µã‚Š</option><option>è…°ã®å¼µã‚Š/è…°ç—›</option>
          <option>è‡ªå¾‹ç¥çµŒã®ä¹±ã‚Œ</option><option>èƒƒè…¸å¼±ã‚</option><option>ã‚€ãã¿</option><option>ç›®ã®ç–²ã‚Œ/ãƒ‰ãƒ©ã‚¤ã‚¢ã‚¤</option>
          <option>ç¡çœ ã®è³ªä½ä¸‹</option><option>å†·ãˆ</option><option>å–‰ã®ç—›ã¿</option><option>é¼»æ°´/é¼»ã¥ã¾ã‚Š</option>
          <option>è‚Œè’ã‚Œ/ã‹ã‚†ã¿</option><option>èŠ±ç²‰/ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼</option><option>ã ã‚‹ã•/å€¦æ€ æ„Ÿ</option><option>ã‚¤ãƒ©ã‚¤ãƒ©/ä¸å®‰</option>
          <option>ãƒ¢ãƒãƒ™ä½ä¸‹</option><option>PMS</option><option>ç”Ÿç†</option>
        </select>
      </div>

      <!-- ç¡çœ ï¼ˆæ™‚é–“ãƒ»åˆ†ï¼‰ -->
      <div class="row nw">
        <label class="labelBig" for="sleepH">ç¡çœ </label>
        <input id="sleepH" class="input compact short" type="number" min="0" placeholder="7">
        <span>æ™‚é–“</span>
        <input id="sleepM" class="input compact short" type="number" min="0" max="59" placeholder="30">
        <span>åˆ†</span>
      </div>

      <!-- ä½“é‡ -->
      <div class="row">
        <label class="labelBig" for="weight">ä½“é‡</label>
        <input id="weight" class="input compact" type="number" step="0.1" placeholder="52.4">
        <span>kg</span>
      </div>
      <!-- ä½“è„‚è‚ª -->
      <div class="row">
        <label class="labelBig" for="bodyFat">ä½“è„‚è‚ª</label>
        <input id="bodyFat" class="input compact" type="number" step="0.1" placeholder="21.8">
        <span>%</span>
      </div>

      <div style="margin-top:12px">
        <label>ğŸ““ è‡ªç”±ãƒ¡ãƒ¢</label>
        <textarea id="freeMemo" placeholder="ãªã‚“ã§ã‚‚ã©ã†ã"></textarea>
      </div>
    </section>

    <!-- â‘¢ ç”Ÿæ´»ç¿’æ…£ãƒã‚§ãƒƒã‚¯ -->
    <section class="card" id="secHabits">
      <h2>â‘¢ ç”Ÿæ´»ç¿’æ…£ãƒã‚§ãƒƒã‚¯</h2>
      <div class="row">
        <label class="checkbox"><input type="checkbox" id="h_curtain"> ã‚«ãƒ¼ãƒ†ãƒ³ã‚’é–‹ã‘ã‚‹</label>
        <label class="checkbox"><input type="checkbox" id="h_bed"> å¸ƒå›£ã‚’ç›´ã™</label>
        <label class="checkbox"><input type="checkbox" id="h_change"> ç€æ›¿ãˆã‚’ã™ã‚‹</label>
        <label class="checkbox"><input type="checkbox" id="h_teeth"> æ­¯ç£¨ã</label>
        <label class="checkbox"><input type="checkbox" id="h_skin"> ã‚¹ã‚­ãƒ³ã‚±ã‚¢</label>
        <label class="checkbox"><input type="checkbox" id="h_hair"> ãƒ˜ã‚¢ã‚±ã‚¢</label>
      </div>
    </section>

    <!-- ğŸ’¾ ä¿å­˜ï¼ˆâ‘¢ã®ä¸‹ãƒ»å±¥æ­´ã®ä¸Šï¼‰ -->
    <section class="card" id="secSave">
      <div class="row">
        <button id="saveBtn" class="btn primary">ğŸ’¾ ä¿å­˜</button>
      </div>
      <div class="small">ä¿å­˜å…ˆï¼šãƒ–ãƒ©ã‚¦ã‚¶(localStorage)ã€‚åŒã˜URLãªã‚‰ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã—ã¦ã‚‚å±¥æ­´ã¯å¼•ãç¶™ãŒã‚Œã¾ã™ã€‚</div>
    </section>

    <!-- å±¥æ­´ -->
    <section class="card">
      <div class="row" style="justify-content:space-between">
        <h2>å±¥æ­´</h2>
        <button id="reloadBtn" class="btn">å†èª­è¾¼</button>
      </div>
      <div id="history"></div>
    </section>
  </div>

<script>
(function(){
  function z2(n){ n = Number(n)||0; return (n<10?"0":"")+n; }
  function $(s){ return document.querySelector(s); }
  function nearestIndex(times, targetISO){
    var best=-1, bestDiff=1e18; var t0 = new Date(targetISO).getTime();
    for(var i=0;i<times.length;i++){ var dt=new Date(times[i]).getTime(); var d=Math.abs(dt - t0); if(d<bestDiff){ best=i; bestDiff=d; } }
    return best;
  }
  function pressureTrend(pressArr, idx){
    if(!(pressArr && pressArr.length) || idx<1) return "å®‰å®š";
    var prev = pressArr[idx-1], cur = pressArr[idx];
    if(prev==null || cur==null) return "å®‰å®š";
    var diff = cur - prev;
    if(diff > 1.5) return "ä¸Šæ˜‡";
    if(diff < -1.5) return "ä¸‹é™";
    return "å®‰å®š";
  }
  function themeFromCode(code){
    if(code==null) return "theme-cloudy";
    if(code>=95) return "theme-storm";
    if(code>=71 && code<=86) return "theme-snow";
    if((code>=61 && code<=67) || (code>=51 && code<=55)) return "theme-rain";
    if(code===0 || code===1) return "theme-sunny";
    if(code===2 || code===3 || code===45 || code===48) return "theme-cloudy";
    return "theme-cloudy";
  }
  function applyTheme(code){
    var cls = themeFromCode(code);
    document.body.classList.remove("theme-sunny","theme-cloudy","theme-rain","theme-snow","theme-storm");
    document.body.classList.add(cls);
  }

  document.addEventListener("DOMContentLoaded", function(){
    // æ—¥ä»˜
    var d=new Date();
    document.getElementById("year").textContent = d.getFullYear();
    document.getElementById("ymd").textContent = z2(d.getMonth()+1)+"/"+z2(d.getDate());
    document.getElementById("wday").textContent = ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"][d.getDay()] + "æ›œæ—¥";
    document.getElementById("openCal").href = "./Calendar.html?date=" + d.toISOString().slice(0,10);

    // URLã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆï¼ˆsleepMin ã‚’ H/Mã«é…åˆ†ã€ä½“é‡ãƒ»ä½“è„‚è‚ªï¼‰
    var usp=new URLSearchParams(location.search);
    if(usp.has("sleepMin")){
      var sm=Number(usp.get("sleepMin"))||0;
      document.getElementById("sleepH").value = Math.floor(sm/60);
      document.getElementById("sleepM").value = sm%60;
    }
    if(usp.has("weight")) document.getElementById("weight").value = usp.get("weight");
    if(usp.has("bodyFat")) document.getElementById("bodyFat").value = usp.get("bodyFat");

    // Storage
    var KEY="morning_logs_v24";
    function loadAll(){ try{ var v=localStorage.getItem(KEY); return v?JSON.parse(v):[]; }catch(e){ return []; } }
    function saveAll(arr){ try{ localStorage.setItem(KEY, JSON.stringify(arr)); }catch(e){} }
    function toKey(dt){ return dt.toLocaleDateString("ja-JP",{timeZone:"Asia/Tokyo"}); }
    function upsert(payload){
      var list = loadAll(); var i=-1;
      for(var k=0;k<list.length;k++){ if(list[k].date===payload.date){ i=k; break; } }
      if(i>-1){ list[i]=payload; } else { list.unshift(payload); }
      list.sort(function(a,b){ return a.date<b.date?1:-1; });
      saveAll(list);
    }

    // State
    var state = {
      mood:"", condSel:[],
      sleepH:"", sleepM:"", weight:"", bodyFat:"",
      freeMemo:"",
      habits:{ curtain:false, bed:false, change:false, teeth:false, skin:false, hair:false },
      wx:null
    };

    // Binds
    var moodSel=$("#moodSel"); if(moodSel) moodSel.addEventListener("change", function(){ state.mood = moodSel.value; autoSave(); });
    var condSel=$("#condSel"); if(condSel) condSel.addEventListener("change", function(){
      state.condSel = []; for(var i=0;i<condSel.options.length;i++){ var op=condSel.options[i]; if(op.selected) state.condSel.push(op.value); } autoSave();
    });
    ["sleepH","sleepM","weight","bodyFat","freeMemo"].forEach(function(id){
      var el=$("#"+id); if(!el) return;
      var evt = (id==="freeMemo")?"input":"change";
      el.addEventListener(evt, function(){ state[id]=el.value; autoSave(); });
    });
    function bindCheck(id, key){ var el=$("#"+id); if(!el) return;
      el.addEventListener("change", function(){ state.habits[key]=el.checked; autoSave(); });
    }
    bindCheck("h_curtain","curtain"); bindCheck("h_bed","bed"); bindCheck("h_change","change");
    bindCheck("h_teeth","teeth"); bindCheck("h_skin","skin"); bindCheck("h_hair","hair");

    // Save & history
    function toMinutes(h,m){ h=Number(h)||0; m=Number(m)||0; return h*60+m; }
    function saveNow(){
      var payload = {
        date: toKey(new Date()),
        mood: state.mood, condSel: state.condSel.slice(0),
        sleepMin: toMinutes(state.sleepH, state.sleepM),
        weight: state.weight, bodyFat: state.bodyFat,
        freeMemo: state.freeMemo, habits: state.habits,
        wx: state.wx, ts: Date.now()
      };
      upsert(payload); renderHistory();
    }
    var t=null; function autoSave(){ if(t) clearTimeout(t); t=setTimeout(saveNow, 200); }
    document.getElementById("saveBtn").addEventListener("click", function(){ saveNow(); alert("ä¿å­˜ã—ã¾ã—ãŸ"); });
    document.getElementById("reloadBtn").addEventListener("click", renderHistory);

    function renderHistory(){
      var root=$("#history"); if(!root) return;
      var logs = loadAll(); root.innerHTML="";
      if(!(logs && logs.length)){ root.innerHTML='<div class="small">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>'; return; }
      for(var i=0;i<logs.length;i++){
        var l=logs[i];
        var box=document.createElement("div"); box.className="historyItem";
        var h=l.habits||{};
        function on(o,k){ return o && o[k]; }
        var htxt = (on(h,"curtain")?"ã‚«ãƒ¼ãƒ†ãƒ³ / ":"") + (on(h,"bed")?"å¸ƒå›£ / ":"") + (on(h,"change")?"ç€æ›¿ãˆ / ":"") + (on(h,"teeth")?"æ­¯ç£¨ã / ":"") + (on(h,"skin")?"ã‚¹ã‚­ãƒ³ã‚±ã‚¢ / ":"") + (on(h,"hair")?"ãƒ˜ã‚¢ã‚±ã‚¢":"");
        if(htxt.replace(/\s|\/|ã€€/g,"")==="") htxt="â€”";
        var press = (l.wx && l.wx.pressure!=null) ? Math.round(l.wx.pressure)+"hPa" : "â€”";
        var hum = (l.wx && l.wx.humidity!=null) ? Math.round(l.wx.humidity)+"%" : "â€”";
        var pprob = (l.wx && l.wx.pprob!=null) ? Math.round(l.wx.pprob)+"%" : "â€”";
        var wtemp = (l.wx && l.wx.temp!=null) ? Math.round(l.wx.temp)+"Â°C" : "â€”";
        var trend = l.wx && l.wx.trend || "â€”";
        var html = "<b>"+l.date+"</b><br>"+
          "æ„Ÿæƒ…ï¼š"+(l.mood||"â€”")+"ã€€ä½“èª¿ï¼š"+((l.condSel||[]).join("ã€")||"â€”")+"<br>"+
          "ç¡çœ ï¼š"+(l.sleepMin||"â€”")+"åˆ†ã€€ä½“é‡ï¼š"+(l.weight||"â€”")+"kgã€€ä½“è„‚è‚ªï¼š"+(l.bodyFat||"â€”")+"%<br>"+
          "å¤©æ°—ï¼š"+wtemp+"ãƒ»é™æ°´ç¢ºç‡ï¼š"+pprob+"ãƒ»æ¹¿åº¦ï¼š"+hum+"ãƒ»æ°—åœ§ï¼š"+press+" ["+trend+"]<br>"+
          "ç¿’æ…£ï¼š"+htxt;
        if(l.freeMemo) html += "<br><div class='small'>ãƒ¡ãƒ¢ï¼š"+l.freeMemo.replace(/\n/g," / ")+"</div>";
        box.innerHTML = html;
        root.appendChild(box);
      }
    }

    // å¤©æ°—ï¼ˆæ¸©åº¦/å¤©å€™ + æ¹¿åº¦ + æ°—åœ§ + é™æ°´ç¢ºç‡ + æ°—åœ§å‚¾å‘ï¼‰ï¼‹èƒŒæ™¯ãƒ†ãƒ¼ãƒ
    var TOKYO={lat:35.681236, lon:139.767125};
    function wxIcon(code){ if(code>=95) return "â›ˆï¸"; if(code>=71&&code<=86) return "ğŸŒ¨ï¸"; if(code>=61&&code<=67) return "ğŸŒ§ï¸"; if(code===0||code===1) return "â˜€ï¸"; if(code===2) return "ğŸŒ¤ï¸"; if(code===3) return "â˜ï¸"; return "ğŸŒ¦ï¸"; }
    function wxText(code){ var map={0:"å¿«æ™´",1:"æ™´ã‚Œ",2:"è–„æ›‡ã‚Š",3:"æ›‡ã‚Š",45:"éœ§",48:"éœ§æ°·",51:"å¼±ã„éœ§é›¨",53:"éœ§é›¨",55:"å¼·ã„éœ§é›¨",61:"å¼±ã„é›¨",63:"é›¨",65:"å¼·ã„é›¨",71:"å¼±ã„é›ª",73:"é›ª",75:"å¤§é›ª",95:"é›·é›¨"}; return map[code]||"â€”"; }
    function renderWx(obj){
      var icon=$("#wxIcon"), temp=$("#wxTemp"), line1=$("#wxLine1"), line2=$("#wxLine2");
      if(!obj){ icon.textContent="âš ï¸"; temp.textContent="--Â°C"; line1.textContent="çŠ¶æ³ï¼šå–å¾—å¤±æ•—ã€€é™æ°´ç¢ºç‡ï¼šâ€”"; line2.textContent="æ¹¿åº¦ï¼šâ€”ã€€æ°—åœ§ï¼šâ€”"; applyTheme(null); return; }
      icon.textContent = wxIcon(obj.code);
      temp.textContent = Math.round(obj.temp)+"Â°C";
      line1.textContent = "çŠ¶æ³ï¼š"+wxText(obj.code)+"ã€€é™æ°´ç¢ºç‡ï¼š"+(obj.pprob!=null?Math.round(obj.pprob)+"%":"â€”");
      line2.textContent = "æ¹¿åº¦ï¼š"+(obj.humidity!=null?Math.round(obj.humidity)+"%":"â€”")+"ã€€æ°—åœ§ï¼š"+(obj.pressure!=null?Math.round(obj.pressure)+"hPa":"â€”")+" ["+obj.trend+"]";
      applyTheme(obj.code);
    }
    function fetchWx(lat, lon){
      var url="https://api.open-meteo.com/v1/forecast?latitude="+lat+"&longitude="+lon+"&current_weather=true&hourly=pressure_msl,relative_humidity_2m,precipitation_probability&timezone=Asia%2FTokyo";
      return fetch(url).then(function(r){ return r.json(); }).then(function(data){
        var c=data.current_weather||{};
        var times=(data.hourly&&data.hourly.time)||[];
        var pArr=(data.hourly&&data.hourly.pressure_msl)||[];
        var hArr=(data.hourly&&data.hourly.relative_humidity_2m)||[];
        var prArr=(data.hourly&&data.hourly.precipitation_probability)||[];
        var idx = (c.time && times && times.length) ? nearestIndex(times, c.time) : -1;
        var p = (idx>-1 && pArr && pArr.length) ? pArr[idx] : null;
        var h = (idx>-1 && hArr && hArr.length) ? hArr[idx] : null;
        var pr = (idx>-1 && prArr && prArr.length) ? prArr[idx] : null;
        var trend = (idx>-1) ? pressureTrend(pArr, idx) : "å®‰å®š";
        var out={ temp:c.temperature, code:c.weathercode, pressure:p, humidity:h, pprob:pr, trend:trend };
        state.wx = out; renderWx(out); autoSave(); return out;
      }).catch(function(){ renderWx(null); });
    }
    function autoWx(){
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(
          function(pos){ fetchWx(pos.coords.latitude, pos.coords.longitude); },
          function(){ fetchWx(TOKYO.lat, TOKYO.lon); },
          {enableHighAccuracy:true, timeout:6000, maximumAge:600000}
        );
      }else{ fetchWx(TOKYO.lat, TOKYO.lon); }
    }
    document.getElementById("useGeo").addEventListener("click", function(){ autoWx(); });
    autoWx();

    // å±¥æ­´åˆæœŸæç”»
    renderHistory();
  });
})();
</script>
</body>
</html>
