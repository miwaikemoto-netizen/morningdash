<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>MorningDash â€” v11 (PWAãƒ–ãƒªãƒƒã‚¸/è¡¨ç¤ºä¿®æ­£)</title>
<meta name="theme-color" content="#0f172a">

<!-- é¡”ã¤ãï¼ˆä¸Šå“ãªã‚«ãƒ¼ãƒ‰ãƒ»æ–‡å­—è‰²ãªã©ï¼‰ -->
<style>
:root{
  --bg:#f8fafc; --card:#ffffff; --line:#e5e7eb; --text:#0f172a; --muted:#64748b;
  --accent:#0ea5e9; --accent-press:#0284c7;
  --radius:14px; --shadow:0 6px 20px rgba(2,8,23,.06);
}
html,body{background:var(--bg);color:var(--text);}
body{font-family:system-ui,-apple-system,"SF Pro","Hiragino Sans",Arial,"Meiryo",sans-serif;}
.section,.card,.panel{
  background:var(--card); border:1px solid var(--line); border-radius:var(--radius);
  box-shadow:var(--shadow); padding:20px !important; margin-block:18px !important;
  overflow:hidden;                          /* iOSã®è§’ä¸¸ã¯ã¿å‡ºã—å¯¾ç­– */
  -webkit-mask-image:-webkit-radial-gradient(white,black);
  box-sizing:border-box;
}
.section h2,.card h2,.panel h2{letter-spacing:.01em;font-weight:700;margin-bottom:10px}
button,.btn,input[type=button],input[type=submit]{
  background:var(--accent); color:#fff; border:none; border-radius:12px;
  padding:10px 14px; font-weight:600; box-shadow:0 4px 12px rgba(14,165,233,.25);
  transition:.15s transform ease,.15s background ease;
}
button:hover,.btn:hover{background:var(--accent-press)}
button:active,.btn:active{transform:translateY(1px)}
.btn-ghost,.ghost{background:transparent!important;color:var(--accent);border:1px solid var(--accent);box-shadow:none}
input[type=text],input[type=number],textarea,select{
  border:1px solid var(--line); border-radius:10px; padding:10px 12px; background:#fff;
  display:block; width:100%; max-width:100%; box-sizing:border-box; /* ã¯ã¿å‡ºã—é˜²æ­¢ */
}
/* æ—¥ä»˜ã‚’å¤§ãã */
#md-date,#todayStr,.date-today{font-size:clamp(24px,3.2rem,44px);font-weight:800;letter-spacing:.02em;line-height:1.15;margin:6px 0 2px}
/* ãƒŸãƒ‹ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è»½é‡åŒ– */
.mini-cal{transform:scale(.92);transform-origin:top left}
.mini-cal .day{width:2.1rem;height:2.1rem;border-radius:10px}
.mini-cal .day.today{outline:1.5px solid var(--accent);outline-offset:1px;font-weight:800}
/* æœªé¸æŠãƒãƒƒãƒ—ã®æ–‡å­—è‰²ãŒæ¶ˆãˆã‚‹å•é¡Œä¿®æ­£ */
.chip{color:#0f172a!important;background:#fff!important;border:1px solid #e5e7eb!important}
.chip.active{background:#0ea5e9!important;border-color:#0ea5e9!important;color:#fff!important}
/* æ—¢å­˜ãƒ†ãƒ¼ãƒéƒ¨å“ */
.container{max-width:980px;margin:0 auto;padding:16px}
h1{font-size:28px;margin:0 0 8px;font-weight:700}
h2{font-size:18px;margin:0 0 8px;font-weight:600}
h3{font-size:14px;margin:0 0 6px;font-weight:600}
.muted{opacity:.7}
.row{display:flex;gap:16px;flex-wrap:wrap}
.btn{appearance:none;border-radius:14px}
.btn.small{font-size:12px;padding:6px 10px}
.btn.tiny{font-size:11px;padding:4px 8px;border-radius:10px}
.input{border:1px solid var(--line);border-radius:12px;padding:10px 12px;font-size:14px}
.text{font-size:14px}
.titlebar{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.number{width:64px;text-align:center}
.badge{font-size:12px;padding:3px 8px;border-radius:999px;border:1px solid var(--line)}
.danger{color:#b91c1c}
.date-big{font-size:40px;font-weight:700;letter-spacing:.5px}
.symptom-group{border:1px dashed var(--line);border-radius:12px;padding:12px;margin:10px 0}
.quick-task{display:flex;align-items:center;gap:8px;margin:4px 0}
.quick-task input[type="text"]{flex:1}
.toolbar{display:flex;align-items:center;gap:8px}
.linklike{font-size:12px;text-decoration:underline;cursor:pointer}
.tabs{display:flex;gap:8px;margin:8px 0}
.tab{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#fff;cursor:pointer}
.tab.active{background:#0f172a;color:#fff;border-color:#0f172a}
.filterbar{display:flex;gap:8px;align-items:center;margin-bottom:8px}
.calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
.cal-cell{border:1px solid var(--line);border-radius:10px;padding:4px 2px;text-align:center;cursor:pointer;background:#fff;font-size:12px;line-height:1.1}
.cal-cell.today{border-color:#0f172a;border-width:2px}
.cal-cell .dot{display:block;width:7px;height:7px;border-radius:50%;margin:4px auto 0;background:#cbd5e1}
.cal-head{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-bottom:6px}
.cal-head div{font-size:12px;text-align:center;opacity:.7}
.summary-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
.chart{width:100%;height:180px;border:1px solid var(--line);border-radius:12px;background:#fff;overflow:hidden}
.chart svg{width:100%;height:100%;display:block}
.chart .axis{stroke:#cbd5e1;stroke-width:1}
.chart .bar{fill:#94a3b8}
.chart .line{fill:none;stroke:#334155;stroke-width:2}
.chart .dot{fill:#334155}
.footer{font-size:12px;opacity:.6;margin-top:24px;line-height:1.6}
</style>
</head>

<body>
  <div class="container">
    <div class="titlebar">
      <h1>MorningDash â˜€ï¸</h1>
      <div class="toolbar">
        <input id="datePicker" type="date" class="input" style="padding:8px 10px">
        <span id="editBadge" class="badge" style="display:none">ç·¨é›†ãƒ¢ãƒ¼ãƒ‰</span>
      </div>
    </div>
    <div class="date-big" id="dateLabel"></div>

    <div class="tabs">
      <button id="tabMain" class="tab active">ãƒ¡ã‚¤ãƒ³</button>
      <button id="tabTaskHistory" class="tab">ã‚¿ã‚¹ã‚¯å±¥æ­´</button>
      <button id="tabSummary" class="tab">ã¾ã¨ã‚</button>
    </div>

    <div id="pageMain">
      <section class="card">
        <div class="titlebar">
          <h2>ãƒŸãƒ‹ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆæœˆï¼‰</h2>
          <div class="toolbar">
            <button id="prevMonth" class="btn tiny">â†</button>
            <span id="calLabel" class="muted"></span>
            <button id="nextMonth" class="btn tiny">â†’</button>
          </div>
        </div>
        <div class="cal-head">
          <div>æ—¥</div><div>æœˆ</div><div>ç«</div><div>æ°´</div><div>æœ¨</div><div>é‡‘</div><div>åœŸ</div>
        </div>
        <div id="miniCalendar" class="calendar"></div>
        <div class="text muted" style="margin-top:6px">â—ã®è‰²ï¼šâ¤ï¸â€ğŸ”¥å…ƒæ°—=æ¿ƒï¼â¤ï¸=ä¸­ï¼â¤ï¸â€ğŸ©¹=è–„ï¼ˆè¨˜éŒ²ãªã—=ã‚°ãƒ¬ãƒ¼ï¼‰</div>
      </section>

      <section class="card" style="margin-top:16px">
        <div class="titlebar">
          <h2>å¤©æ°—ï¼ˆç¾åœ¨åœ°ï¼‰</h2>
          <span id="wxLoading" class="muted" style="display:none">å–å¾—ä¸­â€¦</span>
        </div>
        <div id="wxError" class="text danger"></div>
        <div id="wxBlock" class="row"></div>
        <div class="row" style="margin-top:8px">
          <button id="retryWx" class="btn small">å†å–å¾—</button>
        </div>
      </section>

      <section class="row" style="margin-top:16px">
        <div class="card" style="flex:1 1 300px;min-width:280px">
          <h2>æ°—åˆ†</h2>
          <div id="moodBtns" class="row"></div>
        </div>
        <div class="card" style="flex:1 1 300px;min-width:280px">
          <h2>å…ƒæ°—åº¦</h2>
          <div id="energyBtns" class="row"></div>
        </div>
      </section>

      <section class="row" style="margin-top:16px">
        <div class="card" style="flex:1 1 300px;min-width:280px">
          <h2>ä½“èª¿ãƒ¡ãƒ¢</h2>
          <div class="symptom-group">
            <h3>â‘  ã‚ˆãã‚ã‚‹ä¸èª¿</h3><div id="symptomGroup1" class="row"></div>
          </div>
          <div class="symptom-group">
            <h3>â‘¡ å­£ç¯€ãƒ»ç”Ÿæ´»ãƒªã‚ºãƒ </h3><div id="symptomGroup2" class="row"></div>
          </div>
          <div class="symptom-group">
            <h3>â‘¢ ãƒ¡ãƒ³ã‚¿ãƒ«ãƒ»ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³</h3><div id="symptomGroup3" class="row"></div>
          </div>
          <textarea id="note" class="input" rows="3" placeholder="è‡ªç”±ãƒ¡ãƒ¢ï¼ˆä¾‹ï¼šé¦–ã®å¼µã‚Šå¼·ã‚ï¼å†·ãˆæ°—å‘³ ãªã©ï¼‰"></textarea>
        </div>

        <div class="card" style="flex:1 1 300px;min-width:280px">
          <h2>ç¡çœ </h2>
          <div class="row" style="align-items:center;margin-bottom:8px">
            <input id="sleepH" class="input number" type="number" min="0" max="23" value="0"><span>æ™‚é–“</span>
            <input id="sleepM" class="input number" type="number" min="0" max="59" value="0"><span>åˆ†</span>
          </div>
          <div class="text muted" style="margin-bottom:6px">â€» ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆé€£æºã§è‡ªå‹•å…¥åŠ›ï¼ˆ?sleepMin=åˆè¨ˆåˆ†ï¼‰</div>
          <div class="text">åˆè¨ˆï¼š<b id="sleepTotal">0æ™‚é–“0åˆ†</b></div>

          <div class="card" style="margin-top:12px">
            <h3>ãƒ˜ãƒ«ã‚¹ï¼ˆä»»æ„ï¼‰</h3>
            <div class="row" style="align-items:center">
              <span>ä½“é‡</span><input id="weight" class="input number" type="number" step="0.1" min="0" style="width:90px"><span>kg</span>
              <span>ä½“è„‚è‚ª</span><input id="bodyFat" class="input number" type="number" step="0.1" min="0" max="100" style="width:90px"><span>%</span>
            </div>
            <div class="row" style="align-items:center;margin-top:8px">
              <button id="copyHealthShortcut" class="btn small">ãƒ˜ãƒ«ã‚¹å–ã‚Šè¾¼ã¿ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆç”¨URLã‚’ã‚³ãƒ”ãƒ¼</button>
            </div>
            <div class="text muted" style="margin-top:6px">
              â€» ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã§ãƒ˜ãƒ«ã‚¹ã‚±ã‚¢ã‹ã‚‰å–å¾— â†’ URLã§
              <code>?sleepMin=&weight=&bodyFat=</code> ã‚’æ¸¡ã™ã¨è‡ªå‹•å…¥åŠ›
            </div>
          </div>
        </div>
      </section>

      <section class="row" style="margin-top:16px">
        <button id="saveLog" class="btn">ã“ã®æ—¥ã®è¨˜éŒ²ã‚’ä¿å­˜</button>
        <button id="exportCSV" class="btn btn-ghost">CSV</button>
        <button id="exportJSON" class="btn btn-ghost">JSON</button>
        <a href="./evening.html" class="btn btn-ghost">ğŸŒ™ å¤œã®è¨˜éŒ²ã¸</a>
        <label class="btn small" for="importJSON" style="cursor:pointer">JSONã‚’èª­ã¿è¾¼ã¿</label>
        <input id="importJSON" type="file" accept="application/json" style="display:none">
      </section>

      <section class="card" style="margin-top:16px">
        <div class="titlebar">
          <h2>å±¥æ­´</h2>
          <button id="reloadHistory" class="btn small">å±¥æ­´ã‚’å†èª­è¾¼</button>
        </div>
        <div id="history"></div>
      </section>
    </div>

    <div id="pageTaskHistory" style="display:none">
      <section class="card">
        <div class="titlebar">
          <h2>ã‚¿ã‚¹ã‚¯å±¥æ­´ï¼ˆæœªå®Œäº†ã®ä¿ç®¡åº«ï¼‰</h2>
          <div class="toolbar">
            <button id="clearTaskHistory" class="btn small">å…¨æ¶ˆå»</button>
            <button id="backToMain" class="btn small">ãƒ¡ã‚¤ãƒ³ã¸æˆ»ã‚‹</button>
          </div>
        </div>
        <div class="filterbar">
          <input id="thSearch" class="input" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§çµã‚Šè¾¼ã¿ï¼ˆä¾‹ï¼šæ°´ã‚„ã‚Šï¼‰" style="flex:1">
          <input id="thDate" type="date" class="input">
          <button id="thClear" class="btn small">ãƒ•ã‚£ãƒ«ã‚¿ã‚’ã‚¯ãƒªã‚¢</button>
        </div>
        <div id="taskHistoryList"></div>
      </section>
    </div>

    <div id="pageSummary" style="display:none">
      <section class="card">
        <div class="titlebar"><h2>ã¾ã¨ã‚ï¼ˆé€±é–“ãƒ»æœˆé–“ï¼‰</h2></div>
        <div class="summary-grid">
          <div><h3>ç›´è¿‘7æ—¥ï¼šç¡çœ ï¼ˆæ™‚é–“ï¼‰</h3><div id="chartSleep7" class="chart"></div></div>
          <div><h3>ç›´è¿‘30æ—¥ï¼šå…ƒæ°—åº¦ã‚«ã‚¦ãƒ³ãƒˆ</h3><div id="chartEnergy30" class="chart"></div></div>
          <div><h3>ç›´è¿‘30æ—¥ï¼šä½“é‡ï¼ˆæŠ˜ã‚Œç·šï¼‰</h3><div id="chartWeight30" class="chart"></div></div>
        </div>
      </section>
    </div>

    <div class="footer">
      <p>Tips: å…±æœ‰ â†’ ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ  ã§ã‚¢ãƒ—ãƒªé¢¨ã«ä½¿ãˆã¾ã™ã€‚</p>
      <p class="muted">ä¿å­˜å ´æ‰€ã¯ã“ã®ç«¯æœ«ã®ãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆlocalStorageï¼‰ã€‚åŒã˜URLãªã‚‰ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã—ã¦ã‚‚å±¥æ­´ã¯ç¶™ç¶šåˆ©ç”¨ã•ã‚Œã¾ã™ã€‚</p>
    </div>
  </div>

<script>
/* ====== URLâ†’Cookieâ†’PWA ãƒ–ãƒªãƒƒã‚¸ ====== */
(function bridgeFromURLAndCookie(){
  const u = new URL(window.location.href);
  const hasQP = ['sleepMin','weight','bodyFat'].some(k => u.searchParams.has(k));
  function numOrNull(v){ if(v==null) return null; const n=parseFloat(String(v).trim()); return Number.isFinite(n)?n:null; }
  const Cookie = {
    set(name,val,days){ const d=new Date(); d.setTime(d.getTime()+days*864e5);
      document.cookie=`${name}=${encodeURIComponent(val)}; expires=${d.toUTCString()}; path=/; SameSite=Lax`; },
    get(name){ const m=document.cookie.match(new RegExp('(?:^|; )'+name.replace(/([.$?*|{}()\\[\\]\\\\/+^])/g,'\\$1')+'=([^;]*)')); return m?decodeURIComponent(m[1]):null; },
    del(name){ document.cookie=`${name}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/`; }
  };
  const KEY='md_bridge_v1';
  if(hasQP){
    const payload={
      sleepMin:(u.searchParams.get('sleepMin')!=null?parseInt(u.searchParams.get('sleepMin'),10)||0:null),
      weight:numOrNull(u.searchParams.get('weight')),
      bodyFat:numOrNull(u.searchParams.get('bodyFat')),
      ts:Date.now()
    };
    Cookie.set(KEY, JSON.stringify(payload), 2);
    if(window.matchMedia('(display-mode: standalone)').matches){
      try{
        const LOGS_KEY="md_logs_v2";
        const todayKey=new Date().toLocaleDateString("ja-JP",{timeZone:"Asia/Tokyo"});
        const logs=JSON.parse(localStorage.getItem(LOGS_KEY)||"[]");
        const rec=logs.find(l=>l.date===todayKey)||{date:todayKey};
        if(payload.sleepMin!=null) rec.sleepMin=payload.sleepMin;
        if(payload.weight!=null) rec.weight=payload.weight;
        if(payload.bodyFat!=null) rec.bodyFat=payload.bodyFat;
        rec.ts=Date.now();
        const rest=logs.filter(l=>l.date!==todayKey);
        localStorage.setItem(LOGS_KEY, JSON.stringify([rec,...rest]));
      }catch(e){}
    }
    try{ history.replaceState(null,'',location.pathname); }catch(e){}
  }
  if(window.matchMedia('(display-mode: standalone)').matches){
    const raw=Cookie.get(KEY);
    if(raw){
      try{
        const p=JSON.parse(raw);
        const LOGS_KEY="md_logs_v2";
        const todayKey=new Date().toLocaleDateString("ja-JP",{timeZone:"Asia/Tokyo"});
        const logs=JSON.parse(localStorage.getItem(LOGS_KEY)||"[]");
        const rec=logs.find(l=>l.date===todayKey)||{date:todayKey};
        if(p.sleepMin!=null) rec.sleepMin=parseInt(p.sleepMin,10)||0;
        if(p.weight!=null)   rec.weight=p.weight;
        if(p.bodyFat!=null)  rec.bodyFat=p.bodyFat;
        rec.ts=Date.now();
        const rest=logs.filter(l=>l.date!==todayKey);
        localStorage.setItem(LOGS_KEY, JSON.stringify([rec,...rest]));
      }catch(e){}
      Cookie.del(KEY);
    }
  }
})();

/* ====== ã“ã“ã‹ã‚‰å¾“æ¥ãƒ­ã‚¸ãƒƒã‚¯ ====== */
(function(){
  const $=(s)=>document.querySelector(s);
  const $$=(s)=>Array.from(document.querySelectorAll(s));
  const today=new Date();
  const toKey=d=>d.toLocaleDateString("ja-JP",{timeZone:"Asia/Tokyo"});
  const toInputDate=d=>{const z=n=>String(n).padStart(2,"0");return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`};
  const fromInputDate=s=>{const [y,m,da]=s.split("-").map(Number);return new Date(y,m-1,da)};

  const todayKey=toKey(today); let currentDateKey=todayKey;
  const dateLabel=$("#dateLabel"), datePicker=$("#datePicker"), editBadge=$("#editBadge");
  const pageMain=$("#pageMain"), pageTaskHistory=$("#pageTaskHistory"), pageSummary=$("#pageSummary");

  function renderHeader(){
    dateLabel.textContent=currentDateKey;
    editBadge.style.display=(currentDateKey===todayKey)?"none":"inline-block";
    const [y,m,da]=currentDateKey.split("/").map(Number);
    datePicker.value=toInputDate(new Date(y,m-1,da));
  }
  datePicker.value=toInputDate(today); renderHeader();

  $("#tabMain").addEventListener("click",()=>showPage("main"));
  $("#tabTaskHistory").addEventListener("click",()=>{showPage("taskHistory");renderTaskHistory();});
  $("#tabSummary").addEventListener("click",()=>{showPage("summary");renderCharts();});
  function showPage(which){
    pageMain.style.display=which==="main"?"block":"none";
    pageTaskHistory.style.display=which==="taskHistory"?"block":"none";
    pageSummary.style.display=which==="summary"?"block":"none";
    $("#tabMain").classList.toggle("active",which==="main");
    $("#tabTaskHistory").classList.toggle("active",which==="taskHistory");
    $("#tabSummary").classList.toggle("active",which==="summary");
  }

  const state={mood:"",energy:"",symptoms:[],note:"",sleepH:0,sleepM:0,weight:null,bodyFat:null,weather:null,
               quickTasks:[{done:false,text:""},{done:false,text:""},{done:false,text:""}]};
  const moods=[{v:"ğŸ™‚",label:"è‰¯ã„"},{v:"ğŸ˜",label:"ãµã¤ã†"},{v:"ğŸ™",label:"ã„ã¾ã„ã¡"}];
  const energies=["â¤ï¸â€ğŸ”¥å…ƒæ°—","â¤ï¸ã¾ãšã¾ãš","â¤ï¸â€ğŸ©¹ã ã‚‹ã„"];
  const group1=["é¦–ãƒ»è‚©ã“ã‚Š","é ­ç—›","è…¹ç—›ï¼ãŠè…¹ã®å¼µã‚Š","è…°ã®å¼µã‚Šï¼è…°ç—›","èƒƒè…¸å¼±ã‚ï¼ˆèƒƒã‚‚ãŸã‚Œãƒ»ä¸‹ç—¢ãƒ»ä¾¿ç§˜ãªã©ï¼‰","ã‚€ãã¿","ç›®ã®ç–²ã‚Œï¼ãƒ‰ãƒ©ã‚¤ã‚¢ã‚¤","è‡ªå¾‹ç¥çµŒã®ä¹±ã‚Œ","ç¡çœ ã®è³ªä½ä¸‹ï¼ˆæµ…ã„çœ ã‚Šãƒ»é€”ä¸­è¦šé†’ï¼‰","ç”Ÿç†"];
  const group2=["å†·ãˆï¼ˆæ‰‹è¶³ã®å†·ãˆãƒ»å…¨èº«ï¼‰","æš‘ã•ãƒãƒ†ï¼ç†±ã£ã½ã•","å–‰ã®ç—›ã¿ãƒ»å£°æ¯ã‚Œ","é¼»æ°´ãƒ»é¼»ã¥ã¾ã‚Š","è‚Œè’ã‚Œï¼ã‹ã‚†ã¿","èŠ±ç²‰ãƒ»ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ç—‡çŠ¶"];
  const group3=["é›†ä¸­åŠ›ä½ä¸‹","ã‚¤ãƒ©ã‚¤ãƒ©ï¼ä¸å®‰æ„Ÿ","ã ã‚‹ã•ï¼å€¦æ€ æ„Ÿ","ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ä½ä¸‹","PMSï¼ˆç”Ÿç†å‰ç—‡çŠ¶ï¼‰"];
  const allSymptoms=[...group1,...group2,...group3];

  function buildChips(root,options,isActive,onClick){
    root.innerHTML="";
    options.forEach(opt=>{
      const v=typeof opt==="string"?opt:opt.v;
      const label=typeof opt==="string"?opt:(opt.v+" "+opt.label);
      const b=document.createElement("button");
      b.className="chip"+(isActive(v)?" active":"");
      b.textContent=label;
      b.addEventListener("click",()=>onClick(v));
      root.appendChild(b);
    });
  }
  function renderChips(){
    buildChips($("#moodBtns"),moods,v=>state.mood===v,v=>{state.mood=v;renderChips();autoSave();});
    buildChips($("#energyBtns"),energies,v=>state.energy===v,v=>{state.energy=v;renderChips();autoSave();});
    const mk=(id,arr)=>buildChips($(id),arr,v=>state.symptoms.includes(v),v=>{
      if(state.symptoms.includes(v)) state.symptoms=state.symptoms.filter(x=>x!==v);
      else state.symptoms=[...state.symptoms,v];
      renderChips();autoSave();
    });
    mk("#symptomGroup1",group1); mk("#symptomGroup2",group2); mk("#symptomGroup3",group3);
  }
  renderChips();

  const url=new URL(window.location.href);
  const qp=k=>url.searchParams.get(k);
  function parseNumMaybe(v){ if(v==null) return null; const n=parseFloat(String(v).trim()); return isNaN(n)?null:n; }
  const qpPayload={};
  if(qp("sleepMin")!=null) qpPayload.sleepMin=parseInt(qp("sleepMin"),10)||0;
  if(qp("mood")) qpPayload.mood=qp("mood");
  if(qp("energy")) qpPayload.energy=qp("energy");
  if(qp("symptoms")) qpPayload.symptoms=qp("symptoms").split(",").filter(Boolean);
  if(qp("note")) qpPayload.note=qp("note");
  const wnum=parseNumMaybe(qp("weight")); if(wnum!=null) qpPayload.weight=wnum;
  const bnum=parseNumMaybe(qp("bodyFat")); if(bnum!=null) qpPayload.bodyFat=bnum;

  const sleepTotal=$("#sleepTotal");
  function updateSleepLabel(){ sleepTotal.textContent=Math.floor(state.sleepH)+"æ™‚é–“"+(state.sleepM%60)+"åˆ†"; }

  const qtElems=[{c:$("#qt0c"),t:$("#qt0t")},{c:$("#qt1c"),t:$("#qt1t")},{c:$("#qt2c"),t:$("#qt2t")}];
  function renderQuickTasks(){
    qtElems.forEach((q,i)=>{
      if(!q.c||!q.t) return;
      q.c.checked=!!state.quickTasks[i]?.done;
      q.t.value=state.quickTasks[i]?.text||"";
      q.c.onchange=()=>{state.quickTasks[i].done=q.c.checked;autoSave();};
      q.t.oninput =()=>{state.quickTasks[i].text=q.t.value;autoSave();};
    });
  }
  renderQuickTasks();

  const wxLoading=$("#wxLoading"), wxError=$("#wxError"), wxBlock=$("#wxBlock");
  function wxCodeToText(code){ const map={0:"å¿«æ™´",1:"æ™´ã‚Œ",2:"è–„æ›‡ã‚Š",3:"æ›‡ã‚Š",45:"éœ§",48:"éœ§æ°·",51:"å¼±ã„éœ§é›¨",53:"éœ§é›¨",55:"å¼·ã„éœ§é›¨",61:"å¼±ã„é›¨",63:"é›¨",65:"å¼·ã„é›¨",71:"å¼±ã„é›ª",73:"é›ª",75:"å¤§é›ª",95:"é›·é›¨"}; return map[code]||"â€”"; }
  function renderWeather(){
    wxBlock.innerHTML="";
    if(!state.weather){ const p=document.createElement("p"); p.className="text muted"; p.textContent="ä½ç½®æƒ…å ±ã®è¨±å¯å¾Œã€è‡ªå‹•è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚"; wxBlock.appendChild(p); return; }
    const big=document.createElement("div"); big.style.fontSize="44px"; big.style.fontWeight="600"; big.textContent=Math.round(state.weather.temp)+"Â°C";
    const small=document.createElement("div"); small.className="text";
    const lines=[]; lines.push("çŠ¶æ³ï¼š"+state.weather.condition);
    if(state.weather.appTemp!=null) lines.push("ä½“æ„Ÿï¼š"+Math.round(state.weather.appTemp)+"Â°C");
    lines.push("é¢¨é€Ÿï¼š"+Math.round(state.weather.wind)+" m/s");
    if(state.weather.humidity!=null) lines.push("æ¹¿åº¦ï¼š"+Math.round(state.weather.humidity)+"%");
    if(state.weather.pop!=null) lines.push("é™æ°´ç¢ºç‡ï¼ˆä»Šï¼‰ï¼š"+state.weather.pop+"%");
    if(state.weather.sunrise&&state.weather.sunset) lines.push("æ—¥ã®å‡ºï¼š"+state.weather.sunrise+"ï¼æ—¥ã®å…¥ã‚Šï¼š"+state.weather.sunset);
    lines.push("<span class='muted'>æ›´æ–°ï¼š"+new Date(state.weather.time).toLocaleTimeString("ja-JP",{timeZone:"Asia/Tokyo"})+"</span>");
    small.innerHTML=lines.join("<br>");
    const wrap=document.createElement("div"); wrap.className="row"; wrap.appendChild(big); wrap.appendChild(small);
    wxBlock.appendChild(wrap);
  }
  function fetchWeatherFromGeo(lat,lon){
    wxLoading.style.display="inline"; wxError.textContent="";
    const u=new URL("https://api.open-meteo.com/v1/forecast");
    u.searchParams.set("latitude",lat); u.searchParams.set("longitude",lon);
    u.searchParams.set("current_weather","true");
    u.searchParams.set("hourly","precipitation_probability,relativehumidity_2m");
    u.searchParams.set("daily","sunrise,sunset"); u.searchParams.set("timezone","Asia/Tokyo");
    fetch(u.toString()).then(r=>r.json()).then(data=>{
      const c=data.current_weather, times=(data.hourly&&data.hourly.time)||[], nowISO=c.time, idx=times.indexOf(nowISO);
      const hum=(idx>-1&&data.hourly.relativehumidity_2m)?data.hourly.relativehumidity_2m[idx]:null;
      const pop=(idx>-1&&data.hourly.precipitation_probability)?data.hourly.precipitation_probability[idx]:null;
      const sunrise=(data.daily&&data.daily.sunrise)?data.daily.sunrise[0]?.split("T")[1]?.slice(0,5):null;
      const sunset =(data.daily&&data.daily.sunset )?data.daily.sunset [0]?.split("T")[1]?.slice(0,5):null;
      state.weather={temp:c.temperature,wind:c.windspeed,code:c.weathercode,condition:wxCodeToText(c.weathercode),time:c.time,appTemp:c.apparent_temperature??null,humidity:hum,pop:pop,sunrise:sunrise,sunset:sunset};
      renderWeather(); autoSave();
    }).catch(()=>{ wxError.textContent="å¤©æ°—ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"; }).finally(()=>{ wxLoading.style.display="none"; });
  }
  function askGeo(){
    wxLoading.style.display="inline"; wxError.textContent="";
    if(!("geolocation" in navigator)){ wxError.textContent="ã“ã®ç«¯æœ«ã¯ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚"; wxLoading.style.display="none"; return; }
    navigator.geolocation.getCurrentPosition(
      pos=>{const {latitude,longitude}=pos.coords; fetchWeatherFromGeo(latitude,longitude);},
      ()=>{wxError.textContent="ä½ç½®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚è¨­å®šã§Safari Websitesã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚"; wxLoading.style.display="none";},
      {enableHighAccuracy:false,timeout:8000}
    );
  }
  $("#retryWx").addEventListener("click",askGeo); askGeo();

  const LOGS_KEY="md_logs_v2", TASK_HIST_KEY="md_task_history_v1";
  const loadAllLogs=()=>JSON.parse(localStorage.getItem(LOGS_KEY)||"[]");
  const saveAllLogs=(arr)=>localStorage.setItem(LOGS_KEY,JSON.stringify(arr));
  const loadLog=(dateKey)=>loadAllLogs().find(l=>l.date===dateKey)||null;
  const upsertLog=(payload)=>{ const logs=loadAllLogs(); const rest=logs.filter(l=>l.date!==payload.date); saveAllLogs([payload,...rest].sort((a,b)=>a.date<b.date?1:-1)); };
  const loadTaskHistory=()=>JSON.parse(localStorage.getItem(TASK_HIST_KEY)||"[]");
  const saveTaskHistory=(arr)=>localStorage.setItem(TASK_HIST_KEY,JSON.stringify(arr));
  function saveUnfinishedTasksToHistory(dateKey){
    const unfinished=state.quickTasks.filter(x=>x.text&&!x.done).map(x=>({text:x.text,from:"quick",savedAt:Date.now()}));
    if(!unfinished.length) return 0;
    const hist=loadTaskHistory(); const rest=hist.filter(h=>h.date!==dateKey);
    saveTaskHistory([{date:dateKey,tasks:unfinished},...rest]); return unfinished.length;
  }

  let saveTimer=null;
  function autoSave(){
    clearTimeout(saveTimer);
    saveTimer=setTimeout(()=>{
      const payload={date:currentDateKey,mood:state.mood,energy:state.energy,symptoms:state.symptoms,
        sleepMin:(parseInt(state.sleepH,10)||0)*60+(parseInt(state.sleepM,10)||0),
        weight:state.weight,bodyFat:state.bodyFat,note:state.note,weather:state.weather,quickTasks:state.quickTasks,ts:Date.now()};
      upsertLog(payload); renderHistory(); renderMiniCalendar(); if($("#pageSummary").style.display!=="none") renderCharts();
    },400);
  }

  function syncFormFromState(){
    $("#sleepH").value=state.sleepH; $("#sleepM").value=state.sleepM; updateSleepLabel();
    $("#note").value=state.note; $("#weight").value=state.weight??""; $("#bodyFat").value=state.bodyFat??"";
  }
  function loadLogToForm(log){
    if(!log){ state.mood="";state.energy="";state.symptoms=[];state.note="";state.sleepH=0;state.sleepM=0;state.weight=null;state.bodyFat=null;state.quickTasks=[{done:false,text:""},{done:false,text:""},{done:false,text:""}]; }
    else{
      state.mood=log.mood||""; state.energy=log.energy||""; state.symptoms=Array.isArray(log.symptoms)?log.symptoms.filter(s=>allSymptoms.includes(s)):[];
      const sm=parseInt(log.sleepMin||0,10); state.sleepH=Math.floor(sm/60); state.sleepM=sm%60;
      state.weight=(log.weight??null); state.bodyFat=(log.bodyFat??null); state.note=log.note||""; state.weather=log.weather||state.weather;
      state.quickTasks=Array.isArray(log.quickTasks)&&log.quickTasks.length===3?log.quickTasks:[{done:false,text:""},{done:false,text:""},{done:false,text:""}];
    }
    renderChips(); syncFormFromState(); renderQuickTasks(); renderHeader();
  }

  function renderHistory(){
    const historyRoot=$("#history"); const logs=loadAllLogs(); historyRoot.innerHTML="";
    if(logs.length===0){ const p=document.createElement("p"); p.className="text muted"; p.textContent="ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“"; historyRoot.appendChild(p); return; }
    logs.forEach(l=>{
      const box=document.createElement("div"); box.className="card"; box.style.marginTop="8px";
      const head=document.createElement("div"); head.className="text"; head.innerHTML=`<span class="muted">${l.date}</span>`;
      const row=document.createElement("div"); row.className="row text"; row.style.marginTop="6px";
      row.innerHTML=`<div>æ°—åˆ†ï¼š${l.mood||"â€”"}</div>
        <div>å…ƒæ°—åº¦ï¼š${l.energy||"â€”"}</div>
        <div>ç¡çœ ï¼š${Math.floor((l.sleepMin||0)/60)}æ™‚é–“${(l.sleepMin||0)%60}åˆ†</div>
        ${l.weight!=null?`<div>ä½“é‡ï¼š${l.weight}kg</div>`:""}
        ${l.bodyFat!=null?`<div>ä½“è„‚è‚ªï¼š${l.bodyFat}%</div>`:""}`;
      const qts=document.createElement("div"); qts.className="text";
      const nonEmpty=(l.quickTasks||[]).filter(x=>x&&x.text&&x.text.trim().length>0);
      if(nonEmpty.length){ qts.textContent="ã‚¿ã‚¹ã‚¯ï¼š"+nonEmpty.map(x=>(x.done?"âœ… ":"â¬œ ")+x.text).join(" / "); }
      const actions=document.createElement("div"); actions.className="row"; actions.style.marginTop="8px";
      const editBtn=document.createElement("button"); editBtn.className="btn small"; editBtn.textContent="ç·¨é›†";
      editBtn.addEventListener("click",()=>{ currentDateKey=l.date; loadLogToForm(l); window.scrollTo({top:0,behavior:"smooth"}); });
      const delBtn=document.createElement("button"); delBtn.className="btn small"; delBtn.textContent="å‰Šé™¤"; delBtn.style.borderColor="#fecaca";
      delBtn.addEventListener("click",()=>{ if(!confirm(`${l.date} ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`))return;
        const rest=loadAllLogs().filter(x=>x.date!==l.date); saveAllLogs(rest); renderHistory(); renderMiniCalendar();
        if($("#pageSummary").style.display!=="none") renderCharts(); if(currentDateKey===l.date){ currentDateKey=todayKey; loadLogToForm(loadLog(todayKey)); }});
      actions.appendChild(editBtn); actions.appendChild(delBtn);
      box.appendChild(head); box.appendChild(row); if(qts.textContent) box.appendChild(qts); box.appendChild(actions);
      historyRoot.appendChild(box);
    });
  }

  let calMonth=new Date(today.getFullYear(),today.getMonth(),1);
  function renderMiniCalendar(){
    $("#calLabel").textContent=`${calMonth.getFullYear()}å¹´ ${calMonth.getMonth()+1}æœˆ`;
    const root=$("#miniCalendar"); root.innerHTML="";
    const firstDow=new Date(calMonth.getFullYear(),calMonth.getMonth(),1).getDay();
    const daysInMonth=new Date(calMonth.getFullYear(),calMonth.getMonth()+1,0).getDate();
    for(let i=0;i<firstDow;i++) root.appendChild(document.createElement("div"));
    const logs=loadAllLogs(); const byDate=new Map(logs.map(l=>[l.date,l]));
    for(let d=1; d<=daysInMonth; d++){
      const cell=document.createElement("div"); cell.className="cal-cell";
      const date=new Date(calMonth.getFullYear(),calMonth.getMonth(),d); const key=toKey(date);
      if(key===toKey(new Date())) cell.classList.add("today");
      cell.innerHTML=`${d}<span class="dot"></span>`;
      const dot=cell.querySelector(".dot"); const rec=byDate.get(key);
      if(rec){ const e=rec.energy||""; if(e.includes("â¤ï¸â€ğŸ”¥")) dot.style.background="#be123c"; else if(e.includes("â¤ï¸ã¾ãš")) dot.style.background="#f43f5e"; else if(e.includes("â¤ï¸â€ğŸ©¹")) dot.style.background="#fecaca"; }
      cell.addEventListener("click",()=>{ currentDateKey=key; loadLogToForm(rec||null); window.scrollTo({top:0,behavior:"smooth"}); });
      root.appendChild(cell);
    }
  }
  $("#prevMonth").addEventListener("click",()=>{ calMonth=new Date(calMonth.getFullYear(),calMonth.getMonth()-1,1); renderMiniCalendar(); });
  $("#nextMonth").addEventListener("click",()=>{ calMonth=new Date(calMonth.getFullYear(),calMonth.getMonth()+1,1); renderMiniCalendar(); });

  function createSVG(w,h){ const s=document.createElementNS("http://www.w3.org/2000/svg","svg"); s.setAttribute("viewBox",`0 0 ${w} ${h}`); return s; }
  function drawAxes(svg,w,h,m){ const g=document.createElementNS(svg.namespaceURI,"g");
    const ax=document.createElementNS(svg.namespaceURI,"line"); ax.setAttribute("x1",m.left); ax.setAttribute("y1",h-m.bottom); ax.setAttribute("x2",w-m.right); ax.setAttribute("y2",h-m.bottom); ax.setAttribute("class","axis"); g.appendChild(ax);
    const ay=document.createElementNS(svg.namespaceURI,"line"); ay.setAttribute("x1",m.left); ay.setAttribute("y1",m.top); ay.setAttribute("x2",m.left); ay.setAttribute("y2",h-m.bottom); ay.setAttribute("class","axis"); g.appendChild(ay); svg.appendChild(g); }
  function drawBars(el,labels,values,maxY){
    el.innerHTML=""; const w=400,h=180,m={top:10,right:10,bottom:20,left:26};
    const svg=createSVG(w,h); drawAxes(svg,w,h,m);
    const innerW=w-m.left-m.right, innerH=h-m.top-m.bottom; const n=values.length||1; const bw=innerW/n*0.8; const gap=innerW/n*0.2;
    values.forEach((v,i)=>{ const x=m.left+i*(bw+gap)+gap/2; const vh=maxY?(v/maxY)*innerH:0; const y=h-m.bottom-vh;
      const rect=document.createElementNS(svg.namespaceURI,"rect"); rect.setAttribute("x",x); rect.setAttribute("y",y); rect.setAttribute("width",bw); rect.setAttribute("height",vh); rect.setAttribute("class","bar"); svg.appendChild(rect);});
    el.appendChild(svg);
  }
  function drawLine(el,labels,values){
    el.innerHTML=""; const w=400,h=180,m={top:10,right:10,bottom:20,left:26};
    const svg=createSVG(w,h); drawAxes(svg,w,h,m);
    const innerW=w-m.left-m.right, innerH=h-m.top-m.bottom; const xs=(i)=>m.left+(innerW*(i/(Math.max(1,values.length-1))));
    const valid=values.filter(v=>v!=null); if(!valid.length){ el.appendChild(svg); return; }
    const min=Math.min(...valid), max=Math.max(...valid); const ys=(v)=> max===min ? h-m.bottom-innerH/2 : m.top+(1-(v-min)/(max-min))*innerH;
    let d=""; values.forEach((v,i)=>{ if(v==null) return; const x=xs(i), y=ys(v); d += (d===""?`M ${x} ${y}`:` L ${x} ${y}`); });
    const path=document.createElementNS(svg.namespaceURI,"path"); path.setAttribute("d",d); path.setAttribute("class","line"); svg.appendChild(path);
    values.forEach((v,i)=>{ if(v==null) return; const x=xs(i), y=ys(v); const c=document.createElementNS(svg.namespaceURI,"circle"); c.setAttribute("cx",x); c.setAttribute("cy",y); c.setAttribute("r",2.5); c.setAttribute("class","dot"); svg.appendChild(c); });
    el.appendChild(svg);
  }
  function getLogsInDays(days){
    const logs=loadAllLogs(); const now=new Date(); const start=new Date(now.getTime()-days*864e5);
    return logs.filter(l=>{ const [y,m,d]=l.date.split("/").map(Number); const dt=new Date(y,m-1,d); return dt>=start&&dt<=now; }).sort((a,b)=>new Date(a.date)-new Date(b.date));
  }
  function renderCharts(){
    const sleep7=getLogsInDays(7); const vals7=sleep7.map(l=>(l.sleepMin||0)/60); const maxY=Math.max(8,Math.ceil((Math.max(...vals7,0)+1))); drawBars($("#chartSleep7"),[],vals7,maxY);
    const e30=getLogsInDays(30); const cnt={"â¤ï¸â€ğŸ”¥å…ƒæ°—":0,"â¤ï¸ã¾ãšã¾ãš":0,"â¤ï¸â€ğŸ©¹ã ã‚‹ã„":0}; e30.forEach(l=>{ if(cnt[l.energy]!=null) cnt[l.energy]++; });
    drawBars($("#chartEnergy30"),[],[cnt["â¤ï¸â€ğŸ”¥å…ƒæ°—"],cnt["â¤ï¸ã¾ãšã¾ãš"],cnt["â¤ï¸â€ğŸ©¹ã ã‚‹ã„"]],Math.max(5,...Object.values(cnt)));
    const w30=getLogsInDays(30); const wvals=w30.map(l=>(l.weight!=null?Number(l.weight):null)); drawLine($("#chartWeight30"),[],wvals);
  }

  datePicker.addEventListener("change",()=>{ const d=fromInputDate(datePicker.value); currentDateKey=toKey(d); loadLogToForm(loadLog(currentDateKey)); });
  $("#copyHealthShortcut").addEventListener("click",async()=>{ const base=window.location.origin+window.location.pathname;
    const template=`${base}?sleepMin=[[åˆè¨ˆç¡çœ åˆ†]]&weight=[[ä½“é‡_kg]]&bodyFat=[[ä½“è„‚è‚ª_%]]`; try{ await navigator.clipboard.writeText(template); alert("ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆç”¨URLãƒ†ãƒ³ãƒ—ãƒ¬ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"); }catch(e){ alert(template); }});
  $("#saveLog").addEventListener("click",()=>{ const payload={date:currentDateKey,mood:state.mood,energy:state.energy,symptoms:state.symptoms,
    sleepMin:(parseInt(state.sleepH,10)||0)*60+(parseInt(state.sleepM,10)||0),weight:state.weight,bodyFat:state.bodyFat,note:state.note,weather:state.weather,quickTasks:state.quickTasks,ts:Date.now()};
    upsertLog(payload); alert(`${currentDateKey} ã®è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸ`); renderHistory(); renderMiniCalendar(); if($("#pageSummary").style.display!=="none") renderCharts(); });

  function renderTaskHistory(){ /* ç°¡ç•¥ï¼šå¿…è¦ã«ãªã£ãŸã‚‰å…ƒã®ã¾ã¾çµ„ã¿è¾¼ã¿ */ }

  function initialRender(){
    renderHistory(); renderMiniCalendar(); const saved=loadLog(todayKey); loadLogToForm(saved);
    let changed=false;
    if(qpPayload.sleepMin!=null){ state.sleepH=Math.floor(qpPayload.sleepMin/60); state.sleepM=qpPayload.sleepMin%60; changed=true; }
    if(qpPayload.mood){ state.mood=qpPayload.mood; changed=true; }
    if(qpPayload.energy){ state.energy=qpPayload.energy; changed=true; }
    if(qpPayload.symptoms){ state.symptoms=qpPayload.symptoms; changed=true; }
    if(qpPayload.note){ state.note=qpPayload.note; changed=true; }
    if(qpPayload.weight!=null){ state.weight=qpPayload.weight; changed=true; }
    if(qpPayload.bodyFat!=null){ state.bodyFat=qpPayload.bodyFat; changed=true; }
    if(changed){ renderChips(); syncFormFromState(); autoSave(); }
  }
  initialRender();
})();
</script>
</body>
</html>
