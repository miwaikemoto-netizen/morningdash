<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>MorningDash — v11.2 (Safari fix)</title>
<meta name="theme-color" content="#0f172a">

<style>
/* —— 見た目（前回の修正を含む） —— */
:root{
  --bg:#f8fafc; --card:#ffffff; --line:#e5e7eb; --text:#0f172a; --muted:#64748b;
  --accent:#0ea5e9; --accent-press:#0284c7; --radius:16px;
}
html,body{background:var(--bg); color:var(--text); height:100%;}
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Hiragino Sans","Meiryo","Apple Color Emoji","Segoe UI Emoji";}
.container{max-width:980px;margin:0 auto;padding:16px;}
h1{font-size:28px;margin:0 0 8px 0;font-weight:800}
h2{font-size:18px;margin:0 0 8px 0;font-weight:700}
h3{font-size:14px;margin:0 0 6px 0;font-weight:600}
.text{font-size:14px}
.muted{color:var(--muted)}
.row{display:flex;gap:16px;flex-wrap:wrap}
.card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:16px;box-shadow:0 6px 20px rgba(2,8,23,.06); overflow:hidden; -webkit-mask-image:-webkit-radial-gradient(white, black);}
.section{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:16px;box-shadow:0 6px 20px rgba(2,8,23,.06); overflow:hidden; -webkit-mask-image:-webkit-radial-gradient(white, black);}
.titlebar{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.btn{appearance:none;border:1px solid var(--line);border-radius:14px;padding:10px 14px;background:#fff;cursor:pointer}
.btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
.btn.small{font-size:12px;padding:6px 10px}
.btn.tiny{font-size:11px;padding:4px 8px;border-radius:10px}
.input{border:1px solid var(--line);border-radius:12px;padding:10px 12px;font-size:14px; width:100%; max-width:100%; box-sizing:border-box}
.number{width:90px;text-align:center}
.badge{font-size:12px;padding:3px 8px;border-radius:999px;border:1px solid var(--line)}
.tab{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#fff;cursor:pointer}
.tab.active{background:var(--accent);color:#fff;border-color:var(--accent)}
.list{list-style:none;margin:0;padding:0}
.calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
.cal-cell{border:1px solid var(--line);border-radius:10px;padding:4px 2px;text-align:center;background:#fff;font-size:12px;line-height:1.1;cursor:pointer}
.cal-cell.today{border-color:#0f172a;border-width:2px}
.cal-cell .dot{display:block;width:7px;height:7px;border-radius:50%;margin:4px auto 0;background:#cbd5e1}
.symptom-group{border:1px dashed var(--line);border-radius:12px;padding:12px;margin:10px 0;background:rgba(255,255,255,.35)}
/* チップの読めない問題を強制修正 */
.chip{border:1px solid var(--line);border-radius:999px;padding:6px 10px;background:#fff;cursor:pointer;font-size:13px;color:#0f172a !important}
.chip.active{background:#0ea5e9 !important;border-color:#0ea5e9 !important;color:#fff !important}
.date-big{font-size:40px;font-weight:800;letter-spacing:.5px}
.chart{width:100%;height:180px;border:1px solid var(--line);border-radius:12px;background:#fff;overflow:hidden}
.chart svg{width:100%;height:100%;display:block}
.chart .axis{stroke:#cbd5e1;stroke-width:1}
.chart .bar{fill:#94a3b8}
.chart .line{fill:none;stroke:#334155;stroke-width:2}
.chart .dot{fill:#334155}

/* デバッグ用フローティング（#debug で表示） */
#debugBox{position:fixed;right:10px;bottom:10px;z-index:9999;background:#111;color:#fff;border-radius:12px;padding:10px 12px;font-size:12px;max-width:80vw;display:none}
#debugBox pre{white-space:pre-wrap;word-break:break-word}
</style>
<!-- ===== MorningDash v12: Layout-only override ===== -->
<style>
/* 角丸内のにじみ＆はみ出しを完全封じ（iOS含む） */
.section, .card, .panel {
  overflow: hidden !important;
  -webkit-mask-image: -webkit-radial-gradient(white, black) !important;
}

/* モバイル余白・影・角丸の統一 */
:root{
  --md-radius: 16px;
  --md-border: #e5e7eb;
  --md-shadow: 0 6px 20px rgba(2,8,23,.06);
  --md-text:   #0f172a;
  --md-muted:  #64748b;
  --md-accent: #0ea5e9;
}
.card, .section, .panel{
  border-radius: var(--md-radius) !important;
  border: 1px solid var(--md-border) !important;
  box-shadow: var(--md-shadow) !important;
  padding: 18px 16px !important;
  background: #fff !important;
}

/* 見出しのバランス */
h1,h2,h3{ letter-spacing:.01em }
h2{ font-size: clamp(16px, 3.8vw, 20px) !important; margin: 0 0 10px !important; }
h3{ font-size: 14px !important; margin: 0 0 8px !important; color: var(--md-text) }

/* チップ（未選択の文字が見えない問題を強制上書き） */
.chip{
  -webkit-appearance:none; appearance:none;
  color: var(--md-text) !important;
  background: #fff !important;
  border: 1px solid var(--md-border) !important;
  border-radius: 999px !important;
  padding: 8px 12px !important;
  font-weight: 600 !important;
  box-shadow: none !important;
}
.chip:not(.active){ opacity: .95 !important; }
.chip.active{
  background: var(--md-accent) !important;
  border-color: var(--md-accent) !important;
  color: #fff !important;
}

/* 入力系の横オーバーフロー対策（自由メモ含む） */
input[type="text"], input[type="number"], textarea, select{
  width: 100% !important;
  max-width: 100% !important;
  box-sizing: border-box !important;
  border: 1px solid var(--md-border) !important;
  border-radius: 12px !important;
  padding: 10px 12px !important;
  background: #fff !important;
}

/* 行間とグリッドの詰まり修正 */
.row{ gap: 12px !important; }
.list li{ margin-block: 8px !important; }

/* ボタンの視認性アップ */
.btn, button, input[type=button], input[type=submit]{
  font-weight: 700 !important;
  border-radius: 12px !important;
  padding: 10px 14px !important;
}
.btn.primary, .btn.primary:where(*) {
  background: var(--md-accent) !important;
  border-color: var(--md-accent) !important;
  color:#fff !important;
}

/* ミニカレンダーの今月ボックスに余白を確保 */
.calendar{ gap: 6px !important; }
.cal-cell{ border-radius: 10px !important; }
.cal-cell.today{ border-width: 2px !important; }

/* 症状グループの点線枠の内側に安全マージン */
.symptom-group{
  margin: 10px 0 !important;
  padding: 12px !important;
  border: 1px dashed var(--md-border) !important;
  border-radius: 12px !important;
  background: rgba(255,255,255,.6) !important;
}

/* 履歴カードのテキスト詰まりを緩和 */
#history .card .text{ line-height: 1.5 !important; }

/* 小さな端末でのボタン折返し */
@media (max-width: 430px){
  .toolbar, .row{ flex-wrap: wrap !important; }
  .btn.small, .btn.tiny{ font-size: 12px !important; padding: 6px 10px !important; }
}
</style>
<!-- /Layout-only override -->

</head>

<body>
<div class="container">
  <div class="titlebar">
    <h1>MorningDash ☀️</h1>
    <div class="row" style="gap:8px;align-items:center">
      <input id="datePicker" type="date" class="input" style="max-width:160px">
      <span id="editBadge" class="badge" style="display:none">編集モード</span>
    </div>
  </div>

  <div class="date-big" id="dateLabel"></div>

  <div class="row" style="gap:8px;margin:8px 0">
    <button id="tabMain" class="tab active">メイン</button>
    <button id="tabTaskHistory" class="tab">タスク履歴</button>
    <button id="tabSummary" class="tab">まとめ</button>
  </div>

  <div id="pageMain">
    <section class="card">
      <div class="titlebar">
        <h2>ミニカレンダー（月）</h2>
        <div class="row">
          <button id="prevMonth" class="btn tiny">←</button>
          <span id="calLabel" class="muted"></span>
          <button id="nextMonth" class="btn tiny">→</button>
        </div>
      </div>
      <div class="calendar-head row" style="gap:4px;opacity:.7;justify-content:space-between">
        <div>日</div><div>月</div><div>火</div><div>水</div><div>木</div><div>金</div><div>土</div>
      </div>
      <div id="miniCalendar" class="calendar"></div>
      <div class="text muted" style="margin-top:6px">●：❤️‍🔥濃／❤️中／❤️‍🩹薄（記録なし=グレー）</div>
    </section>

    <section class="card">
      <div class="titlebar">
        <h2>天気（現在地）</h2>
        <span id="wxLoading" class="muted" style="display:none">取得中…</span>
      </div>
      <div id="wxError" class="text" style="color:#b91c1c"></div>
      <div id="wxBlock" class="row"></div>
      <div class="row" style="margin-top:8px"><button id="retryWx" class="btn small">再取得</button></div>
    </section>

    <section class="row">
      <div class="card" style="flex:1 1 300px;min-width:280px">
        <h2>気分</h2>
        <div id="moodBtns" class="row"></div>
      </div>
      <div class="card" style="flex:1 1 300px;min-width:280px">
        <h2>元気度</h2>
        <div id="energyBtns" class="row"></div>
      </div>
    </section>

    <section class="row">
      <div class="card" style="flex:1 1 300px;min-width:280px">
        <h2>体調メモ</h2>
        <div class="symptom-group"><h3>① よくある不調</h3><div id="symptomGroup1" class="row"></div></div>
        <div class="symptom-group"><h3>② 季節・生活リズム</h3><div id="symptomGroup2" class="row"></div></div>
        <div class="symptom-group"><h3>③ メンタル・コンディション</h3><div id="symptomGroup3" class="row"></div></div>
        <textarea id="note" class="input" rows="3" placeholder="自由メモ（例：首の張り強め／冷え気味 など）"></textarea>
      </div>
      <div class="card" style="flex:1 1 300px;min-width:280px">
        <h2>睡眠</h2>
        <div class="row" style="align-items:center;margin-bottom:8px">
          <input id="sleepH" class="input number" type="number" min="0" max="23" value="0"><span>時間</span>
          <input id="sleepM" class="input number" type="number" min="0" max="59" value="0"><span>分</span>
        </div>
        <div class="text muted" style="margin-bottom:6px">※ ショートカットで自動入力（`?sleepMin=合計分`）</div>
        <div class="text">合計：<b id="sleepTotal">0時間0分</b></div>

        <div class="card" style="margin-top:12px">
          <h3>ヘルス（任意）</h3>
          <div class="row" style="align-items:center">
            <span>体重</span><input id="weight" class="input number" type="number" step="0.1" min="0"><span>kg</span>
            <span>体脂肪</span><input id="bodyFat" class="input number" type="number" step="0.1" min="0" max="100"><span>%</span>
          </div>
          <div class="row" style="align-items:center;margin-top:8px">
            <button id="copyHealthShortcut" class="btn small">ショートカット用URLをコピー</button>
          </div>
          <div class="text muted" style="margin-top:6px"><code>?sleepMin=&weight=&bodyFat=</code> を渡すと自動入力</div>
        </div>
      </div>
    </section>

    <section class="row" style="margin-top:16px">
      <button id="saveLog" class="btn primary">この日の記録を保存</button>
      <button id="exportCSV" class="btn">CSV</button>
      <button id="exportJSON" class="btn">JSON</button>
      <a href="./evening.html" class="btn">🌙 夜の記録へ</a>
      <label class="btn small" for="importJSON" style="cursor:pointer">JSONを読み込み</label>
      <input id="importJSON" type="file" accept="application/json" style="display:none">
    </section>

    <section class="card" style="margin-top:16px">
      <div class="titlebar">
        <h2>履歴</h2>
        <button id="reloadHistory" class="btn small">履歴を再読込</button>
      </div>
      <div id="history"></div>
    </section>
  </div>

  <div id="pageTaskHistory" style="display:none">
    <section class="card">
      <div class="titlebar">
        <h2>タスク履歴（未完了の保管庫）</h2>
        <div class="row"><button id="clearTaskHistory" class="btn small">全消去</button><button id="backToMain" class="btn small">メインへ戻る</button></div>
      </div>
      <div class="row" style="margin-bottom:8px">
        <input id="thSearch" class="input" placeholder="キーワードで絞り込み（例：水やり）" style="flex:1">
        <input id="thDate" type="date" class="input" style="max-width:160px">
        <button id="thClear" class="btn small">フィルタをクリア</button>
      </div>
      <div id="taskHistoryList"></div>
    </section>
  </div>

  <div id="pageSummary" style="display:none">
    <section class="card">
      <h2>まとめ（週間・月間）</h2>
      <div class="row" style="gap:12px">
        <div style="flex:1 1 260px"><h3>直近7日：睡眠（時間）</h3><div id="chartSleep7" class="chart"></div></div>
        <div style="flex:1 1 260px"><h3>直近30日：元気度カウント</h3><div id="chartEnergy30" class="chart"></div></div>
        <div style="flex:1 1 260px"><h3>直近30日：体重（折れ線）</h3><div id="chartWeight30" class="chart"></div></div>
      </div>
    </section>
  </div>

  <div class="text muted" style="margin-top:24px;line-height:1.6">
    Tips: 共有 → ホーム画面に追加 でアプリ風にも使えます（※PWAはSafariと保管場所が分かれます）。
    保存先：この端末のブラウザ localStorage。同じURLなら履歴は継続利用されます。
  </div>
</div>

<!-- デバッグ出力 -->
<div id="debugBox"><b>Debug</b><pre id="debugOut"></pre></div>
<script>
/* ===== MD: クエリ取り込み・先行保存ホットフィックス =====
   ?sleepMin=441&weight=66.4&bodyFat=33.4 を開いた瞬間に
   localStorage(md_logs_v2 / 今日の日付)へ先に書き込み、
   その後UIが起動しても値が消えないようにする。
*/
(function(){
  try{
    const u = new URL(location.href);
    const hasQP =
      u.searchParams.has("sleepMin") ||
      u.searchParams.has("weight")   ||
      u.searchParams.has("bodyFat");
    if(!hasQP) return;

    // 受け取り & 数値化
    const nInt = v => { const n = parseInt(v,10); return Number.isFinite(n) ? n : null; };
    const nFloat = v => { const n = parseFloat(v); return Number.isFinite(n) ? n : null; };

    const sleepMin = nInt(u.searchParams.get("sleepMin"));
    const weight   = nFloat(u.searchParams.get("weight"));
    const bodyFat  = nFloat(u.searchParams.get("bodyFat"));

    // 保存先キーと “今日” のキー（Asia/Tokyo 固定）
    const LOGS_KEY = "md_logs_v2";
    const todayKey = new Date().toLocaleDateString("ja-JP",{ timeZone:"Asia/Tokyo" });

    // 既存ログの読み出し
    const logs = JSON.parse(localStorage.getItem(LOGS_KEY) || "[]");
    const others = logs.filter(x => x.date !== todayKey);
    const existing = logs.find(x => x.date === todayKey) || {
      date: todayKey,
      mood: "", energy: "", symptoms: [],
      sleepMin: 0, weight: null, bodyFat: null, note: "",
      weather: null,
      quickTasks: [{done:false,text:""},{done:false,text:""},{done:false,text:""}],
    };

    // 上書き（来ている値だけ）
    if (sleepMin != null) existing.sleepMin = sleepMin;
    if (weight   != null) existing.weight   = weight;
    if (bodyFat  != null) existing.bodyFat  = bodyFat;
    existing.ts = Date.now();

    // 先に保存
    localStorage.setItem(LOGS_KEY, JSON.stringify([existing, ...others]));

    // クエリを消してリロードしない（そのままUIが読みに行く）
    history.replaceState(null, "", location.pathname);
  }catch(e){
    console.warn("ingest hotfix failed:", e);
  }
})();
</script>

<script>
(function(){
  // ====== 共通ユーティリティ ======
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const tz = "Asia/Tokyo";
  const toKey = (d)=> d.toLocaleDateString("ja-JP",{timeZone:tz}); // 例: 2025/8/16
  const normalizeKey = (k)=>{
    if(!k) return k;
    const m = String(k).trim().match(/^(\d{4})[\/-](\d{1,2})[\/-](\d{1,2})$/);
    return m ? `${Number(m[1])}/${Number(m[2])}/${Number(m[3])}` : k;
  };
  const today = new Date();
  const todayKey = toKey(today);

  // ====== Storage（キー統一・読み込み強化） ======
  const PRIMARY_KEY = "md_logs_v3";          // 新しい主キー
  const COMPAT_KEYS = ["md_logs_v3","md_logs_v2","md_logs_v1"]; // 互換読み込み
  const TASK_HIST_KEY = "md_task_history_v1";

  function loadAllLogs(){
    // 互換キーをすべて読み、日付を正規化して重複を統合
    const merged = new Map();
    COMPAT_KEYS.forEach(k=>{
      try{
        const arr = JSON.parse(localStorage.getItem(k) || "[]");
        arr.forEach(it=>{
          const dk = normalizeKey(it.date);
          if(!dk) return;
          // 後勝ち（より新しい保存を優先）
          merged.set(dk, {...it, date: dk});
        });
      }catch(e){}
    });
    // 降順で返す
    return Array.from(merged.values()).sort((a,b)=> (a.date < b.date ? 1 : -1));
  }
  function saveAllLogs(arr){
    localStorage.setItem(PRIMARY_KEY, JSON.stringify(arr));
  }
  function loadLog(dateKey){
    const logs = loadAllLogs();
    return logs.find(l => l.date === normalizeKey(dateKey)) || null;
  }
  function upsertLog(payload){
    const logs = loadAllLogs();
    const rest = logs.filter(l => l.date !== normalizeKey(payload.date));
    saveAllLogs([{...payload, date: normalizeKey(payload.date)}, ...rest].sort((a,b)=> (a.date < b.date ? 1 : -1)));
  }
  function loadTaskHistory(){ return JSON.parse(localStorage.getItem(TASK_HIST_KEY) || "[]"); }
  function saveTaskHistory(arr){ localStorage.setItem(TASK_HIST_KEY, JSON.stringify(arr)); }

  // ====== 画面状態 ======
  let currentDateKey = todayKey;
  const state = {
    mood:"", energy:"", symptoms:[], note:"",
    sleepH:0, sleepM:0, weight:null, bodyFat:null,
    weather:null,
    quickTasks:[{done:false,text:""},{done:false,text:""},{done:false,text:""}],
  };

  // 起動時上書きガード
  let booting = true; // 初期レンダリングが終わるまで true
  let saveTimer=null;
  function autoSave(){
    if (booting) return; // ← 空値で上書きを防止
    clearTimeout(saveTimer);
    saveTimer = setTimeout(()=>{
      const payload = {
        date: currentDateKey,
        mood: state.mood,
        energy: state.energy,
        symptoms: state.symptoms,
        sleepMin: (parseInt(state.sleepH,10)||0)*60 + (parseInt(state.sleepM,10)||0),
        weight: state.weight, bodyFat: state.bodyFat,
        note: state.note, weather: state.weather,
        quickTasks: state.quickTasks,
        ts: Date.now()
      };
      upsertLog(payload);
      renderHistory(); renderMiniCalendar();
    }, 300);
  }

  // ====== ヘッダ ======
  const dateLabel=$("#dateLabel"), datePicker=$("#datePicker"), editBadge=$("#editBadge");
  const toInputDate=d=>{const z=n=>String(n).padStart(2,"0");return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`;}
  const fromInputDate=s=>{const [y,m,d]=s.split("-").map(Number);return new Date(y,m-1,d);}
  function renderHeader(){
    dateLabel.textContent = currentDateKey;
    editBadge.style.display = (currentDateKey===todayKey) ? "none" : "inline-block";
    const [y,m,d] = currentDateKey.split("/").map(Number);
    datePicker.value = toInputDate(new Date(y,m-1,d));
  }
  datePicker.value = toInputDate(today);
  datePicker.addEventListener("change", ()=>{
    currentDateKey = toKey(fromInputDate(datePicker.value));
    loadLogToForm(loadLog(currentDateKey));
  });

  // ====== UI構築 ======
  const moods = [{v:"🙂",label:"良い"},{v:"😐",label:"ふつう"},{v:"🙁",label:"いまいち"}];
  const energies = ["❤️‍🔥元気","❤️まずまず","❤️‍🩹だるい"];
  const group1=["首・肩こり","頭痛","腹痛／お腹の張り","腰の張り／腰痛","胃腸弱め（胃もたれ・下痢・便秘など）","むくみ","目の疲れ／ドライアイ","自律神経の乱れ","睡眠の質低下（浅い眠り・途中覚醒）","生理"];
  const group2=["冷え（手足の冷え・全身）","暑さバテ／熱っぽさ","喉の痛み・声枯れ","鼻水・鼻づまり","肌荒れ／かゆみ","花粉・アレルギー症状"];
  const group3=["集中力低下","イライラ／不安感","だるさ／倦怠感","モチベーション低下","PMS（生理前症状）"];
  const allSymptoms=[...group1,...group2,...group3];

  function buildChips(root, options, isActive, onClick){
    root.innerHTML=""; options.forEach(opt=>{
      const v = typeof opt==="string" ? opt : opt.v;
      const label = typeof opt==="string" ? opt : (opt.v+" "+opt.label);
      const b = document.createElement("button");
      b.className = "chip" + (isActive(v) ? " active" : "");
      b.textContent = label;
      b.onclick = ()=>{ onClick(v); };
      root.appendChild(b);
    });
  }
  function renderChips(){
    buildChips($("#moodBtns"), moods, v=>state.mood===v, v=>{state.mood=v; renderChips(); autoSave();});
    buildChips($("#energyBtns"), energies, v=>state.energy===v, v=>{state.energy=v; renderChips(); autoSave();});
    const mk=(id,arr)=>buildChips($(id),arr, v=>state.symptoms.includes(v), v=>{
      if(state.symptoms.includes(v)) state.symptoms = state.symptoms.filter(x=>x!==v);
      else state.symptoms=[...state.symptoms, v];
      renderChips(); autoSave();
    });
    mk("#symptomGroup1",group1); mk("#symptomGroup2",group2); mk("#symptomGroup3",group3);
  }

  // 入力群
  const sleepH=$("#sleepH"), sleepM=$("#sleepM"), sleepTotal=$("#sleepTotal");
  const weight=$("#weight"), bodyFat=$("#bodyFat"), note=$("#note");
  function updateSleepLabel(){ sleepTotal.textContent = Math.floor(state.sleepH)+"時間"+(state.sleepM%60)+"分"; }
  function syncFormFromState(){
    sleepH.value=state.sleepH; sleepM.value=state.sleepM; updateSleepLabel();
    weight.value = state.weight ?? ""; bodyFat.value = state.bodyFat ?? ""; note.value = state.note || "";
  }

  // クイックタスク（省略: クリック時に autoSave）
  const qtElems=[{c:$("#qt0c"),t:$("#qt0t")},{c:$("#qt1c"),t:$("#qt1t")},{c:$("#qt2c"),t:$("#qt2t")}].filter(x=>x.c&&x.t);
  function renderQuickTasks(){ qtElems.forEach((q,i)=>{ if(!state.quickTasks[i]) state.quickTasks[i]={done:false,text:""}; }); }

  // 天気（省略版）
  function askGeo(){ /* 必要ならそのまま */ }
  $("#retryWx")?.addEventListener("click", askGeo);

  // 履歴
  function renderHistory(){
    const root=$("#history"); const logs=loadAllLogs(); root.innerHTML="";
    if(!logs.length){ root.innerHTML='<p class="text muted">まだ記録がありません</p>'; return; }
    logs.forEach(l=>{
      const box=document.createElement("div"); box.className="card"; box.style.marginTop="8px";
      const head=document.createElement("div"); head.className="text"; head.innerHTML=`<span class="muted">${l.date}</span>`;
      const row=document.createElement("div"); row.className="row text"; row.style.marginTop="6px";
      row.innerHTML = `<div>気分：${l.mood||"—"}</div>
                       <div>元気度：${l.energy||"—"}</div>
                       <div>睡眠：${Math.floor((l.sleepMin||0)/60)}時間${(l.sleepMin||0)%60}分</div>
                       ${l.weight!=null?`<div>体重：${l.weight}kg</div>`:""}
                       ${l.bodyFat!=null?`<div>体脂肪：${l.bodyFat}%</div>`:""}`;
      const actions=document.createElement("div"); actions.className="row"; actions.style.marginTop="8px";
      const edit=document.createElement("button"); edit.className="btn small"; edit.textContent="編集";
      edit.onclick=()=>{ currentDateKey=l.date; loadLogToForm(l); window.scrollTo({top:0,behavior:"smooth"}); };
      const del=document.createElement("button"); del.className="btn small"; del.textContent="削除";
      del.onclick=()=>{ if(!confirm(`${l.date} を削除しますか？`)) return; const rest=loadAllLogs().filter(x=>x.date!==l.date); saveAllLogs(rest); renderHistory(); renderMiniCalendar(); if(currentDateKey===l.date){ currentDateKey=todayKey; loadLogToForm(loadLog(todayKey)); }};
      actions.appendChild(edit); actions.appendChild(del);
      box.appendChild(head); box.appendChild(row); box.appendChild(actions); root.appendChild(box);
    });
  }

  // ミニカレンダー
  let calMonth = new Date(today.getFullYear(), today.getMonth(), 1);
  function renderMiniCalendar(){
    $("#calLabel").textContent = `${calMonth.getFullYear()}年 ${calMonth.getMonth()+1}月`;
    const root=$("#miniCalendar"); root.innerHTML="";
    const firstDow = new Date(calMonth.getFullYear(), calMonth.getMonth(), 1).getDay();
    const daysInMonth = new Date(calMonth.getFullYear(), calMonth.getMonth()+1, 0).getDate();
    for(let i=0;i<firstDow;i++) root.appendChild(document.createElement("div"));
    const byDate=new Map(loadAllLogs().map(l=>[l.date,l]));
    for(let d=1; d<=daysInMonth; d++){
      const cell=document.createElement("div"); cell.className="cal-cell";
      const key = toKey(new Date(calMonth.getFullYear(), calMonth.getMonth(), d));
      if(key===toKey(new Date())) cell.classList.add("today");
      cell.innerHTML=`${d}<span class="dot"></span>`;
      const dot=cell.querySelector(".dot"); const rec=byDate.get(key);
      if(rec){ const e=rec.energy||""; if(e.includes("❤️‍🔥")) dot.style.background="#be123c"; else if(e.includes("❤️まず")) dot.style.background="#f43f5e"; else if(e.includes("❤️‍🩹")) dot.style.background="#fecaca"; }
      cell.onclick=()=>{ currentDateKey=key; loadLogToForm(rec||null); window.scrollTo({top:0,behavior:"smooth"}); };
      root.appendChild(cell);
    }
  }
  $("#prevMonth").addEventListener("click", ()=>{ calMonth=new Date(calMonth.getFullYear(),calMonth.getMonth()-1,1); renderMiniCalendar(); });
  $("#nextMonth").addEventListener("click", ()=>{ calMonth=new Date(calMonth.getFullYear(),calMonth.getMonth()+1,1); renderMiniCalendar(); });

  // 画面ロード・保存・コピー
  function loadLogToForm(log){
    if(!log){ state.mood=""; state.energy=""; state.symptoms=[]; state.note=""; state.sleepH=0; state.sleepM=0; state.weight=null; state.bodyFat=null; }
    else{
      state.mood=log.mood||""; state.energy=log.energy||""; state.symptoms=Array.isArray(log.symptoms)?log.symptoms.filter(s=>allSymptoms.includes(s)):[];
      const sm=parseInt(log.sleepMin||0,10); state.sleepH=Math.floor(sm/60); state.sleepM=sm%60;
      state.weight=(log.weight ?? null); state.bodyFat=(log.bodyFat ?? null); state.note=log.note||"";
    }
    renderChips(); syncFormFromState(); renderQuickTasks(); renderHeader();
  }

  $("#saveLog").addEventListener("click", ()=>{
    const payload={ date: currentDateKey, mood:state.mood, energy:state.energy, symptoms:state.symptoms,
      sleepMin:(parseInt(state.sleepH,10)||0)*60+(parseInt(state.sleepM,10)||0),
      weight:state.weight, bodyFat:state.bodyFat, note:state.note, weather:state.weather, quickTasks:state.quickTasks, ts:Date.now()
    };
    upsertLog(payload); alert(`${currentDateKey} を保存しました`); renderHistory(); renderMiniCalendar();
  });
  $("#reloadHistory").addEventListener("click", ()=>{ renderHistory(); });

  $("#copyHealthShortcut").addEventListener("click", async ()=>{
    const base = location.origin + location.pathname.replace(/index\.html?$/,"");
    const u = `${base}ingest.html?sleepMin=[[合計睡眠分]]&weight=[[体重_kg]]&bodyFat=[[体脂肪_%]]`;
    try{ await navigator.clipboard.writeText(u); alert("ショートカット用URLをコピーしました"); }catch(e){ alert(u); }
  });

  // 初期表示（保存 → 読み出し順の競合を避ける）
  function initialRender(){
    renderHistory(); renderMiniCalendar();
    const saved = loadLog(todayKey);
    loadLogToForm(saved);
    // ingestからのリダイレクトで index にパラメータが付いていた場合も反映
    const url=new URL(location.href);
    const gp=k=>url.searchParams.get(k);
    let changed=false;
    if(gp("sleepMin")!=null){ const m=parseInt(gp("sleepMin"),10)||0; state.sleepH=Math.floor(m/60); state.sleepM=m%60; changed=true; }
    if(gp("weight")!=null){ const w=parseFloat(gp("weight")); if(!isNaN(w)){ state.weight=w; changed=true; } }
    if(gp("bodyFat")!=null){ const b=parseFloat(gp("bodyFat")); if(!isNaN(b)){ state.bodyFat=b; changed=true; } }
    if(changed){ syncFormFromState(); }
    // 起動ガード解除（これ以降の操作で autoSave を許可）
    booting=false;
  }
  initialRender();

  // ====== デバッグ（#debug で表示） ======
  function showDebug(){
    if(location.hash!=="#debug") return;
    const box=$("#debugBox"), out=$("#debugOut");
    box.style.display="block";
    const logs = loadAllLogs();
    const todayLog = loadLog(todayKey);
    out.textContent = `storageKeys: ${JSON.stringify(COMPAT_KEYS)}\n`+
      `todayKey: ${todayKey}\n`+
      `hasToday: ${!!todayLog}\n`+
      `todayLog: ${JSON.stringify(todayLog,null,2)}\n\n`+
      `first2: ${JSON.stringify(logs.slice(0,2),null,2)}`;
  }
  showDebug();

  // タブ
  const pageMain=$("#pageMain"), pageTaskHistory=$("#pageTaskHistory"), pageSummary=$("#pageSummary");
  function showPage(which){
    pageMain.style.display = which==="main"?"block":"none";
    pageTaskHistory.style.display = which==="taskHistory"?"block":"none";
    pageSummary.style.display = which==="summary"?"block":"none";
    $("#tabMain").classList.toggle("active", which==="main");
    $("#tabTaskHistory").classList.toggle("active", which==="taskHistory");
    $("#tabSummary").classList.toggle("active", which==="summary");
  }
  $("#tabMain").onclick=()=>showPage("main");
  $("#tabTaskHistory").onclick=()=>{ showPage("taskHistory"); /* renderTaskHistory() 省略 */ };
  $("#tabSummary").onclick=()=>{ showPage("summary"); /* renderCharts() 省略 */ };

})();
</script>
</body>
</html>
