<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>MorningDash â€” ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ç‰ˆ</title>
<meta name="theme-color" content="#0f172a">
<style>
  :root{
    --bg1:#ffffff;--bg2:#f1f5f9;--fg:#0f172a;--muted:#64748b;--accent:#0f172a;--card:#ffffff;--border:#e5e7eb;
  }
  html,body{height:100%;}
  body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";color:var(--fg);
       background:linear-gradient(var(--bg1),var(--bg2));}
  .container{max-width:960px;margin:0 auto;padding:16px;}
  h1{font-size:28px;margin:0 0 8px 0;font-weight:700}
  h2{font-size:18px;margin:0 0 8px 0;font-weight:600}
  .muted{opacity:.7}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
  .row{display:flex;gap:16px;flex-wrap:wrap}
  .col{flex:1 1 300px;min-width:280px}
  .btn{appearance:none;border:1px solid var(--border);border-radius:14px;padding:10px 14px;background:#fff;cursor:pointer}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  .btn.small{font-size:12px;padding:6px 10px}
  .chip{border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:#fff;cursor:pointer;font-size:13px}
  .chip.active{background:var(--accent);border-color:var(--accent);color:#fff}
  .input{border:1px solid var(--border);border-radius:12px;padding:10px 12px;font-size:14px}
  .text{font-size:14px}
  .list{list-style:none;padding:0;margin:0}
  .list li{display:flex;align-items:center;gap:8px;padding:4px 0}
  .strike{ text-decoration: line-through; opacity:.6 }
  .footer{font-size:12px;opacity:.6;margin-top:24px;line-height:1.6}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px}
  .space-y> * + *{margin-top:8px}
  .titlebar{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
  .number{width:64px;text-align:center}
  .badge{font-size:12px;opacity:.7}
  .hidden{display:none}
</style>
</head>
<body>
  <div class="container">
    <div class="titlebar">
      <h1>MorningDash â˜€ï¸</h1>
      <div id="today" class="muted"></div>
    </div>

    <!-- Weather -->
    <section class="card space-y">
      <div class="titlebar">
        <h2>å¤©æ°—ï¼ˆç¾åœ¨åœ°ï¼‰</h2>
        <span id="wxLoading" class="badge hidden">å–å¾—ä¸­â€¦</span>
      </div>
      <div id="wxError" class="text" style="color:#dc2626;"></div>
      <div id="wxBlock" class="row"></div>
      <div class="row">
        <button id="retryWx" class="btn small">å†å–å¾—</button>
      </div>
    </section>

    <!-- Mood & Energy -->
    <section class="grid" style="margin-top:16px">
      <div class="card">
        <h2>æ°—åˆ†</h2>
        <div id="moodBtns" class="row"></div>
      </div>
      <div class="card">
        <h2>ã‚¨ãƒãƒ«ã‚®ãƒ¼</h2>
        <div id="energyBtns" class="row"></div>
      </div>
    </section>

    <!-- Symptoms & Sleep -->
    <section class="grid" style="margin-top:16px">
      <div class="card">
        <h2>ä½“èª¿ãƒ¡ãƒ¢</h2>
        <div id="symptomBtns" class="row" style="margin-bottom:8px"></div>
        <textarea id="note" class="input" rows="3" style="width:100%" placeholder="è‡ªç”±ãƒ¡ãƒ¢ï¼ˆä¾‹ï¼šé¦–ã®å¼µã‚Šå¼·ã‚ï¼å†·ãˆæ°—å‘³ ãªã©ï¼‰"></textarea>
      </div>
      <div class="card">
        <h2>ç¡çœ </h2>
        <div class="row" style="align-items:center;margin-bottom:8px">
          <input id="sleepH" class="input number" type="number" min="0" max="23" value="0">
          <span>æ™‚é–“</span>
          <input id="sleepM" class="input number" type="number" min="0" max="59" value="0">
          <span>åˆ†</span>
        </div>
        <div class="text muted" style="margin-bottom:6px">â€» å°†æ¥çš„ã«ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆé€£æºã§è‡ªå‹•å…¥åŠ›ï¼ˆsleepMin=åˆè¨ˆåˆ†ï¼‰</div>
        <div class="text">åˆè¨ˆï¼š<b id="sleepTotal">0æ™‚é–“0åˆ†</b></div>
      </div>
    </section>

    <!-- Tasks -->
    <section class="card" style="margin-top:16px">
      <div class="titlebar">
        <h2>ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯</h2>
        <button id="copyURL" class="btn small">URLé€£æºä¾‹ã‚’ã‚³ãƒ”ãƒ¼</button>
      </div>
      <div class="row" style="margin-bottom:8px">
        <input id="taskInput" class="input" placeholder="ã‚¿ã‚¹ã‚¯ã‚’å…¥åŠ›" style="flex:1">
        <button id="addTask" class="btn primary">è¿½åŠ </button>
      </div>
      <ul id="taskList" class="list"></ul>
    </section>

    <!-- Actions -->
    <section class="row" style="margin-top:16px">
      <button id="saveLog" class="btn primary">ä»Šæ—¥ã®è¨˜éŒ²ã‚’ä¿å­˜</button>
      <button id="exportCSV" class="btn">CSVã‚’æ›¸ãå‡ºã™</button>
    </section>

    <!-- History -->
    <section class="card" style="margin-top:16px">
      <h2>å±¥æ­´</h2>
      <div id="history"></div>
    </section>

    <div class="footer">
      <p>Tips: å…±æœ‰ â†’ ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ  ã§ã‚¢ãƒ—ãƒªé¢¨ã«ä½¿ãˆã¾ã™ã€‚</p>
      <p>æ‹¡å¼µï¼šã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‹ã‚‰ <code>?sleepMin=480&mood=ğŸ™‚&energy=ä¸­&symptoms=é¦–è‚©ã“ã‚Š,èƒƒè…¸å¼±ã‚&note=â€¦</code> ã‚’ä»˜ã‘ã¦ã“ã®ãƒšãƒ¼ã‚¸ã‚’é–‹ãã¨è‡ªå‹•å…¥åŠ›ã§ãã¾ã™ã€‚</p>
    </div>
  </div>

<script>
(function(){
  const $ = (s) => document.querySelector(s);
  const $$ = (s) => Array.from(document.querySelectorAll(s));
  const todayKey = new Date().toLocaleDateString("ja-JP", { timeZone: "Asia/Tokyo" });
  $("#today").textContent = todayKey;

  // State
  let state = {
    mood: "",
    energy: "",
    symptoms: [],
    sleepH: 0,
    sleepM: 0,
    note: "",
    weather: null,
  };

  // Query params (for Shortcut integration)
  const url = new URL(window.location.href);
  const qp = k => url.searchParams.get(k);
  const sleepMin = qp("sleepMin");
  if (sleepMin) {
    const total = parseInt(sleepMin,10)||0;
    state.sleepH = Math.floor(total/60);
    state.sleepM = total%60;
  }
  state.mood = qp("mood") || state.mood;
  state.energy = qp("energy") || state.energy;
  const symptomsQ = qp("symptoms");
  if (symptomsQ) state.symptoms = symptomsQ.split(",").filter(Boolean);
  state.note = qp("note") || state.note;

  // UI Builders
  const moods = [{v:"ğŸ™‚",label:"è‰¯ã„"},{v:"ğŸ˜",label:"ãµã¤ã†"},{v:"ğŸ™",label:"ã„ã¾ã„ã¡"}];
  const energies = ["é«˜","ä¸­","ä½"];
  const symptomOptions = ["é¦–è‚©ã“ã‚Š","é ­ç—›","è…°ã®å¼µã‚Š","èƒƒè…¸å¼±ã‚","ã‚€ãã¿","ç›®ã®ç–²ã‚Œ","èŠ±ç²‰/ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼","ç”Ÿç†/å‰å…†"];

  function buildChips(root, options, isActive, onClick){
    root.innerHTML = "";
    options.forEach(opt => {
      const v = typeof opt === "string" ? opt : opt.v;
      const label = typeof opt === "string" ? opt : (opt.v+" "+opt.label);
      const b = document.createElement("button");
      b.className = "chip" + (isActive(v) ? " active" : "");
      b.textContent = label;
      b.addEventListener("click", () => onClick(v));
      root.appendChild(b);
    });
  }

  buildChips($("#moodBtns"), moods, v => state.mood===v, v => { state.mood=v; buildChips($("#moodBtns"), moods, x=>state.mood===x, v=>{state.mood=v; buildChips($("#moodBtns"), moods, x=>state.mood===x, ()=>{});}); });
  buildChips($("#energyBtns"), energies, v => state.energy===v, v => { state.energy=v; buildChips($("#energyBtns"), energies, x=>state.energy===x, v=>{state.energy=v; buildChips($("#energyBtns"), energies, x=>state.energy===x, ()=>{});}); });
  buildChips($("#symptomBtns"), symptomOptions, v => state.symptoms.includes(v), v => {
    if (state.symptoms.includes(v)) state.symptoms = state.symptoms.filter(x=>x!==v);
    else state.symptoms = [...state.symptoms, v];
    buildChips($("#symptomBtns"), symptomOptions, x => state.symptoms.includes(x), v=>{});
  });

  // Note & Sleep
  const sleepH = $("#sleepH"), sleepM = $("#sleepM"), note = $("#note"), sleepTotal = $("#sleepTotal");
  function updateSleepLabel(){ sleepTotal.textContent = Math.floor(state.sleepH/1)+"æ™‚é–“"+(state.sleepM%60)+"åˆ†"; }
  sleepH.value = state.sleepH; sleepM.value = state.sleepM; note.value = state.note;
  updateSleepLabel();
  sleepH.addEventListener("input", () => { state.sleepH = parseInt(sleepH.value||"0",10); updateSleepLabel(); });
  sleepM.addEventListener("input", () => { state.sleepM = parseInt(sleepM.value||"0",10); updateSleepLabel(); });
  note.addEventListener("input", () => { state.note = note.value; });

  // Tasks (localStorage)
  const tasksKey = "md_tasks";
  const logsKey = "md_logs";
  const tasks = JSON.parse(localStorage.getItem(tasksKey) || "[]");
  function saveTasks(){ localStorage.setItem(tasksKey, JSON.stringify(tasks)); }
  function todayTasks(){ return tasks.filter(t => t.date === todayKey); }

  const taskList = $("#taskList");
  function renderTasks(){
    taskList.innerHTML = "";
    const list = todayTasks();
    if (list.length === 0){
      const p = document.createElement("p");
      p.className = "text muted";
      p.textContent = "ä»Šæ—¥ã¯ã¾ã ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“";
      taskList.appendChild(p);
      return;
    }
    list.forEach(t => {
      const li = document.createElement("li");
      const cb = document.createElement("input"); cb.type="checkbox"; cb.checked = !!t.done;
      cb.addEventListener("change", () => { t.done = !t.done; saveTasks(); renderTasks(); });
      const span = document.createElement("span"); span.textContent = t.title; span.className = "flex-1 text "+(t.done?"strike":"");
      const del = document.createElement("button"); del.className="btn small"; del.textContent="å‰Šé™¤";
      del.addEventListener("click", ()=>{ const idx = tasks.findIndex(x => x.id===t.id); if(idx>-1){ tasks.splice(idx,1); saveTasks(); renderTasks(); }});
      li.appendChild(cb); li.appendChild(span); li.appendChild(del);
      taskList.appendChild(li);
    });
  }
  renderTasks();

  $("#addTask").addEventListener("click", () => {
    const inp = $("#taskInput");
    const val = (inp.value||"").trim();
    if (!val) return;
    tasks.unshift({ id: Date.now(), title: val, done: false, date: todayKey });
    inp.value = "";
    saveTasks(); renderTasks();
  });

  $("#copyURL").addEventListener("click", async () => {
    const u = new URL(window.location.href); u.search = "";
    u.searchParams.set("mood", state.mood||"");
    u.searchParams.set("energy", state.energy||"");
    try { await navigator.clipboard.writeText(u.toString()); alert("URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼ˆmood/energyä»˜ãï¼‰"); }
    catch(e){ alert(u.toString()); }
  });

  // Weather
  const wxLoading = $("#wxLoading"), wxError = $("#wxError"), wxBlock = $("#wxBlock");
  function wxCodeToText(code){
    const map={0:"å¿«æ™´",1:"æ™´ã‚Œ",2:"è–„æ›‡ã‚Š",3:"æ›‡ã‚Š",45:"éœ§",48:"éœ§æ°·",51:"å¼±ã„éœ§é›¨",53:"éœ§é›¨",55:"å¼·ã„éœ§é›¨",61:"å¼±ã„é›¨",63:"é›¨",65:"å¼·ã„é›¨",71:"å¼±ã„é›ª",73:"é›ª",75:"å¤§é›ª",95:"é›·é›¨"};
    return map[code]||"â€”";
  }
  function renderWeather(){
    wxBlock.innerHTML = "";
    if (!state.weather){ const p=document.createElement("p"); p.className="text muted"; p.textContent="ä½ç½®æƒ…å ±ã®è¨±å¯å¾Œã€è‡ªå‹•è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚"; wxBlock.appendChild(p); return; }
    const big = document.createElement("div"); big.style.fontSize="48px"; big.style.fontWeight="600"; big.textContent = Math.round(state.weather.temp)+"Â°C";
    const small = document.createElement("div"); small.className="text"; small.innerHTML = "çŠ¶æ³ï¼š"+state.weather.condition+"<br>é¢¨é€Ÿï¼š"+Math.round(state.weather.wind)+" m/s<br><span class='muted'>æ›´æ–°ï¼š"+new Date(state.weather.time).toLocaleTimeString("ja-JP",{timeZone:"Asia/Tokyo"})+"</span>";
    const wrap = document.createElement("div"); wrap.className="row"; wrap.appendChild(big); wrap.appendChild(small);
    wxBlock.appendChild(wrap);
  }
  function fetchWeatherFromGeo(lat, lon){
    wxLoading.classList.remove("hidden"); wxError.textContent="";
    const u = new URL("https://api.open-meteo.com/v1/forecast");
    u.searchParams.set("latitude", lat);
    u.searchParams.set("longitude", lon);
    u.searchParams.set("current_weather","true");
    u.searchParams.set("hourly","precipitation_probability");
    u.searchParams.set("timezone","Asia/Tokyo");
    fetch(u.toString()).then(r=>r.json()).then(data=>{
      const c = data.current_weather;
      state.weather = { temp:c.temperature, wind:c.windspeed, code:c.weathercode, condition:wxCodeToText(c.weathercode), time:c.time };
      renderWeather();
    }).catch(e=>{
      wxError.textContent = "å¤©æ°—ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
    }).finally(()=>{ wxLoading.classList.add("hidden"); });
  }
  function askGeo(){
    wxLoading.classList.remove("hidden"); wxError.textContent="";
    if (!("geolocation" in navigator)){ wxError.textContent="ã“ã®ç«¯æœ«ã¯ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚"; wxLoading.classList.add("hidden"); return; }
    navigator.geolocation.getCurrentPosition(
      pos => { const {latitude, longitude} = pos.coords; fetchWeatherFromGeo(latitude, longitude); },
      err => { wxError.textContent = "ä½ç½®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚è¨­å®šâ†’ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼â†’ä½ç½®æƒ…å ±ã‚µãƒ¼ãƒ“ã‚¹â†’Safari Websitesã‚’è¨±å¯ ã«ã—ã¦ãã ã•ã„ã€‚"; wxLoading.classList.add("hidden"); },
      { enableHighAccuracy:false, timeout:8000 }
    );
  }
  $("#retryWx").addEventListener("click", askGeo);
  // åˆå›
  askGeo();

  // Logs
  const historyRoot = $("#history");
  function renderHistory(){
    const logs = JSON.parse(localStorage.getItem(logsKey) || "[]");
    historyRoot.innerHTML = "";
    if (logs.length===0){ const p=document.createElement("p"); p.className="text muted"; p.textContent="ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“"; historyRoot.appendChild(p); return; }
    logs.forEach(l => {
      const box = document.createElement("div"); box.className="card"; box.style.marginTop="8px";
      const head = document.createElement("div"); head.className="muted text"; head.textContent = l.date;
      const row = document.createElement("div"); row.className="row text"; row.style.marginTop="6px";
      row.innerHTML = `<div>æ°—åˆ†ï¼š${l.mood||"â€”"}</div>
                       <div>ã‚¨ãƒãƒ«ã‚®ãƒ¼ï¼š${l.energy||"â€”"}</div>
                       <div>ç¡çœ ï¼š${Math.floor((l.sleepMin||0)/60)}æ™‚é–“${(l.sleepMin||0)%60}åˆ†</div>
                       <div>å¤©æ°—ï¼š${l.weather ? (l.weather.condition+' / '+Math.round(l.weather.temp)+'Â°C') : "â€”"}</div>`;
      box.appendChild(head); box.appendChild(row);
      if (l.symptoms && l.symptoms.length){ const d=document.createElement("div"); d.className="text"; d.textContent="ä½“èª¿ï¼š"+l.symptoms.join("ã€ "); box.appendChild(d); }
      if (l.note){ const d=document.createElement("div"); d.className="text"; d.textContent="ãƒ¡ãƒ¢ï¼š"+l.note; box.appendChild(d); }
      if (l.tasks && l.tasks.length){ const ul=document.createElement("ul"); ul.style.marginLeft="20px"; ul.className="text"; l.tasks.forEach(t=>{ const li=document.createElement("li"); li.textContent=(t.done?'âœ… ':'â¬œ ')+t.title; ul.appendChild(li); }); box.appendChild(ul); }
      historyRoot.appendChild(box);
    });
  }
  renderHistory();

  $("#saveLog").addEventListener("click", () => {
    const logs = JSON.parse(localStorage.getItem(logsKey) || "[]");
    const todayTasksList = todayTasks();
    const payload = {
      date: todayKey,
      mood: state.mood,
      energy: state.energy,
      symptoms: state.symptoms,
      sleepMin: (parseInt(state.sleepH,10)||0)*60 + (parseInt(state.sleepM,10)||0),
      note: state.note,
      weather: state.weather,
      tasks: todayTasksList,
      ts: Date.now()
    };
    const newLogs = [payload, ...logs.filter(l => l.date !== todayKey)];
    localStorage.setItem(logsKey, JSON.stringify(newLogs));
    alert("ä»Šæ—¥ã®è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
    renderHistory();
  });

  $("#exportCSV").addEventListener("click", () => {
    const logs = JSON.parse(localStorage.getItem(logsKey) || "[]");
    const rows = [
      ["date","mood","energy","symptoms","sleep_min","weather","task_count","note"],
      ...logs.map(l => [
        l.date, l.mood, l.energy, (l.symptoms||[]).join(" "),
        l.sleepMin, l.weather ? (l.weather.condition+"/"+l.weather.temp) : "",
        (l.tasks||[]).length, String(l.note||"").replace(/\n/g," ")
      ])
    ];
    const csv = rows.map(r => r.map(x => `"${String(x ?? "").replace(/"/g,'""')}"`).join(",")).join("\n");
    const blob = new Blob([csv], { type:"text/csv;charset=utf-8;" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `morning_logs_${Date.now()}.csv`;
    document.body.appendChild(a); a.click(); a.remove();
  });
})();
</script>
</body>
</html>
