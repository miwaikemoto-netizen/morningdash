<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>MorningDash â€” v11.2 (Safari fix)</title>
<meta name="theme-color" content="#0f172a">

<style>
/* â€”â€” è¦‹ãŸç›®ï¼ˆå‰å›ã®ä¿®æ­£ã‚’å«ã‚€ï¼‰ â€”â€” */
:root{
  --bg:#f8fafc; --card:#ffffff; --line:#e5e7eb; --text:#0f172a; --muted:#64748b;
  --accent:#0ea5e9; --accent-press:#0284c7; --radius:16px;
}
html,body{background:var(--bg); color:var(--text); height:100%;}
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Hiragino Sans","Meiryo","Apple Color Emoji","Segoe UI Emoji";}
.container{max-width:980px;margin:0 auto;padding:16px;}
h1{font-size:28px;margin:0 0 8px 0;font-weight:800}
h2{font-size:18px;margin:0 0 8px 0;font-weight:700}
h3{font-size:14px;margin:0 0 6px 0;font-weight:600}
.text{font-size:14px}
.muted{color:var(--muted)}
.row{display:flex;gap:16px;flex-wrap:wrap}
.card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:16px;box-shadow:0 6px 20px rgba(2,8,23,.06); overflow:hidden; -webkit-mask-image:-webkit-radial-gradient(white, black);}
.section{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:16px;box-shadow:0 6px 20px rgba(2,8,23,.06); overflow:hidden; -webkit-mask-image:-webkit-radial-gradient(white, black);}
.titlebar{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.btn{appearance:none;border:1px solid var(--line);border-radius:14px;padding:10px 14px;background:#fff;cursor:pointer}
.btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
.btn.small{font-size:12px;padding:6px 10px}
.btn.tiny{font-size:11px;padding:4px 8px;border-radius:10px}
.input{border:1px solid var(--line);border-radius:12px;padding:10px 12px;font-size:14px; width:100%; max-width:100%; box-sizing:border-box}
.number{width:90px;text-align:center}
.badge{font-size:12px;padding:3px 8px;border-radius:999px;border:1px solid var(--line)}
.tab{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#fff;cursor:pointer}
.tab.active{background:var(--accent);color:#fff;border-color:var(--accent)}
.list{list-style:none;margin:0;padding:0}
.calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
.cal-cell{border:1px solid var(--line);border-radius:10px;padding:4px 2px;text-align:center;background:#fff;font-size:12px;line-height:1.1;cursor:pointer}
.cal-cell.today{border-color:#0f172a;border-width:2px}
.cal-cell .dot{display:block;width:7px;height:7px;border-radius:50%;margin:4px auto 0;background:#cbd5e1}
.symptom-group{border:1px dashed var(--line);border-radius:12px;padding:12px;margin:10px 0;background:rgba(255,255,255,.35)}
/* ãƒãƒƒãƒ—ã®èª­ã‚ãªã„å•é¡Œã‚’å¼·åˆ¶ä¿®æ­£ */
.chip{border:1px solid var(--line);border-radius:999px;padding:6px 10px;background:#fff;cursor:pointer;font-size:13px;color:#0f172a !important}
.chip.active{background:#0ea5e9 !important;border-color:#0ea5e9 !important;color:#fff !important}
.date-big{font-size:40px;font-weight:800;letter-spacing:.5px}
.chart{width:100%;height:180px;border:1px solid var(--line);border-radius:12px;background:#fff;overflow:hidden}
.chart svg{width:100%;height:100%;display:block}
.chart .axis{stroke:#cbd5e1;stroke-width:1}
.chart .bar{fill:#94a3b8}
.chart .line{fill:none;stroke:#334155;stroke-width:2}
.chart .dot{fill:#334155}

/* ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼ˆ#debug ã§è¡¨ç¤ºï¼‰ */
#debugBox{position:fixed;right:10px;bottom:10px;z-index:9999;background:#111;color:#fff;border-radius:12px;padding:10px 12px;font-size:12px;max-width:80vw;display:none}
#debugBox pre{white-space:pre-wrap;word-break:break-word}
</style>
<!-- ===== MorningDash v12: Layout-only override ===== -->
<style>
/* è§’ä¸¸å†…ã®ã«ã˜ã¿ï¼†ã¯ã¿å‡ºã—ã‚’å®Œå…¨å°ã˜ï¼ˆiOSå«ã‚€ï¼‰ */
.section, .card, .panel {
  overflow: hidden !important;
  -webkit-mask-image: -webkit-radial-gradient(white, black) !important;
}

/* ãƒ¢ãƒã‚¤ãƒ«ä½™ç™½ãƒ»å½±ãƒ»è§’ä¸¸ã®çµ±ä¸€ */
:root{
  --md-radius: 16px;
  --md-border: #e5e7eb;
  --md-shadow: 0 6px 20px rgba(2,8,23,.06);
  --md-text:   #0f172a;
  --md-muted:  #64748b;
  --md-accent: #0ea5e9;
}
.card, .section, .panel{
  border-radius: var(--md-radius) !important;
  border: 1px solid var(--md-border) !important;
  box-shadow: var(--md-shadow) !important;
  padding: 18px 16px !important;
  background: #fff !important;
}

/* è¦‹å‡ºã—ã®ãƒãƒ©ãƒ³ã‚¹ */
h1,h2,h3{ letter-spacing:.01em }
h2{ font-size: clamp(16px, 3.8vw, 20px) !important; margin: 0 0 10px !important; }
h3{ font-size: 14px !important; margin: 0 0 8px !important; color: var(--md-text) }

/* ãƒãƒƒãƒ—ï¼ˆæœªé¸æŠã®æ–‡å­—ãŒè¦‹ãˆãªã„å•é¡Œã‚’å¼·åˆ¶ä¸Šæ›¸ãï¼‰ */
.chip{
  -webkit-appearance:none; appearance:none;
  color: var(--md-text) !important;
  background: #fff !important;
  border: 1px solid var(--md-border) !important;
  border-radius: 999px !important;
  padding: 8px 12px !important;
  font-weight: 600 !important;
  box-shadow: none !important;
}
.chip:not(.active){ opacity: .95 !important; }
.chip.active{
  background: var(--md-accent) !important;
  border-color: var(--md-accent) !important;
  color: #fff !important;
}

/* å…¥åŠ›ç³»ã®æ¨ªã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼å¯¾ç­–ï¼ˆè‡ªç”±ãƒ¡ãƒ¢å«ã‚€ï¼‰ */
input[type="text"], input[type="number"], textarea, select{
  width: 100% !important;
  max-width: 100% !important;
  box-sizing: border-box !important;
  border: 1px solid var(--md-border) !important;
  border-radius: 12px !important;
  padding: 10px 12px !important;
  background: #fff !important;
}

/* è¡Œé–“ã¨ã‚°ãƒªãƒƒãƒ‰ã®è©°ã¾ã‚Šä¿®æ­£ */
.row{ gap: 12px !important; }
.list li{ margin-block: 8px !important; }

/* ãƒœã‚¿ãƒ³ã®è¦–èªæ€§ã‚¢ãƒƒãƒ— */
.btn, button, input[type=button], input[type=submit]{
  font-weight: 700 !important;
  border-radius: 12px !important;
  padding: 10px 14px !important;
}
.btn.primary, .btn.primary:where(*) {
  background: var(--md-accent) !important;
  border-color: var(--md-accent) !important;
  color:#fff !important;
}

/* ãƒŸãƒ‹ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ä»Šæœˆãƒœãƒƒã‚¯ã‚¹ã«ä½™ç™½ã‚’ç¢ºä¿ */
.calendar{ gap: 6px !important; }
.cal-cell{ border-radius: 10px !important; }
.cal-cell.today{ border-width: 2px !important; }

/* ç—‡çŠ¶ã‚°ãƒ«ãƒ¼ãƒ—ã®ç‚¹ç·šæ ã®å†…å´ã«å®‰å…¨ãƒãƒ¼ã‚¸ãƒ³ */
.symptom-group{
  margin: 10px 0 !important;
  padding: 12px !important;
  border: 1px dashed var(--md-border) !important;
  border-radius: 12px !important;
  background: rgba(255,255,255,.6) !important;
}

/* å±¥æ­´ã‚«ãƒ¼ãƒ‰ã®ãƒ†ã‚­ã‚¹ãƒˆè©°ã¾ã‚Šã‚’ç·©å’Œ */
#history .card .text{ line-height: 1.5 !important; }

/* å°ã•ãªç«¯æœ«ã§ã®ãƒœã‚¿ãƒ³æŠ˜è¿”ã— */
@media (max-width: 430px){
  .toolbar, .row{ flex-wrap: wrap !important; }
  .btn.small, .btn.tiny{ font-size: 12px !important; padding: 6px 10px !important; }
}
</style>
<!-- /Layout-only override -->

</head>

<body>
<div class="container">
  <div class="titlebar">
    <h1>MorningDash â˜€ï¸</h1>
    <div class="row" style="gap:8px;align-items:center">
      <input id="datePicker" type="date" class="input" style="max-width:160px">
      <span id="editBadge" class="badge" style="display:none">ç·¨é›†ãƒ¢ãƒ¼ãƒ‰</span>
    </div>
  </div>

  <div class="date-big" id="dateLabel"></div>

  <div class="row" style="gap:8px;margin:8px 0">
    <button id="tabMain" class="tab active">ãƒ¡ã‚¤ãƒ³</button>
    <button id="tabTaskHistory" class="tab">ã‚¿ã‚¹ã‚¯å±¥æ­´</button>
    <button id="tabSummary" class="tab">ã¾ã¨ã‚</button>
  </div>

  <div id="pageMain">
    <section class="card">
      <div class="titlebar">
        <h2>ãƒŸãƒ‹ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆæœˆï¼‰</h2>
        <div class="row">
          <button id="prevMonth" class="btn tiny">â†</button>
          <span id="calLabel" class="muted"></span>
          <button id="nextMonth" class="btn tiny">â†’</button>
        </div>
      </div>
      <div class="calendar-head row" style="gap:4px;opacity:.7;justify-content:space-between">
        <div>æ—¥</div><div>æœˆ</div><div>ç«</div><div>æ°´</div><div>æœ¨</div><div>é‡‘</div><div>åœŸ</div>
      </div>
      <div id="miniCalendar" class="calendar"></div>
      <div class="text muted" style="margin-top:6px">â—ï¼šâ¤ï¸â€ğŸ”¥æ¿ƒï¼â¤ï¸ä¸­ï¼â¤ï¸â€ğŸ©¹è–„ï¼ˆè¨˜éŒ²ãªã—=ã‚°ãƒ¬ãƒ¼ï¼‰</div>
    </section>

    <section class="card">
      <div class="titlebar">
        <h2>å¤©æ°—ï¼ˆç¾åœ¨åœ°ï¼‰</h2>
        <span id="wxLoading" class="muted" style="display:none">å–å¾—ä¸­â€¦</span>
      </div>
      <div id="wxError" class="text" style="color:#b91c1c"></div>
      <div id="wxBlock" class="row"></div>
      <div class="row" style="margin-top:8px"><button id="retryWx" class="btn small">å†å–å¾—</button></div>
    </section>

    <section class="row">
      <div class="card" style="flex:1 1 300px;min-width:280px">
        <h2>æ°—åˆ†</h2>
        <div id="moodBtns" class="row"></div>
      </div>
      <div class="card" style="flex:1 1 300px;min-width:280px">
        <h2>å…ƒæ°—åº¦</h2>
        <div id="energyBtns" class="row"></div>
      </div>
    </section>

    <section class="row">
      <div class="card" style="flex:1 1 300px;min-width:280px">
        <h2>ä½“èª¿ãƒ¡ãƒ¢</h2>
        <div class="symptom-group"><h3>â‘  ã‚ˆãã‚ã‚‹ä¸èª¿</h3><div id="symptomGroup1" class="row"></div></div>
        <div class="symptom-group"><h3>â‘¡ å­£ç¯€ãƒ»ç”Ÿæ´»ãƒªã‚ºãƒ </h3><div id="symptomGroup2" class="row"></div></div>
        <div class="symptom-group"><h3>â‘¢ ãƒ¡ãƒ³ã‚¿ãƒ«ãƒ»ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³</h3><div id="symptomGroup3" class="row"></div></div>
        <textarea id="note" class="input" rows="3" placeholder="è‡ªç”±ãƒ¡ãƒ¢ï¼ˆä¾‹ï¼šé¦–ã®å¼µã‚Šå¼·ã‚ï¼å†·ãˆæ°—å‘³ ãªã©ï¼‰"></textarea>
      </div>
      <div class="card" style="flex:1 1 300px;min-width:280px">
        <h2>ç¡çœ </h2>
        <div class="row" style="align-items:center;margin-bottom:8px">
          <input id="sleepH" class="input number" type="number" min="0" max="23" value="0"><span>æ™‚é–“</span>
          <input id="sleepM" class="input number" type="number" min="0" max="59" value="0"><span>åˆ†</span>
        </div>
        <div class="text muted" style="margin-bottom:6px">â€» ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã§è‡ªå‹•å…¥åŠ›ï¼ˆ`?sleepMin=åˆè¨ˆåˆ†`ï¼‰</div>
        <div class="text">åˆè¨ˆï¼š<b id="sleepTotal">0æ™‚é–“0åˆ†</b></div>

        <div class="card" style="margin-top:12px">
          <h3>ãƒ˜ãƒ«ã‚¹ï¼ˆä»»æ„ï¼‰</h3>
          <div class="row" style="align-items:center">
            <span>ä½“é‡</span><input id="weight" class="input number" type="number" step="0.1" min="0"><span>kg</span>
            <span>ä½“è„‚è‚ª</span><input id="bodyFat" class="input number" type="number" step="0.1" min="0" max="100"><span>%</span>
          </div>
          <div class="row" style="align-items:center;margin-top:8px">
            <button id="copyHealthShortcut" class="btn small">ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆç”¨URLã‚’ã‚³ãƒ”ãƒ¼</button>
          </div>
          <div class="text muted" style="margin-top:6px"><code>?sleepMin=&weight=&bodyFat=</code> ã‚’æ¸¡ã™ã¨è‡ªå‹•å…¥åŠ›</div>
        </div>
      </div>
    </section>

    <section class="row" style="margin-top:16px">
      <button id="saveLog" class="btn primary">ã“ã®æ—¥ã®è¨˜éŒ²ã‚’ä¿å­˜</button>
      <button id="exportCSV" class="btn">CSV</button>
      <button id="exportJSON" class="btn">JSON</button>
      <a href="./evening.html" class="btn">ğŸŒ™ å¤œã®è¨˜éŒ²ã¸</a>
      <label class="btn small" for="importJSON" style="cursor:pointer">JSONã‚’èª­ã¿è¾¼ã¿</label>
      <input id="importJSON" type="file" accept="application/json" style="display:none">
    </section>

    <section class="card" style="margin-top:16px">
      <div class="titlebar">
        <h2>å±¥æ­´</h2>
        <button id="reloadHistory" class="btn small">å±¥æ­´ã‚’å†èª­è¾¼</button>
      </div>
      <div id="history"></div>
    </section>
  </div>

  <div id="pageTaskHistory" style="display:none">
    <section class="card">
      <div class="titlebar">
        <h2>ã‚¿ã‚¹ã‚¯å±¥æ­´ï¼ˆæœªå®Œäº†ã®ä¿ç®¡åº«ï¼‰</h2>
        <div class="row"><button id="clearTaskHistory" class="btn small">å…¨æ¶ˆå»</button><button id="backToMain" class="btn small">ãƒ¡ã‚¤ãƒ³ã¸æˆ»ã‚‹</button></div>
      </div>
      <div class="row" style="margin-bottom:8px">
        <input id="thSearch" class="input" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§çµã‚Šè¾¼ã¿ï¼ˆä¾‹ï¼šæ°´ã‚„ã‚Šï¼‰" style="flex:1">
        <input id="thDate" type="date" class="input" style="max-width:160px">
        <button id="thClear" class="btn small">ãƒ•ã‚£ãƒ«ã‚¿ã‚’ã‚¯ãƒªã‚¢</button>
      </div>
      <div id="taskHistoryList"></div>
    </section>
  </div>

  <div id="pageSummary" style="display:none">
    <section class="card">
      <h2>ã¾ã¨ã‚ï¼ˆé€±é–“ãƒ»æœˆé–“ï¼‰</h2>
      <div class="row" style="gap:12px">
        <div style="flex:1 1 260px"><h3>ç›´è¿‘7æ—¥ï¼šç¡çœ ï¼ˆæ™‚é–“ï¼‰</h3><div id="chartSleep7" class="chart"></div></div>
        <div style="flex:1 1 260px"><h3>ç›´è¿‘30æ—¥ï¼šå…ƒæ°—åº¦ã‚«ã‚¦ãƒ³ãƒˆ</h3><div id="chartEnergy30" class="chart"></div></div>
        <div style="flex:1 1 260px"><h3>ç›´è¿‘30æ—¥ï¼šä½“é‡ï¼ˆæŠ˜ã‚Œç·šï¼‰</h3><div id="chartWeight30" class="chart"></div></div>
      </div>
    </section>
  </div>

  <div class="text muted" style="margin-top:24px;line-height:1.6">
    Tips: å…±æœ‰ â†’ ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ  ã§ã‚¢ãƒ—ãƒªé¢¨ã«ã‚‚ä½¿ãˆã¾ã™ï¼ˆâ€»PWAã¯Safariã¨ä¿ç®¡å ´æ‰€ãŒåˆ†ã‹ã‚Œã¾ã™ï¼‰ã€‚
    ä¿å­˜å…ˆï¼šã“ã®ç«¯æœ«ã®ãƒ–ãƒ©ã‚¦ã‚¶ localStorageã€‚åŒã˜URLãªã‚‰å±¥æ­´ã¯ç¶™ç¶šåˆ©ç”¨ã•ã‚Œã¾ã™ã€‚
  </div>
</div>

<!-- ãƒ‡ãƒãƒƒã‚°å‡ºåŠ› -->
<div id="debugBox"><b>Debug</b><pre id="debugOut"></pre></div>
<script>
/* ===== MD: ã‚¯ã‚¨ãƒªå–ã‚Šè¾¼ã¿ãƒ»å…ˆè¡Œä¿å­˜ãƒ›ãƒƒãƒˆãƒ•ã‚£ãƒƒã‚¯ã‚¹ =====
   ?sleepMin=441&weight=66.4&bodyFat=33.4 ã‚’é–‹ã„ãŸç¬é–“ã«
   localStorage(md_logs_v2 / ä»Šæ—¥ã®æ—¥ä»˜)ã¸å…ˆã«æ›¸ãè¾¼ã¿ã€
   ãã®å¾ŒUIãŒèµ·å‹•ã—ã¦ã‚‚å€¤ãŒæ¶ˆãˆãªã„ã‚ˆã†ã«ã™ã‚‹ã€‚
*/
(function(){
  try{
    const u = new URL(location.href);
    const hasQP =
      u.searchParams.has("sleepMin") ||
      u.searchParams.has("weight")   ||
      u.searchParams.has("bodyFat");
    if(!hasQP) return;

    // å—ã‘å–ã‚Š & æ•°å€¤åŒ–
    const nInt = v => { const n = parseInt(v,10); return Number.isFinite(n) ? n : null; };
    const nFloat = v => { const n = parseFloat(v); return Number.isFinite(n) ? n : null; };

    const sleepMin = nInt(u.searchParams.get("sleepMin"));
    const weight   = nFloat(u.searchParams.get("weight"));
    const bodyFat  = nFloat(u.searchParams.get("bodyFat"));

    // ä¿å­˜å…ˆã‚­ãƒ¼ã¨ â€œä»Šæ—¥â€ ã®ã‚­ãƒ¼ï¼ˆAsia/Tokyo å›ºå®šï¼‰
    const LOGS_KEY = "md_logs_v2";
    const todayKey = new Date().toLocaleDateString("ja-JP",{ timeZone:"Asia/Tokyo" });

    // æ—¢å­˜ãƒ­ã‚°ã®èª­ã¿å‡ºã—
    const logs = JSON.parse(localStorage.getItem(LOGS_KEY) || "[]");
    const others = logs.filter(x => x.date !== todayKey);
    const existing = logs.find(x => x.date === todayKey) || {
      date: todayKey,
      mood: "", energy: "", symptoms: [],
      sleepMin: 0, weight: null, bodyFat: null, note: "",
      weather: null,
      quickTasks: [{done:false,text:""},{done:false,text:""},{done:false,text:""}],
    };

    // ä¸Šæ›¸ãï¼ˆæ¥ã¦ã„ã‚‹å€¤ã ã‘ï¼‰
    if (sleepMin != null) existing.sleepMin = sleepMin;
    if (weight   != null) existing.weight   = weight;
    if (bodyFat  != null) existing.bodyFat  = bodyFat;
    existing.ts = Date.now();

    // å…ˆã«ä¿å­˜
    localStorage.setItem(LOGS_KEY, JSON.stringify([existing, ...others]));

    // ã‚¯ã‚¨ãƒªã‚’æ¶ˆã—ã¦ãƒªãƒ­ãƒ¼ãƒ‰ã—ãªã„ï¼ˆãã®ã¾ã¾UIãŒèª­ã¿ã«è¡Œãï¼‰
    history.replaceState(null, "", location.pathname);
  }catch(e){
    console.warn("ingest hotfix failed:", e);
  }
})();
</script>

<script>
(function(){
  // ====== å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ======
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const tz = "Asia/Tokyo";
  const toKey = (d)=> d.toLocaleDateString("ja-JP",{timeZone:tz}); // ä¾‹: 2025/8/16
  const normalizeKey = (k)=>{
    if(!k) return k;
    const m = String(k).trim().match(/^(\d{4})[\/-](\d{1,2})[\/-](\d{1,2})$/);
    return m ? `${Number(m[1])}/${Number(m[2])}/${Number(m[3])}` : k;
  };
  const today = new Date();
  const todayKey = toKey(today);

  // ====== Storageï¼ˆã‚­ãƒ¼çµ±ä¸€ãƒ»èª­ã¿è¾¼ã¿å¼·åŒ–ï¼‰ ======
  const PRIMARY_KEY = "md_logs_v3";          // æ–°ã—ã„ä¸»ã‚­ãƒ¼
  const COMPAT_KEYS = ["md_logs_v3","md_logs_v2","md_logs_v1"]; // äº’æ›èª­ã¿è¾¼ã¿
  const TASK_HIST_KEY = "md_task_history_v1";

  function loadAllLogs(){
    // äº’æ›ã‚­ãƒ¼ã‚’ã™ã¹ã¦èª­ã¿ã€æ—¥ä»˜ã‚’æ­£è¦åŒ–ã—ã¦é‡è¤‡ã‚’çµ±åˆ
    const merged = new Map();
    COMPAT_KEYS.forEach(k=>{
      try{
        const arr = JSON.parse(localStorage.getItem(k) || "[]");
        arr.forEach(it=>{
          const dk = normalizeKey(it.date);
          if(!dk) return;
          // å¾Œå‹ã¡ï¼ˆã‚ˆã‚Šæ–°ã—ã„ä¿å­˜ã‚’å„ªå…ˆï¼‰
          merged.set(dk, {...it, date: dk});
        });
      }catch(e){}
    });
    // é™é †ã§è¿”ã™
    return Array.from(merged.values()).sort((a,b)=> (a.date < b.date ? 1 : -1));
  }
  function saveAllLogs(arr){
    localStorage.setItem(PRIMARY_KEY, JSON.stringify(arr));
  }
  function loadLog(dateKey){
    const logs = loadAllLogs();
    return logs.find(l => l.date === normalizeKey(dateKey)) || null;
  }
  function upsertLog(payload){
    const logs = loadAllLogs();
    const rest = logs.filter(l => l.date !== normalizeKey(payload.date));
    saveAllLogs([{...payload, date: normalizeKey(payload.date)}, ...rest].sort((a,b)=> (a.date < b.date ? 1 : -1)));
  }
  function loadTaskHistory(){ return JSON.parse(localStorage.getItem(TASK_HIST_KEY) || "[]"); }
  function saveTaskHistory(arr){ localStorage.setItem(TASK_HIST_KEY, JSON.stringify(arr)); }

  // ====== ç”»é¢çŠ¶æ…‹ ======
  let currentDateKey = todayKey;
  const state = {
    mood:"", energy:"", symptoms:[], note:"",
    sleepH:0, sleepM:0, weight:null, bodyFat:null,
    weather:null,
    quickTasks:[{done:false,text:""},{done:false,text:""},{done:false,text:""}],
  };

  // èµ·å‹•æ™‚ä¸Šæ›¸ãã‚¬ãƒ¼ãƒ‰
  let booting = true; // åˆæœŸãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãŒçµ‚ã‚ã‚‹ã¾ã§ true
  let saveTimer=null;
  function autoSave(){
    if (booting) return; // â† ç©ºå€¤ã§ä¸Šæ›¸ãã‚’é˜²æ­¢
    clearTimeout(saveTimer);
    saveTimer = setTimeout(()=>{
      const payload = {
        date: currentDateKey,
        mood: state.mood,
        energy: state.energy,
        symptoms: state.symptoms,
        sleepMin: (parseInt(state.sleepH,10)||0)*60 + (parseInt(state.sleepM,10)||0),
        weight: state.weight, bodyFat: state.bodyFat,
        note: state.note, weather: state.weather,
        quickTasks: state.quickTasks,
        ts: Date.now()
      };
      upsertLog(payload);
      renderHistory(); renderMiniCalendar();
    }, 300);
  }

  // ====== ãƒ˜ãƒƒãƒ€ ======
  const dateLabel=$("#dateLabel"), datePicker=$("#datePicker"), editBadge=$("#editBadge");
  const toInputDate=d=>{const z=n=>String(n).padStart(2,"0");return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`;}
  const fromInputDate=s=>{const [y,m,d]=s.split("-").map(Number);return new Date(y,m-1,d);}
  function renderHeader(){
    dateLabel.textContent = currentDateKey;
    editBadge.style.display = (currentDateKey===todayKey) ? "none" : "inline-block";
    const [y,m,d] = currentDateKey.split("/").map(Number);
    datePicker.value = toInputDate(new Date(y,m-1,d));
  }
  datePicker.value = toInputDate(today);
  datePicker.addEventListener("change", ()=>{
    currentDateKey = toKey(fromInputDate(datePicker.value));
    loadLogToForm(loadLog(currentDateKey));
  });

  // ====== UIæ§‹ç¯‰ ======
  const moods = [{v:"ğŸ™‚",label:"è‰¯ã„"},{v:"ğŸ˜",label:"ãµã¤ã†"},{v:"ğŸ™",label:"ã„ã¾ã„ã¡"}];
  const energies = ["â¤ï¸â€ğŸ”¥å…ƒæ°—","â¤ï¸ã¾ãšã¾ãš","â¤ï¸â€ğŸ©¹ã ã‚‹ã„"];
  const group1=["é¦–ãƒ»è‚©ã“ã‚Š","é ­ç—›","è…¹ç—›ï¼ãŠè…¹ã®å¼µã‚Š","è…°ã®å¼µã‚Šï¼è…°ç—›","èƒƒè…¸å¼±ã‚ï¼ˆèƒƒã‚‚ãŸã‚Œãƒ»ä¸‹ç—¢ãƒ»ä¾¿ç§˜ãªã©ï¼‰","ã‚€ãã¿","ç›®ã®ç–²ã‚Œï¼ãƒ‰ãƒ©ã‚¤ã‚¢ã‚¤","è‡ªå¾‹ç¥çµŒã®ä¹±ã‚Œ","ç¡çœ ã®è³ªä½ä¸‹ï¼ˆæµ…ã„çœ ã‚Šãƒ»é€”ä¸­è¦šé†’ï¼‰","ç”Ÿç†"];
  const group2=["å†·ãˆï¼ˆæ‰‹è¶³ã®å†·ãˆãƒ»å…¨èº«ï¼‰","æš‘ã•ãƒãƒ†ï¼ç†±ã£ã½ã•","å–‰ã®ç—›ã¿ãƒ»å£°æ¯ã‚Œ","é¼»æ°´ãƒ»é¼»ã¥ã¾ã‚Š","è‚Œè’ã‚Œï¼ã‹ã‚†ã¿","èŠ±ç²‰ãƒ»ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ç—‡çŠ¶"];
  const group3=["é›†ä¸­åŠ›ä½ä¸‹","ã‚¤ãƒ©ã‚¤ãƒ©ï¼ä¸å®‰æ„Ÿ","ã ã‚‹ã•ï¼å€¦æ€ æ„Ÿ","ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ä½ä¸‹","PMSï¼ˆç”Ÿç†å‰ç—‡çŠ¶ï¼‰"];
  const allSymptoms=[...group1,...group2,...group3];

  function buildChips(root, options, isActive, onClick){
    root.innerHTML=""; options.forEach(opt=>{
      const v = typeof opt==="string" ? opt : opt.v;
      const label = typeof opt==="string" ? opt : (opt.v+" "+opt.label);
      const b = document.createElement("button");
      b.className = "chip" + (isActive(v) ? " active" : "");
      b.textContent = label;
      b.onclick = ()=>{ onClick(v); };
      root.appendChild(b);
    });
  }
  function renderChips(){
    buildChips($("#moodBtns"), moods, v=>state.mood===v, v=>{state.mood=v; renderChips(); autoSave();});
    buildChips($("#energyBtns"), energies, v=>state.energy===v, v=>{state.energy=v; renderChips(); autoSave();});
    const mk=(id,arr)=>buildChips($(id),arr, v=>state.symptoms.includes(v), v=>{
      if(state.symptoms.includes(v)) state.symptoms = state.symptoms.filter(x=>x!==v);
      else state.symptoms=[...state.symptoms, v];
      renderChips(); autoSave();
    });
    mk("#symptomGroup1",group1); mk("#symptomGroup2",group2); mk("#symptomGroup3",group3);
  }

  // å…¥åŠ›ç¾¤
  const sleepH=$("#sleepH"), sleepM=$("#sleepM"), sleepTotal=$("#sleepTotal");
  const weight=$("#weight"), bodyFat=$("#bodyFat"), note=$("#note");
  function updateSleepLabel(){ sleepTotal.textContent = Math.floor(state.sleepH)+"æ™‚é–“"+(state.sleepM%60)+"åˆ†"; }
  function syncFormFromState(){
    sleepH.value=state.sleepH; sleepM.value=state.sleepM; updateSleepLabel();
    weight.value = state.weight ?? ""; bodyFat.value = state.bodyFat ?? ""; note.value = state.note || "";
  }

  // ã‚¯ã‚¤ãƒƒã‚¯ã‚¿ã‚¹ã‚¯ï¼ˆçœç•¥: ã‚¯ãƒªãƒƒã‚¯æ™‚ã« autoSaveï¼‰
  const qtElems=[{c:$("#qt0c"),t:$("#qt0t")},{c:$("#qt1c"),t:$("#qt1t")},{c:$("#qt2c"),t:$("#qt2t")}].filter(x=>x.c&&x.t);
  function renderQuickTasks(){ qtElems.forEach((q,i)=>{ if(!state.quickTasks[i]) state.quickTasks[i]={done:false,text:""}; }); }

  // å¤©æ°—ï¼ˆçœç•¥ç‰ˆï¼‰
  function askGeo(){ /* å¿…è¦ãªã‚‰ãã®ã¾ã¾ */ }
  $("#retryWx")?.addEventListener("click", askGeo);

  // å±¥æ­´
  function renderHistory(){
    const root=$("#history"); const logs=loadAllLogs(); root.innerHTML="";
    if(!logs.length){ root.innerHTML='<p class="text muted">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p>'; return; }
    logs.forEach(l=>{
      const box=document.createElement("div"); box.className="card"; box.style.marginTop="8px";
      const head=document.createElement("div"); head.className="text"; head.innerHTML=`<span class="muted">${l.date}</span>`;
      const row=document.createElement("div"); row.className="row text"; row.style.marginTop="6px";
      row.innerHTML = `<div>æ°—åˆ†ï¼š${l.mood||"â€”"}</div>
                       <div>å…ƒæ°—åº¦ï¼š${l.energy||"â€”"}</div>
                       <div>ç¡çœ ï¼š${Math.floor((l.sleepMin||0)/60)}æ™‚é–“${(l.sleepMin||0)%60}åˆ†</div>
                       ${l.weight!=null?`<div>ä½“é‡ï¼š${l.weight}kg</div>`:""}
                       ${l.bodyFat!=null?`<div>ä½“è„‚è‚ªï¼š${l.bodyFat}%</div>`:""}`;
      const actions=document.createElement("div"); actions.className="row"; actions.style.marginTop="8px";
      const edit=document.createElement("button"); edit.className="btn small"; edit.textContent="ç·¨é›†";
      edit.onclick=()=>{ currentDateKey=l.date; loadLogToForm(l); window.scrollTo({top:0,behavior:"smooth"}); };
      const del=document.createElement("button"); del.className="btn small"; del.textContent="å‰Šé™¤";
      del.onclick=()=>{ if(!confirm(`${l.date} ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return; const rest=loadAllLogs().filter(x=>x.date!==l.date); saveAllLogs(rest); renderHistory(); renderMiniCalendar(); if(currentDateKey===l.date){ currentDateKey=todayKey; loadLogToForm(loadLog(todayKey)); }};
      actions.appendChild(edit); actions.appendChild(del);
      box.appendChild(head); box.appendChild(row); box.appendChild(actions); root.appendChild(box);
    });
  }

  // ãƒŸãƒ‹ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
  let calMonth = new Date(today.getFullYear(), today.getMonth(), 1);
  function renderMiniCalendar(){
    $("#calLabel").textContent = `${calMonth.getFullYear()}å¹´ ${calMonth.getMonth()+1}æœˆ`;
    const root=$("#miniCalendar"); root.innerHTML="";
    const firstDow = new Date(calMonth.getFullYear(), calMonth.getMonth(), 1).getDay();
    const daysInMonth = new Date(calMonth.getFullYear(), calMonth.getMonth()+1, 0).getDate();
    for(let i=0;i<firstDow;i++) root.appendChild(document.createElement("div"));
    const byDate=new Map(loadAllLogs().map(l=>[l.date,l]));
    for(let d=1; d<=daysInMonth; d++){
      const cell=document.createElement("div"); cell.className="cal-cell";
      const key = toKey(new Date(calMonth.getFullYear(), calMonth.getMonth(), d));
      if(key===toKey(new Date())) cell.classList.add("today");
      cell.innerHTML=`${d}<span class="dot"></span>`;
      const dot=cell.querySelector(".dot"); const rec=byDate.get(key);
      if(rec){ const e=rec.energy||""; if(e.includes("â¤ï¸â€ğŸ”¥")) dot.style.background="#be123c"; else if(e.includes("â¤ï¸ã¾ãš")) dot.style.background="#f43f5e"; else if(e.includes("â¤ï¸â€ğŸ©¹")) dot.style.background="#fecaca"; }
      cell.onclick=()=>{ currentDateKey=key; loadLogToForm(rec||null); window.scrollTo({top:0,behavior:"smooth"}); };
      root.appendChild(cell);
    }
  }
  $("#prevMonth").addEventListener("click", ()=>{ calMonth=new Date(calMonth.getFullYear(),calMonth.getMonth()-1,1); renderMiniCalendar(); });
  $("#nextMonth").addEventListener("click", ()=>{ calMonth=new Date(calMonth.getFullYear(),calMonth.getMonth()+1,1); renderMiniCalendar(); });

  // ç”»é¢ãƒ­ãƒ¼ãƒ‰ãƒ»ä¿å­˜ãƒ»ã‚³ãƒ”ãƒ¼
  function loadLogToForm(log){
    if(!log){ state.mood=""; state.energy=""; state.symptoms=[]; state.note=""; state.sleepH=0; state.sleepM=0; state.weight=null; state.bodyFat=null; }
    else{
      state.mood=log.mood||""; state.energy=log.energy||""; state.symptoms=Array.isArray(log.symptoms)?log.symptoms.filter(s=>allSymptoms.includes(s)):[];
      const sm=parseInt(log.sleepMin||0,10); state.sleepH=Math.floor(sm/60); state.sleepM=sm%60;
      state.weight=(log.weight ?? null); state.bodyFat=(log.bodyFat ?? null); state.note=log.note||"";
    }
    renderChips(); syncFormFromState(); renderQuickTasks(); renderHeader();
  }

  $("#saveLog").addEventListener("click", ()=>{
    const payload={ date: currentDateKey, mood:state.mood, energy:state.energy, symptoms:state.symptoms,
      sleepMin:(parseInt(state.sleepH,10)||0)*60+(parseInt(state.sleepM,10)||0),
      weight:state.weight, bodyFat:state.bodyFat, note:state.note, weather:state.weather, quickTasks:state.quickTasks, ts:Date.now()
    };
    upsertLog(payload); alert(`${currentDateKey} ã‚’ä¿å­˜ã—ã¾ã—ãŸ`); renderHistory(); renderMiniCalendar();
  });
  $("#reloadHistory").addEventListener("click", ()=>{ renderHistory(); });

  $("#copyHealthShortcut").addEventListener("click", async ()=>{
    const base = location.origin + location.pathname.replace(/index\.html?$/,"");
    const u = `${base}ingest.html?sleepMin=[[åˆè¨ˆç¡çœ åˆ†]]&weight=[[ä½“é‡_kg]]&bodyFat=[[ä½“è„‚è‚ª_%]]`;
    try{ await navigator.clipboard.writeText(u); alert("ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆç”¨URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"); }catch(e){ alert(u); }
  });

  // åˆæœŸè¡¨ç¤ºï¼ˆä¿å­˜ â†’ èª­ã¿å‡ºã—é †ã®ç«¶åˆã‚’é¿ã‘ã‚‹ï¼‰
  function initialRender(){
    renderHistory(); renderMiniCalendar();
    const saved = loadLog(todayKey);
    loadLogToForm(saved);
    // ingestã‹ã‚‰ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã§ index ã«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒä»˜ã„ã¦ã„ãŸå ´åˆã‚‚åæ˜ 
    const url=new URL(location.href);
    const gp=k=>url.searchParams.get(k);
    let changed=false;
    if(gp("sleepMin")!=null){ const m=parseInt(gp("sleepMin"),10)||0; state.sleepH=Math.floor(m/60); state.sleepM=m%60; changed=true; }
    if(gp("weight")!=null){ const w=parseFloat(gp("weight")); if(!isNaN(w)){ state.weight=w; changed=true; } }
    if(gp("bodyFat")!=null){ const b=parseFloat(gp("bodyFat")); if(!isNaN(b)){ state.bodyFat=b; changed=true; } }
    if(changed){ syncFormFromState(); }
    // èµ·å‹•ã‚¬ãƒ¼ãƒ‰è§£é™¤ï¼ˆã“ã‚Œä»¥é™ã®æ“ä½œã§ autoSave ã‚’è¨±å¯ï¼‰
    booting=false;
  }
  initialRender();

  // ====== ãƒ‡ãƒãƒƒã‚°ï¼ˆ#debug ã§è¡¨ç¤ºï¼‰ ======
  function showDebug(){
    if(location.hash!=="#debug") return;
    const box=$("#debugBox"), out=$("#debugOut");
    box.style.display="block";
    const logs = loadAllLogs();
    const todayLog = loadLog(todayKey);
    out.textContent = `storageKeys: ${JSON.stringify(COMPAT_KEYS)}\n`+
      `todayKey: ${todayKey}\n`+
      `hasToday: ${!!todayLog}\n`+
      `todayLog: ${JSON.stringify(todayLog,null,2)}\n\n`+
      `first2: ${JSON.stringify(logs.slice(0,2),null,2)}`;
  }
  showDebug();

  // ã‚¿ãƒ–
  const pageMain=$("#pageMain"), pageTaskHistory=$("#pageTaskHistory"), pageSummary=$("#pageSummary");
  function showPage(which){
    pageMain.style.display = which==="main"?"block":"none";
    pageTaskHistory.style.display = which==="taskHistory"?"block":"none";
    pageSummary.style.display = which==="summary"?"block":"none";
    $("#tabMain").classList.toggle("active", which==="main");
    $("#tabTaskHistory").classList.toggle("active", which==="taskHistory");
    $("#tabSummary").classList.toggle("active", which==="summary");
  }
  $("#tabMain").onclick=()=>showPage("main");
  $("#tabTaskHistory").onclick=()=>{ showPage("taskHistory"); /* renderTaskHistory() çœç•¥ */ };
  $("#tabSummary").onclick=()=>{ showPage("summary"); /* renderCharts() çœç•¥ */ };

})();
</script>
</body>
</html>
