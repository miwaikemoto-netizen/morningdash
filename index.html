<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>MorningDash â€” v8ï¼ˆã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆå€¤ãŒåæ˜ ã•ã‚Œãªã„å•é¡Œã‚’ä¿®æ­£ï¼‰</title>
<meta name="theme-color" content="#0f172a">

<!-- ===== Morning Dash quick facelift (moved into <head>) ===== -->
<style>
:root{
  --bg:#f8fafc;          /* ã»ã®ç™½ */
  --card:#ffffff;        /* ã‚«ãƒ¼ãƒ‰é¢ */
  --line:#e5e7eb;        /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³å¢ƒç•Œ */
  --text:#0f172a;        /* æ–‡å­—è‰²ï¼ˆæ¿ƒç´ºï¼‰ */
  --muted:#64748b;       /* è£œåŠ©ãƒ†ã‚­ã‚¹ãƒˆ */
  --accent:#0ea5e9;      /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è‰²ï¼ˆMorningï¼‰ */
  --accent-press:#0284c7;
  --radius:14px;         /* è§’ä¸¸ã‚’å°‘ã—å¤§ãã‚ã« */
  --shadow:0 6px 20px rgba(2,8,23,.06);
}

/* å…¨ä½“ã®ãƒˆãƒ¼ãƒ³ */
html,body{background:var(--bg); color:var(--text);}
body{font-family:system-ui,-apple-system,"SF Pro","Hiragino Sans",Arial,"Meiryo",sans-serif;}

/* ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã‚«ãƒ¼ãƒ‰ï¼‰ */
.section, .card, .panel{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:20px !important;
  margin-block:18px !important;
  box-sizing:border-box;
  overflow:hidden;
}

/* è¦‹å‡ºã— */
.section h2, .card h2, .panel h2{
  letter-spacing:.01em;
  font-weight:700;
  margin-bottom:10px;
}

/* ä¸»è¦ãƒœã‚¿ãƒ³ */
button, .btn, input[type=button], input[type=submit]{
  background:var(--accent);
  color:#fff;
  border:none;
  border-radius:12px;
  padding:10px 14px;
  font-weight:600;
  box-shadow:0 4px 12px rgba(14,165,233,.25);
  transition:.15s transform ease, .15s background ease;
}
button:hover, .btn:hover{background:var(--accent-press);}
button:active, .btn:active{transform:translateY(1px);}

/* ã‚µãƒ–ãƒœã‚¿ãƒ³ï¼ˆæ ã®ã¿ï¼‰ */
.btn-ghost, .ghost{
  background:transparent !important;
  color:var(--accent);
  border:1px solid var(--accent);
  box-shadow:none;
}

/* å…¥åŠ› */
input[type=text], input[type=number], textarea, select{
  border:1px solid var(--line);
  border-radius:10px;
  padding:10px 12px;
  background:#fff;
}

/* æ—¥ä»˜ã‚’å¤§ãã */
#md-date, #todayStr, .date-today{
  font-size:clamp(24px, 3.2rem, 44px);
  font-weight:800;
  letter-spacing:.02em;
  line-height:1.15;
  margin:6px 0 2px;
}

/* ãƒŸãƒ‹ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’â€œã‚­ãƒ¥ãƒƒâ€ã¨ */
.mini-cal{ transform:scale(.92); transform-origin: top left; }
.mini-cal .day{ width:2.1rem; height:2.1rem; border-radius:10px; }
.mini-cal .day.today{
  outline:1.5px solid var(--accent);
  outline-offset:1px;
  font-weight:800;
}

/* å…ƒæ°—åº¦ã®ã‚¢ã‚¤ã‚³ãƒ³ä»˜ä¸ï¼ˆå¿…è¦ãªã‚‰HTMLå´ã« data-energy ã‚’ä»˜ä¸ï¼‰ */
[data-energy="high"]::before{content:"â¤ï¸â€ğŸ”¥ "; }
[data-energy="mid"]::before{ content:"â¤ï¸ "; }
[data-energy="low"]::before{ content:"â¤ï¸â€ğŸ©¹ "; }

/* ã‚¯ã‚¤ãƒƒã‚¯ã‚¿ã‚¹ã‚¯å³ä¸Šãƒœã‚¿ãƒ³ã‚’å°ã¶ã‚Šã« */
.quick-actions button, .quick-actions .btn{
  padding:6px 8px;
  border-radius:10px;
  font-size:.9rem;
}

/* ãƒªã‚¹ãƒˆè¡Œé–“ */
.list, .table{--row-gap:8px;}
.list li{margin-block:var(--row-gap);}

/* è£œåŠ©ãƒ†ã‚­ã‚¹ãƒˆ */
.muted, .help, .note{ color:var(--muted); }
</style>

<!-- æ—¢å­˜ãƒ†ãƒ¼ãƒCSS -->
<style>
  :root{ --bg1:#ffffff;--bg2:#f1f5f9;--fg:#0f172a;--muted:#64748b;--accent:#0f172a;--card:#ffffff;--border:#e5e7eb; }
  html,body{height:100%;}
  body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";color:var(--fg);
       background:linear-gradient(var(--bg1),var(--bg2));}
  .container{max-width:980px;margin:0 auto;padding:16px;}
  h1{font-size:28px;margin:0 0 8px 0;font-weight:700}
  h2{font-size:18px;margin:0 0 8px 0;font-weight:600}
  h3{font-size:14px;margin:0 0 6px 0;font-weight:600}
  .muted{opacity:.7}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
  .row{display:flex;gap:16px;flex-wrap:wrap}
  .btn{appearance:none;border:1px solid var(--border);border-radius:14px;padding:10px 14px;background:#fff;cursor:pointer}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  .btn.small{font-size:12px;padding:6px 10px}
  .btn.tiny{font-size:11px;padding:4px 8px;border-radius:10px}
  .chip{border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:#fff;cursor:pointer;font-size:13px}
  .chip.active{background:var(--accent);border-color:var(--accent);color:#fff}
  .input{border:1px solid var(--border);border-radius:12px;padding:10px 12px;font-size:14px}
  .text{font-size:14px}
  .list{list-style:none;padding:0;margin:0}
  .footer{font-size:12px;opacity:.6;margin-top:24px;line-height:1.6}
  .titlebar{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
  .number{width:64px;text-align:center}
  .badge{font-size:12px;padding:3px 8px;border-radius:999px;border:1px solid var(--border);}
  .danger{color:#b91c1c}
  .date-big{font-size:40px;font-weight:700;letter-spacing:0.5px}
  .symptom-group{border:1px dashed var(--border);border-radius:12px;padding:10px;margin-bottom:8px}
  .symptom-group h3{font-size:13px;margin:0 0 6px 0;opacity:.8}
  .quick-task{display:flex;align-items:center;gap:8px;margin:4px 0}
  .quick-task input[type="text"]{flex:1}
  .toolbar{display:flex;align-items:center;gap:8px}
  .linklike{font-size:12px;text-decoration:underline;cursor:pointer}
  .tabs{display:flex;gap:8px;margin:8px 0}
  .tab{padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#fff;cursor:pointer}
  .tab.active{background:var(--accent);color:#fff;border-color:var(--accent)}
  .filterbar{display:flex;gap:8px;align-items:center;margin-bottom:8px}
  .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
  .cal-cell{border:1px solid var(--border);border-radius:10px;padding:4px 2px;text-align:center;cursor:pointer;background:#fff;font-size:12px;line-height:1.1}
  .cal-cell.today{border-color:#0f172a; border-width:2px}
  .cal-cell .dot{display:block;width:7px;height:7px;border-radius:50%;margin:4px auto 0 auto;background:#cbd5e1}
  .cal-head{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-bottom:6px}
  .cal-head div{font-size:12px;text-align:center;opacity:.7}
  .summary-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
  .pill{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:999px;font-size:12px;margin-right:6px}
  .chart{width:100%; height:180px; border:1px solid var(--border); border-radius:12px; background:#fff; overflow:hidden}
  .chart svg{width:100%; height:100%; display:block}
  .chart .axis{stroke:#cbd5e1; stroke-width:1}
  .chart text{fill:#64748b; font-size:10px}
  .chart .bar{fill:#94a3b8}
  .chart .line{fill:none; stroke:#334155; stroke-width:2}
  .chart .dot{fill:#334155}
</style>
  
<style>
/* --- iPhoneã§å†…å´ã®æ ãŒã¯ã¿å‡ºã™å¯¾ç­– --- */
.section, .card, .panel{
  overflow: hidden;                                  /* è§’ä¸¸ã®å¤–ã¸å‡ºãªã„ */
  -webkit-mask-image: -webkit-radial-gradient(white, black); /* iOSã§è§’ä¸¸åˆ‡ã‚ŠæŠœãã‚’å¼·åˆ¶ */
}

/* ç—‡çŠ¶ã®ç‚¹ç·šãƒœãƒƒã‚¯ã‚¹ã®ä½™ç™½ãƒ»è§’ã‚’èª¿æ•´ï¼ˆè¦ªã®è§’ã‹ã‚‰å®‰å…¨ãªè·é›¢ã«ï¼‰ */
.symptom-group{
  margin: 10px 0;
  padding: 12px;
  border-radius: 12px;
  border: 1px dashed var(--line);
  background: rgba(255,255,255,.35);                 /* ä¸‹åœ°ã‚’å°‘ã—å…¥ã‚Œã¦ã«ã˜ã¿é˜²æ­¢ï¼ˆä»»æ„ï¼‰ */
}
.card .symptom-group:last-child{ margin-bottom: 0; }

/* --- ãƒãƒƒãƒ—ï¼ˆæœªé¸æŠæ™‚ã®æ–‡å­—ãŒè¦‹ãˆãªã„å•é¡Œï¼‰--- */
.chip{
  -webkit-appearance: none; appearance: none;
  color: var(--text);                                 /* æ–‡å­—è‰²ã‚’æ˜ç¤º */
  background: #fff;
  border: 1px solid var(--line);
  box-shadow: none;                                   /* é’ã„ã‚°ãƒ­ãƒ¼ã‚’æ¶ˆã™ */
}
.chip:not(.active){ color: var(--text); opacity: .92; }
.chip.active{
  background: var(--accent);
  border-color: var(--accent);
  color: #fff;                                        /* é¸æŠæ™‚ã¯ç™½æ–‡å­— */
}
</style>


<!-- MD v9 quick fixes -->
<style>
/* ---- Fix 1: inner card overflow / iOS rounding bleed ---- */
.section, .card, .panel { overflow: hidden; }
.section, .card, .panel { -webkit-mask-image: -webkit-radial-gradient(white, black); }

/* ---- Fix 2: textarea/input width stays inside ---- */
textarea { width: 100% !important; max-width: 100%; box-sizing: border-box; }
input[type="text"], input[type="number"] { max-width: 100%; box-sizing: border-box; }

/* ---- Fix 3: unselected chips readable / active chips inverted ---- */
:root { --md-chip-text:#0f172a; --md-chip-bg:#ffffff; --md-chip-border:#e5e7eb; --md-chip-active:#0ea5e9; }
.chip { color: var(--md-chip-text) !important; background: var(--md-chip-bg) !important; border: 1px solid var(--md-chip-border) !important; }
.chip.active { background: var(--md-chip-active) !important; border-color: var(--md-chip-active) !important; color: #fff !important; }
</style>

</head>
<body>
  <div class="container">
    <div class="titlebar">
      <h1>MorningDash â˜€ï¸</h1>
      <div class="toolbar">
        <input id="datePicker" type="date" class="input" style="padding:8px 10px">
        <span id="editBadge" class="badge" style="display:none">ç·¨é›†ãƒ¢ãƒ¼ãƒ‰</span>
      </div>
    </div>
    <div class="date-big" id="dateLabel"></div>

    <div class="tabs">
      <button id="tabMain" class="tab active">ãƒ¡ã‚¤ãƒ³</button>
      <button id="tabTaskHistory" class="tab">ã‚¿ã‚¹ã‚¯å±¥æ­´</button>
      <button id="tabSummary" class="tab">ã¾ã¨ã‚</button>
    </div>

    <div id="pageMain">
      <section class="card">
        <div class="titlebar">
          <h2>ãƒŸãƒ‹ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆæœˆï¼‰</h2>
          <div class="toolbar">
            <button id="prevMonth" class="btn tiny">â†</button>
            <span id="calLabel" class="muted"></span>
            <button id="nextMonth" class="btn tiny">â†’</button>
          </div>
        </div>
        <div class="cal-head">
          <div>æ—¥</div><div>æœˆ</div><div>ç«</div><div>æ°´</div><div>æœ¨</div><div>é‡‘</div><div>åœŸ</div>
        </div>
        <div id="miniCalendar" class="calendar"></div>
        <div class="text muted" style="margin-top:6px">â—ã®è‰²ï¼šâ¤ï¸â€ğŸ”¥å…ƒæ°—=æ¿ƒï¼â¤ï¸=ä¸­ï¼â¤ï¸â€ğŸ©¹=è–„ï¼ˆè¨˜éŒ²ãªã—=ã‚°ãƒ¬ãƒ¼ï¼‰</div>
      </section>

      <section class="card" style="margin-top:16px">
        <div class="titlebar">
          <h2>å¤©æ°—ï¼ˆç¾åœ¨åœ°ï¼‰</h2>
          <span id="wxLoading" class="muted" style="display:none">å–å¾—ä¸­â€¦</span>
        </div>
        <div id="wxError" class="text danger"></div>
        <div id="wxBlock" class="row"></div>
        <div class="row" style="margin-top:8px">
          <button id="retryWx" class="btn small">å†å–å¾—</button>
        </div>
      </section>

      <section class="row" style="margin-top:16px">
        <div class="card" style="flex:1 1 300px;min-width:280px">
          <h2>æ°—åˆ†</h2>
          <div id="moodBtns" class="row"></div>
        </div>
        <div class="card" style="flex:1 1 300px;min-width:280px">
          <h2>å…ƒæ°—åº¦</h2>
          <div id="energyBtns" class="row"></div>
        </div>
      </section>

      <section class="row" style="margin-top:16px">
        <div class="card" style="flex:1 1 300px;min-width:280px">
          <h2>ä½“èª¿ãƒ¡ãƒ¢</h2>
          <div class="symptom-group">
            <h3>â‘  ã‚ˆãã‚ã‚‹ä¸èª¿</h3>
            <div id="symptomGroup1" class="row"></div>
          </div>
          <div class="symptom-group">
            <h3>â‘¡ å­£ç¯€ãƒ»ç”Ÿæ´»ãƒªã‚ºãƒ </h3>
            <div id="symptomGroup2" class="row"></div>
          </div>
          <div class="symptom-group">
            <h3>â‘¢ ãƒ¡ãƒ³ã‚¿ãƒ«ãƒ»ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³</h3>
            <div id="symptomGroup3" class="row"></div>
          </div>
          <textarea id="note" class="input" rows="3" style="width:100%" placeholder="è‡ªç”±ãƒ¡ãƒ¢ï¼ˆä¾‹ï¼šé¦–ã®å¼µã‚Šå¼·ã‚ï¼å†·ãˆæ°—å‘³ ãªã©ï¼‰"></textarea>
        </div>

        <div class="card" style="flex:1 1 300px;min-width:280px">
          <h2>ç¡çœ </h2>
          <div class="row" style="align-items:center;margin-bottom:8px">
            <input id="sleepH" class="input number" type="number" min="0" max="23" value="0">
            <span>æ™‚é–“</span>
            <input id="sleepM" class="input number" type="number" min="0" max="59" value="0">
            <span>åˆ†</span>
          </div>
          <div class="text muted" style="margin-bottom:6px">â€» ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆé€£æºã§è‡ªå‹•å…¥åŠ›ï¼ˆ?sleepMin=åˆè¨ˆåˆ†ï¼‰</div>
          <div class="text">åˆè¨ˆï¼š<b id="sleepTotal">0æ™‚é–“0åˆ†</b></div>

          <div class="card" style="margin-top:12px">
            <h3>ãƒ˜ãƒ«ã‚¹ï¼ˆä»»æ„ï¼‰</h3>
            <div class="row" style="align-items:center">
              <span>ä½“é‡</span><input id="weight" class="input number" type="number" step="0.1" min="0" style="width:90px"><span>kg</span>
              <span>ä½“è„‚è‚ª</span><input id="bodyFat" class="input number" type="number" step="0.1" min="0" max="100" style="width:90px"><span>%</span>
            </div>
            <div class="row" style="align-items:center;margin-top:8px">
              <button id="copyHealthShortcut" class="btn small">ãƒ˜ãƒ«ã‚¹å–ã‚Šè¾¼ã¿ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆç”¨URLã‚’ã‚³ãƒ”ãƒ¼</button>
            </div>
            <div class="text muted" style="margin-top:6px">â€» ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã§ãƒ˜ãƒ«ã‚¹ã‚±ã‚¢ã‹ã‚‰å–å¾—â†’URLã§ <code>?sleepMin=&weight=&bodyFat=</code> ã‚’æ¸¡ã™ã¨è‡ªå‹•å…¥åŠ›</div>
          </div>
        </div>
      </section>

      <section class="row" style="margin-top:16px">
        <button id="saveLog" class="btn primary">ã“ã®æ—¥ã®è¨˜éŒ²ã‚’ä¿å­˜</button>
        <button id="exportCSV" class="btn">CSV</button>
        <button id="exportJSON" class="btn">JSON</button>
        <!-- å¤œãƒšãƒ¼ã‚¸ã¸ã®ãƒªãƒ³ã‚¯ï¼ˆâ‘¡æ¡ˆï¼‰ -->
        <a href="./evening.html" class="btn">ğŸŒ™ å¤œã®è¨˜éŒ²ã¸</a>
        <label class="btn small" for="importJSON" style="cursor:pointer">JSONã‚’èª­ã¿è¾¼ã¿</label>
        <input id="importJSON" type="file" accept="application/json" style="display:none">
      </section>

      <section class="card" style="margin-top:16px">
        <div class="titlebar">
          <h2>å±¥æ­´</h2>
          <button id="reloadHistory" class="btn small">å±¥æ­´ã‚’å†èª­è¾¼</button>
        </div>
        <div id="history"></div>
      </section>
    </div>

    <div id="pageTaskHistory" style="display:none">
      <section class="card">
        <div class="titlebar">
          <h2>ã‚¿ã‚¹ã‚¯å±¥æ­´ï¼ˆæœªå®Œäº†ã®ä¿ç®¡åº«ï¼‰</h2>
          <div class="toolbar">
            <button id="clearTaskHistory" class="btn small">å…¨æ¶ˆå»</button>
            <button id="backToMain" class="btn small">ãƒ¡ã‚¤ãƒ³ã¸æˆ»ã‚‹</button>
          </div>
        </div>

        <div class="filterbar">
          <input id="thSearch" class="input" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§çµã‚Šè¾¼ã¿ï¼ˆä¾‹ï¼šæ°´ã‚„ã‚Šï¼‰" style="flex:1">
          <input id="thDate" type="date" class="input">
          <button id="thClear" class="btn small">ãƒ•ã‚£ãƒ«ã‚¿ã‚’ã‚¯ãƒªã‚¢</button>
        </div>

        <div id="taskHistoryList"></div>
      </section>
    </div>

    <div id="pageSummary" style="display:none">
      <section class="card">
        <div class="titlebar"><h2>ã¾ã¨ã‚ï¼ˆé€±é–“ãƒ»æœˆé–“ï¼‰</h2></div>
        <div class="summary-grid">
          <div>
            <h3>ç›´è¿‘7æ—¥ï¼šç¡çœ ï¼ˆæ™‚é–“ï¼‰</h3>
            <div id="chartSleep7" class="chart"></div>
          </div>
          <div>
            <h3>ç›´è¿‘30æ—¥ï¼šå…ƒæ°—åº¦ã‚«ã‚¦ãƒ³ãƒˆ</h3>
            <div id="chartEnergy30" class="chart"></div>
          </div>
          <div>
            <h3>ç›´è¿‘30æ—¥ï¼šä½“é‡ï¼ˆæŠ˜ã‚Œç·šï¼‰</h3>
            <div id="chartWeight30" class="chart"></div>
          </div>
        </div>
      </section>
    </div>

    <div class="footer">
      <p>Tips: å…±æœ‰ â†’ ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ  ã§ã‚¢ãƒ—ãƒªé¢¨ã«ä½¿ãˆã¾ã™ã€‚</p>
      <p class="muted">ä¿å­˜å ´æ‰€ã¯ã“ã®ç«¯æœ«ã®ãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆlocalStorageï¼‰ã€‚åŒã˜URLãªã‚‰ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã—ã¦ã‚‚å±¥æ­´ã¯ç¶™ç¶šåˆ©ç”¨ã•ã‚Œã¾ã™ã€‚</p>
    </div>
  </div>

<script>
(function(){
  const $ = (s) => document.querySelector(s);
  const $$ = (s) => Array.from(document.querySelectorAll(s));
  const today = new Date();
  const toKey = d => d.toLocaleDateString("ja-JP",{timeZone:"Asia/Tokyo"});
  const toInputDate = d => { const z = n => String(n).padStart(2,"0"); return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`; };
  const fromInputDate = s => { const [y,m,da] = s.split("-").map(Number); return new Date(y, m-1, da); };

  const todayKey = toKey(today);
  let currentDateKey = todayKey;
  const dateLabel = $("#dateLabel");
  const datePicker = $("#datePicker");
  const editBadge = $("#editBadge");
  const pageMain = $("#pageMain");
  const pageTaskHistory = $("#pageTaskHistory");
  const pageSummary = $("#pageSummary");

  function renderHeader(){
    dateLabel.textContent = currentDateKey;
    editBadge.style.display = (currentDateKey === todayKey) ? "none" : "inline-block";
    const [y, m, da] = currentDateKey.split("/").map(Number);
    datePicker.value = toInputDate(new Date(y, m-1, da));
  }
  datePicker.value = toInputDate(today);
  renderHeader();

  // Tabs
  $("#tabMain").addEventListener("click", () => { showPage("main"); });
  $("#tabTaskHistory").addEventListener("click", () => { showPage("taskHistory"); renderTaskHistory(); });
  $("#tabSummary").addEventListener("click", () => { showPage("summary"); renderCharts(); });
  function showPage(which){
    pageMain.style.display = which==="main" ? "block":"none";
    pageTaskHistory.style.display = which==="taskHistory" ? "block":"none";
    pageSummary.style.display = which==="summary" ? "block":"none";
    $("#tabMain").classList.toggle("active", which==="main");
    $("#tabTaskHistory").classList.toggle("active", which==="taskHistory");
    $("#tabSummary").classList.toggle("active", which==="summary");
  }

  // State
  const state = {
    mood: "",
    energy: "",
    symptoms: [],
    note: "",
    sleepH: 0,
    sleepM: 0,
    weight: null,
    bodyFat: null,
    weather: null,
    quickTasks: [{done:false,text:""},{done:false,text:""},{done:false,text:""}],
  };

  // UI builders
  const moods = [{v:"ğŸ™‚",label:"è‰¯ã„"},{v:"ğŸ˜",label:"ãµã¤ã†"},{v:"ğŸ™",label:"ã„ã¾ã„ã¡"}];
  const energies = ["â¤ï¸â€ğŸ”¥å…ƒæ°—","â¤ï¸ã¾ãšã¾ãš","â¤ï¸â€ğŸ©¹ã ã‚‹ã„"];

  // Symptom groups
  const group1 = [
    "é¦–ãƒ»è‚©ã“ã‚Š","é ­ç—›","è…¹ç—›ï¼ãŠè…¹ã®å¼µã‚Š","è…°ã®å¼µã‚Šï¼è…°ç—›","èƒƒè…¸å¼±ã‚ï¼ˆèƒƒã‚‚ãŸã‚Œãƒ»ä¸‹ç—¢ãƒ»ä¾¿ç§˜ãªã©ï¼‰","ã‚€ãã¿","ç›®ã®ç–²ã‚Œï¼ãƒ‰ãƒ©ã‚¤ã‚¢ã‚¤",
    "è‡ªå¾‹ç¥çµŒã®ä¹±ã‚Œ","ç¡çœ ã®è³ªä½ä¸‹ï¼ˆæµ…ã„çœ ã‚Šãƒ»é€”ä¸­è¦šé†’ï¼‰","ç”Ÿç†"
  ];
  const group2 = [
    "å†·ãˆï¼ˆæ‰‹è¶³ã®å†·ãˆãƒ»å…¨èº«ï¼‰","æš‘ã•ãƒãƒ†ï¼ç†±ã£ã½ã•","å–‰ã®ç—›ã¿ãƒ»å£°æ¯ã‚Œ","é¼»æ°´ãƒ»é¼»ã¥ã¾ã‚Š","è‚Œè’ã‚Œï¼ã‹ã‚†ã¿","èŠ±ç²‰ãƒ»ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ç—‡çŠ¶"
  ];
  const group3 = [
    "é›†ä¸­åŠ›ä½ä¸‹","ã‚¤ãƒ©ã‚¤ãƒ©ï¼ä¸å®‰æ„Ÿ","ã ã‚‹ã•ï¼å€¦æ€ æ„Ÿ","ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ä½ä¸‹","PMSï¼ˆç”Ÿç†å‰ç—‡çŠ¶ï¼‰"
  ];
  const allSymptoms = [...group1, ...group2, ...group3];

  function buildChips(root, options, isActive, onClick){
    root.innerHTML = "";
    options.forEach(opt => {
      const v = typeof opt === "string" ? opt : opt.v;
      const label = typeof opt === "string" ? opt : (opt.v+" "+opt.label);
      const b = document.createElement("button");
      b.className = "chip" + (isActive(v) ? " active" : "");
      b.textContent = label;
      b.addEventListener("click", () => onClick(v));
      root.appendChild(b);
    });
  }

  function renderChips(){
    buildChips($("#moodBtns"), moods, v => state.mood===v, v => { state.mood=v; renderChips(); autoSave(); });
    buildChips($("#energyBtns"), energies, v => state.energy===v, v => { state.energy=v; renderChips(); autoSave(); });

    const mk = (id, arr) => buildChips($(id), arr, v => state.symptoms.includes(v), v => {
      if (state.symptoms.includes(v)) state.symptoms = state.symptoms.filter(x=>x!==v);
      else state.symptoms = [...state.symptoms, v];
      renderChips(); autoSave();
    });
    mk("#symptomGroup1", group1);
    mk("#symptomGroup2", group2);
    mk("#symptomGroup3", group3);
  }
  renderChips();

  // Query params
  function parseNumMaybe(v){
    if (v==null) return null;
    const s = String(v).trim().replace(/,%20/g,",").replace(/%20/g," ").trim();
    const n = parseFloat(s);
    return isNaN(n) ? null : n;
  }
  const url = new URL(window.location.href);
  const qp = k => url.searchParams.get(k);
  const qpPayload = {};
  const sleepMinQ = qp("sleepMin"); if (sleepMinQ!=null) qpPayload.sleepMin = parseInt(sleepMinQ,10)||0;
  const moodQ = qp("mood"); if (moodQ) qpPayload.mood = moodQ;
  const energyQ = qp("energy"); if (energyQ) qpPayload.energy = energyQ;
  const symptomsQ = qp("symptoms"); if (symptomsQ) qpPayload.symptoms = symptomsQ.split(",").filter(Boolean);
  const noteQ = qp("note"); if (noteQ) qpPayload.note = noteQ;
  const weightQ = qp("weight"); const wnum = parseNumMaybe(weightQ); if (wnum!=null) qpPayload.weight = wnum;
  const bodyFatQ = qp("bodyFat"); const bnum = parseNumMaybe(bodyFatQ); if (bnum!=null) qpPayload.bodyFat = bnum;

  // Note & Sleep & Health
  const sleepH = $("#sleepH"), sleepM = $("#sleepM"), note = $("#note"), sleepTotal = $("#sleepTotal");
  const weight = $("#weight"), bodyFat = $("#bodyFat");
  function updateSleepLabel(){ sleepTotal.textContent = Math.floor(state.sleepH)+"æ™‚é–“"+(state.sleepM%60)+"åˆ†"; }

  // Quick tasks
  const qtElems = [
    {c:$("#qt0c"), t:$("#qt0t")},
    {c:$("#qt1c"), t:$("#qt1t")},
    {c:$("#qt2c"), t:$("#qt2t")},
  ];
  function renderQuickTasks(){
    qtElems.forEach((q,i)=>{
      q.c.checked = !!state.quickTasks[i]?.done;
      q.t.value = state.quickTasks[i]?.text || "";
      q.c.onchange = () => { state.quickTasks[i].done = q.c.checked; autoSave(); };
      q.t.oninput = () => { state.quickTasks[i].text = q.t.value; autoSave(); };
    });
    $$("#quickTasks .linklike").forEach(el => {
      el.onclick = async () => {
        const sel = el.getAttribute("data-copy");
        const input = document.querySelector(sel);
        const txt = (input?.value || "").trim();
        if (!txt){ alert("ã‚³ãƒ”ãƒ¼ã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆãŒã‚ã‚Šã¾ã›ã‚“"); return; }
        try { await navigator.clipboard.writeText(txt); alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"); } catch(e){ alert(txt); }
      };
    });
  }
  renderQuickTasks();

  // Weather
  const wxLoading = $("#wxLoading"), wxError = $("#wxError"), wxBlock = $("#wxBlock");
  function wxCodeToText(code){ const map={0:"å¿«æ™´",1:"æ™´ã‚Œ",2:"è–„æ›‡ã‚Š",3:"æ›‡ã‚Š",45:"éœ§",48:"éœ§æ°·",51:"å¼±ã„éœ§é›¨",53:"éœ§é›¨",55:"å¼·ã„éœ§é›¨",61:"å¼±ã„é›¨",63:"é›¨",65:"å¼·ã„é›¨",71:"å¼±ã„é›ª",73:"é›ª",75:"å¤§é›ª",95:"é›·é›¨"}; return map[code]||"â€”"; }
  function renderWeather(){
    wxBlock.innerHTML="";
    if (!state.weather){ const p=document.createElement("p"); p.className="text muted"; p.textContent="ä½ç½®æƒ…å ±ã®è¨±å¯å¾Œã€è‡ªå‹•è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚"; wxBlock.appendChild(p); return; }
    const big=document.createElement("div"); big.style.fontSize="44px"; big.style.fontWeight="600"; big.textContent=Math.round(state.weather.temp)+"Â°C";
    const small=document.createElement("div"); small.className="text";
    const lines = [];
    lines.push("çŠ¶æ³ï¼š"+state.weather.condition);
    if (state.weather.appTemp!=null) lines.push("ä½“æ„Ÿï¼š"+Math.round(state.weather.appTemp)+"Â°C");
    lines.push("é¢¨é€Ÿï¼š"+Math.round(state.weather.wind)+" m/s");
    if (state.weather.humidity!=null) lines.push("æ¹¿åº¦ï¼š"+Math.round(state.weather.humidity)+"%");
    if (state.weather.pop!=null) lines.push("é™æ°´ç¢ºç‡ï¼ˆä»Šï¼‰ï¼š"+state.weather.pop+"%");
    if (state.weather.sunrise && state.weather.sunset) lines.push("æ—¥ã®å‡ºï¼š"+state.weather.sunrise+"ï¼æ—¥ã®å…¥ã‚Šï¼š"+state.weather.sunset);
    lines.push("<span class='muted'>æ›´æ–°ï¼š"+new Date(state.weather.time).toLocaleTimeString("ja-JP",{timeZone:"Asia/Tokyo"})+"</span>");
    small.innerHTML = lines.join("<br>");
    const wrap=document.createElement("div"); wrap.className="row"; wrap.appendChild(big); wrap.appendChild(small);
    wxBlock.appendChild(wrap);
  }
  function fetchWeatherFromGeo(lat, lon){
    wxLoading.style.display="inline"; wxError.textContent="";
    const u = new URL("https://api.open-meteo.com/v1/forecast");
    u.searchParams.set("latitude", lat);
    u.searchParams.set("longitude", lon);
    u.searchParams.set("current_weather","true");
    u.searchParams.set("hourly","precipitation_probability,relativehumidity_2m");
    u.searchParams.set("daily","sunrise,sunset");
    u.searchParams.set("timezone","Asia/Tokyo");
    fetch(u.toString()).then(r=>r.json()).then(data=>{
      const c=data.current_weather;
      const times = (data.hourly && data.hourly.time) || [];
      const nowISO = c.time;
      const idx = times.indexOf(nowISO);
      const hum = (idx>-1 && data.hourly.relativehumidity_2m) ? data.hourly.relativehumidity_2m[idx] : null;
      const pop = (idx>-1 && data.hourly.precipitation_probability) ? data.hourly.precipitation_probability[idx] : null;
      const sunrise = (data.daily && data.daily.sunrise) ? data.daily.sunrise[0]?.split("T")[1]?.slice(0,5) : null;
      const sunset  = (data.daily && data.daily.sunset)  ? data.daily.sunset[0]?.split("T")[1]?.slice(0,5) : null;
      state.weather={
        temp:c.temperature, wind:c.windspeed, code:c.weathercode, condition:wxCodeToText(c.weathercode), time:c.time,
        appTemp: c.apparent_temperature ?? null,
        humidity: hum, pop: pop, sunrise: sunrise, sunset: sunset
      };
      renderWeather(); autoSave();
    }).catch(e=>{ wxError.textContent="å¤©æ°—ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"; }).finally(()=>{ wxLoading.style.display="none"; });
  }
  function askGeo(){
    wxLoading.style.display="inline"; wxError.textContent="";
    if (!("geolocation" in navigator)){ wxError.textContent="ã“ã®ç«¯æœ«ã¯ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚"; wxLoading.style.display="none"; return; }
    navigator.geolocation.getCurrentPosition(
      pos => { const {latitude, longitude}=pos.coords; fetchWeatherFromGeo(latitude, longitude); },
      err => { wxError.textContent="ä½ç½®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚è¨­å®šâ†’ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼â†’ä½ç½®æƒ…å ±ã‚µãƒ¼ãƒ“ã‚¹â†’Safari Websitesã‚’è¨±å¯ ã«ã—ã¦ãã ã•ã„ã€‚"; wxLoading.style.display="none"; },
      { enableHighAccuracy:false, timeout:8000 }
    );
  }
  $("#retryWx").addEventListener("click", askGeo);
  askGeo();

  // Storage keys
  const LOGS_KEY = "md_logs_v2";
  const TASK_HIST_KEY = "md_task_history_v1";
  function loadAllLogs(){ return JSON.parse(localStorage.getItem(LOGS_KEY) || "[]"); }
  function saveAllLogs(arr){ localStorage.setItem(LOGS_KEY, JSON.stringify(arr)); }
  function loadLog(dateKey){ const logs = loadAllLogs(); return logs.find(l => l.date === dateKey) || null; }
  function upsertLog(payload){
    const logs = loadAllLogs();
    const rest = logs.filter(l => l.date !== payload.date);
    saveAllLogs([payload, ...rest].sort((a,b)=> (a.date < b.date ? 1 : -1)));
  }
  function loadTaskHistory(){ return JSON.parse(localStorage.getItem(TASK_HIST_KEY) || "[]"); }
  function saveTaskHistory(arr){ localStorage.setItem(TASK_HIST_KEY, JSON.stringify(arr)); }
  function saveUnfinishedTasksToHistory(dateKey){
    const unfinished = state.quickTasks.filter(x => x.text && !x.done).map(x => ({text:x.text, from:"quick", savedAt: Date.now()}));
    if (!unfinished.length) return 0;
    const hist = loadTaskHistory();
    const rest = hist.filter(h => h.date !== dateKey);
    saveTaskHistory([{date: dateKey, tasks: unfinished}, ...rest]);
    return unfinished.length;
  }

  // Auto-save
  let saveTimer=null;
  function autoSave(){
    clearTimeout(saveTimer);
    saveTimer = setTimeout(() => {
      const payload = {
        date: currentDateKey,
        mood: state.mood,
        energy: state.energy,
        symptoms: state.symptoms,
        sleepMin: (parseInt(state.sleepH,10)||0)*60 + (parseInt(state.sleepM,10)||0),
        weight: state.weight,
        bodyFat: state.bodyFat,
        note: state.note,
        weather: state.weather,
        quickTasks: state.quickTasks,
        ts: Date.now()
      };
      upsertLog(payload);
      renderHistory();
      renderMiniCalendar();
      if ($("#pageSummary").style.display !== "none") renderCharts();
    }, 400);
  }

  // Form sync
  function updateSleepLabel(){ $("#sleepTotal").textContent = Math.floor(state.sleepH)+"æ™‚é–“"+(state.sleepM%60)+"åˆ†"; }
  function syncFormFromState(){
    $("#sleepH").value = state.sleepH; $("#sleepM").value = state.sleepM; updateSleepLabel();
    $("#note").value = state.note;
    $("#weight").value = state.weight ?? "";
    $("#bodyFat").value = state.bodyFat ?? "";
  }

  function loadLogToForm(log){
    if (!log){
      state.mood=""; state.energy=""; state.symptoms=[]; state.note="";
      state.sleepH=0; state.sleepM=0;
      state.weight=null; state.bodyFat=null;
      state.quickTasks=[{done:false,text:""},{done:false,text:""},{done:false,text:""}];
    } else {
      state.mood = log.mood||"";
      state.energy = log.energy||"";
      state.symptoms = Array.isArray(log.symptoms) ? log.symptoms.filter(s => allSymptoms.includes(s)) : [];
      const sm = parseInt(log.sleepMin||0,10); state.sleepH = Math.floor(sm/60); state.sleepM = sm%60;
      state.weight = (log.weight ?? null);
      state.bodyFat = (log.bodyFat ?? null);
      state.note = log.note||"";
      state.weather = log.weather || state.weather;
      state.quickTasks = Array.isArray(log.quickTasks) && log.quickTasks.length===3 ? log.quickTasks : [{done:false,text:""},{done:false,text:""},{done:false,text:""}];
    }
    renderChips();
    syncFormFromState();
    renderQuickTasks();
    renderHeader();
  }

  // History render
  function renderHistory(){
    const historyRoot = $("#history");
    const logs = loadAllLogs();
    historyRoot.innerHTML="";
    if (logs.length===0){ const p=document.createElement("p"); p.className="text muted"; p.textContent="ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“"; historyRoot.appendChild(p); return; }
    logs.forEach(l => {
      const box=document.createElement("div"); box.className="card"; box.style.marginTop="8px";
      const head=document.createElement("div"); head.className="text"; head.innerHTML = `<span class="muted">${l.date}</span>`;
      const row=document.createElement("div"); row.className="row text"; row.style.marginTop="6px";
      row.innerHTML = `<div>æ°—åˆ†ï¼š${l.mood||"â€”"}</div>
                       <div>å…ƒæ°—åº¦ï¼š${l.energy||"â€”"}</div>
                       <div>ç¡çœ ï¼š${Math.floor((l.sleepMin||0)/60)}æ™‚é–“${(l.sleepMin||0)%60}åˆ†</div>
                       ${l.weight!=null?`<div>ä½“é‡ï¼š${l.weight}kg</div>`:""}
                       ${l.bodyFat!=null?`<div>ä½“è„‚è‚ªï¼š${l.bodyFat}%</div>`:""}`;
      const tags = document.createElement("div"); tags.className="text"; if (l.symptoms && l.symptoms.length){ tags.textContent="ä½“èª¿ï¼š"+l.symptoms.join("ã€ "); }
      const memo = document.createElement("div"); memo.className="text"; if (l.note){ memo.textContent="ãƒ¡ãƒ¢ï¼š"+l.note; }
      const qts = document.createElement("div"); qts.className="text";
      const nonEmpty = (l.quickTasks||[]).filter(x=>x && x.text && x.text.trim().length>0);
      if (nonEmpty.length){ qts.textContent = "ã‚¿ã‚¹ã‚¯ï¼š" + nonEmpty.map(x => (x.done ? "âœ… " : "â¬œ ") + x.text).join(" / "); }

      const actions = document.createElement("div"); actions.className="row"; actions.style.marginTop="8px";
      const editBtn = document.createElement("button"); editBtn.className="btn small"; editBtn.textContent="ç·¨é›†";
      editBtn.addEventListener("click", () => {
        currentDateKey = l.date; loadLogToForm(l);
        window.scrollTo({ top: 0, behavior: "smooth" });
      });
      const delBtn = document.createElement("button"); delBtn.className="btn small"; delBtn.textContent="å‰Šé™¤"; delBtn.style.borderColor="#fecaca";
      delBtn.addEventListener("click", () => {
        if (!confirm(`${l.date} ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
        const rest = loadAllLogs().filter(x => x.date !== l.date);
        saveAllLogs(rest);
        renderHistory();
        if ($("#pageSummary").style.display !== "none") renderCharts();
        renderMiniCalendar();
        if (currentDateKey === l.date){ currentDateKey = todayKey; loadLogToForm(loadLog(todayKey)); }
      });
      actions.appendChild(editBtn); actions.appendChild(delBtn);

      box.appendChild(head); box.appendChild(row);
      if (tags.textContent) box.appendChild(tags);
      if (memo.textContent) box.appendChild(memo);
      if (qts.textContent) box.appendChild(qts);
      box.appendChild(actions);
      historyRoot.appendChild(box);
    });
  }

  // Mini Calendar
  let calMonth = new Date(today.getFullYear(), today.getMonth(), 1);
  function renderMiniCalendar(){
    $("#calLabel").textContent = `${calMonth.getFullYear()}å¹´ ${calMonth.getMonth()+1}æœˆ`;
    const root = $("#miniCalendar");
    root.innerHTML="";
    const firstDow = new Date(calMonth.getFullYear(), calMonth.getMonth(), 1).getDay();
    const daysInMonth = new Date(calMonth.getFullYear(), calMonth.getMonth()+1, 0).getDate();
    for (let i=0;i<firstDow;i++){ const pad=document.createElement("div"); root.appendChild(pad); }
    const logs = loadAllLogs();
    const byDate = new Map(logs.map(l => [l.date, l]));
    for (let d=1; d<=daysInMonth; d++){
      const cell=document.createElement("div"); cell.className="cal-cell";
      const date = new Date(calMonth.getFullYear(), calMonth.getMonth(), d);
      const key = toKey(date);
      if (key===toKey(new Date())) cell.classList.add("today");
      cell.innerHTML = `${d}<span class="dot"></span>`;
      const dot = cell.querySelector(".dot");
      const rec = byDate.get(key);
      if (rec){
        const e = rec.energy||"";
        if (e.includes("â¤ï¸â€ğŸ”¥")) dot.style.background = "#be123c";
        else if (e.includes("â¤ï¸ã¾ãš")) dot.style.background = "#f43f5e";
        else if (e.includes("â¤ï¸â€ğŸ©¹")) dot.style.background = "#fecaca";
      }
      cell.addEventListener("click", () => {
        currentDateKey = key; loadLogToForm(rec||null);
        window.scrollTo({ top: 0, behavior: "smooth" });
      });
      root.appendChild(cell);
    }
  }
  $("#prevMonth").addEventListener("click", () => { calMonth = new Date(calMonth.getFullYear(), calMonth.getMonth()-1, 1); renderMiniCalendar(); });
  $("#nextMonth").addEventListener("click", () => { calMonth = new Date(calMonth.getFullYear(), calMonth.getMonth()+1, 1); renderMiniCalendar(); });

  // Charts
  function clear(el){ el.innerHTML=""; }
  function createSVG(w,h){ const s=document.createElementNS("http://www.w3.org/2000/svg","svg"); s.setAttribute("viewBox",`0 0 ${w} ${h}`); return s; }
  function drawAxes(svg,w,h,margin){ const g=document.createElementNS(svg.namespaceURI,"g"); const ax=document.createElementNS(svg.namespaceURI,"line"); ax.setAttribute("x1",margin.left); ax.setAttribute("y1",h-margin.bottom); ax.setAttribute("x2",w-margin.right); ax.setAttribute("y2",h-margin.bottom); ax.setAttribute("class","axis"); g.appendChild(ax); const ay=document.createElementNS(svg.namespaceURI,"line"); ay.setAttribute("x1",margin.left); ay.setAttribute("y1",margin.top); ay.setAttribute("x2",margin.left); ay.setAttribute("y2",h-margin.bottom); ay.setAttribute("class","axis"); g.appendChild(ay); svg.appendChild(g); }
  function drawBars(el, labels, values, maxY){
    el.innerHTML=""; const w=400,h=180, m={top:10,right:10,bottom:20,left:26};
    const svg=createSVG(w,h); drawAxes(svg,w,h,m);
    const innerW = w - m.left - m.right; const innerH = h - m.top - m.bottom;
    const n=values.length||1; const bw = innerW / n * 0.8; const gap = innerW / n * 0.2;
    values.forEach((v,i)=>{
      const x = m.left + i*(bw+gap) + gap/2;
      const vh = maxY ? (v/maxY)*innerH : 0;
      const y = h - m.bottom - vh;
      const rect=document.createElementNS(svg.namespaceURI,"rect"); rect.setAttribute("x",x); rect.setAttribute("y",y); rect.setAttribute("width",bw); rect.setAttribute("height",vh); rect.setAttribute("class","bar");
      svg.appendChild(rect);
    });
    el.appendChild(svg);
  }
  function drawLine(el, labels, values){
    el.innerHTML=""; const w=400,h=180, m={top:10,right:10,bottom:20,left:26};
    const svg=createSVG(w,h); drawAxes(svg,w,h,m);
    const innerW = w - m.left - m.right; const innerH = h - m.top - m.bottom;
    const xs = (i)=> m.left + (innerW * (i/(Math.max(1,values.length-1))));
    const valid = values.filter(v => v!=null);
    if (!valid.length){ el.appendChild(svg); return; }
    const min = Math.min(...valid), max = Math.max(...valid);
    const ys = (v)=> {
      if (max===min){ return h - m.bottom - innerH/2; }
      return m.top + (1 - (v-min)/(max-min)) * innerH;
    };
    let d="";
    values.forEach((v,i)=>{
      if (v==null) return;
      const x=xs(i), y=ys(v);
      d += (d==="" ? `M ${x} ${y}` : ` L ${x} ${y}`);
    });
    const path=document.createElementNS(svg.namespaceURI,"path"); path.setAttribute("d",d); path.setAttribute("class","line"); svg.appendChild(path);
    values.forEach((v,i)=>{
      if (v==null) return;
      const x=xs(i), y=ys(v);
      const c=document.createElementNS(svg.namespaceURI,"circle"); c.setAttribute("cx",x); c.setAttribute("cy",y); c.setAttribute("r",2.5); c.setAttribute("class","dot"); svg.appendChild(c);
    });
    el.appendChild(svg);
  }

  function getLogsInDays(days){
    const logs = loadAllLogs();
    const now = new Date();
    const start = new Date(now.getTime() - days*24*3600*1000);
    return logs.filter(l => {
      const [y,m,d] = l.date.split("/").map(Number);
      const dt = new Date(y, m-1, d);
      return dt >= start && dt <= now;
    }).sort((a,b)=> new Date(a.date) - new Date(b.date));
  }
  function renderCharts(){
    const sleep7 = getLogsInDays(7);
    const vals7 = sleep7.map(l=> (l.sleepMin||0)/60 );
    const maxY = Math.max(8, Math.ceil((Math.max(...vals7,0)+1)));
    drawBars($("#chartSleep7"), [], vals7, maxY);

    const e30 = getLogsInDays(30);
    const cnt = {"â¤ï¸â€ğŸ”¥å…ƒæ°—":0,"â¤ï¸ã¾ãšã¾ãš":0,"â¤ï¸â€ğŸ©¹ã ã‚‹ã„":0};
    e30.forEach(l => { if (cnt[l.energy]!=null) cnt[l.energy]++; });
    drawBars($("#chartEnergy30"), [], [cnt["â¤ï¸â€ğŸ”¥å…ƒæ°—"], cnt["â¤ï¸ã¾ãšã¾ãš"], cnt["â¤ï¸â€ğŸ©¹ã ã‚‹ã„"]], Math.max(5, ...Object.values(cnt)));

    const w30 = getLogsInDays(30);
    const wvals = w30.map(l => (l.weight!=null ? Number(l.weight) : null));
    drawLine($("#chartWeight30"), [], wvals);
  }

  // Date change
  datePicker.addEventListener("change", () => {
    const d = fromInputDate(datePicker.value);
    currentDateKey = toKey(d);
    loadLogToForm(loadLog(currentDateKey));
  });

  // Buttons
  $("#resetToToday").addEventListener("click", () => {
    currentDateKey = todayKey;
    loadLogToForm(loadLog(todayKey));
  });
  $("#copyURL").addEventListener("click", async () => {
    const u = new URL(window.location.href); u.search="";
    u.searchParams.set("mood", state.mood||"");
    u.searchParams.set("energy", state.energy||"");
    try { await navigator.clipboard.writeText(u.toString()); alert("URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼ˆmood/energyä»˜ãï¼‰"); }
    catch(e){ alert(u.toString()); }
  });
  $("#copyHealthShortcut").addEventListener("click", async () => {
    const base = window.location.origin + window.location.pathname;
    const template = `${base}?sleepMin=[[åˆè¨ˆç¡çœ åˆ†]]&weight=[[ä½“é‡_kg]]&bodyFat=[[ä½“è„‚è‚ª_%]]`;
    try{ await navigator.clipboard.writeText(template); alert("ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆç”¨URLãƒ†ãƒ³ãƒ—ãƒ¬ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"); }
    catch(e){ alert(template); }
  });

  $("#closeDay").addEventListener("click", () => {
    const payload = {
      date: currentDateKey, mood: state.mood, energy: state.energy, symptoms: state.symptoms,
      sleepMin: (parseInt(state.sleepH,10)||0)*60 + (parseInt(state.sleepM,10)||0),
      weight: state.weight, bodyFat: state.bodyFat,
      note: state.note, weather: state.weather, quickTasks: state.quickTasks, ts: Date.now()
    };
    upsertLog(payload);
    const count = saveUnfinishedTasksToHistory(currentDateKey);
    alert(`ä¿å­˜ã—ã¾ã—ãŸã€‚æœªå®Œäº†ã‚¿ã‚¹ã‚¯ ${count} ä»¶ã‚’ã‚¿ã‚¹ã‚¯å±¥æ­´ã«ä¿ç®¡ã—ã¾ã—ãŸã€‚`);
    renderHistory(); renderMiniCalendar(); if ($("#pageSummary").style.display !== "none") renderCharts();
  });

  $("#saveLog").addEventListener("click", () => {
    const payload = {
      date: currentDateKey, mood: state.mood, energy: state.energy, symptoms: state.symptoms,
      sleepMin: (parseInt(state.sleepH,10)||0)*60 + (parseInt(state.sleepM,10)||0),
      weight: state.weight, bodyFat: state.bodyFat,
      note: state.note, weather: state.weather, quickTasks: state.quickTasks, ts: Date.now()
    };
    upsertLog(payload);
    alert(`${currentDateKey} ã®è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸ`);
    renderHistory(); renderMiniCalendar(); if ($("#pageSummary").style.display !== "none") renderCharts();
  });

  // Task history
  function renderTaskHistory(){
    const root = $("#taskHistoryList"); root.innerHTML = "";
    const hist = JSON.parse(localStorage.getItem("md_task_history_v1") || "[]");
    const q = ($("#thSearch").value || "").trim();
    const dateFilter = $("#thDate").value;
    const toKeyFromInput = (s) => (!s ? null : toKey(fromInputDate(s)));
    const fDateKey = toKeyFromInput(dateFilter);

    const filtered = hist
      .map(day => ({ date: day.date, tasks: day.tasks.filter(t => q ? t.text.includes(q) : true) }))
      .filter(day => day.tasks.length > 0)
      .filter(day => fDateKey ? (day.date === fDateKey) : true);

    if (filtered.length === 0){
      const p=document.createElement("p"); p.className="text muted"; p.textContent="è©²å½“ã™ã‚‹ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚"; root.appendChild(p); return;
    }

    filtered.forEach(day => {
      const box=document.createElement("div"); box.className="card"; box.style.marginTop="8px";
      const head=document.createElement("div"); head.className="text"; head.innerHTML = `<span class="muted">${day.date}</span>`;
      const list=document.createElement("ul"); list.className="list";
      day.tasks.forEach((t,idx) => {
        const li=document.createElement("li");
        const span=document.createElement("span"); span.textContent=t.text; span.style.flex="1";
        const add=document.createElement("button"); add.className="btn small"; add.textContent="ä»Šæ—¥ã«è¿½åŠ ";
        add.onclick=()=>{
          const emptyIdx = state.quickTasks.findIndex(x => !x.text);
          if (emptyIdx === -1){ alert("ä»Šæ—¥ã®ã‚¯ã‚¤ãƒƒã‚¯ã‚¿ã‚¹ã‚¯ã¯3æ ã¨ã‚‚åŸ‹ã¾ã£ã¦ã„ã¾ã™"); return; }
          state.quickTasks[emptyIdx] = {done:false, text:t.text};
          currentDateKey = toKey(new Date()); renderHeader();
          renderQuickTasks(); autoSave();
          alert("ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯ã«è¿½åŠ ã—ã¾ã—ãŸ");
        };
        const copy=document.createElement("button"); copy.className="btn small"; copy.textContent="ã‚³ãƒ”ãƒ¼";
        copy.onclick=async()=>{ try{ await navigator.clipboard.writeText(t.text); alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"); }catch(e){ alert(t.text); } };
        const del=document.createElement("button"); del.className="btn small"; del.textContent="å‰Šé™¤";
        del.onclick=()=>{
          const h = JSON.parse(localStorage.getItem("md_task_history_v1") || "[]");
          const target = h.find(x => x.date === day.date);
          if (!target) return;
          target.tasks.splice(idx,1);
          const cleaned = target.tasks.length ? h : h.filter(x => x.date !== day.date);
          localStorage.setItem("md_task_history_v1", JSON.stringify(cleaned));
          renderTaskHistory();
        };
        li.appendChild(span); li.appendChild(add); li.appendChild(copy); li.appendChild(del);
        list.appendChild(li);
      });
      box.appendChild(head); box.appendChild(list);
      root.appendChild(box);
    });
  }
  $("#thSearch").addEventListener("input", renderTaskHistory);
  $("#thDate").addEventListener("change", renderTaskHistory);
  $("#thClear").addEventListener("click", () => { $("#thSearch").value=""; $("#thDate").value=""; renderTaskHistory(); });

  // Initial render
  function initialRender(){
    renderHistory();
    renderMiniCalendar();
    const saved = loadLog(todayKey);
    loadLogToForm(saved);
    // QP overrides after loading
    const payload = {};
    const url = new URL(window.location.href);
    const qp = k => url.searchParams.get(k);
    if (qp("sleepMin")!=null) payload.sleepMin = parseInt(qp("sleepMin"),10)||0;
    if (qp("mood")) payload.mood = qp("mood");
    if (qp("energy")) payload.energy = qp("energy");
    if (qp("symptoms")) payload.symptoms = qp("symptoms").split(",").filter(Boolean);
    if (qp("note")) payload.note = qp("note");
    if (qp("weight")!=null){ const n = parseFloat(qp("weight")); if(!isNaN(n)) payload.weight = n; }
    if (qp("bodyFat")!=null){ const n = parseFloat(qp("bodyFat")); if(!isNaN(n)) payload.bodyFat = n; }

    let changed = false;
    if (payload.sleepMin!=null){ state.sleepH = Math.floor(payload.sleepMin/60); state.sleepM = payload.sleepMin%60; changed = true; }
    if (payload.mood){ state.mood = payload.mood; changed = true; }
    if (payload.energy){ state.energy = payload.energy; changed = true; }
    if (payload.symptoms){ state.symptoms = payload.symptoms; changed = true; }
    if (payload.note){ state.note = payload.note; changed = true; }
    if (payload.weight!=null){ state.weight = payload.weight; changed = true; }
    if (payload.bodyFat!=null){ state.bodyFat = payload.bodyFat; changed = true; }
    if (changed){ renderChips(); syncFormFromState(); autoSave(); }
  }
  initialRender();
})();
</script>
</body>
</html>
