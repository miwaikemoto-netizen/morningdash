<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>MorningDash Ingest v11.2</title>
<style>
  body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Hiragino Sans","Meiryo";margin:24px}
  .ok{color:#065f46;background:#ecfdf5;border:1px solid #a7f3d0;padding:12px;border-radius:12px}
  .ng{color:#7f1d1d;background:#fef2f2;border:1px solid #fecaca;padding:12px;border-radius:12px}
  .muted{opacity:.7}
</style>
<div id="box">Saving…</div>
<script>
(function(){
  const PRIMARY_KEY="md_logs_v3";
  const COMPAT_KEYS=["md_logs_v3","md_logs_v2","md_logs_v1"];
  const tz="Asia/Tokyo";
  const toKey=(d)=> d.toLocaleDateString("ja-JP",{timeZone:tz});
  const normalizeKey=(k)=>{ const m=String(k||"").match(/^(\d{4})[\/-](\d{1,2})[\/-](\d{1,2})$/); return m?`${Number(m[1])}/${Number(m[2])}/${Number(m[3])}`:k; };
  function loadAll(){
    const m=new Map();
    COMPAT_KEYS.forEach(K=>{ try{ (JSON.parse(localStorage.getItem(K)||"[]")||[]).forEach(r=>{ const dk=normalizeKey(r.date); if(dk) m.set(dk,{...r,date:dk}); }); }catch(e){} });
    return Array.from(m.values()).sort((a,b)=> (a.date<b.date?1:-1));
  }
  function saveAll(arr){ localStorage.setItem(PRIMARY_KEY, JSON.stringify(arr)); }

  const url=new URL(location.href);
  const qp=k=>url.searchParams.get(k);
  const sleepMin = parseInt(qp("sleepMin")||"",10);
  const weight = parseFloat(qp("weight")||"");
  const bodyFat = parseFloat(qp("bodyFat")||"");

  const todayKey = toKey(new Date());
  const logs = loadAll();
  const rest = logs.filter(x=> x.date !== todayKey);
  const prev = logs.find(x=> x.date === todayKey) || {};

  const newRec = {
    date: todayKey,
    mood: prev.mood || "",
    energy: prev.energy || "",
    symptoms: Array.isArray(prev.symptoms)?prev.symptoms:[],
    sleepMin: Number.isFinite(sleepMin) ? sleepMin : (prev.sleepMin||0),
    weight: Number.isFinite(weight) ? weight : (prev.weight ?? null),
    bodyFat: Number.isFinite(bodyFat) ? bodyFat : (prev.bodyFat ?? null),
    note: prev.note || "",
    weather: prev.weather || null,
    quickTasks: Array.isArray(prev.quickTasks)?prev.quickTasks:[{done:false,text:""},{done:false,text:""},{done:false,text:""}],
    ts: Date.now()
  };

  saveAll([newRec, ...rest].sort((a,b)=> (a.date<b.date?1:-1)));

  const box=document.getElementById("box");
  box.className="ok";
  box.innerHTML = `<b>保存しました</b><br>
  date: ${todayKey}<br>
  sleepMin: ${newRec.sleepMin} / weight: ${newRec.weight} / bodyFat: ${newRec.bodyFat}
  <div class="muted" style="margin-top:8px">この画面は数秒後に朝のページへ移動します。</div>`;
  setTimeout(()=>{
    // そのまま index へ。キャッシュ影響を避けてクエリで軽くバリアント
    const base = location.href.replace(/ingest\.html.*/,"");
    location.href = base + "?r=ing";
  }, 800);
})();
</script>
