<!doctype html>
<html lang="ja">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>MorningDash – ingest</title>
<style>
  html,body{height:100%;margin:0;font:14px -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial}
  .wrap{display:flex;align-items:center;justify-content:center;height:100%}
  .card{padding:18px 20px;border:1px solid #e5e7eb;border-radius:12px;background:#fff;box-shadow:0 8px 24px rgba(0,0,0,.06)}
  .ok{color:#065f46}.warn{color:#92400e}.muted{color:#64748b}
</style>
<div class="wrap"><div class="card">
  <div id="msg" class="muted">更新中…</div>
</div></div>
<script>
(function(){
  const $ = s => document.querySelector(s);
  const url = new URL(location.href);
  const qp  = k => url.searchParams.get(k);

  // 日付キー（本体と同じ表記：例 2025/8/15）
  const toKey = d => d.toLocaleDateString("ja-JP",{timeZone:"Asia/Tokyo"});
  const todayKey = toKey(new Date());

  // 既存ログ読み込み
  const LOGS_KEY = "md_logs_v2";
  const loadAll = () => JSON.parse(localStorage.getItem(LOGS_KEY) || "[]");
  const saveAll = a => localStorage.setItem(LOGS_KEY, JSON.stringify(a));
  const logs = loadAll();
  const current = logs.find(l => l.date === todayKey) || {date: todayKey};

  // 数値パース（小数OK）
  const num = (v)=>{ if(v==null) return null; const n = parseFloat(String(v).trim()); return isNaN(n)?null:n; }
  const int = (v)=>{ if(v==null) return null; const n = parseInt(String(v).trim(),10); return isNaN(n)?null:n; }

  // 受け取る値
  const sleepMin = int(qp("sleepMin"));
  const weight   = num(qp("weight"));
  const bodyFat  = num(qp("bodyFat"));

  // 反映（来ているものだけ上書き）
  if (sleepMin!=null) current.sleepMin = sleepMin;
  if (weight  !=null) current.weight   = weight;
  if (bodyFat !=null) current.bodyFat  = bodyFat;

  // 既存以外のフィールドは温存
  const rest = logs.filter(l => l.date !== todayKey);
  saveAll([current, ...rest].sort((a,b)=> (a.date<b.date?1:-1)));

  // メッセージ
  const got = [];
  if(sleepMin!=null) got.push(`睡眠 ${sleepMin}分`);
  if(weight  !=null) got.push(`体重 ${weight}kg`);
  if(bodyFat !=null) got.push(`体脂肪 ${bodyFat}%`);
  $("#msg").textContent = got.length? `保存しました：${got.join(" / ")}` : "受け取る値がありませんでした。";
  $("#msg").className = got.length? "ok" : "warn";

  // 本体へ遷移（キャッシュ回避のため ?v=ts を付与）
  const v = Date.now();
  setTimeout(()=>{ location.replace("./index.html?v="+v); }, 250);
})();
</script>
