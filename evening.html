<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Evening Dashï¼ˆå¤œã®è¨˜éŒ²ï¼‰</title>
<meta name="theme-color" content="#0f172a">
<style>
:root{
  --bg:#0b1220; --card:#0f172a; --ink:#e6edf7; --muted:#93a0b4; --pri:#60a5fa; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
  --radius:16px;
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui, -apple-system, "Helvetica Neue", Arial}
.wrap{max-width:720px;margin:0 auto;padding:20px 16px 40px}
h1{font-size:20px;margin:0 0 12px}
.card{background:var(--card);border-radius:var(--radius);padding:16px;margin:12px 0;box-shadow:0 6px 18px rgba(0,0,0,.32);overflow:hidden}
.row{display:flex;gap:10px;flex-wrap:wrap}
.btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 14px;border-radius:999px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);color:var(--ink);cursor:pointer;user-select:none}
.btn[aria-pressed="true"]{background:rgba(96,165,250,.16);border-color:rgba(96,165,250,.5)}
.btn.ok[aria-pressed="true"]{background:rgba(34,197,94,.18);border-color:rgba(34,197,94,.6)}
.btn.warn[aria-pressed="true"]{background:rgba(245,158,11,.18);border-color:rgba(245,158,11,.6)}
.btn.bad[aria-pressed="true"]{background:rgba(239,68,68,.18);border-color:rgba(239,68,68,.6)}
label.chk{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:12px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06)}
input[type="text"], textarea{width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:var(--ink);outline:none}
.small{color:var(--muted);font-size:12px}
.actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
a.link{color:var(--pri);text-decoration:none}
hr{border:none;border-top:1px solid rgba(255,255,255,.08);margin:8px 0 12px}
.badge{display:inline-block;padding:4px 8px;border-radius:999px;background:rgba(255,255,255,.06);font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <h1>ğŸŒ™ Evening Dashï¼ˆå¤œã®è¨˜éŒ²ï¼‰ <span id="date" class="badge"></span></h1>

  <!-- å…ƒæ°—åº¦ï¼ˆå¤œã®æ°—åˆ†ï¼‰ -->
  <div class="card" id="moodCard">
    <div class="small">å¤œã®æ°—åˆ†</div>
    <div class="row" role="group" aria-label="æ°—åˆ†">
      <button class="btn ok"   data-mood="great">âœ¨ æœ€é«˜</button>
      <button class="btn"      data-mood="ok">ğŸ™‚ ãµã¤ã†</button>
      <button class="btn warn" data-mood="low">ğŸ˜ª ã­ã‚€ã„</button>
      <button class="btn bad"  data-mood="down">ğŸ˜ ã—ã‚“ã©ã„</button>
    </div>
  </div>

  <!-- ç¿’æ…£ãƒã‚§ãƒƒã‚¯ï¼ˆç·¨é›†å¯ãƒ»ä¿å­˜ï¼‰ -->
  <div class="card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div class="small">ç¿’æ…£ãƒã‚§ãƒƒã‚¯</div>
      <button class="btn" id="editHabitsBtn">âš™ï¸ ã‚«ã‚¹ã‚¿ãƒ </button>
    </div>
    <div id="habitList" class="row"></div>
    <div class="actions small">æœªé¸æŠ = æœªå®Ÿæ–½</div>
  </div>

  <!-- æ—¥è¨˜ï¼ˆ3è¡Œï¼‰ -->
  <div class="card">
    <div class="small">å¤œã®ãƒ¡ãƒ¢ / æ—¥è¨˜</div>
    <textarea id="note" rows="4" placeholder="ä»Šæ—¥ã®å‡ºæ¥äº‹ã‚„æ°—ã¥ãã‚’3è¡Œã§ã€‚"></textarea>
  </div>

  <!-- ã­ã‚‹æº–å‚™ & éŸ³æ¥½ãƒˆãƒªã‚¬ãƒ¼ -->
  <div class="card">
    <div class="small">ã­ã‚‹æº–å‚™</div>
    <div class="row">
      <label class="chk"><input type="checkbox" id="noScreen"> ç”»é¢ã‚ªãƒ•ãƒ¢ãƒ¼ãƒ‰</label>
      <label class="chk"><input type="checkbox" id="lights"> ç…§æ˜ã‚’æš—ãã™ã‚‹</label>
    </div>
    <hr>
    <div class="small">å¯ã‚‹å‰BGMï¼ˆãƒˆãƒªã‚¬ãƒ¼ï¼‰</div>
    <div class="actions">
      <a class="btn" id="playAppleMusic" href="#" rel="noopener">ğŸµ Apple Music å†ç”Ÿ</a>
      <a class="btn" id="runShortcut"    href="#" rel="noopener">ğŸ§˜ ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆå®Ÿè¡Œ</a>
    </div>
    <div class="small">â€» ãƒªãƒ³ã‚¯å…ˆã¯ä¸‹ã®ã€Œè¨­å®šã€ã§å¤‰æ›´ã§ãã¾ã™ã€‚</div>
  </div>

  <!-- ä¿å­˜/è¨­å®š -->
  <div class="card">
    <div class="actions">
      <button class="btn ok" id="saveBtn">ğŸ’¾ ä¿å­˜</button>
      <button class="btn" id="openMorning">â˜€ï¸ Morningã¸</button>
      <button class="btn" id="settingsBtn">ğŸ”§ è¨­å®š</button>
    </div>
    <div id="saveState" class="small"></div>
  </div>
</div>

<script>
// ========= å…±é€šï¼šæ—¥ä»˜ã‚­ãƒ¼ =========
const todayKey = new Date().toLocaleDateString('sv-SE'); // YYYY-MM-DD
document.getElementById('date').textContent = todayKey;

// ========= ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æ§‹é€  =========
// localStorage key: "mdash:YYYY-MM-DD"
// å€¤: { morning: {...}, evening: {...}, meta: {...} }
const getDay = () => JSON.parse(localStorage.getItem('mdash:'+todayKey) || '{}');
const setDay = (obj) => localStorage.setItem('mdash:'+todayKey, JSON.stringify(obj));

// ========= æ—¢å®šã®ç¿’æ…£ =========
const HABITS_KEY = 'mdash:evening:habits';
const defaultHabits = ["ç”»é¢ã‚ªãƒ•","ã‚¹ãƒˆãƒ¬ãƒƒãƒ","ç‘æƒ³","ç™½æ¹¯","æ—¥è¨˜3è¡Œ"];
const readHabits = () => JSON.parse(localStorage.getItem(HABITS_KEY) || '[]');
const writeHabits = (arr) => localStorage.setItem(HABITS_KEY, JSON.stringify(arr));

// åˆæœŸæç”»ï¼ˆç¿’æ…£ï¼‰
function renderHabits(){
  const habits = readHabits().length ? readHabits() : defaultHabits;
  const holder = document.getElementById('habitList');
  holder.innerHTML = '';
  const checked = (getDay().evening?.habits)||[];
  habits.forEach(h=>{
    const id = 'h_'+btoa(unescape(encodeURIComponent(h))).replace(/=/g,'');
    const label = document.createElement('label');
    label.className='chk';
    label.innerHTML = `<input type="checkbox" id="${id}"> ${h}`;
    holder.appendChild(label);
    document.getElementById(id).checked = checked.includes(h);
  });
}
renderHabits();

// ç¿’æ…£ç·¨é›†
document.getElementById('editHabitsBtn').onclick = ()=>{
  const now = readHabits().length? readHabits(): defaultHabits;
  const input = prompt("ç¿’æ…£ã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§ç·¨é›†", now.join(","));
  if(input!=null){
    writeHabits(input.split(",").map(s=>s.trim()).filter(Boolean));
    renderHabits();
  }
};

// æ°—åˆ†ãƒˆã‚°ãƒ«
let mood = getDay().evening?.mood || null;
for(const b of document.querySelectorAll('#moodCard .btn')){
  if(b.dataset.mood===mood) b.setAttribute('aria-pressed','true');
  b.addEventListener('click', ()=>{
    for(const x of document.querySelectorAll('#moodCard .btn')) x.removeAttribute('aria-pressed');
    b.setAttribute('aria-pressed','true');
    mood = b.dataset.mood;
  });
}

// è¨­å®šï¼ˆéŸ³æ¥½ãƒªãƒ³ã‚¯/ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆï¼‰
const CFG_KEY = 'mdash:evening:cfg';
const cfg = Object.assign({
  appleMusicURL: 'https://music.apple.com/jp/playlist/%E5%AF%9D%E3%82%8B%E5%89%8D/pl.u-6mo4lK4tX1', // ä»»æ„ã§å¤‰æ›´
  shortcutURL:  'shortcuts://run-shortcut?name=Wind%20Down' // ä»»æ„ã§å¤‰æ›´
}, JSON.parse(localStorage.getItem(CFG_KEY) || '{}'));
localStorage.setItem(CFG_KEY, JSON.stringify(cfg));
document.getElementById('playAppleMusic').href = cfg.appleMusicURL;
document.getElementById('runShortcut').href    = cfg.shortcutURL;

document.getElementById('settingsBtn').onclick = ()=>{
  const mus = prompt("Apple Musicã®URL", cfg.appleMusicURL);
  if(mus!=null) cfg.appleMusicURL = mus.trim();
  const sh  = prompt("å®Ÿè¡Œã™ã‚‹ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆURL", cfg.shortcutURL);
  if(sh!=null) cfg.shortcutURL = sh.trim();
  localStorage.setItem(CFG_KEY, JSON.stringify(cfg));
  document.getElementById('playAppleMusic').href = cfg.appleMusicURL;
  document.getElementById('runShortcut').href    = cfg.shortcutURL;
};

// æ—¢å­˜ï¼ˆå¤•ï¼‰ãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒ
(function restore(){
  const d = getDay().evening || {};
  if(d.note) document.getElementById('note').value = d.note || '';
  if(d.flags){
    document.getElementById('noScreen').checked = !!d.flags.noScreen;
    document.getElementById('lights').checked   = !!d.flags.lights;
  }
})();

// ä¿å­˜
document.getElementById('saveBtn').onclick = ()=>{
  const day = getDay();
  const habits = [];
  for(const el of document.querySelectorAll('#habitList input[type="checkbox"]')){
    if(el.checked){
      const txt = el.parentElement.textContent.trim();
      habits.push(txt);
    }
  }
  const payload = {
    mood,
    habits,
    note: document.getElementById('note').value.trim(),
    flags:{
      noScreen: document.getElementById('noScreen').checked,
      lights:   document.getElementById('lights').checked
    },
    savedAt: new Date().toISOString()
  };
  day.evening = Object.assign({}, day.evening||{}, payload);
  setDay(day);
  const s = document.getElementById('saveState');
  s.textContent = "ä¿å­˜ã—ã¾ã—ãŸ âœ“";
  setTimeout(()=>s.textContent="", 2000);
};

// Morningã¸
document.getElementById('openMorning').onclick = ()=>{
  location.href = './index.html';
};

// ====== URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ã®è‡ªå‹•å…¥åŠ›ï¼ˆä»»æ„ï¼‰ ======
// ä¾‹: .../evening.html?mood=ok&habits=ã‚¹ãƒˆãƒ¬ãƒƒãƒ,ç‘æƒ³&note=çŸ­ã„ãƒ¡ãƒ¢
(function fromParams(){
  const p = new URLSearchParams(location.search);
  if(![...p.keys()].length) return;
  if(p.get('mood')){
    const t = document.querySelector(`[data-mood="${p.get('mood')}"]`);
    if(t) t.click();
  }
  if(p.get('habits')){
    const want = p.get('habits').split(',').map(s=>s.trim());
    for(const el of document.querySelectorAll('#habitList input[type="checkbox"]')){
      const txt = el.parentElement.textContent.trim();
      el.checked = want.includes(txt);
    }
  }
  if(p.get('note')) document.getElementById('note').value = p.get('note');
})();
</script>
</body>
</html>
